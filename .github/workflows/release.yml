name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”Ž Run analysis
        run: flutter analyze --no-fatal-infos

      - name: ðŸ§ª Run tests
        run: flutter test

      - name: ðŸ”¨ Build release APK (Universal)
        run: flutter build apk --release

      - name: ðŸ”¨ Build release APK (Split per ABI)
        run: flutter build apk --release --split-per-abi --obfuscate --split-debug-info=build/app/outputs/symbols

      - name: ðŸ“ Rename APKs
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-universal.apk
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
             build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-arm64.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk \
             build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-armv7.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk \
             build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-x86_64.apk

      - name: ðŸ“Š Generate checksums
        run: |
          cd build/app/outputs/flutter-apk
          sha256sum synth-vib3plus-v${{ steps.get_version.outputs.version }}-*.apk > checksums.txt
          cat checksums.txt

      - name: ðŸ“ Create release notes
        run: |
          cat > release_notes.md << 'EOF'
          # Synth-VIB3+ Modular v${{ steps.get_version.outputs.version }}

          ## ðŸŽµ What's New

          Professional holographic synthesizer with 4D VIB34D visualization and bidirectional audio-visual coupling.

          ### Features
          - âœ… 72 unique sound+visual combinations (3 systems Ã— 24 geometries)
          - âœ… Advanced quaternion-based 4D rotations
          - âœ… Three synthesis branches (Direct, FM, Ring Modulation)
          - âœ… Three visual systems (Quantum, Faceted, Holographic)
          - âœ… Real-time bidirectional parameter coupling at 60 FPS
          - âœ… 8-voice polyphony with ADSR envelopes
          - âœ… Professional effects (reverb, delay, filtering)

          ## ðŸ“¦ Downloads

          Choose the APK that matches your device architecture:

          - **Universal APK** - Works on all devices (recommended if unsure)
          - **ARM64 APK** - Most modern Android devices (2015+)
          - **ARMv7 APK** - Older 32-bit ARM devices
          - **x86_64 APK** - Intel-based Android devices (rare)

          ## ðŸ“‹ Requirements

          - Android 5.0 (API 21) or higher
          - ~60-80 MB free storage
          - Audio output device

          ## ðŸ” Checksums

          See `checksums.txt` for SHA-256 hashes.

          ---

          **A Paul Phillips Manifestation**
          Â© 2025 Clear Seas Solutions LLC
          EOF

      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Synth-VIB3+ v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-universal.apk
            build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-arm64.apk
            build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-armv7.apk
            build/app/outputs/flutter-apk/synth-vib3plus-v${{ steps.get_version.outputs.version }}-x86_64.apk
            build/app/outputs/flutter-apk/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload symbols for crash reporting
        uses: actions/upload-artifact@v4
        with:
          name: debug-symbols-v${{ steps.get_version.outputs.version }}
          path: build/app/outputs/symbols
          retention-days: 90
