class p{constructor(t){this.engine=t,this.storageKey="vib34d-unified-variations",this.collectionStorageKey="vib34d-unified-collections",this.maxVariations=1e4,this.variations=[],this.collections=new Map,this.loadFromStorage()}async save(t={}){const e=this.captureCurrentState();switch(e.id=this.generateUniqueId(),e.timestamp=Date.now(),e.created=new Date().toISOString(),t.target||"gallery"){case"localStorage":return this.saveToLocalStorage(e);case"download":return this.saveToDownload(e,t.format||"json");case"gallery":return this.saveToGallery(e);case"collection":return this.saveToCollection(e,t.collectionName);case"share":return this.saveForSharing(e);default:return this.saveToGallery(e)}}captureCurrentState(){var r;const t=window.currentSystem||"faceted";console.log("üîµ UnifiedSaveManager capturing state for system:",t),console.log("üîç Available global objects:",{engine:!!window.engine,quantumEngine:!!window.quantumEngine,holographicSystem:!!window.holographicSystem,userParameterState:!!window.userParameterState,currentSystem:window.currentSystem});const e={system:t,name:this.generateVariationName(),parameters:{},metadata:{}};if(e.parameters=this.getSystemParameters(t),!e.parameters||Object.keys(e.parameters).length===0)console.warn("‚ö†Ô∏è No parameters captured via system methods, using manual fallback"),e.parameters=this.captureManualParameters();else{const o=this.captureManualParameters(),n=["geometry","rot4dXW","rot4dYW","rot4dZW","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation"];let a=0;n.forEach(s=>{e.parameters[s]===void 0&&o[s]!==void 0&&(e.parameters[s]=o[s],a++)}),a>0&&console.log(`üîç Added ${a} missing core parameters from manual capture`)}return e.metadata={timestamp:Date.now(),engine:"VIB34D Unified",version:"3.0",author:"VIB34D User",device:navigator.userAgent,toggleStates:{audioEnabled:window.audioEnabled||!1,interactivityEnabled:window.interactivityEnabled||!1,deviceTiltEnabled:((r=window.deviceTiltHandler)==null?void 0:r.isEnabled)||!1,reactivityMode:window.getCurrentReactivityState()}},console.log("üîµ Final captured state:",e),console.log(`üîç Final parameter count: ${Object.keys(e.parameters).length} parameters`),e}getSystemParameters(t){var o,n,a,s,c,d,i,l,g,u,h,w;let e=null,r="unknown";try{switch(t){case"faceted":(n=(o=this.engine)==null?void 0:o.parameterManager)!=null&&n.getAllParameters?(e=this.engine.parameterManager.getAllParameters(),r="this.engine.parameterManager.getAllParameters()"):(s=(a=window.engine)==null?void 0:a.parameterManager)!=null&&s.getAllParameters?(e=window.engine.parameterManager.getAllParameters(),r="window.engine.parameterManager.getAllParameters()"):(d=(c=window.facetedEngine)==null?void 0:c.parameterManager)!=null&&d.getAllParameters&&(e=window.facetedEngine.parameterManager.getAllParameters(),r="window.facetedEngine.parameterManager.getAllParameters()");break;case"quantum":(i=this.engine)!=null&&i.getParameters?(e=this.engine.getParameters(),r="this.engine.getParameters()"):(l=window.quantumEngine)!=null&&l.getParameters&&(e=window.quantumEngine.getParameters(),r="window.quantumEngine.getParameters()");break;case"holographic":(g=window.holographicSystem)!=null&&g.getParameters&&(e=window.holographicSystem.getParameters(),r="window.holographicSystem.getParameters()");break;case"polychora":(u=window.newPolychoraEngine)!=null&&u.getParameters?(e=window.newPolychoraEngine.getParameters(),r="window.newPolychoraEngine.getParameters()"):(w=(h=window.newPolychoraEngine)==null?void 0:h.parameters)!=null&&w.getAllParameters&&(e=window.newPolychoraEngine.parameters.getAllParameters(),r="window.newPolychoraEngine.parameters.getAllParameters()");break;default:console.warn(`‚ö†Ô∏è Unknown system: ${t}`);break}}catch(m){console.error(`‚ùå Error capturing ${t} parameters:`,m),e=null,r="error-occurred"}if(e&&typeof e=="object"){const m=Object.keys(e).length;if(m>0)return console.log(`‚úÖ Successfully captured ${m} parameters for ${t} via ${r}`),console.log(`üîç ${t} parameters:`,e),e;console.warn(`‚ö†Ô∏è ${t} returned empty parameters object via ${r}`)}else console.warn(`‚ö†Ô∏è ${t} system parameters not available via ${r}`);return null}captureManualParameters(){const t={};let e="unknown";try{window.userParameterState&&typeof window.userParameterState=="object"&&(Object.assign(t,window.userParameterState),e="global-userParameterState",console.log("üîµ Using global userParameterState for parameter capture"));let o=null;const n=[".geom-btn.active",".geometry-btn.active","[data-geometry].active"];for(const i of n){const l=document.querySelector(i);if(l){const g=l.dataset.index||l.dataset.geometry;if(g!==void 0){o=parseInt(g);break}}}o!==null&&(t.geometry=o,t.geometryType=o,e=e==="unknown"?"DOM-geometry":`${e}+DOM-geometry`);const a=["rot4dXW","rot4dYW","rot4dZW","rot4dXY","rot4dXZ","rot4dYZ","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation","dimension"];let s=0;a.forEach(i=>{const l=document.getElementById(i);if(l&&l.value!==void 0){const g=parseFloat(l.value);!isNaN(g)&&(t[i]===void 0||e==="unknown")&&(t[i]=g,s++)}}),s>0&&(e=e==="unknown"?"DOM-sliders":`${e}+DOM-sliders`);const c={geometry:0,geometryType:0,rot4dXW:0,rot4dYW:0,rot4dZW:0,gridDensity:20,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.7,saturation:.8};let d=0;Object.entries(c).forEach(([i,l])=>{(t[i]===void 0||isNaN(t[i]))&&(t[i]=l,d++)}),d>0&&(e=`${e}+defaults(${d})`)}catch(o){console.error("‚ùå Error during manual parameter capture:",o),e="error-fallback",Object.assign(t,{geometry:0,geometryType:0,rot4dXW:0,rot4dYW:0,rot4dZW:0,gridDensity:20,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.7,saturation:.8})}const r=Object.keys(t).length;return console.log(`üîµ Manual parameter capture complete: ${r} parameters via ${e}`,t),t}initializeSystemWithParameters(t,e){console.log(`üîµ Initializing ${t} system with parameters:`,e);try{if(window.userParameterState&&e&&(Object.assign(window.userParameterState,e),console.log("üîµ Updated global userParameterState")),window.syncSlidersToStoredValues&&setTimeout(()=>{window.syncSlidersToStoredValues(),console.log("üîµ Synced UI sliders to parameters")},100),e.geometry!==void 0){const r=parseInt(e.geometry);!isNaN(r)&&r>=0&&r<=7&&setTimeout(()=>{window.selectGeometry&&(window.selectGeometry(r),console.log(`üîµ Set geometry to ${r}`))},150)}return setTimeout(()=>{if(window.syncVisualizerToUI){const r=this.getCurrentEngine(t);r&&(window.syncVisualizerToUI(t,r),console.log(`üîµ Force-synced ${t} visualizer`))}},200),setTimeout(()=>{window.updateParameter&&e&&(Object.entries(e).forEach(([r,o])=>{typeof o=="number"&&!isNaN(o)&&window.updateParameter(r,o)}),console.log(`üîµ Applied ${Object.keys(e).length} parameters individually`))},250),!0}catch(r){return console.error(`‚ùå Error initializing ${t} with parameters:`,r),!1}}getCurrentEngine(t){try{switch(t){case"faceted":return window.engine||window.facetedEngine||this.engine;case"quantum":return window.quantumEngine;case"holographic":return window.holographicSystem||window.holographicEngine;case"polychora":return console.warn("‚ö†Ô∏è Polychora system excluded - no engine available"),null;default:return null}}catch(e){return console.error(`‚ùå Error getting ${t} engine:`,e),null}}saveToLocalStorage(t){this.variations.push(t),this.variations.length>this.maxVariations&&(this.variations=this.variations.slice(-this.maxVariations));try{return localStorage.setItem(this.storageKey,JSON.stringify(this.variations)),console.log("‚úÖ Saved variation to localStorage:",t.name),{success:!0,id:t.id}}catch(e){return console.error("‚ùå Failed to save to localStorage:",e),{success:!1,error:e.message}}}async saveToGallery(t){const e=this.saveToLocalStorage(t);if(!e.success)return e;const o=`custom-saves-${new Date().toISOString().split("T")[0]}`,n=new Date().toLocaleDateString();let a=this.collections.get(o);a||(console.log(`üìÖ Creating new daily collection: ${o}`),a={name:`Custom Saves - ${n}`,description:`Custom variations saved on ${n}`,version:"1.0",type:"holographic-collection",profileName:"VIB34D User",totalVariations:0,created:t.created,updated:t.created,filename:o,variations:[]},this.collections.set(o,a));const s={id:a.variations.length,name:t.name,isCustom:!0,globalId:t.id,system:t.system,parameters:this.normalizeParameters(t.parameters)};return a.variations.push(s),a.totalVariations=a.variations.length,a.updated=new Date().toISOString(),console.log(`üìù Added variation to daily collection. Total in ${o}: ${a.totalVariations}`),this.saveCollectionsToStorage(),this.engine.statusManager&&this.engine.statusManager.success(`‚úÖ Saved to Gallery!<br><strong>${t.name}</strong><br>Added to: ${a.name}<br>Total today: ${a.totalVariations}<br><small>Gallery will update automatically</small>`),this.emitGalleryUpdate(t),{success:!0,id:t.id,collection:o,totalInCollection:a.totalVariations}}saveToDownload(t,e="json"){let r,o,n;switch(e){case"json":r=JSON.stringify(t,null,2),o=`vib34d-${t.id}.json`,n="application/json";break;case"collection":const d=this.createCollectionFormat([t]);r=JSON.stringify(d,null,2),o=`collection-${t.id}.json`,n="application/json";break;default:throw new Error(`Unsupported format: ${e}`)}const a=new Blob([r],{type:n}),s=URL.createObjectURL(a),c=document.createElement("a");return c.href=s,c.download=o,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(s),console.log(`üì• Downloaded ${o}`),{success:!0,filename:o}}saveToCollection(t,e="My Collection"){let r=this.collections.get(e);return r||(r=this.createCollectionFormat([],e),this.collections.set(e,r)),r.variations.push({id:r.variations.length,name:t.name,isCustom:!0,globalId:t.id,system:t.system,parameters:this.normalizeParameters(t.parameters)}),r.totalVariations=r.variations.length,r.updated=new Date().toISOString(),this.saveCollectionsToStorage(),console.log(`üìÅ Added to collection "${e}":`,t.name),{success:!0,collection:e,id:t.id}}saveForSharing(t){this.saveToLocalStorage(t);const e=window.location.origin+window.location.pathname.replace("index.html",""),r=new URLSearchParams;r.set("id",t.id),r.set("system",t.system),Object.entries(t.parameters).forEach(([n,a])=>{a!=null&&r.set(n,a)});const o=`${e}share.html?${r.toString()}`;return navigator.clipboard&&(navigator.clipboard.writeText(o),this.engine.statusManager&&this.engine.statusManager.success(`üîó Share URL copied!<br><small>${o}</small>`)),{success:!0,url:o,id:t.id}}normalizeParameters(t){const e={};return e.geometry=t.geometry||t.geometryType||0,e.gridDensity=t.gridDensity||t.density||10,e.morphFactor=t.morphFactor||t.morph||0,e.speed=t.speed||1,e.chaos=t.chaos||0,e.hue=t.hue||200,e.saturation=t.saturation||.8,e.intensity=t.intensity||.5,e.rot4dXW=t.rot4dXW||0,e.rot4dYW=t.rot4dYW||0,e.rot4dZW=t.rot4dZW||0,e.dimension=t.dimension||3.8,e.rot4dXY=t.rot4dXY||0,e.rot4dXZ=t.rot4dXZ||0,e.rot4dYZ=t.rot4dYZ||0,e.geometryType=e.geometry,e.density=e.gridDensity,e.morph=e.morphFactor,e}createCollectionFormat(t=[],e="Unnamed Collection"){return{name:e,description:"VIB34D Unified Collection",version:"1.0",type:"holographic-collection",profileName:"VIB34D System",totalVariations:t.length,created:new Date().toISOString(),updated:new Date().toISOString(),variations:t.map((r,o)=>({id:o,name:r.name,isCustom:!0,globalId:r.id||this.generateUniqueId(),system:r.system,parameters:this.normalizeParameters(r.parameters||{})}))}}loadFromStorage(){try{const t=localStorage.getItem(this.storageKey);t&&(this.variations=JSON.parse(t),console.log(`üìÇ Loaded ${this.variations.length} variations from storage`));const e=localStorage.getItem(this.collectionStorageKey);if(e){const r=JSON.parse(e);this.collections=new Map(r),console.log(`üìÅ Loaded ${this.collections.size} collections from storage`)}}catch(t){console.error("Failed to load from storage:",t)}}saveCollectionsToStorage(){try{const t=Array.from(this.collections.entries());localStorage.setItem(this.collectionStorageKey,JSON.stringify(t))}catch(t){console.error("Failed to save collections:",t)}}emitGalleryUpdate(t){const e=new CustomEvent("vib34d-gallery-update",{detail:{variation:t,timestamp:Date.now()}});window.dispatchEvent(e)}generateUniqueId(){return`V${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateVariationName(){const t={faceted:"FACETED",holographic:"HOLO",polychora:"POLY"},e=window.currentSystem||"faceted",r=t[e]||"CUSTOM",o=new Date().toTimeString().split(" ")[0].replace(/:/g,"");return`${r}-${o}`}getAllVariations(){return this.variations}getAllCollections(){return Array.from(this.collections.values())}clearAll(){this.variations=[],this.collections.clear(),localStorage.removeItem(this.storageKey),localStorage.removeItem(this.collectionStorageKey),console.log("üóëÔ∏è Cleared all saved data")}}export{p as UnifiedSaveManager};
