<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB3+ Engine - 24 Geometries â€¢ 6D Rotation</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet" onerror="console.warn('Google Fonts failed to load - using fallback')">
    
    <!-- Organized CSS Architecture -->
  <script type="module">
var Tt=Object.defineProperty;var It=(i,e,t)=>e in i?Tt(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Te=(i,e,t)=>It(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();class Dt{constructor(){this.galleryPreviewData=null,this.isGalleryPreview=!1}parseURLParameters(){const e=new URLSearchParams(window.location.search);if(e.has("system")){const t=e.get("system"),o=e.get("hideui")==="true";o&&this.setupCleanPreview();const a={};e.forEach((l,c)=>{["system","hideui","alllayers","highquality"].includes(c)||(a[c]=parseFloat(l)||l)});const r=e.get("alllayers")==="true",s=e.get("highquality")==="true";(r||s)&&(window.forceAllLayers=!0,window.forceHighQuality=!0,console.log("ğŸ¨ Gallery preview: Forcing all 5 layers with high quality")),this.galleryPreviewData={system:t,parameters:a,hideUI:o},console.log("ğŸ¨ Gallery preview mode detected:",this.galleryPreviewData),console.log("ğŸ¨ URL that triggered this:",window.location.href),console.log("ğŸ¨ Parameters parsed:",a),console.log("ğŸ¨ System to switch to:",t),this.isGalleryPreview=!0;const n=window.currentSystem;window.currentSystem=t,console.log(`ğŸ¯ Gallery preview: currentSystem set to '${t}' (was '${n}')`),window.galleryPreviewData=this.galleryPreviewData,window.isGalleryPreview=this.isGalleryPreview}}setupCleanPreview(){const e=()=>{const t=document.querySelector(".top-bar"),o=document.querySelector(".control-panel"),a=document.querySelector(".canvas-container");t&&(t.style.display="none"),o&&(o.style.display="none"),a&&(a.style.cssText=`
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    display: block !important;
                    background: #000 !important;
                `,a.querySelectorAll("canvas").forEach((s,n)=>{s.style.cssText=`
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                    `}))};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()}showCorrectSystemLayers(e){const t=()=>{["faceted","quantum","holographic","polychora"].forEach(a=>{const r=a==="faceted"?"vib34dLayers":`${a}Layers`,s=document.getElementById(r);if(s){const n=a===e;s.style.display=n?"block":"none",console.log(`ğŸ¯ EARLY CANVAS CONTROL: ${a} layers â†’ ${n?"VISIBLE":"HIDDEN"}`)}})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}}const Lt=new Dt;Lt.parseURLParameters();class Mt{constructor(){this.initializationAttempts=0,this.maxAttempts=10,this.retryDelay=1e3}async initializeGalleryPreview(){if(!window.isGalleryPreview||!window.galleryPreviewData)return;console.log("ğŸš€ FAST GALLERY PREVIEW: Initializing for",window.galleryPreviewData.system),await this.waitForCriticalSystems();const e=window.galleryPreviewData.system;console.log(`ğŸš€ FAST GALLERY PREVIEW: Switching to ${e} (ONCE)`);try{await window.switchSystem(e),console.log(`âœ… FAST: ${e} system ready`)}catch(t){if(console.warn(`âŒ FAST: Switch to ${e} failed, using fallback:`,t.message),e!=="faceted")try{await window.switchSystem("faceted"),window.galleryPreviewData.system="faceted",console.log("âœ… FAST: Fallback to faceted successful")}catch(o){console.error("âŒ FAST: Even fallback failed:",o.message)}}await this.applyParametersFast()}async waitForCriticalSystems(){return new Promise(e=>{const t=()=>{const o=typeof window.switchSystem=="function",a=!!window.canvasManager,r=window.engineClasses&&Object.keys(window.engineClasses).length>0;o&&a&&r?(console.log("ğŸš€ FAST GALLERY PREVIEW: Essential systems ready!"),e()):this.initializationAttempts<5?(this.initializationAttempts++,console.log(`ğŸš€ FAST: Waiting for essentials... (${this.initializationAttempts}/5)`),console.log(`  - switchSystem: ${o?"âœ…":"âŒ"}`),console.log(`  - canvasManager: ${a?"âœ…":"âŒ"}`),console.log(`  - engineClasses: ${r?"âœ…":"âŒ"}`),setTimeout(t,500)):(console.warn("ğŸš€ FAST: Timeout waiting for essentials - proceeding anyway"),e())};t()})}checkTargetSystemEngine(e){if(!e)return!1;const o=!!{faceted:window.engine,quantum:window.quantumEngine,holographic:window.holographicSystem,polychora:window.polychoraSystem}[e],a=typeof window.switchSystem=="function";return o||a}checkSystemAvailability(e){console.log(`ğŸ¨ GALLERY PREVIEW FIX: Checking ${e} system availability...`);const t={faceted:window.engine,quantum:window.quantumEngine,holographic:window.holographicSystem,polychora:window.polychoraSystem},o=!!t[e];return o?(console.log(`âœ… ${e} available via engine instance`),!0):window.switchSystem&&e==="faceted"?(console.log(`âœ… ${e} available via switchSystem (fallback)`),!0):window.isGalleryPreview&&e!=="faceted"?(console.warn(`âš ï¸ Gallery preview: ${e} not available, will fallback to faceted`),!1):(console.warn(`âŒ ${e} system not available`,{engineInstance:o,switchSystemExists:!!window.switchSystem,isGalleryPreview:window.isGalleryPreview,availableInstances:Object.keys(t).filter(a=>t[a])}),!1)}async applyParametersFast(){const{parameters:e}=window.galleryPreviewData;console.log("ğŸš€ ENHANCED GALLERY PREVIEW: Applying full parameter set"),console.log(`ğŸš€ Parameters (${Object.keys(e).length}):`,e),await new Promise(t=>setTimeout(t,100));try{if(window.userParameterState){const s={variation:0,geometry:0,gridDensity:15,speed:.5,chaos:0,morphFactor:0,hue:0,saturation:.8,intensity:.5,rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0,dimension:3.2,...e};Object.assign(window.userParameterState,s),console.log(`ğŸš€ ENHANCED: Global state updated with ${Object.keys(s).length} parameters`)}if(["rot4dXY","rot4dXZ","rot4dYZ"].forEach(s=>{if(e[s]!==void 0)try{window.updateParameter&&(window.updateParameter(s,e[s]),console.log(`ğŸš€ 3D ROTATION: ${s} = ${e[s].toFixed(4)}`))}catch(n){console.warn(`ğŸš€ 3D ROTATION ${s} failed:`,n.message)}}),["rot4dXW","rot4dYW","rot4dZW"].forEach(s=>{if(e[s]!==void 0)try{window.updateParameter&&(window.updateParameter(s,e[s]),console.log(`ğŸš€ 4D ROTATION: ${s} = ${e[s].toFixed(4)}`))}catch(n){console.warn(`ğŸš€ 4D ROTATION ${s} failed:`,n.message)}}),e.dimension!==void 0)try{window.updateParameter&&(window.updateParameter("dimension",e.dimension),console.log(`ğŸš€ DIMENSION: dimension = ${e.dimension}`))}catch(s){console.warn("ğŸš€ DIMENSION failed:",s.message)}if(["geometry","gridDensity","morphFactor","chaos","speed"].forEach(s=>{if(e[s]!==void 0)try{window.updateParameter&&(window.updateParameter(s,e[s]),console.log(`ğŸš€ VISUAL: ${s} = ${e[s]}`))}catch(n){console.warn(`ğŸš€ VISUAL ${s} failed:`,n.message)}}),["hue","saturation","intensity"].forEach(s=>{if(e[s]!==void 0)try{window.updateParameter&&(window.updateParameter(s,e[s]),console.log(`ğŸš€ COLOR: ${s} = ${e[s]}`))}catch(n){console.warn(`ğŸš€ COLOR ${s} failed:`,n.message)}}),e.variation!==void 0)try{window.updateParameter&&(window.updateParameter("variation",e.variation),console.log(`ğŸš€ VARIATION: variation = ${e.variation}`))}catch(s){console.warn("ğŸš€ VARIATION failed:",s.message)}console.log("ğŸš€ ENHANCED GALLERY PREVIEW: All parameters applied successfully"),window.updateTiltBaseRotations&&(window.updateTiltBaseRotations(),console.log("ğŸš€ ENHANCED: Updated device tilt base rotations"))}catch(t){console.error("ğŸš€ ENHANCED: Parameter application error:",t)}}getCurrentEngine(){switch(window.currentSystem){case"faceted":return window.engine;case"quantum":return window.quantumEngine;case"holographic":return window.holographicSystem;default:return null}}suppressWarningSpam(){if(!window.originalConsoleWarn){window.originalConsoleWarn=console.warn;const e=new Map,t=3;console.warn=function(...o){const a=o.join(" ");if(a.includes("System")&&a.includes("not available")){const r=e.get(a)||0;r<t&&(e.set(a,r+1),window.originalConsoleWarn.apply(console,o),r===t-1&&window.originalConsoleWarn("ğŸ”‡ Suppressing further identical warnings for this session"))}else window.originalConsoleWarn.apply(console,o)},console.log("ğŸ”‡ Gallery preview warning spam suppression active")}}}if(typeof window<"u"&&window.location.search.includes("system=")){console.log("ğŸ¨ GALLERY PREVIEW FIX: Detected gallery preview mode");const i=new Mt;i.suppressWarningSpam(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>i.initializeGalleryPreview(),50)}):setTimeout(()=>i.initializeGalleryPreview(),50),window.galleryPreviewFix=i}console.log("ğŸ¨ Gallery Preview Fix: Loaded");window.audioEnabled=!1;class At{constructor(){this.context=null,this.analyser=null,this.dataArray=null,this.isActive=!1,window.audioReactive={bass:0,mid:0,high:0,energy:0},console.log("ğŸµ Audio Engine: Initialized with default values")}async init(){if(this.isActive)return!0;try{console.log("ğŸµ Simple Audio Engine: Starting...");const e=await navigator.mediaDevices.getUserMedia({audio:!0});return this.context=new(window.AudioContext||window.webkitAudioContext),this.context.state==="suspended"&&await this.context.resume(),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=256,this.analyser.smoothingTimeConstant=.8,this.context.createMediaStreamSource(e).connect(this.analyser),this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.isActive=!0,window.audioEnabled=!0,this.startProcessing(),console.log("âœ… Audio Engine: Active - window.audioEnabled = true"),!0}catch{return console.log("âš ï¸ Audio denied - silent mode"),window.audioEnabled=!1,!1}}startProcessing(){const e=()=>{if(!this.isActive||!this.analyser){requestAnimationFrame(e);return}this.analyser.getByteFrequencyData(this.dataArray);const t=this.dataArray.length,o=Math.floor(t*.1),a=Math.floor(t*.3);let r=0,s=0,n=0;for(let c=0;c<o;c++)r+=this.dataArray[c];for(let c=o;c<a;c++)s+=this.dataArray[c];for(let c=a;c<t;c++)n+=this.dataArray[c];r=r/o/255,s=s/(a-o)/255,n=n/(t-a)/255;const l=.7;window.audioReactive.bass=r*l+window.audioReactive.bass*(1-l),window.audioReactive.mid=s*l+window.audioReactive.mid*(1-l),window.audioReactive.high=n*l+window.audioReactive.high*(1-l),window.audioReactive.energy=(window.audioReactive.bass+window.audioReactive.mid+window.audioReactive.high)/3,Date.now()%5e3<16&&console.log(`ğŸµ Audio levels: Bass=${window.audioReactive.bass.toFixed(2)} Mid=${window.audioReactive.mid.toFixed(2)} High=${window.audioReactive.high.toFixed(2)} Energy=${window.audioReactive.energy.toFixed(2)}`),requestAnimationFrame(e)};e()}isAudioActive(){return this.isActive&&window.audioEnabled}getAudioLevels(){return window.audioReactive}stop(){this.isActive=!1,window.audioEnabled=!1,this.context&&(this.context.close(),this.context=null),console.log("ğŸµ Audio Engine: Stopped")}}function _t(){window.toggleAudio=function(){const i=document.querySelector('[onclick="toggleAudio()"]');if(!window.audioEngine.isActive)window.audioEngine.init().then(e=>{e?(i&&(i.style.background="linear-gradient(45deg, rgba(0, 255, 0, 0.3), rgba(0, 255, 0, 0.6))",i.style.borderColor="#00ff00",i.title="Audio Reactivity: ON"),console.log("ğŸµ Audio Reactivity: ON")):console.log("âš ï¸ Audio permission denied or not available")});else{let e=!window.audioEnabled;window.audioEnabled=e,i&&(i.style.background=e?"linear-gradient(45deg, rgba(0, 255, 0, 0.3), rgba(0, 255, 0, 0.6))":"linear-gradient(45deg, rgba(255, 0, 255, 0.1), rgba(255, 0, 255, 0.3))",i.style.borderColor=e?"#00ff00":"rgba(255, 0, 255, 0.3)",i.title=`Audio Reactivity: ${e?"ON":"OFF"}`),e&&navigator.mediaDevices.getUserMedia({audio:!0}).catch(t=>{e=!1,window.audioEnabled=!1,console.log("âš ï¸ Audio permission denied:",t.message)}),console.log(`ğŸµ Audio Reactivity: ${e?"ON":"OFF"}`)}}}const Pt=new At;window.audioEngine=Pt;_t();console.log("ğŸµ Audio Engine Module: Loaded");let $t=window.audioEnabled||!1,_=!1;window.updateParameter=function(i,e){window.userParameterState[i]=parseFloat(e),console.log(`ğŸ’¾ User parameter: ${i} = ${e}`);const t={rot4dXY:"rot4dXY-display",rot4dXZ:"rot4dXZ-display",rot4dYZ:"rot4dYZ-display",rot4dXW:"rot4dXW-display",rot4dYW:"rot4dYW-display",rot4dZW:"rot4dZW-display",gridDensity:"gridDensity-display",morphFactor:"morphFactor-display",chaos:"chaos-display",speed:"speed-display",hue:"hue-display",intensity:"intensity-display",saturation:"saturation-display"},o=document.getElementById(t[i]);o&&(i==="hue"?o.textContent=e+"Â°":i.startsWith("rot4d")?o.textContent=parseFloat(e).toFixed(2):o.textContent=parseFloat(e).toFixed(1));try{const a=window.currentSystem||"faceted",r={faceted:window.engine,quantum:window.quantumEngine,holographic:window.holographicSystem,polychora:window.polychoraSystem},s=r[a];if(!s){console.warn(`âš ï¸ System ${a} not available - engines:`,Object.keys(r).map(c=>`${c}:${!!r[c]}`).join(", ")),window.parameterRetryCount||(window.parameterRetryCount={});const n=`${i}_${e}_${a}`,l=window.parameterRetryCount[n]||0;l<1?(window.parameterRetryCount[n]=l+1,console.log(`ğŸ”„ Retrying parameter ${i} = ${e} for ${a} (attempt ${l+2})`),setTimeout(()=>{window.updateParameter(i,e)},100)):(console.warn(`âŒ Parameter ${i} = ${e} failed for ${a} - system not available, giving up after 2 attempts`),delete window.parameterRetryCount[n]);return}a==="faceted"?(s.parameterManager.setParameter(i,parseFloat(e)),s.updateVisualizers()):a==="quantum"||a==="holographic"?s.updateParameter(i,parseFloat(e)):a==="polychora"&&s.updateParameters({[i]:parseFloat(e)}),console.log(`ğŸ“Š ${a.toUpperCase()}: ${i} = ${e}`)}catch(a){console.error(`âŒ Parameter update error in ${window.currentSystem||"unknown"} for ${i}:`,a)}};window.randomizeAll=function(){Ke()};window.randomizeEverything=function(){Ke(),setTimeout(()=>Rt(),10)};function Ke(){const i=["hue"];document.querySelectorAll(".control-slider").forEach(e=>{const t=e.id;if(!i.includes(t)){const o=parseFloat(e.min),a=parseFloat(e.max),r=Math.random()*(a-o)+o;e.value=r,e.oninput()}}),console.log("ğŸ² Parameters randomized (NO hue, NO geometry)")}function Rt(){var e,t;if(window.currentSystem!=="holographic"){const o=((t=(e=window.geometries)==null?void 0:e[window.currentSystem])==null?void 0:t.length)||8,a=Math.floor(Math.random()*o);window.selectGeometry&&window.selectGeometry(a)}const i=document.getElementById("hue");if(i){const o=Math.random()*360;i.value=o,i.oninput()}console.log("ğŸ² Stage 2: Randomized geometry and hue")}window.resetAll=function(){Object.entries({rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0,gridDensity:15,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.5,saturation:.8}).forEach(([e,t])=>{const o=document.getElementById(e);o&&(o.value=t,o.oninput())}),console.log("ğŸ”„ Reset all parameters")};window.openGallery=function(){if(console.log("ğŸ–¼ï¸ Navigating to gallery..."),window.location.href="./gallery.html",window.galleryWindow){const i=setInterval(()=>{window.galleryWindow.closed&&(window.galleryWindow=null,clearInterval(i),console.log("ğŸ–¼ï¸ Gallery window closed"))},1e3)}};window.toggleInteractivity=function(){_=!_;const i=document.querySelector('[onclick="toggleInteractivity()"]');i&&(i.style.background=_?"linear-gradient(45deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 255, 0.6))":"linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.3))",i.style.borderColor=_?"#00ffff":"rgba(255, 255, 255, 0.5)",i.title=`Toggle Interactivity: ${_?"ON":"OFF"}`,i.textContent="I"),console.log(`ğŸ›ï¸ Mouse/Touch Interactions: ${_?"ENABLED":"DISABLED"}`),console.log("ğŸ”· Faceted: Mouse tracking",_?"âœ…":"âŒ"),console.log("ğŸŒŒ Quantum: Enhanced interactions",_?"âœ…":"âŒ"),console.log("âœ¨ Holographic: Touch interactions",_?"âœ…":"âŒ"),console.log("ğŸ”® Polychora: 4D precision tracking",_?"âœ…":"âŒ"),Ft()};window.toggleSystemReactivity=function(i,e,t){var o,a,r,s,n,l,c,d,u;if(!window.reactivityManager){console.warn("âš ï¸ ReactivityManager not initialized");return}if(console.log(`ğŸ›ï¸ ${i.toUpperCase()} ${e.toUpperCase()}: ${t?"ON":"OFF"}`),`${i}${e.charAt(0).toUpperCase()}${e.slice(1)}`,e==="mouse")if(t)i==="faceted"?(window.reactivityManager.setMouseMode("rotations"),console.log("  ğŸ”· Activating Faceted 4D rotation mouse tracking")):i==="quantum"?(window.reactivityManager.setMouseMode("velocity"),console.log("  ğŸŒŒ Activating Quantum velocity mouse tracking")):i==="holographic"&&(window.reactivityManager.setMouseMode("distance"),console.log("  âœ¨ Activating Holographic shimmer mouse tracking")),window.reactivityManager.toggleMouse(!0);else{const m=((o=document.getElementById("facetedMouse"))==null?void 0:o.checked)||!1,f=((a=document.getElementById("quantumMouse"))==null?void 0:a.checked)||!1,h=((r=document.getElementById("holographicMouse"))==null?void 0:r.checked)||!1;!m&&!f&&!h&&(window.reactivityManager.toggleMouse(!1),console.log("  ğŸ–±ï¸ All mouse reactivity disabled"))}else if(e==="click")if(t)i==="faceted"?(window.reactivityManager.setClickMode("burst"),console.log("  ğŸ”· Activating Faceted burst clicks")):i==="quantum"?(window.reactivityManager.setClickMode("blast"),console.log("  ğŸŒŒ Activating Quantum blast clicks")):i==="holographic"&&(window.reactivityManager.setClickMode("ripple"),console.log("  âœ¨ Activating Holographic ripple clicks")),window.reactivityManager.toggleClick(!0);else{const m=((s=document.getElementById("facetedClick"))==null?void 0:s.checked)||!1,f=((n=document.getElementById("quantumClick"))==null?void 0:n.checked)||!1,h=((l=document.getElementById("holographicClick"))==null?void 0:l.checked)||!1;!m&&!f&&!h&&(window.reactivityManager.toggleClick(!1),console.log("  ğŸ‘† All click reactivity disabled"))}else if(e==="scroll")if(t)i==="faceted"?(window.reactivityManager.setScrollMode("cycle"),console.log("  ğŸ”· Activating Faceted cycle scroll effects")):i==="quantum"?(window.reactivityManager.setScrollMode("wave"),console.log("  ğŸŒŒ Activating Quantum wave scroll")):i==="holographic"&&(window.reactivityManager.setScrollMode("sweep"),console.log("  âœ¨ Activating Holographic sweep scroll effects")),window.reactivityManager.toggleScroll(!0);else{const m=((c=document.getElementById("facetedScroll"))==null?void 0:c.checked)||!1,f=((d=document.getElementById("quantumScroll"))==null?void 0:d.checked)||!1,h=((u=document.getElementById("holographicScroll"))==null?void 0:u.checked)||!1;!m&&!f&&!h&&(window.reactivityManager.toggleScroll(!1),console.log("  ğŸŒ€ All scroll reactivity disabled"))}};window.toggleAudioReactivity=function(i,e,t){console.log(`ğŸµ ${i.toUpperCase()} ${e.toUpperCase()}: ${t?"ON":"OFF"}`),window.audioReactivitySettings||(window.audioReactivitySettings={sensitivity:{low:.3,medium:1,high:2},visualModes:{color:["hue","saturation","intensity"],geometry:["morphFactor","gridDensity","chaos"],movement:["speed","rot4dXW","rot4dYW","rot4dZW"]},activeSensitivity:"medium",activeVisualModes:new Set(["color"])});const o=window.audioReactivitySettings,a=`${i}-${e}`;t?(o.activeVisualModes.add(a),o.activeSensitivity=i,console.log(`  ğŸµ Activated: ${i} sensitivity with ${e} visual changes`),console.log(`  ğŸ“Š Sensitivity multiplier: ${o.sensitivity[i]}x`),console.log("  ğŸ¨ Visual parameters:",o.visualModes[e])):(o.activeVisualModes.delete(a),console.log(`  ğŸµ Deactivated: ${i} ${e}`)),window.holographicSystem&&window.holographicSystem.audioEnabled&&(window.holographicSystem.audioReactivitySettings=o,console.log("  âœ¨ Updated holographic system audio settings")),window.quantumEngine&&window.quantumEngine.audioEnabled&&(window.quantumEngine.audioReactivitySettings=o,console.log("  ğŸŒŒ Updated quantum engine audio settings")),kt()};window.toggleAudioCell=function(i){const e=document.getElementById(i);if(e){e.checked=!e.checked;const t=i.replace(/Color|Geometry|Movement/,"").toLowerCase();let o="";i.includes("Color")?o="color":i.includes("Geometry")?o="geometry":i.includes("Movement")&&(o="movement"),toggleAudioReactivity(t,o,e.checked)}};function Ft(){let i=document.getElementById("reactivity-status-overlay");i||(i=document.createElement("div"),i.id="reactivity-status-overlay",i.style.cssText=`
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ffff;
            padding: 15px;
            border-radius: 10px;
            color: #fff;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            z-index: 2000;
            backdrop-filter: blur(10px);
            animation: fadeInOut 3s ease;
        `,document.body.appendChild(i)),i.innerHTML=`
        <div style="color: #00ffff; font-weight: bold; margin-bottom: 10px;">
            ğŸ›ï¸ REACTIVITY STATUS
        </div>
        <div>ğŸµ Audio: ${$t?'<span style="color: #00ff00">ON</span>':'<span style="color: #ff4444">OFF</span>'}</div>
        <div>ğŸ–±ï¸ Interactions: ${_?'<span style="color: #00ff00">ON</span>':'<span style="color: #ff4444">OFF</span>'}</div>
    `,setTimeout(()=>{i&&i.parentNode&&i.parentNode.removeChild(i)},3e3)}function kt(){const i=window.audioReactivitySettings;if(!i)return;let e=document.getElementById("audio-reactivity-overlay");e||(e=document.createElement("div"),e.id="audio-reactivity-overlay",e.style.cssText=`
            position: fixed;
            top: 60px;
            left: 20px;
            background: rgba(40, 0, 40, 0.9);
            border: 2px solid #ff64ff;
            padding: 15px;
            border-radius: 10px;
            color: #fff;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            z-index: 2000;
            backdrop-filter: blur(10px);
            animation: fadeInOut 4s ease;
            max-width: 300px;
        `,document.body.appendChild(e));const t=Array.from(i.activeVisualModes),o=t.length>0?t.map(a=>a.replace("-"," ")).join(", "):"None active";e.innerHTML=`
        <div style="color: #ff64ff; font-weight: bold; margin-bottom: 10px;">
            ğŸµ AUDIO REACTIVITY STATUS
        </div>
        <div>ğŸ”Š Sensitivity: <span style="color: #ff64ff">${i.activeSensitivity.toUpperCase()}</span></div>
        <div>ğŸ¨ Active Modes: <span style="color: #ff64ff">${o}</span></div>
        <div>ğŸ“Š Multiplier: <span style="color: #ff64ff">${i.sensitivity[i.activeSensitivity]}x</span></div>
    `,setTimeout(()=>{e&&e.parentNode&&e.parentNode.removeChild(e)},4e3)}document.addEventListener("keydown",i=>{(i.key==="i"||i.key==="I")&&window.toggleInteractivity()});window.addEventListener("message",i=>{if(i.data&&i.data.type){if(i.data.type==="mouseMove"){const e=t=>{t&&t.visualizers&&t.visualizers.forEach(o=>{o&&(o.mouseX=i.data.x,o.mouseY=i.data.y,o.mouseIntensity=i.data.intensity||.5)})};window.currentSystem==="faceted"&&window.engine?e(window.engine):window.currentSystem==="quantum"&&window.quantumEngine?e(window.quantumEngine):window.currentSystem==="holographic"&&window.holographicSystem&&e(window.holographicSystem)}else if(i.data.type==="mouseClick"){const e=t=>{t&&t.visualizers&&t.visualizers.forEach(o=>{o&&(o.clickIntensity=i.data.intensity||1)})};window.currentSystem==="faceted"&&window.engine?e(window.engine):window.currentSystem==="quantum"&&window.quantumEngine?e(window.quantumEngine):window.currentSystem==="holographic"&&window.holographicSystem&&e(window.holographicSystem)}}});window.setupGeometry=function(i){var o,a;const e=document.getElementById("geometryGrid");if(!e)return;const t=((o=window.geometries)==null?void 0:o[i])||((a=window.geometries)==null?void 0:a.faceted)||["TETRAHEDRON","HYPERCUBE","SPHERE","TORUS","KLEIN BOTTLE","FRACTAL","WAVE","CRYSTAL"];e.innerHTML=t.map((r,s)=>`<button class="geom-btn ${s===0?"active":""}" 
                 data-index="${s}" onclick="selectGeometry(${s})">
            ${r}
        </button>`).join("")};window.toggleMobilePanel=function(){const i=document.getElementById("controlPanel"),e=document.querySelector(".mobile-collapse-btn");i&&e&&(i.classList.toggle("collapsed"),e.textContent=i.classList.contains("collapsed")?"â–²":"â–¼",console.log("ğŸ“± Mobile panel toggled"))};console.log("ğŸ›ï¸ UI Handlers Module: Loaded");const Wt="modulepreload",zt=function(i,e){return new URL(i,e).href},Ie={},x=function(e,t,o){let a=Promise.resolve();if(t&&t.length>0){const s=document.getElementsByTagName("link"),n=document.querySelector("meta[property=csp-nonce]"),l=(n==null?void 0:n.nonce)||(n==null?void 0:n.getAttribute("nonce"));a=Promise.allSettled(t.map(c=>{if(c=zt(c,o),c in Ie)return;Ie[c]=!0;const d=c.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(!!o)for(let h=s.length-1;h>=0;h--){const y=s[h];if(y.href===c&&(!d||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":Wt,d||(f.as="script"),f.crossOrigin="",f.href=c,l&&f.setAttribute("nonce",l),document.head.appendChild(f),d)return new Promise((h,y)=>{f.addEventListener("load",h),f.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(s){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=s,window.dispatchEvent(n),!n.defaultPrevented)throw s}return a.then(s=>{for(const n of s||[])n.status==="rejected"&&r(n.reason);return e().catch(r)})};let ue=null;const ve=()=>{window.vib34dPreservedFunctions||(window.vib34dPreservedFunctions={switchSystem:window.switchSystem,updateParameter:window.updateParameter,currentSystem:window.currentSystem,reactivityManager:window.reactivityManager,engine:window.engine,userParameterState:window.userParameterState,selectGeometry:window.selectGeometry,quantumEngine:window.quantumEngine,holographicSystem:window.holographicSystem,polychoraSystem:window.polychoraSystem},console.log("ğŸ›¡ï¸ Critical VIB34D functions preserved"))},we=()=>{if(window.vib34dPreservedFunctions){let i=0;Object.entries(window.vib34dPreservedFunctions).forEach(([e,t])=>{!window[e]&&t&&(window[e]=t,i++,console.log(`ğŸ”§ Restored ${e}`))}),i>0&&console.log(`ğŸ›¡ï¸ Restored ${i} critical functions`)}};window.saveToGallery=async function(){console.log("ğŸ”µ Save to Gallery button clicked"),ve();try{if(!!!(window.engine||window.quantumEngine||window.holographicSystem))throw new Error("No engine system initialized yet - please wait a moment");if(console.log("ğŸ” Engine check passed:",{faceted:!!window.engine,quantum:!!window.quantumEngine,holographic:!!window.holographicSystem,currentSystem:window.currentSystem}),!ue){console.log("ğŸ”§ Initializing UnifiedSaveManager...");const{UnifiedSaveManager:t}=await x(async()=>{const{UnifiedSaveManager:a}=await Promise.resolve().then(()=>ri);return{UnifiedSaveManager:a}},void 0,import.meta.url);let o=null;window.currentSystem==="faceted"&&window.engine?o=window.engine:window.currentSystem==="quantum"&&window.quantumEngine?o=window.quantumEngine:window.currentSystem==="holographic"&&window.holographicSystem&&(o=window.holographicSystem),console.log("ğŸ”§ Initializing UnifiedSaveManager with engine for:",window.currentSystem,!!o),ue=new t(o)}window.currentSystem||(window.currentSystem="faceted",console.log("ğŸ”§ Fixed window.currentSystem:",window.currentSystem)),console.log("ğŸ”µ Starting save process...");const e=await ue.save({target:"gallery"});if(console.log("ğŸ”µ Save result:",e),e&&e.success){console.log("âœ… Saved to gallery:",e.id),Gt("Variation saved to gallery!",e.id);const t=new CustomEvent("gallery-refresh-needed");window.dispatchEvent(t);try{window.galleryWindow&&!window.galleryWindow.closed&&(window.galleryWindow.postMessage({type:"vib34d-variation-saved",variationId:e.id,timestamp:Date.now()},"*"),console.log("ğŸ“¤ Sent gallery update message to gallery window"))}catch{console.log("ğŸ“¤ No gallery window to notify")}localStorage.setItem("vib34d-gallery-update-trigger",Date.now().toString())}else throw new Error((e==null?void 0:e.error)||"Save failed - no result returned")}catch(i){console.error("âŒ Failed to save to gallery:",i),Ot(i.message||"Gallery save failed")}finally{setTimeout(we,100)}};window.createTradingCard=async function(i="classic"){var e,t,o;console.log(`ğŸ´ Creating ${i} trading card for ${window.currentSystem} system...`),ve();try{const{TradingCardManager:a}=await x(async()=>{const{TradingCardManager:n}=await Promise.resolve().then(()=>si);return{TradingCardManager:n}},void 0,import.meta.url),r={system:window.currentSystem||"faceted",geometry:Bt(),rot4dXY:parseFloat(((e=document.getElementById("rot4dXY"))==null?void 0:e.value)||0),rot4dXZ:parseFloat(((t=document.getElementById("rot4dXZ"))==null?void 0:t.value)||0),rot4dYZ:parseFloat(((o=document.getElementById("rot4dYZ"))==null?void 0:o.value)||0),rot4dXW:parseFloat(document.getElementById("rot4dXW").value),rot4dYW:parseFloat(document.getElementById("rot4dYW").value),rot4dZW:parseFloat(document.getElementById("rot4dZW").value),gridDensity:parseFloat(document.getElementById("gridDensity").value),morphFactor:parseFloat(document.getElementById("morphFactor").value),chaos:parseFloat(document.getElementById("chaos").value),speed:parseFloat(document.getElementById("speed").value),hue:parseFloat(document.getElementById("hue").value),intensity:parseFloat(document.getElementById("intensity").value),saturation:parseFloat(document.getElementById("saturation").value)},s=await a.createCard(window.currentSystem||"faceted",i,r);if(s.success){console.log(`âœ… ${s.system} trading card created: ${s.filename}`);const n=document.createElement("div");n.style.cssText=`
                position: fixed;
                top: 70px;
                right: 20px;
                background: rgba(0, 255, 0, 0.9);
                color: black;
                padding: 15px 20px;
                border-radius: 10px;
                font-family: 'Orbitron', monospace;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `,n.innerHTML=`
                ğŸ´ ${s.system.toUpperCase()} Trading Card Created!<br>
                <small style="opacity: 0.8;">${s.filename}</small>
            `,document.body.appendChild(n),setTimeout(()=>n.remove(),4e3)}else throw new Error(s.error||"Trading card generation failed")}catch(a){console.error("âŒ Failed to create trading card:",a);const r=document.createElement("div");r.style.cssText=`
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-family: 'Orbitron', monospace;
            z-index: 10000;
        `,r.innerHTML=`âŒ Trading Card Failed: ${a.message}`,document.body.appendChild(r),setTimeout(()=>r.remove(),3e3)}finally{setTimeout(we,100)}};window.showLLMInterface=async function(){console.log("ğŸ¤– Opening AI parameter interface"),ve();try{const{LLMParameterInterface:i}=await x(async()=>{const{LLMParameterInterface:t}=await Promise.resolve().then(()=>li);return{LLMParameterInterface:t}},void 0,import.meta.url),{LLMParameterUI:e}=await x(async()=>{const{LLMParameterUI:t}=await Promise.resolve().then(()=>di);return{LLMParameterUI:t}},void 0,import.meta.url);window.llmInterface||(window.llmInterface=new i,window.llmUI=new e(window.llmInterface),window.llmInterface.setParameterCallback(t=>{console.log("ğŸ¤– Applying AI-generated parameters:",t);let o=window.currentSystem||"faceted";t.chaos>.7&&t.speed>2?o="quantum":t.intensity>.8&&t.saturation>.8?o="holographic":t.chaos<.3&&t.gridDensity>60&&(o="faceted"),o!==window.currentSystem&&(console.log(`ğŸ¯ AI switching from ${window.currentSystem} to ${o} for optimal visual effect`),window.switchSystem&&window.switchSystem(o)),Object.entries(t).forEach(([a,r],s)=>{setTimeout(()=>{window.updateParameter?(console.log(`ğŸ¤– Applying ${a} = ${r} to ${o} system`),window.updateParameter(a,r)):console.error("âŒ window.updateParameter not available")},s*50)})})),window.llmUI.show()}catch(i){console.error("âŒ Error loading LLM interface:",i),alert("Error loading AI parameter interface. Please check console for details.")}finally{setTimeout(we,100)}};function Bt(){const i=document.querySelector(".geom-btn.active");return i&&parseInt(i.dataset.index)||0}function Gt(i,e){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 70px;
        left: 20px;
        background: rgba(0, 255, 255, 0.9);
        color: black;
        padding: 15px 20px;
        border-radius: 10px;
        font-family: 'Orbitron', monospace;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `,t.innerHTML=`
        âœ… ${i}<br>
        <small style="opacity: 0.8;">ID: ${e}</small>
    `,document.body.appendChild(t),setTimeout(()=>t.remove(),4e3)}function Ot(i){const e=document.createElement("div");e.style.cssText=`
        position: fixed;
        top: 70px;
        left: 20px;
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-family: 'Orbitron', monospace;
        z-index: 10000;
    `,e.innerHTML=`âŒ Save Error: ${i}`,document.body.appendChild(e),setTimeout(()=>e.remove(),3e3)}function De(){const i=localStorage.getItem("vib34d-load-params");if(i)try{const e=JSON.parse(i);console.log("ğŸ”— Received parameters from gallery:",e),localStorage.removeItem("vib34d-load-params"),e.system&&e.system!==window.currentSystem?(window.switchSystem(e.system),setTimeout(()=>Le(e),20)):Le(e)}catch(e){console.error("âŒ Failed to parse gallery parameters:",e),localStorage.removeItem("vib34d-load-params")}}function Le(i){const{system:e,parameters:t,globalId:o}=i;console.log(`ğŸ¯ Loading ${e} variation #${o} from gallery`),e==="faceted"&&window.engine?Object.entries(t).forEach(([a,r])=>{if(a==="geometry"&&typeof r=="number")window.selectGeometry&&window.selectGeometry(r);else{const s=document.getElementById(a);s&&(s.value=r,window.updateParameter(a,r))}}):e==="holographic"&&window.holographicSystem&&Object.entries(t).forEach(([a,r])=>{const s=document.getElementById(a);s&&(s.value=r,window.updateParameter(a,r))})}window.baseHue=200;window.baseDensity=15;window.baseMorph=1;let Me=0,ie=null,he=null;function Yt(){if(!ie||!window.updateParameter||!window.moduleReady)return;const{mouseX:i,mouseY:e,intensity:t}=ie,o=(i-.5)*60,a=(e-.5)*10,r=t*.3;window.updateParameter("hue",(window.baseHue||200)+o),window.updateParameter("gridDensity",Math.max(5,(window.baseDensity||15)+a)),window.updateParameter("morphFactor",Math.max(0,Math.min(2,(window.baseMorph||1)+r))),window.updateParameter("intensity",Math.max(0,Math.min(1,t))),ie=null}window.addEventListener("message",i=>{if(i.data&&i.data.type==="mouseMove"){const e=performance.now();e-Me>16&&(ie={mouseX:i.data.x||.5,mouseY:i.data.y||.5,intensity:i.data.intensity||.5},he&&cancelAnimationFrame(he),he=requestAnimationFrame(Yt),Me=e)}});typeof window<"u"&&(setTimeout(De,100),window.addEventListener("storage",i=>{i.key==="vib34d-load-params"&&De()}));console.log("ğŸ–¼ï¸ Gallery Manager Module: Loaded");window.openGallery=function(){console.log("ğŸ–¼ï¸ Opening inline gallery modal...");let i=document.getElementById("gallery-modal");i||(i=Vt(),document.body.appendChild(i)),be(),i.style.display="flex",setTimeout(()=>{i.classList.add("visible")},10),document.body.style.overflow="hidden"};window.closeGallery=function(){const i=document.getElementById("gallery-modal");i&&(i.classList.remove("visible"),setTimeout(()=>{i.style.display="none",document.body.style.overflow=""},300))};function Vt(){const i=document.createElement("div");return i.id="gallery-modal",i.className="gallery-modal",i.innerHTML=`
        <div class="gallery-overlay" onclick="closeGallery()"></div>
        <div class="gallery-container">
            <!-- Gallery Header -->
            <div class="gallery-header">
                <div class="gallery-title">
                    <span class="gallery-icon">ğŸ–¼ï¸</span>
                    <span>VIB34D GALLERY</span>
                </div>
                <div class="gallery-stats" id="galleryStats">
                    Loading...
                </div>
                <button class="gallery-close-btn" onclick="closeGallery()">Ã—</button>
            </div>

            <!-- Gallery Filter/Sort -->
            <div class="gallery-controls">
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterGallery('all')">All</button>
                    <button class="filter-tab" onclick="filterGallery('faceted')">ğŸ”· Faceted</button>
                    <button class="filter-tab" onclick="filterGallery('quantum')">ğŸŒŒ Quantum</button>
                    <button class="filter-tab" onclick="filterGallery('holographic')">âœ¨ Holographic</button>
                    <button class="filter-tab" onclick="filterGallery('polychora')">ğŸ”® Polychora</button>
                </div>
                <select class="sort-select" onchange="sortGallery(this.value)">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="system">By System</option>
                </select>
            </div>

            <!-- Gallery Grid -->
            <div class="gallery-grid" id="galleryGrid">
                <!-- Gallery items loaded dynamically -->
            </div>

            <!-- Empty State -->
            <div class="gallery-empty" id="galleryEmpty" style="display: none;">
                <div class="empty-icon">ğŸ¨</div>
                <div class="empty-title">No Variations Saved</div>
                <div class="empty-text">
                    Create your first variation by clicking "ğŸ’¾ Save to Gallery" in the control panel
                </div>
            </div>
        </div>
    `,i}function be(){console.log("ğŸ“¦ Loading gallery items...");try{const i=[];for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(t.startsWith("vib34d-variation-"))try{const o=JSON.parse(localStorage.getItem(t));i.push({key:t,id:t.replace("vib34d-variation-",""),...o})}catch(o){console.warn(`Failed to parse ${t}:`,o)}}return console.log(`âœ… Loaded ${i.length} gallery items`),Ut(i),i.length===0?Ae():Qe(i),i}catch(i){return console.error("âŒ Failed to load gallery items:",i),Ae(),[]}}function Ut(i){const e=document.getElementById("galleryStats");if(!e)return;const t=i.reduce((a,r)=>{const s=r.system||"unknown";return a[s]=(a[s]||0)+1,a},{}),o=Object.entries(t).map(([a,r])=>`${{faceted:"ğŸ”·",quantum:"ğŸŒŒ",holographic:"âœ¨",polychora:"ğŸ”®"}[a]||""} ${r}`).join(" â€¢ ");e.innerHTML=`
        <span class="stat-total">${i.length} Variations</span>
        ${o?`<span class="stat-breakdown">${o}</span>`:""}
    `}function Qe(i){const e=document.getElementById("galleryGrid"),t=document.getElementById("galleryEmpty");e&&(e.style.display="grid",t&&(t.style.display="none"),i.sort((o,a)=>new Date(a.timestamp)-new Date(o.timestamp)),e.innerHTML=i.map(o=>qt(o)).join(""))}function qt(i){var n;const e={faceted:"ğŸ”·",quantum:"ğŸŒŒ",holographic:"âœ¨",polychora:"ğŸ”®"},t={faceted:"#00ffff",quantum:"#ff00ff",holographic:"#ff64ff",polychora:"#ffff00"},o=e[i.system]||"ğŸ¨",a=t[i.system]||"#00ffff",r=Ht(i.system,((n=i.parameters)==null?void 0:n.geometry)||0),s=new Date(i.timestamp).toLocaleDateString();return`
        <div class="gallery-card" data-id="${i.id}" data-system="${i.system}">
            <div class="card-preview" style="border-color: ${a};">
                <div class="preview-icon" style="color: ${a};">${o}</div>
                <div class="preview-info">
                    <div class="preview-system">${i.system.toUpperCase()}</div>
                    <div class="preview-geometry">${r}</div>
                </div>
            </div>
            <div class="card-info">
                <div class="card-title">${i.name||`Variation #${i.id}`}</div>
                <div class="card-meta">
                    <span class="card-date">${s}</span>
                    <span class="card-id">#${i.id}</span>
                </div>
            </div>
            <div class="card-actions">
                <button class="card-btn load-btn" onclick="loadGalleryVariation('${i.id}')" title="Load Variation">
                    â–¶ï¸ Load
                </button>
                <button class="card-btn delete-btn" onclick="deleteGalleryVariation('${i.id}')" title="Delete Variation">
                    ğŸ—‘ï¸
                </button>
            </div>
        </div>
    `}function Ht(i,e){const t={faceted:["Tetrahedron","Hypercube","Sphere","Torus","Klein Bottle","Fractal","Wave","Crystal","ğŸŒ€ Tetrahedron","ğŸŒ€ Hypercube","ğŸŒ€ Sphere","ğŸŒ€ Torus","ğŸŒ€ Klein","ğŸŒ€ Fractal","ğŸŒ€ Wave","ğŸŒ€ Crystal","ğŸ”º Tetrahedron","ğŸ”º Hypercube","ğŸ”º Sphere","ğŸ”º Torus","ğŸ”º Klein","ğŸ”º Fractal","ğŸ”º Wave","ğŸ”º Crystal"],quantum:["Tetrahedron","Hypercube","Sphere","Torus","Klein Bottle","Fractal","Wave","Crystal","ğŸŒ€ Tetrahedron","ğŸŒ€ Hypercube","ğŸŒ€ Sphere","ğŸŒ€ Torus","ğŸŒ€ Klein","ğŸŒ€ Fractal","ğŸŒ€ Wave","ğŸŒ€ Crystal","ğŸ”º Tetrahedron","ğŸ”º Hypercube","ğŸ”º Sphere","ğŸ”º Torus","ğŸ”º Klein","ğŸ”º Fractal","ğŸ”º Wave","ğŸ”º Crystal"],holographic:["Holographic"],polychora:["5-Cell","Tesseract","16-Cell","24-Cell","600-Cell","120-Cell"]};return(t[i]||t.faceted)[e]||`Geometry #${e}`}window.loadGalleryVariation=async function(i){console.log(`ğŸ“‚ Loading variation ${i}...`);try{const e=`vib34d-variation-${i}`,t=JSON.parse(localStorage.getItem(e));if(!t)throw new Error(`Variation ${i} not found`);console.log("âœ… Loaded variation:",t),closeGallery(),t.system&&t.system!==window.currentSystem&&(console.log(`ğŸ”„ Switching from ${window.currentSystem} to ${t.system}`),window.switchSystem&&(await window.switchSystem(t.system),await new Promise(o=>setTimeout(o,500)))),t.parameters&&Object.entries(t.parameters).forEach(([o,a])=>{if(o==="geometry"&&typeof a=="number")window.selectGeometry&&window.selectGeometry(a);else{const r=document.getElementById(o);r&&(r.value=a,window.updateParameter&&window.updateParameter(o,a))}}),se(`âœ… Loaded: ${t.name||`Variation #${i}`}`,"success")}catch(e){console.error("âŒ Failed to load variation:",e),se(`âŒ Failed to load variation: ${e.message}`,"error")}};window.deleteGalleryVariation=function(i){if(confirm(`Delete variation #${i}?`))try{const e=`vib34d-variation-${i}`;localStorage.removeItem(e),console.log(`ğŸ—‘ï¸ Deleted variation ${i}`),be(),se(`ğŸ—‘ï¸ Deleted variation #${i}`,"success")}catch(e){console.error("âŒ Failed to delete variation:",e),se(`âŒ Failed to delete: ${e.message}`,"error")}};window.filterGallery=function(i){console.log(`ğŸ” Filtering by: ${i}`),document.querySelectorAll(".filter-tab").forEach(t=>{t.classList.remove("active")}),event.target.classList.add("active"),document.querySelectorAll(".gallery-card").forEach(t=>{i==="all"||t.dataset.system===i?t.style.display="block":t.style.display="none"})};window.sortGallery=function(i){console.log(`ğŸ”¢ Sorting by: ${i}`);const e=be();i==="oldest"?e.sort((t,o)=>new Date(t.timestamp)-new Date(o.timestamp)):i==="system"?e.sort((t,o)=>t.system.localeCompare(o.system)):e.sort((t,o)=>new Date(o.timestamp)-new Date(t.timestamp)),Qe(e)};function Ae(){const i=document.getElementById("galleryGrid"),e=document.getElementById("galleryEmpty");i&&(i.style.display="none"),e&&(e.style.display="flex")}function se(i,e="info"){const t=document.createElement("div");t.className=`gallery-notification ${e}`,t.textContent=i,t.style.cssText=`
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${e==="success"?"rgba(0, 255, 0, 0.9)":"rgba(255, 0, 0, 0.9)"};
        color: ${e==="success"?"black":"white"};
        padding: 15px 20px;
        border-radius: 8px;
        font-family: 'Orbitron', monospace;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}document.addEventListener("keydown",i=>{if(i.key==="Escape"){const e=document.getElementById("gallery-modal");e&&e.style.display!=="none"&&closeGallery()}});console.log("ğŸ–¼ï¸ Gallery Modal Module: Loaded");let Je="controls",R=!1;window.switchBezelTab=function(i){console.log(`ğŸ”„ Switching to tab: ${i}`),Je=i,document.querySelectorAll(".bezel-tab").forEach(e=>{e.dataset.tab===i?e.classList.add("active"):e.classList.remove("active")}),document.querySelectorAll(".bezel-content").forEach(e=>{e.id===`${i}-content`?e.classList.add("active"):e.classList.remove("active")}),R&&toggleBezelCollapse()};window.toggleBezelCollapse=function(){const i=document.getElementById("controlPanel"),e=document.querySelector(".bezel-collapse-btn");i&&(R=!R,i.classList.toggle("collapsed"),e&&(e.innerHTML=R?"â–²":"â–¼",e.title=R?"Expand Controls":"Collapse Controls"),console.log(`ğŸ›ï¸ Bezel ${R?"collapsed":"expanded"}`),et())};function et(){const i=document.getElementById("canvasContainer");i&&(R?i.style.bottom="52px":i.style.bottom="65vh")}window.quickRandomize=function(){window.randomizeAll&&window.randomizeAll()};window.quickSave=function(){window.saveToGallery&&window.saveToGallery()};window.quickGallery=function(){window.openGallery&&window.openGallery()};document.addEventListener("keydown",i=>{if((i.ctrlKey||i.metaKey)&&i.key==="b"&&(i.preventDefault(),toggleBezelCollapse()),(i.ctrlKey||i.metaKey)&&i.key>="1"&&i.key<="5"){i.preventDefault();const e=["controls","color","geometry","reactivity","export"],t=parseInt(i.key)-1;e[t]&&switchBezelTab(e[t])}i.code==="Space"&&i.target.tagName!=="INPUT"&&i.target.tagName!=="TEXTAREA"&&(i.preventDefault(),toggleBezelCollapse())});let _e;const Xt=8e3;function ce(){clearTimeout(_e),window.innerWidth<=768&&!R&&(_e=setTimeout(()=>{console.log("ğŸ“± Auto-collapsing bezel due to inactivity"),toggleBezelCollapse()},Xt))}document.addEventListener("mousemove",ce);document.addEventListener("touchstart",ce);document.addEventListener("keypress",ce);window.addEventListener("resize",()=>{et(),ce()});window.addEventListener("DOMContentLoaded",()=>{switchBezelTab("controls"),window.innerWidth<=768&&setTimeout(()=>{toggleBezelCollapse()},2e3),console.log("ğŸ›ï¸ Bezel Tab System: Initialized"),console.log("âŒ¨ï¸ Keyboard Shortcuts:"),console.log("  - Ctrl/Cmd + B: Toggle collapse"),console.log("  - Ctrl/Cmd + 1-5: Switch tabs"),console.log("  - Space: Toggle collapse")});function Nt(){localStorage.setItem("vib34d-active-tab",Je),localStorage.setItem("vib34d-bezel-collapsed",R)}function Zt(){const i=localStorage.getItem("vib34d-active-tab"),e=localStorage.getItem("vib34d-bezel-collapsed");i&&switchBezelTab(i),e==="true"&&!R&&toggleBezelCollapse()}window.addEventListener("beforeunload",Nt);setTimeout(Zt,500);console.log("ğŸ›ï¸ Bezel Tabs Module: Loaded");let $=0,W=0,V=0;const U={base:{index:0,name:"Base",icon:"ğŸ”·",color:"#00ffff",range:"0-7"},hypersphere:{index:1,name:"Hypersphere",icon:"ğŸŒ€",color:"#ff00ff",range:"8-15"},hypertetra:{index:2,name:"Hypertetra",icon:"ğŸ”º",color:"#ff8800",range:"16-23"}},N=[{name:"Tetrahedron",icon:"ğŸ”º"},{name:"Hypercube",icon:"ğŸŸ¦"},{name:"Sphere",icon:"ğŸ”®"},{name:"Torus",icon:"ğŸ©"},{name:"Klein Bottle",icon:"ğŸ«™"},{name:"Fractal",icon:"â„ï¸"},{name:"Wave",icon:"ğŸŒŠ"},{name:"Crystal",icon:"ğŸ’"}];window.initGeometryTabs=function(){console.log("ğŸ¨ Initializing Geometry Tab System..."),jt(),Kt(),switchCoreType("base"),selectGeometryButton(0),console.log("âœ… Geometry Tab System initialized"),console.log("ğŸ“ 24 geometries available: 8 base Ã— 3 core types")};function jt(){const i=document.getElementById("coreTabsContainer");if(!i){console.warn("âš ï¸ Core tabs container not found");return}i.className="core-tabs",i.innerHTML=Object.entries(U).map(([e,t])=>`
        <button
            class="core-tab"
            data-core="${e}"
            onclick="switchCoreType('${e}')"
            title="${t.name} Core (Geometries ${t.range})"
        >
            <div class="core-tab-icon">${t.icon}</div>
            <div class="core-tab-name">${t.name}</div>
            <div class="core-tab-range">${t.range}</div>
        </button>
    `).join("")}function Kt(){const i=document.getElementById("geometryGrid");if(!i){console.warn("âš ï¸ Geometry grid container not found");return}i.className="geometry-grid",i.innerHTML=N.map((e,t)=>`
        <button
            class="geom-btn"
            data-base-index="${t}"
            onclick="selectGeometryButton(${t})"
            title="${e.name}"
        >
            <div class="geom-icon">${e.icon}</div>
            <div class="geom-name">${e.name}</div>
        </button>
    `).join("")}window.switchCoreType=function(i){console.log(`ğŸ”„ Switching core type to: ${i}`);const e=U[i];if(!e){console.error(`âŒ Unknown core type: ${i}`);return}$=e.index,document.querySelectorAll(".core-tab").forEach(o=>{o.dataset.core===i?o.classList.add("active"):o.classList.remove("active")});const t=document.querySelector(".geometry-container");t&&(t.dataset.activeCore=i),tt(),console.log(`âœ… Core type: ${e.name} (index ${$})`),console.log(`ğŸ“ Geometry range: ${e.range}`)};window.selectGeometryButton=function(i){if(i<0||i>7){console.error(`âŒ Invalid base index: ${i} (must be 0-7)`);return}console.log(`ğŸ¯ Selected base geometry: ${N[i].name} (index ${i})`),W=i,document.querySelectorAll(".geom-btn").forEach(e=>{parseInt(e.dataset.baseIndex)===i?e.classList.add("active"):e.classList.remove("active")}),tt()};function tt(){var t,o;V=$*8+W;const i=(t=Object.values(U).find(a=>a.index===$))==null?void 0:t.name,e=(o=N[W])==null?void 0:o.name;console.log(`ğŸ§® Calculated geometry index: ${V}`),console.log(`   = ${i} (${$}) Ã— 8 + ${e} (${W})`),console.log(`   = ${$*8} + ${W} = ${V}`),window.selectGeometry?(window.selectGeometry(V),console.log(`âœ… Applied geometry ${V} to engine`)):console.warn("âš ï¸ window.selectGeometry() not available yet"),Qt()}function Qt(){var a,r;const i=(a=Object.values(U).find(s=>s.index===$))==null?void 0:a.name,e=(r=N[W])==null?void 0:r.name,t=$===0?e:`${e} + ${i} Core`;document.querySelectorAll("[data-geometry-display]").forEach(s=>{s.textContent=t,s.dataset.geometryIndex=V})}window.loadGeometryFromIndex=function(i){var a;if(i<0||i>23){console.error(`âŒ Invalid geometry index: ${i} (must be 0-23)`);return}console.log(`ğŸ“‚ Loading geometry from index: ${i}`);const e=Math.floor(i/8),t=i%8;console.log(`   Decoded: core=${e}, base=${t}`);const o=(a=Object.entries(U).find(([r,s])=>s.index===e))==null?void 0:a[0];if(!o){console.error(`âŒ Failed to decode core index: ${e}`);return}switchCoreType(o),selectGeometryButton(t),console.log(`âœ… Loaded geometry ${i}: ${N[t].name} + ${U[o].name}`)};window.getGeometryInfo=function(){var t,o;const i=(t=Object.values(U).find(a=>a.index===$))==null?void 0:t.name,e=(o=N[W])==null?void 0:o.name;return{index:V,coreIndex:$,baseIndex:W,coreName:i,baseName:e,fullName:$===0?e:`${e} + ${i} Core`}};document.addEventListener("keydown",i=>{if(i.altKey&&i.key>="1"&&i.key<="3"){i.preventDefault();const t=["base","hypersphere","hypertetra"][parseInt(i.key)-1];t&&switchCoreType(t)}if(i.altKey){const t={q:0,w:1,e:2,r:3,a:4,s:5,d:6,f:7}[i.key.toLowerCase()];t!==void 0&&(i.preventDefault(),selectGeometryButton(t))}});window.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{typeof initGeometryTabs=="function"&&initGeometryTabs()},100)});console.log("ğŸ“ Geometry Tabs Module: Loaded");console.log("âŒ¨ï¸ Keyboard Shortcuts:");console.log("  - Alt + 1-3: Switch core types");console.log("  - Alt + Q,W,E,R,A,S,D,F: Select geometries 0-7");class Jt{constructor(){this.isEnabled=!1,this.isSupported=!1,this.sensitivity=1,this.smoothing=.1,this.dramaticMode=!1,this.currentTilt={alpha:0,beta:0,gamma:0},this.tiltIntensity=0,this.extremeTilt=!1,this.smoothedRotation={rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0},this.baseRotation={rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0},this.mapping={normal:{alphaGammaToXY:{scale:.006,range:[-180,180],clamp:[-3.14,3.14]},alphaBetaToXZ:{scale:.008,range:[-90,90],clamp:[-1.57,1.57]},betaGammaToYZ:{scale:.008,range:[-90,90],clamp:[-1.57,1.57]},betaToXW:{scale:.01,range:[-45,45],clamp:[-1.5,1.5]},gammaToYW:{scale:.015,range:[-30,30],clamp:[-1.5,1.5]},alphaToZW:{scale:.008,range:[-180,180],clamp:[-2,2]}},dramatic:{alphaGammaToXY:{scale:.048,range:[-180,180],clamp:[-6.28,6.28]},alphaBetaToXZ:{scale:.064,range:[-120,120],clamp:[-6.28,6.28]},betaGammaToYZ:{scale:.064,range:[-120,120],clamp:[-6.28,6.28]},betaToXW:{scale:.08,range:[-120,120],clamp:[-6,6]},gammaToYW:{scale:.12,range:[-120,120],clamp:[-6,6]},alphaToZW:{scale:.064,range:[-180,180],clamp:[-6,6]}}},this.boundHandleDeviceOrientation=this.handleDeviceOrientation.bind(this)}checkSupport(){return this.isSupported="DeviceOrientationEvent"in window,this.isSupported?typeof DeviceOrientationEvent.requestPermission=="function"?(console.log("ğŸ¯ DEVICE TILT: iOS device detected - permission required"),"permission-required"):(console.log("ğŸ¯ DEVICE TILT: Supported and ready"),!0):(console.warn("ğŸ¯ DEVICE TILT: Not supported on this device/browser"),!1)}async requestPermission(){if(typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"?(console.log("ğŸ¯ DEVICE TILT: iOS permission granted"),!0):(console.warn("ğŸ¯ DEVICE TILT: iOS permission denied"),!1)}catch(e){return console.error("ğŸ¯ DEVICE TILT: Permission request failed:",e),!1}return!0}async enable(){return!this.checkSupport()||!await this.requestPermission()?!1:(window.userParameterState&&(this.baseRotation.rot4dXY=window.userParameterState.rot4dXY||0,this.baseRotation.rot4dXZ=window.userParameterState.rot4dXZ||0,this.baseRotation.rot4dYZ=window.userParameterState.rot4dYZ||0,this.baseRotation.rot4dXW=window.userParameterState.rot4dXW||0,this.baseRotation.rot4dYW=window.userParameterState.rot4dYW||0,this.baseRotation.rot4dZW=window.userParameterState.rot4dZW||0),this.smoothedRotation={...this.baseRotation},window.addEventListener("deviceorientation",this.boundHandleDeviceOrientation),this.isEnabled=!0,console.log("ğŸ¯ DEVICE TILT: Enabled - tilt your device to control 4D rotation!"),console.log("ğŸ¯ Base rotation values:",this.baseRotation),this.showTiltIndicator(!0),!0)}disable(){window.removeEventListener("deviceorientation",this.boundHandleDeviceOrientation),this.isEnabled=!1,window.updateParameter&&(window.updateParameter("rot4dXY",this.baseRotation.rot4dXY),window.updateParameter("rot4dXZ",this.baseRotation.rot4dXZ),window.updateParameter("rot4dYZ",this.baseRotation.rot4dYZ),window.updateParameter("rot4dXW",this.baseRotation.rot4dXW),window.updateParameter("rot4dYW",this.baseRotation.rot4dYW),window.updateParameter("rot4dZW",this.baseRotation.rot4dZW)),console.log("ğŸ¯ DEVICE TILT: Disabled - reset to base rotation"),this.showTiltIndicator(!1)}handleDeviceOrientation(e){if(!this.isEnabled)return;const t=(e.alpha||0)*Math.PI/180,o=(e.beta||0)*Math.PI/180,a=(e.gamma||0)*Math.PI/180;this.currentTilt={alpha:t,beta:o,gamma:a};const r=this.mapToRotation(e);this.smoothedRotation.rot4dXY=this.lerp(this.smoothedRotation.rot4dXY,r.rot4dXY,this.smoothing),this.smoothedRotation.rot4dXZ=this.lerp(this.smoothedRotation.rot4dXZ,r.rot4dXZ,this.smoothing),this.smoothedRotation.rot4dYZ=this.lerp(this.smoothedRotation.rot4dYZ,r.rot4dYZ,this.smoothing),this.smoothedRotation.rot4dXW=this.lerp(this.smoothedRotation.rot4dXW,r.rot4dXW,this.smoothing),this.smoothedRotation.rot4dYW=this.lerp(this.smoothedRotation.rot4dYW,r.rot4dYW,this.smoothing),this.smoothedRotation.rot4dZW=this.lerp(this.smoothedRotation.rot4dZW,r.rot4dZW,this.smoothing),window.updateParameter&&(window.updateParameter("rot4dXY",this.smoothedRotation.rot4dXY),window.updateParameter("rot4dXZ",this.smoothedRotation.rot4dXZ),window.updateParameter("rot4dYZ",this.smoothedRotation.rot4dYZ),window.updateParameter("rot4dXW",this.smoothedRotation.rot4dXW),window.updateParameter("rot4dYW",this.smoothedRotation.rot4dYW),window.updateParameter("rot4dZW",this.smoothedRotation.rot4dZW)),this.updateTiltDisplay()}mapToRotation(e){const t=e.beta||0,o=e.gamma||0,a=e.alpha||0,r=this.dramaticMode?this.mapping.dramatic:this.mapping.normal,s=Math.max(-120,Math.min(120,t)),n=Math.max(-120,Math.min(120,o));this.tiltIntensity=Math.sqrt(s*s+n*n)/90,this.extremeTilt=this.tiltIntensity>1;let l=a;l>180&&(l-=360);const c=Math.max(r.alphaGammaToXY.range[0],Math.min(r.alphaGammaToXY.range[1],l)),d=this.baseRotation.rot4dXY+c*r.alphaGammaToXY.scale*this.sensitivity,u=Math.max(r.alphaBetaToXZ.range[0],Math.min(r.alphaBetaToXZ.range[1],t)),m=this.baseRotation.rot4dXZ+u*r.alphaBetaToXZ.scale*this.sensitivity,f=Math.max(r.betaGammaToYZ.range[0],Math.min(r.betaGammaToYZ.range[1],o)),h=this.baseRotation.rot4dYZ+f*r.betaGammaToYZ.scale*this.sensitivity,y=Math.max(r.betaToXW.range[0],Math.min(r.betaToXW.range[1],t)),w=this.baseRotation.rot4dXW+y*r.betaToXW.scale*this.sensitivity,T=Math.max(r.gammaToYW.range[0],Math.min(r.gammaToYW.range[1],o)),C=this.baseRotation.rot4dYW+T*r.gammaToYW.scale*this.sensitivity,b=Math.max(r.alphaToZW.range[0],Math.min(r.alphaToZW.range[1],l)),F=this.baseRotation.rot4dZW+b*r.alphaToZW.scale*this.sensitivity;return{rot4dXY:Math.max(r.alphaGammaToXY.clamp[0],Math.min(r.alphaGammaToXY.clamp[1],d)),rot4dXZ:Math.max(r.alphaBetaToXZ.clamp[0],Math.min(r.alphaBetaToXZ.clamp[1],m)),rot4dYZ:Math.max(r.betaGammaToYZ.clamp[0],Math.min(r.betaGammaToYZ.clamp[1],h)),rot4dXW:Math.max(r.betaToXW.clamp[0],Math.min(r.betaToXW.clamp[1],w)),rot4dYW:Math.max(r.gammaToYW.clamp[0],Math.min(r.gammaToYW.clamp[1],C)),rot4dZW:Math.max(r.alphaToZW.clamp[0],Math.min(r.alphaToZW.clamp[1],F))}}lerp(e,t,o){return e+(t-e)*o}updateBaseRotation(e,t,o,a,r,s){this.baseRotation.rot4dXY=e||0,this.baseRotation.rot4dXZ=t||0,this.baseRotation.rot4dYZ=o||0,this.baseRotation.rot4dXW=a||0,this.baseRotation.rot4dYW=r||0,this.baseRotation.rot4dZW=s||0,console.log("ğŸ¯ DEVICE TILT: Base rotation updated (all 6 rotations):",this.baseRotation)}setSensitivity(e){this.sensitivity=Math.max(.1,Math.min(3,e)),console.log(`ğŸ¯ DEVICE TILT: Sensitivity set to ${this.sensitivity}`)}setSmoothing(e){this.smoothing=Math.max(.01,Math.min(1,e)),console.log(`ğŸ¯ DEVICE TILT: Smoothing set to ${this.smoothing}`)}setDramaticMode(e){this.dramaticMode=e,console.log(`ğŸš€ DEVICE TILT: Dramatic mode ${e?"ENABLED - 8x more sensitive!":"disabled - normal sensitivity"}`),this.updateTiltModeDisplay(),e&&this.isEnabled&&console.log("âš ï¸ DRAMATIC TILTING ACTIVE: Tilt your device carefully - effects are 8x more intense!")}toggleDramaticMode(){return this.setDramaticMode(!this.dramaticMode),this.dramaticMode}showTiltIndicator(e){let t=document.getElementById("tilt-indicator");e&&!t?(t=document.createElement("div"),t.id="tilt-indicator",t.innerHTML=`
                <div class="tilt-status">
                    <div class="tilt-icon">ğŸ“±</div>
                    <div class="tilt-text">6D Tilt Active</div>
                    <div class="tilt-mode" id="tilt-mode">NORMAL MODE</div>
                    <div class="tilt-values">
                        <div style="color: #0ff; font-weight: bold; margin-top: 4px;">3D Space:</div>
                        <span id="tilt-xy">XY: 0.00</span>
                        <span id="tilt-xz">XZ: 0.00</span>
                        <span id="tilt-yz">YZ: 0.00</span>
                        <div style="color: #0ff; font-weight: bold; margin-top: 4px;">4D Hyperspace:</div>
                        <span id="tilt-xw">XW: 0.00</span>
                        <span id="tilt-yw">YW: 0.00</span>
                        <span id="tilt-zw">ZW: 0.00</span>
                        <span id="tilt-intensity" style="margin-top: 4px;">Intensity: 0.00</span>
                    </div>
                </div>
            `,t.style.cssText=`
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: #0ff;
                padding: 8px 12px;
                border-radius: 8px;
                font-family: 'Orbitron', monospace;
                font-size: 11px;
                z-index: 10000;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(0, 255, 255, 0.3);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            `,document.body.appendChild(t)):!e&&t&&t.remove()}updateTiltDisplay(){const e=document.getElementById("tilt-xy"),t=document.getElementById("tilt-xz"),o=document.getElementById("tilt-yz"),a=document.getElementById("tilt-xw"),r=document.getElementById("tilt-yw"),s=document.getElementById("tilt-zw"),n=document.getElementById("tilt-intensity");e&&(e.textContent=`XY: ${this.smoothedRotation.rot4dXY.toFixed(2)}`),t&&(t.textContent=`XZ: ${this.smoothedRotation.rot4dXZ.toFixed(2)}`),o&&(o.textContent=`YZ: ${this.smoothedRotation.rot4dYZ.toFixed(2)}`),a&&(a.textContent=`XW: ${this.smoothedRotation.rot4dXW.toFixed(2)}`),r&&(r.textContent=`YW: ${this.smoothedRotation.rot4dYW.toFixed(2)}`),s&&(s.textContent=`ZW: ${this.smoothedRotation.rot4dZW.toFixed(2)}`),n&&(n.textContent=`Intensity: ${this.tiltIntensity.toFixed(2)}`,n.style.color=this.extremeTilt?"#ff4444":"#0ff")}updateTiltModeDisplay(){const e=document.getElementById("tilt-mode");e&&(e.textContent=this.dramaticMode?"ğŸš€ DRAMATIC MODE":"NORMAL MODE",e.style.color=this.dramaticMode?"#ff4444":"#0ff",e.style.fontWeight=this.dramaticMode?"bold":"normal")}getStatus(){return{isSupported:this.isSupported,isEnabled:this.isEnabled,sensitivity:this.sensitivity,smoothing:this.smoothing,currentTilt:{...this.currentTilt},smoothedRotation:{...this.smoothedRotation},baseRotation:{...this.baseRotation}}}}typeof window<"u"&&(window.deviceTiltHandler=new Jt,window.enableDeviceTilt=async()=>await window.deviceTiltHandler.enable(),window.disableDeviceTilt=()=>{window.deviceTiltHandler.disable()},window.toggleDeviceTilt=async()=>{const i=document.getElementById("tiltBtn");if(window.deviceTiltHandler.isEnabled)return window.deviceTiltHandler.disable(),i&&(i.style.background="",i.style.color="",i.title="Device Tilt (4D Rotation)"),console.log("ğŸ¯ Device tilt disabled"),!1;if(await window.deviceTiltHandler.enable()){if(window.interactivityMenu&&window.interactivityMenu.engine&&(window.interactivityMenu.engine.setActiveInputMode("mouse/touch"),console.log("ğŸ¯ Forced interactivity to mouse/touch mode (matches tilt behavior)"),setTimeout(()=>{window.interactivityMenu.updateInputSources&&window.interactivityMenu.updateInputSources()},100)),window.interactivityEnabled!==void 0){window.interactivityEnabled=!0;const t=document.querySelector('[onclick="toggleInteractivity()"]');t&&(t.style.background="rgba(0, 255, 0, 0.3)",t.style.borderColor="#00ff00",t.title="Mouse/Touch Interactions: ON (Auto-enabled by tilt)")}return i&&(i.style.background="linear-gradient(45deg, #00ffff, #0099ff)",i.style.color="#000",i.title="Device Tilt Active + Mouse Movement Mode - Both work together!"),console.log("ğŸ¯ Device tilt enabled"),console.log("ğŸ–±ï¸ Interactivity forced to mouse movement mode (compatible with tilt)"),!0}else return console.warn("ğŸ¯ Device tilt failed to enable - permission may be required"),i&&(i.style.background="rgba(255, 0, 0, 0.3)",i.title="Device Tilt (Permission Required - Click to try again)"),!1},window.setTiltSensitivity=i=>{window.deviceTiltHandler.setSensitivity(i)},window.setDramaticTilting=i=>{window.deviceTiltHandler.setDramaticMode(i)},window.toggleDramaticTilting=()=>window.deviceTiltHandler.toggleDramaticMode(),window.toggleDeviceTiltDramatic=async()=>{if(window.deviceTiltHandler.isEnabled){const i=window.deviceTiltHandler.toggleDramaticMode(),e=document.getElementById("tiltBtn");return e&&(i?(e.style.background="linear-gradient(45deg, #ff4444, #ff0080)",e.title="ğŸš€ DRAMATIC 4D Tilt Active - 8x More Sensitive!"):(e.style.background="linear-gradient(45deg, #00ffff, #0099ff)",e.title="Device Tilt Active - Normal Sensitivity")),i}else{const i=await window.toggleDeviceTilt();if(i){window.deviceTiltHandler.setDramaticMode(!0),console.log("ğŸš€ DRAMATIC TILTING ENABLED: 8x more sensitive! Tilt carefully!");const e=document.getElementById("tiltBtn");e&&(e.style.background="linear-gradient(45deg, #ff4444, #ff0080)",e.title="ğŸš€ DRAMATIC 4D Tilt Active - 8x More Sensitive!")}return i}},console.log("ğŸ¯ DEVICE TILT: System loaded with DRAMATIC MODE support! ğŸš€"));let q=0;function eo(){console.log("ğŸ”§ Installing canvas resize fix...");const i=window.toggleBezelCollapse;window.toggleBezelCollapse=function(){i&&i(),setTimeout(()=>{ge()},100)};let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(ge,150)}),console.log("âœ… Canvas resize fix installed")}function ge(){const i=document.getElementById("canvasContainer");if(!i)return;const e=i.getBoundingClientRect(),t=e.width,o=e.height;console.log(`ğŸ“ Resizing canvases to ${t}x${o}px`),i.querySelectorAll("canvas").forEach(r=>{r.style.display!=="none"&&(r.width=t,r.height=o,r.style.width=`${t}px`,r.style.height=`${o}px`)}),window.vib34dApp&&window.vib34dApp.currentEngine&&(window.vib34dApp.currentEngine.handleResize&&window.vib34dApp.currentEngine.handleResize(t,o),window.vib34dApp.currentEngine.render&&window.vib34dApp.currentEngine.render())}function to(){console.log("ğŸ”§ Installing geometry persistence fix...");const i=window.selectGeometry;window.selectGeometry=function(t){if(q=t,console.log(`ğŸ’¾ Stored geometry selection: ${t}`),fe(t),i)return i(t)};const e=window.switchSystem;window.switchSystem=async function(t){console.log(`ğŸ”„ Switching to ${t}, will apply geometry ${q}`);const o=await e(t);return setTimeout(()=>{console.log(`ğŸ“ Applying persistent geometry ${q} to ${t}`),window.loadGeometryFromIndex?window.loadGeometryFromIndex(q):window.selectGeometry&&window.selectGeometry(q),fe(q)},300),o},console.log("âœ… Geometry persistence fix installed")}function fe(i){const e=Math.floor(i/8),t=i%8;console.log(`ğŸ¨ Highlighting button: core=${e}, base=${t}`),document.querySelectorAll(".core-tab").forEach(a=>{const r=a.dataset.core;({base:0,hypersphere:1,hypertetra:2})[r]===e?a.classList.add("active"):a.classList.remove("active")}),document.querySelectorAll(".geom-btn").forEach(a=>{parseInt(a.dataset.baseIndex)===t?a.classList.add("active"):a.classList.remove("active")});const o=document.querySelector(".geometry-container");if(o){const a=["base","hypersphere","hypertetra"][e];o.dataset.activeCore=a}}function oo(){if(console.log("ğŸ”§ Enhancing 4D tilt mechanics..."),!window.deviceTiltHandler){console.warn("âš ï¸ Device tilt handler not available");return}window.deviceTiltHandler.setSensitivity(2.5),window.deviceTiltHandler.setSmoothing(.15);const i=window.deviceTiltHandler.enable.bind(window.deviceTiltHandler);if(window.deviceTiltHandler.enable=async function(){const e=await i();return e&&setTimeout(()=>{this.setDramaticMode(!0),console.log("ğŸš€ Auto-enabled DRAMATIC tilting mode for better effect")},100),e},window.deviceTiltHandler.mapping&&window.deviceTiltHandler.mapping.dramatic){const e=window.deviceTiltHandler.mapping.dramatic;e.alphaGammaToXY.scale*=1.5,e.alphaBetaToXZ.scale*=1.5,e.betaGammaToYZ.scale*=1.5,e.betaToXW.scale*=1.5,e.gammaToYW.scale*=1.5,e.alphaToZW.scale*=1.5,console.log("ğŸš€ Tilt mapping scales increased by 1.5x for more dramatic effect")}console.log("âœ… Tilt mechanics enhanced: 2.5x sensitivity, 0.15 smoothing, dramatic mode auto-enabled")}function io(){console.log("ğŸ”§ Adding randomize buttons to tabs..."),document.querySelectorAll(".bezel-content").forEach((e,t)=>{const o=e.id;if(e.querySelector(".tab-randomize-buttons"))return;const a=document.createElement("div");a.className="tab-randomize-buttons",a.style.cssText=`
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 8px;
            padding: 10px 0;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid rgba(0, 255, 255, 0.15);
            z-index: 10;
            backdrop-filter: blur(10px);
        `;const r=document.createElement("button");r.className="tab-random-btn randomize-all",r.innerHTML="ğŸ² Randomize All",r.style.cssText=`
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.15), rgba(200, 0, 255, 0.15));
            border: 1px solid rgba(255, 0, 255, 0.3);
            border-radius: 6px;
            color: #ff00ff;
            font-family: 'Orbitron', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        `,r.onclick=()=>{window.randomizeEverything&&window.randomizeEverything()};const s=document.createElement("button");s.className="tab-random-btn randomize-tab",s.innerHTML="ğŸ¯ Random Tab",s.style.cssText=`
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.15), rgba(0, 200, 255, 0.15));
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 6px;
            color: #00ffff;
            font-family: 'Orbitron', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        `,s.onclick=()=>{ot(o)};const n=(c,d)=>{c.addEventListener("mouseenter",()=>{c.style.transform="scale(1.05)",c.style.boxShadow=`0 0 15px ${d}`}),c.addEventListener("mouseleave",()=>{c.style.transform="scale(1)",c.style.boxShadow="none"})};n(r,"rgba(255, 0, 255, 0.4)"),n(s,"rgba(0, 255, 255, 0.4)"),a.appendChild(r),a.appendChild(s);const l=e.querySelector(".tab-content-grid");l?e.insertBefore(a,l):e.insertBefore(a,e.firstChild)}),console.log("âœ… Randomize buttons added to all tabs")}function ot(i){console.log(`ğŸ¯ Randomizing tab: ${i}`);const e=(t,o)=>t+Math.random()*(o-t);switch(i){case"controls-content":window.updateParameter("rot4dXY",e(-6.28,6.28)),window.updateParameter("rot4dXZ",e(-6.28,6.28)),window.updateParameter("rot4dYZ",e(-6.28,6.28)),window.updateParameter("rot4dXW",e(-6.28,6.28)),window.updateParameter("rot4dYW",e(-6.28,6.28)),window.updateParameter("rot4dZW",e(-6.28,6.28)),window.updateParameter("gridDensity",Math.floor(e(5,100))),window.updateParameter("morphFactor",e(0,2)),window.updateParameter("chaos",e(0,1)),window.updateParameter("speed",e(.1,3)),console.log("âœ… Randomized rotation & visual parameters");break;case"color-content":window.updateParameter("hue",Math.floor(e(0,360))),window.updateParameter("saturation",e(0,1)),window.updateParameter("intensity",e(0,1)),console.log("âœ… Randomized color parameters");break;case"geometry-content":const t=Math.floor(e(0,24));window.loadGeometryFromIndex?window.loadGeometryFromIndex(t):window.selectGeometry&&window.selectGeometry(t),console.log(`âœ… Randomized geometry to #${t}`);break;case"reactivity-content":const o=["faceted","quantum","holographic"],a=["mouse","click","scroll"];o.forEach(r=>{a.forEach(s=>{const n=document.getElementById(`${r}${s.charAt(0).toUpperCase()+s.slice(1)}`);n&&(n.checked=Math.random()>.5,n.dispatchEvent(new Event("change")))})}),console.log("âœ… Randomized reactivity settings");break;default:console.log("âš ï¸ No randomization defined for this tab");break}}function ao(){console.log("ğŸš€ Initializing UI Fixes Module..."),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Pe()}):Pe()}function Pe(){setTimeout(()=>eo(),100),setTimeout(()=>to(),200),setTimeout(()=>oo(),300),setTimeout(()=>io(),500),console.log("âœ… All UI fixes initialized successfully")}ao();typeof window<"u"&&(window.resizeAllCanvases=ge,window.updateGeometryButtonHighlight=fe,window.randomizeCurrentTab=ot);console.log("ğŸ”§ UI Fixes Module: Loaded");console.log("ğŸ¨ Geometric Icons Module: Loading...");const O={faceted:"#00ffff",quantum:"#ff00ff",holographic:"#ff64ff",polychora:"#ffff00",base:"#00ffff",hypersphere:"#ff00ff",hypertetra:"#ff8800"},it={faceted:(i=O.faceted)=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2 L22 8 L22 16 L12 22 L2 16 L2 8 Z"
                  stroke="${i}" stroke-width="2" fill="none" opacity="0.8"/>
            <path d="M12 2 L12 22 M2 8 L22 16 M22 8 L2 16"
                  stroke="${i}" stroke-width="1" opacity="0.4"/>
        </svg>
    `,quantum:(i=O.quantum)=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="8" stroke="${i}" stroke-width="2" opacity="0.3"/>
            <circle cx="12" cy="12" r="5" stroke="${i}" stroke-width="2" opacity="0.5"/>
            <circle cx="12" cy="12" r="2" fill="${i}" opacity="0.8"/>
            <path d="M12 4 L12 20 M4 12 L20 12" stroke="${i}" stroke-width="1" opacity="0.4"/>
            <circle cx="12" cy="4" r="1.5" fill="${i}"/>
            <circle cx="20" cy="12" r="1.5" fill="${i}"/>
            <circle cx="12" cy="20" r="1.5" fill="${i}"/>
            <circle cx="4" cy="12" r="1.5" fill="${i}"/>
        </svg>
    `,holographic:(i=O.holographic)=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12 Q7 6, 12 12 T21 12" stroke="${i}" stroke-width="2" fill="none" opacity="0.6"/>
            <path d="M3 10 Q7 4, 12 10 T21 10" stroke="${i}" stroke-width="1.5" fill="none" opacity="0.4"/>
            <path d="M3 14 Q7 8, 12 14 T21 14" stroke="${i}" stroke-width="1.5" fill="none" opacity="0.4"/>
            <circle cx="12" cy="12" r="3" stroke="${i}" stroke-width="2" fill="none" opacity="0.8"/>
            <circle cx="12" cy="12" r="1" fill="${i}" opacity="1"/>
        </svg>
    `,polychora:(i=O.polychora)=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2 L20 7 L20 17 L12 22 L4 17 L4 7 Z"
                  stroke="${i}" stroke-width="2" fill="none" opacity="0.6"/>
            <path d="M8 9 L16 9 L16 15 L8 15 Z"
                  stroke="${i}" stroke-width="2" fill="none" opacity="0.8"/>
            <path d="M12 2 L12 9 M12 15 L12 22 M4 7 L8 9 M20 7 L16 9 M4 17 L8 15 M20 17 L16 15"
                  stroke="${i}" stroke-width="1" opacity="0.4"/>
        </svg>
    `,save:(i="#00ff00")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"
                  stroke="${i}" stroke-width="2"/>
            <path d="M17 21v-8H7v8M7 3v5h8" stroke="${i}" stroke-width="2"/>
            <circle cx="12" cy="14" r="2" fill="${i}" opacity="0.8"/>
        </svg>
    `,gallery:(i="#ff00ff")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="7" height="7" stroke="${i}" stroke-width="2" fill="none" opacity="0.8"/>
            <rect x="14" y="3" width="7" height="7" stroke="${i}" stroke-width="2" fill="none" opacity="0.8"/>
            <rect x="3" y="14" width="7" height="7" stroke="${i}" stroke-width="2" fill="none" opacity="0.8"/>
            <rect x="14" y="14" width="7" height="7" stroke="${i}" stroke-width="2" fill="none" opacity="0.8"/>
            <circle cx="6.5" cy="6.5" r="1.5" fill="${i}"/>
            <circle cx="17.5" cy="6.5" r="1.5" fill="${i}"/>
            <circle cx="6.5" cy="17.5" r="1.5" fill="${i}"/>
            <circle cx="17.5" cy="17.5" r="1.5" fill="${i}"/>
        </svg>
    `,audio:(i="#ffff00")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 9v6l-3 2v-10l3 2z" fill="${i}" opacity="0.8"/>
            <path d="M15 5 Q18 8, 15 11" stroke="${i}" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
            <path d="M15 9 Q19 12, 15 15" stroke="${i}" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
            <path d="M15 13 Q21 12, 15 19" stroke="${i}" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
        </svg>
    `,tilt:(i="#00ffff")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="6" y="8" width="12" height="8" stroke="${i}" stroke-width="2" fill="none" opacity="0.6" transform="rotate(-15 12 12)"/>
            <circle cx="12" cy="12" r="2" fill="${i}" opacity="0.8"/>
            <path d="M12 2 L12 6 M12 18 L12 22 M2 12 L6 12 M18 12 L22 12"
                  stroke="${i}" stroke-width="2" stroke-linecap="round" opacity="0.4"/>
        </svg>
    `,ai:(i="#ff64ff")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="9" stroke="${i}" stroke-width="2" fill="none" opacity="0.4"/>
            <circle cx="8" cy="10" r="1.5" fill="${i}"/>
            <circle cx="16" cy="10" r="1.5" fill="${i}"/>
            <path d="M8 15 Q12 17, 16 15" stroke="${i}" stroke-width="2" stroke-linecap="round" fill="none"/>
            <path d="M4 6 L8 4 M20 6 L16 4 M4 18 L8 20 M20 18 L16 20"
                  stroke="${i}" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
        </svg>
    `,interactivity:(i="#00ffff")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="8" stroke="${i}" stroke-width="2" fill="none" opacity="0.4"/>
            <text x="12" y="16" font-family="Orbitron" font-size="12" font-weight="bold"
                  fill="${i}" text-anchor="middle">I</text>
        </svg>
    `,base:(i=O.base)=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="8" stroke="${i}" stroke-width="2" fill="none" opacity="0.6"/>
            <circle cx="12" cy="12" r="2" fill="${i}" opacity="0.8"/>
        </svg>
    `,hypersphere:(i=O.hypersphere)=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="9" stroke="${i}" stroke-width="2" fill="none" opacity="0.3"/>
            <ellipse cx="12" cy="12" rx="9" ry="4" stroke="${i}" stroke-width="1.5" fill="none" opacity="0.5"/>
            <ellipse cx="12" cy="12" rx="4" ry="9" stroke="${i}" stroke-width="1.5" fill="none" opacity="0.5"/>
            <circle cx="12" cy="12" r="3" fill="${i}" opacity="0.8"/>
        </svg>
    `,hypertetra:(i=O.hypertetra)=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3 L21 15 L12 21 L3 15 Z"
                  stroke="${i}" stroke-width="2" fill="none" opacity="0.6"/>
            <path d="M12 3 L12 21 M3 15 L21 15"
                  stroke="${i}" stroke-width="1" opacity="0.4"/>
            <circle cx="12" cy="12" r="2" fill="${i}" opacity="0.8"/>
        </svg>
    `,randomizeAll:(i="#ff00ff")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="5" y="5" width="5" height="5" fill="${i}" opacity="0.8" transform="rotate(15 7.5 7.5)"/>
            <rect x="14" y="5" width="5" height="5" fill="${i}" opacity="0.6" transform="rotate(-15 16.5 7.5)"/>
            <rect x="5" y="14" width="5" height="5" fill="${i}" opacity="0.6" transform="rotate(-15 7.5 16.5)"/>
            <rect x="14" y="14" width="5" height="5" fill="${i}" opacity="0.8" transform="rotate(15 16.5 16.5)"/>
            <circle cx="12" cy="12" r="2" fill="${i}"/>
        </svg>
    `,randomizeTab:(i="#00ffff")=>`
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3 L19 7 L19 17 L12 21 L5 17 L5 7 Z"
                  stroke="${i}" stroke-width="2" fill="none" opacity="0.6"/>
            <path d="M8 10 L16 10 M8 12 L16 12 M8 14 L16 14"
                  stroke="${i}" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
            <circle cx="12" cy="12" r="1" fill="${i}"/>
        </svg>
    `};function K(i,e=24,t=null){const o=it[i];if(!o)return console.warn(`âš ï¸ Icon '${i}' not found`),null;const a=o(t),r=document.createElement("span");return r.className=`vib-icon vib-icon-${i}`,r.style.cssText=`
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: ${e}px;
        height: ${e}px;
    `,r.innerHTML=a,r}function te(i,e){const t=i.textContent.trim();for(const[o,a]of Object.entries(e))if(t.includes(o)){const r=i.classList.contains("system-icon")?24:i.classList.contains("tab-icon")?20:18,s=K(a,r);if(s){i.innerHTML="",i.appendChild(s);const n=t.replace(o,"").trim();if(n){const l=document.createElement("span");l.textContent=n,i.appendChild(l)}}break}}function ae(){console.log("ğŸ”„ Replacing all emojis with geometric SVG icons...");const i={"ğŸ”·":"faceted","ğŸŒŒ":"quantum","âœ¨":"holographic","ğŸ”®":"polychora","ğŸ’¾":"save","ğŸ–¼ï¸":"gallery","ğŸµ":"audio","ğŸ“±":"tilt","ğŸ¤–":"ai",I:"interactivity","ğŸŒ€":"hypersphere","ğŸ”º":"hypertetra","ğŸ²":"randomizeAll","ğŸ¯":"randomizeTab"};document.querySelectorAll(".system-icon").forEach(t=>{te(t,i)}),document.querySelectorAll(".action-btn").forEach(t=>{t.textContent.trim().length<=2&&te(t,i)});const e=document.querySelector(".save-btn");if(e){const t=e.textContent.trim().split(" ")[0];if(i[t]){const o=K(i[t],20,"#00ff00");if(o){e.innerHTML="",e.appendChild(o);const a=document.createElement("span");a.textContent=" SAVE",e.appendChild(a)}}}document.querySelectorAll(".tab-icon").forEach(t=>{te(t,i)}),document.querySelectorAll(".core-tab-icon").forEach(t=>{te(t,i)}),document.querySelectorAll(".tab-random-btn").forEach(t=>{const o=t.textContent;if(o.includes("ğŸ²")){const a=K("randomizeAll",16,"#ff00ff");if(a){t.innerHTML="",t.appendChild(a);const r=document.createElement("span");r.textContent=" Randomize All",r.style.marginLeft="6px",t.appendChild(r)}}else if(o.includes("ğŸ¯")){const a=K("randomizeTab",16,"#00ffff");if(a){t.innerHTML="",t.appendChild(a);const r=document.createElement("span");r.textContent=" Random Tab",r.style.marginLeft="6px",t.appendChild(r)}}}),console.log("âœ… All emojis replaced with geometric SVG icons")}function ro(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(ae,1e3)}):setTimeout(ae,1e3);const i=new MutationObserver(e=>{e.forEach(t=>{t.addedNodes.forEach(o=>{o.classList&&o.classList.contains("tab-randomize-buttons")&&setTimeout(()=>{ae()},100)})})});setTimeout(()=>{i.observe(document.body,{childList:!0,subtree:!0})},500)}ro();typeof window<"u"&&(window.createIcon=K,window.replaceAllEmojisWithIcons=ae,window.GEOMETRIC_ICONS=it);console.log("ğŸ¨ Geometric Icons Module: Loaded");console.log("ğŸ”§ Comprehensive Fixes Module: Loading...");let $e=null;function ne(){const i=document.getElementById("canvasContainer"),e=document.getElementById("controlPanel");if(!i||!e)return;const t=e.classList.contains("collapsed"),o=60;let a;t?a=52:a=e.offsetHeight,console.log(`ğŸ“ Force canvas resize: ${t?"collapsed":"expanded"}, bottom=${a}px`),i.style.top=`${o}px`,i.style.bottom=`${a}px`,i.style.left="0",i.style.right="0",i.offsetHeight;const r=i.getBoundingClientRect(),s=r.width,n=r.height;console.log(`ğŸ“ Canvas container: ${s}x${n}px`),i.querySelectorAll("canvas").forEach(c=>{c.width=s,c.height=n,c.style.width=`${s}px`,c.style.height=`${n}px`}),window.vib34dApp&&window.vib34dApp.currentEngine&&setTimeout(()=>{window.vib34dApp.currentEngine.handleResize&&window.vib34dApp.currentEngine.handleResize(s,n),window.vib34dApp.currentEngine.render&&window.vib34dApp.currentEngine.render()},50)}function so(){const i=document.getElementById("controlPanel");if(!i){console.warn("âš ï¸ Control panel not found for resize observer");return}$e=new MutationObserver(e=>{e.forEach(t=>{t.attributeName==="class"&&(console.log("ğŸ”„ Bezel class changed, forcing canvas resize..."),setTimeout(ne,100))})}),$e.observe(i,{attributes:!0,attributeFilter:["class"]}),console.log("âœ… Canvas resize observer installed"),setTimeout(ne,500)}let Re;window.addEventListener("resize",()=>{clearTimeout(Re),Re=setTimeout(ne,200)});function Se(i,e,t=500){const o=document.getElementById(i);if(!o)return;const a=parseFloat(o.value),r=parseFloat(e),s=performance.now();function n(l){const c=l-s,d=Math.min(c/t,1),u=1-Math.pow(1-d,3),m=a+(r-a)*u;o.value=m;const f=new Event("input",{bubbles:!0});o.dispatchEvent(f),d<1&&requestAnimationFrame(n)}requestAnimationFrame(n)}const Fe=window.updateParameter;window.updateParameter=function(i,e,t=!1){t?Se(i,e):Fe&&Fe(i,e)};window.randomizeAll=function(){console.log("ğŸ² Randomizing with animations..."),["rot4dXY","rot4dXZ","rot4dYZ","rot4dXW","rot4dYW","rot4dZW","gridDensity","morphFactor","chaos","speed","hue","saturation","intensity"].forEach((e,t)=>{const o=document.getElementById(e);if(!o)return;const a=parseFloat(o.min),r=parseFloat(o.max),s=a+Math.random()*(r-a);setTimeout(()=>{Se(e,s,800)},t*50)}),console.log("âœ… Animated randomization complete")};window.randomizeEverything=function(){console.log("ğŸ¯ Full randomize with animations...");const i=["faceted","quantum","holographic","polychora"],e=i[Math.floor(Math.random()*i.length)];window.switchSystem&&window.switchSystem(e);const t=Math.floor(Math.random()*24);setTimeout(()=>{window.loadGeometryFromIndex?window.loadGeometryFromIndex(t):window.selectGeometry&&window.selectGeometry(t)},300),setTimeout(()=>{window.randomizeAll()},600),console.log(`âœ… Full randomization: ${e}, geometry ${t}`)};window.saveToGallery=function(){console.log("ğŸ’¾ Saving to gallery with fixes...");try{const i={system:window.currentSystem||"faceted",parameters:window.userParameterState||{},timestamp:new Date().toISOString(),name:`${window.currentSystem||"Unnamed"} - ${new Date().toLocaleString()}`};if(window.getGeometryInfo){const a=window.getGeometryInfo();i.parameters.geometry=a.index,i.geometryName=a.fullName}const e=Date.now().toString(36)+Math.random().toString(36).substr(2,5),t=`vib34d-variation-${e}`;return localStorage.setItem(t,JSON.stringify(i)),console.log(`âœ… Saved variation ${e}:`,i),console.log(`ğŸ“¦ LocalStorage key: ${t}`),pe(`âœ… Saved: ${i.name}`,"success"),localStorage.getItem(t)?console.log("âœ… Save verified in localStorage"):console.error("âŒ Save verification failed!"),e}catch(i){return console.error("âŒ Save failed:",i),pe(`âŒ Save failed: ${i.message}`,"error"),null}};function pe(i,e="success"){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${e==="success"?"linear-gradient(135deg, rgba(0, 255, 0, 0.95), rgba(0, 200, 100, 0.95))":"linear-gradient(135deg, rgba(255, 0, 0, 0.95), rgba(200, 0, 0, 0.95))"};
        color: ${e==="success"?"#000":"#fff"};
        padding: 15px 25px;
        border-radius: 10px;
        font-family: 'Orbitron', monospace;
        font-weight: bold;
        font-size: 0.9rem;
        z-index: 10001;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        animation: slideInRight 0.3s ease-out;
    `,t.textContent=i;const o=document.createElement("style");o.textContent=`
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `,document.head.appendChild(o),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>t.remove(),300)},3e3)}function no(){try{const i="vib34d-test";localStorage.setItem(i,"test");const e=localStorage.getItem(i);return localStorage.removeItem(i),e==="test"?(console.log("âœ… LocalStorage is working"),!0):(console.error("âŒ LocalStorage read/write mismatch"),!1)}catch(i){return console.error("âŒ LocalStorage not available:",i),!1}}function lo(){console.log("ğŸš€ Initializing Comprehensive Fixes..."),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ke):ke()}function ke(){no()||console.error("âš ï¸ LocalStorage is not working - save functionality will be limited"),setTimeout(()=>{so(),console.log("âœ… Canvas resize observer initialized")},500),setTimeout(()=>{const e=Object.keys(localStorage).filter(t=>t.startsWith("vib34d-variation-"));console.log(`ğŸ“¦ Found ${e.length} saved variations:`,e)},1e3),console.log("âœ… All comprehensive fixes applied")}lo();typeof window<"u"&&(window.forceCanvasResize=ne,window.animateSlider=Se,window.showSaveNotification=pe);console.log("ğŸ”§ Comprehensive Fixes Module: Loaded");console.log("âŒ¨ï¸ Global Shortcuts Module: Loading...");let xe=!0,Z=!1,ye=null;const co={systems:{title:"System Switching",shortcuts:[{keys:["1"],action:"switchToFaceted",desc:"Switch to Faceted System"},{keys:["2"],action:"switchToQuantum",desc:"Switch to Quantum System"},{keys:["3"],action:"switchToHolographic",desc:"Switch to Holographic System"},{keys:["4"],action:"switchToPolychora",desc:"Switch to Polychora System"}]},tabs:{title:"Tab Navigation",shortcuts:[{keys:["Ctrl","B"],action:"toggleBezel",desc:"Toggle Bezel Collapse"},{keys:["Space"],action:"toggleBezel",desc:"Toggle Bezel (alt)"},{keys:["Ctrl","1"],action:"openControlsTab",desc:"Open Controls Tab"},{keys:["Ctrl","2"],action:"openColorTab",desc:"Open Color Tab"},{keys:["Ctrl","3"],action:"openGeometryTab",desc:"Open Geometry Tab"},{keys:["Ctrl","4"],action:"openReactivityTab",desc:"Open Reactivity Tab"},{keys:["Ctrl","5"],action:"openExportTab",desc:"Open Export Tab"}]},geometry:{title:"Geometry Selection",shortcuts:[{keys:["Alt","1"],action:"baseCore",desc:"Switch to Base Core"},{keys:["Alt","2"],action:"hypersphereCore",desc:"Switch to Hypersphere Core"},{keys:["Alt","3"],action:"hypertetraCore",desc:"Switch to Hypertetra Core"},{keys:["Alt","Q"],action:"tetrahedron",desc:"Select Tetrahedron"},{keys:["Alt","W"],action:"hypercube",desc:"Select Hypercube"},{keys:["Alt","E"],action:"sphere",desc:"Select Sphere"},{keys:["Alt","R"],action:"torus",desc:"Select Torus"},{keys:["Alt","A"],action:"kleinBottle",desc:"Select Klein Bottle"},{keys:["Alt","S"],action:"fractal",desc:"Select Fractal"},{keys:["Alt","D"],action:"wave",desc:"Select Wave"},{keys:["Alt","F"],action:"crystal",desc:"Select Crystal"}]},actions:{title:"Actions",shortcuts:[{keys:["Ctrl","S"],action:"saveToGallery",desc:"Save to Gallery"},{keys:["Ctrl","G"],action:"openGallery",desc:"Open Gallery"},{keys:["Ctrl","R"],action:"randomizeAll",desc:"Randomize All Parameters"},{keys:["Ctrl","Shift","R"],action:"randomizeEverything",desc:"Randomize Everything"},{keys:["Ctrl","Shift","Z"],action:"resetAll",desc:"Reset All Parameters"},{keys:["Ctrl","E"],action:"exportCard",desc:"Export Trading Card"}]},features:{title:"Feature Toggles",shortcuts:[{keys:["A"],action:"toggleAudio",desc:"Toggle Audio Reactivity"},{keys:["T"],action:"toggleTilt",desc:"Toggle Device Tilt"},{keys:["I"],action:"toggleInteractivity",desc:"Toggle Interactivity"},{keys:["F"],action:"toggleFullscreen",desc:"Toggle Fullscreen"},{keys:["H"],action:"toggleHelp",desc:"Toggle Shortcuts Help"}]},navigation:{title:"Navigation",shortcuts:[{keys:["â†"],action:"previousGeometry",desc:"Previous Geometry"},{keys:["â†’"],action:"nextGeometry",desc:"Next Geometry"},{keys:["â†‘"],action:"nextSystem",desc:"Next System"},{keys:["â†“"],action:"previousSystem",desc:"Previous System"}]}};function We(){console.log("ğŸ¹ Initializing global shortcuts..."),mo(),document.addEventListener("keydown",uo),console.log("âœ… Global shortcuts initialized"),console.log("ğŸ“‹ Press H to view all shortcuts")}function uo(i){if(xe&&!((i.target.tagName==="INPUT"||i.target.tagName==="TEXTAREA")&&!i.ctrlKey&&!i.metaKey)){if(!i.ctrlKey&&!i.altKey&&!i.shiftKey&&!i.metaKey){if(i.key==="1"&&window.switchSystem){i.preventDefault(),window.switchSystem("faceted");return}if(i.key==="2"&&window.switchSystem){i.preventDefault(),window.switchSystem("quantum");return}if(i.key==="3"&&window.switchSystem){i.preventDefault(),window.switchSystem("holographic");return}if(i.key==="4"&&window.switchSystem){i.preventDefault(),window.switchSystem("polychora");return}if(i.key.toLowerCase()==="a"&&window.toggleAudio){i.preventDefault(),window.toggleAudio();return}if(i.key.toLowerCase()==="t"&&window.toggleDeviceTilt){i.preventDefault(),window.toggleDeviceTilt();return}if(i.key.toLowerCase()==="i"&&window.toggleInteractivity){i.preventDefault(),window.toggleInteractivity();return}if(i.key.toLowerCase()==="f"){i.preventDefault(),ho();return}if(i.key.toLowerCase()==="h"){i.preventDefault(),le();return}}if(i.ctrlKey||i.metaKey){if(i.key==="s"&&window.saveToGallery){i.preventDefault(),window.saveToGallery();return}if(i.key==="g"&&window.openGallery){i.preventDefault(),window.openGallery();return}if(i.key==="r"){i.preventDefault(),i.shiftKey&&window.randomizeEverything?window.randomizeEverything():window.randomizeAll&&window.randomizeAll();return}if(i.key==="z"&&i.shiftKey&&window.resetAll){i.preventDefault(),window.resetAll();return}if(i.key==="e"&&window.createTradingCard){i.preventDefault(),window.createTradingCard();return}}if(!i.ctrlKey&&!i.altKey&&!i.shiftKey){if(i.key==="ArrowLeft"){i.preventDefault(),ze(-1);return}if(i.key==="ArrowRight"){i.preventDefault(),ze(1);return}if(i.key==="ArrowUp"){i.preventDefault(),Be(1);return}if(i.key==="ArrowDown"){i.preventDefault(),Be(-1);return}}}}function ze(i){const e=window.getGeometryInfo?window.getGeometryInfo().index:0;let t=e+i;t<0&&(t=23),t>23&&(t=0),console.log(`â¡ï¸ Navigating from geometry ${e} to ${t}`),window.loadGeometryFromIndex&&window.loadGeometryFromIndex(t)}function Be(i){const e=["faceted","quantum","holographic","polychora"],t=window.currentSystem||"faceted";let a=e.indexOf(t)+i;a<0&&(a=e.length-1),a>=e.length&&(a=0),console.log(`â¡ï¸ Navigating from ${t} to ${e[a]}`),window.switchSystem&&window.switchSystem(e[a])}function ho(){document.fullscreenElement?document.exitFullscreen().then(()=>{console.log("ğŸ–¥ï¸ Exited fullscreen mode"),Ge("Fullscreen Mode Disabled","","info")}):document.documentElement.requestFullscreen().then(()=>{console.log("ğŸ–¥ï¸ Entered fullscreen mode"),Ge("Fullscreen Mode Enabled","Press F to exit","info")}).catch(i=>{console.error("âŒ Failed to enter fullscreen:",i)})}function mo(){const i=document.createElement("div");i.id="shortcuts-help-modal",i.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        font-family: 'Orbitron', monospace;
    `;const e=document.createElement("div");e.style.cssText=`
        background: linear-gradient(135deg, rgba(0, 30, 60, 0.95), rgba(0, 15, 30, 0.95));
        border: 2px solid #00ffff;
        border-radius: 15px;
        padding: 30px;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 0 40px rgba(0, 255, 255, 0.3);
    `;let t=`
        <h2 style="color: #00ffff; text-align: center; margin-bottom: 25px; font-size: 1.8rem;">
            âŒ¨ï¸ VIB3+ KEYBOARD SHORTCUTS
        </h2>
        <p style="color: #888; text-align: center; margin-bottom: 30px; font-size: 0.85rem;">
            Master the VIB3+ Engine with comprehensive keyboard control
        </p>
    `;Object.entries(co).forEach(([o,a])=>{t+=`
            <div style="margin-bottom: 25px;">
                <h3 style="color: #ff00ff; font-size: 1.1rem; margin-bottom: 12px; border-bottom: 1px solid rgba(255, 0, 255, 0.3); padding-bottom: 5px;">
                    ${a.title}
                </h3>
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 8px; font-size: 0.85rem;">
        `,a.shortcuts.forEach(r=>{const s=r.keys.map(n=>`<kbd style="background: rgba(0, 255, 255, 0.15); border: 1px solid rgba(0, 255, 255, 0.3); padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; color: #00ffff;">${n}</kbd>`).join(" + ");t+=`
                <div style="color: #fff;">${s}</div>
                <div style="color: #aaa;">${r.desc}</div>
            `}),t+=`
                </div>
            </div>
        `}),t+=`
        <div style="text-align: center; margin-top: 25px;">
            <button onclick="toggleShortcutsHelp()" style="
                background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 255, 0.2));
                border: 1px solid #00ffff;
                color: #00ffff;
                padding: 10px 30px;
                border-radius: 8px;
                font-family: 'Orbitron', monospace;
                font-size: 0.9rem;
                cursor: pointer;
                font-weight: bold;
            ">CLOSE (H or ESC)</button>
        </div>
    `,e.innerHTML=t,i.appendChild(e),document.body.appendChild(i),i.addEventListener("click",o=>{o.target===i&&le()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&Z&&(o.preventDefault(),le())}),ye=i}function le(){ye&&(Z=!Z,ye.style.display=Z?"flex":"none",console.log(`âŒ¨ï¸ Shortcuts help ${Z?"shown":"hidden"}`))}function Ge(i,e,t="info"){const o={success:{bg:"#00ff00",border:"#00cc00"},error:{bg:"#ff0000",border:"#cc0000"},info:{bg:"#00ffff",border:"#00cccc"},warning:{bg:"#ffff00",border:"#cccc00"}},a=o[t]||o.info,r=document.createElement("div");r.style.cssText=`
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid ${a.border};
        border-radius: 10px;
        padding: 15px 20px;
        color: ${a.bg};
        font-family: 'Orbitron', monospace;
        font-size: 0.85rem;
        z-index: 9999;
        box-shadow: 0 0 20px ${a.bg}40;
        animation: slideInRight 0.3s ease-out;
        max-width: 300px;
    `,r.innerHTML=`
        <div style="font-weight: bold; margin-bottom: 5px;">${i}</div>
        ${e?`<div style="font-size: 0.75rem; opacity: 0.8;">${e}</div>`:""}
    `,document.body.appendChild(r),setTimeout(()=>{r.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>r.remove(),300)},3e3)}window.enableShortcuts=function(){xe=!0,console.log("âœ… Keyboard shortcuts enabled")};window.disableShortcuts=function(){xe=!1,console.log("â¸ï¸ Keyboard shortcuts disabled")};window.toggleShortcutsHelp=le;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",We):We();console.log("âŒ¨ï¸ Global Shortcuts Module: Loaded");console.log("ğŸ“‹ Press H anytime to view all shortcuts");console.log("âš¡ Performance Optimizer Module: Loading...");let v={fps:0,frameTime:0,drawCalls:0,triangles:0,memoryUsage:0,lastFrameTime:performance.now(),frameCount:0,sampleStartTime:performance.now()},H="auto",M=[],go=60,k=null,z=null,re=!1;const B={lowFpsThreshold:30,mediumFpsThreshold:45,highFpsThreshold:55,memoryWarningThreshold:500*1024*1024,memoryDangerThreshold:1e3*1024*1024},Oe={low:{gridDensity:8,maxParticles:1e3,shadowQuality:0,antialiasing:!1,bloomEnabled:!1,particleLimit:500},medium:{gridDensity:15,maxParticles:2e3,shadowQuality:1,antialiasing:!0,bloomEnabled:!1,particleLimit:1500},high:{gridDensity:30,maxParticles:5e3,shadowQuality:2,antialiasing:!0,bloomEnabled:!0,particleLimit:3e3},ultra:{gridDensity:50,maxParticles:1e4,shadowQuality:3,antialiasing:!0,bloomEnabled:!0,particleLimit:5e3}};function Ye(){console.log("âš¡ Initializing Performance Optimizer..."),fo(),po(),yo(),document.addEventListener("keydown",i=>{i.key.toLowerCase()==="p"&&!i.ctrlKey&&!i.altKey&&(i.preventDefault(),at())}),console.log("âœ… Performance Optimizer initialized"),console.log("âŒ¨ï¸ Press P to toggle performance stats")}function fo(){k=document.createElement("div"),k.id="fps-display",k.style.cssText=`
        position: fixed;
        top: 70px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #00ffff;
        border-radius: 5px;
        padding: 5px 10px;
        font-family: 'Orbitron', monospace;
        font-size: 0.75rem;
        color: #00ffff;
        z-index: 9998;
        display: none;
        min-width: 80px;
        text-align: center;
    `,document.body.appendChild(k)}function po(){z=document.createElement("div"),z.id="performance-stats",z.style.cssText=`
        position: fixed;
        top: 100px;
        right: 10px;
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #00ffff;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Orbitron', monospace;
        font-size: 0.7rem;
        color: #fff;
        z-index: 9998;
        display: none;
        min-width: 200px;
        line-height: 1.6;
    `,document.body.appendChild(z)}function yo(){function i(){vo(),wo(),H==="auto"&&So(),requestAnimationFrame(i)}i()}function vo(){const i=performance.now(),e=i-v.lastFrameTime;v.lastFrameTime=i,v.frameCount++;const t=i-v.sampleStartTime;if(t>=1e3&&(v.fps=Math.round(v.frameCount/t*1e3),v.frameTime=e.toFixed(2),v.frameCount=0,v.sampleStartTime=i,M.push(v.fps),M.length>go&&M.shift()),performance.memory&&(v.memoryUsage=performance.memory.usedJSHeapSize),window.vib34dApp&&window.vib34dApp.currentEngine){const o=window.vib34dApp.currentEngine;if(o.getStats){const a=o.getStats();v.drawCalls=a.drawCalls||0,v.triangles=a.triangles||0}}}function wo(){if(k){if(k.style.display!=="none"){const i=oe(v.fps);k.innerHTML=`
            <div style="color: ${i}; font-weight: bold; font-size: 1.2em;">
                ${v.fps} FPS
            </div>
        `}if(z&&re){const i=M.length>0?Math.round(M.reduce((r,s)=>r+s,0)/M.length):v.fps,e=M.length>0?Math.min(...M):v.fps,t=M.length>0?Math.max(...M):v.fps,o=(v.memoryUsage/(1024*1024)).toFixed(1),a=bo(v.memoryUsage);z.innerHTML=`
            <div style="color: #00ffff; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #00ffff; padding-bottom: 5px;">
                âš¡ PERFORMANCE STATS
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 5px;">
                <div style="color: #888;">FPS:</div>
                <div style="color: ${oe(v.fps)}; font-weight: bold;">${v.fps}</div>

                <div style="color: #888;">Avg FPS:</div>
                <div style="color: ${oe(i)};">${i}</div>

                <div style="color: #888;">Min/Max:</div>
                <div style="color: ${oe(e)};">${e} / ${t}</div>

                <div style="color: #888;">Frame Time:</div>
                <div>${v.frameTime}ms</div>

                <div style="color: #888;">Memory:</div>
                <div style="color: ${a};">${o} MB</div>

                <div style="color: #888;">Draw Calls:</div>
                <div>${v.drawCalls}</div>

                <div style="color: #888;">Triangles:</div>
                <div>${v.triangles.toLocaleString()}</div>

                <div style="color: #888;">Mode:</div>
                <div style="color: #ff00ff; font-weight: bold;">${H.toUpperCase()}</div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; font-size: 0.65rem; color: #666;">
                Press P to hide â€¢ Press M to cycle modes
            </div>
        `}}}function oe(i){return i>=B.highFpsThreshold?"#00ff00":i>=B.mediumFpsThreshold?"#ffff00":i>=B.lowFpsThreshold?"#ff8800":"#ff0000"}function bo(i){return i>=B.memoryDangerThreshold?"#ff0000":i>=B.memoryWarningThreshold?"#ffff00":"#00ff00"}function So(){if(M.length<30)return;const i=M.reduce((t,o)=>t+o,0)/M.length;let e="medium";i<B.lowFpsThreshold?e="low":i<B.mediumFpsThreshold?e="medium":i<B.highFpsThreshold?e="high":e="ultra",e!==H&&(console.log(`âš¡ Auto-adjusting quality from ${H} to ${e} (avgFps: ${i.toFixed(1)})`),Ee(e))}function Ee(i){if(!Oe[i]){console.error(`âŒ Invalid performance mode: ${i}`);return}H=i;const e=Oe[i];if(console.log(`âš¡ Setting performance mode: ${i}`,e),window.updateParameter&&document.getElementById("gridDensity")&&window.updateParameter("gridDensity",e.gridDensity),window.vib34dApp&&window.vib34dApp.currentEngine){const o=window.vib34dApp.currentEngine;o.setPerformanceMode&&o.setPerformanceMode(i,e)}const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid #00ffff;
        border-radius: 10px;
        padding: 20px 40px;
        font-family: 'Orbitron', monospace;
        font-size: 1.2rem;
        color: #00ffff;
        z-index: 10001;
        text-align: center;
    `,t.innerHTML=`
        âš¡ PERFORMANCE MODE<br>
        <span style="font-size: 2rem; font-weight: bold;">${i.toUpperCase()}</span>
    `,document.body.appendChild(t),setTimeout(()=>t.remove(),1500)}function at(){re=!re,re?(k.style.display="block",z.style.display="block",console.log("ğŸ“Š Performance stats enabled")):(k.style.display="none",z.style.display="none",console.log("ğŸ“Š Performance stats disabled"))}function rt(){const i=["auto","low","medium","high","ultra"],t=(i.indexOf(H)+1)%i.length;Ee(i[t])}window.getPerformanceStats=function(){return{...v}};window.setPerformanceMode=Ee;window.togglePerformanceStats=at;window.cyclePerformanceMode=rt;document.addEventListener("keydown",i=>{i.key.toLowerCase()==="m"&&!i.ctrlKey&&!i.altKey&&(i.preventDefault(),rt())});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ye):Ye();console.log("âš¡ Performance Optimizer Module: Loaded");console.log("âŒ¨ï¸ Press P to toggle stats, M to cycle modes");console.log("ğŸ’¾ State Manager Module: Loading...");let I=[],D=-1,xo=50,Eo=2e3,Ve=null,st={version:"1.0",timestamp:Date.now(),system:"faceted",geometry:0,parameters:{},ui:{},performance:{},reactivity:{}};function Ue(){console.log("ğŸ’¾ Initializing State Manager...");const i=_o();if(i)console.log("ğŸ”— Restoring state from URL..."),J(i);else{const e=ut();e?(console.log("ğŸ“‚ Restoring state from localStorage..."),J(e)):ee()}Po(),$o(),Ro(),console.log("âœ… State Manager initialized")}function ee(){const i={version:"1.0",timestamp:Date.now(),system:window.currentSystem||"faceted",geometry:window.getGeometryInfo?window.getGeometryInfo().index:0,parameters:Co(),ui:{activeTab:Io(),bezelCollapsed:Do(),performanceStatsVisible:Lo()},performance:{mode:window.performanceMode||"auto"},reactivity:To()};return st=i,i}function Co(){const i={};return["rot4dXY","rot4dXZ","rot4dYZ","rot4dXW","rot4dYW","rot4dZW"].forEach(a=>{const r=document.getElementById(a);r&&(i[a]=parseFloat(r.value))}),["gridDensity","morphFactor","chaos","speed"].forEach(a=>{const r=document.getElementById(a);r&&(i[a]=parseFloat(r.value))}),["hue","saturation","intensity"].forEach(a=>{const r=document.getElementById(a);r&&(i[a]=parseFloat(r.value))}),i}function To(){var o;const i={audio:window.audioEnabled||!1,deviceTilt:((o=window.deviceTiltHandler)==null?void 0:o.isEnabled)||!1,interactivity:window.interactivityEnabled!==!1},e=["faceted","quantum","holographic"],t=["Mouse","Click","Scroll"];return e.forEach(a=>{i[a]={},t.forEach(r=>{const s=document.getElementById(`${a}${r}`);s&&(i[a][r.toLowerCase()]=s.checked)})}),i}function Io(){const i=document.querySelector(".bezel-tab.active");return i?i.dataset.tab:"controls"}function Do(){const i=document.getElementById("controlPanel");return i?i.classList.contains("collapsed"):!1}function Lo(){const i=document.getElementById("performance-stats");return i?i.style.display!=="none":!1}function J(i){if(!i||!i.version)return console.error("âŒ Invalid state object"),!1;console.log("ğŸ“‚ Restoring state:",i);try{return i.system&&window.switchSystem&&window.switchSystem(i.system),i.geometry!==void 0&&setTimeout(()=>{window.loadGeometryFromIndex&&window.loadGeometryFromIndex(i.geometry)},300),i.parameters&&Object.entries(i.parameters).forEach(([e,t])=>{setTimeout(()=>{window.updateParameter&&window.updateParameter(e,t)},500)}),i.ui&&setTimeout(()=>{if(i.ui.activeTab&&window.switchBezelTab&&window.switchBezelTab(i.ui.activeTab),i.ui.bezelCollapsed&&window.toggleBezelCollapse){const e=document.getElementById("controlPanel");e&&!e.classList.contains("collapsed")&&window.toggleBezelCollapse()}},700),i.performance&&i.performance.mode&&window.setPerformanceMode&&window.setPerformanceMode(i.performance.mode),i.reactivity&&setTimeout(()=>{Mo(i.reactivity)},1e3),st=i,console.log("âœ… State restored successfully"),!0}catch(e){return console.error("âŒ Failed to restore state:",e),!1}}function Mo(i){if(!i)return;i.audio!==void 0&&i.audio!==window.audioEnabled&&window.toggleAudio&&window.toggleAudio();const e=["faceted","quantum","holographic"],t=["mouse","click","scroll"];e.forEach(o=>{i[o]&&t.forEach(a=>{const r=document.getElementById(`${o}${a.charAt(0).toUpperCase()+a.slice(1)}`);r&&i[o][a]!==void 0&&(r.checked=i[o][a],r.dispatchEvent(new Event("change")))})})}function nt(i=null){const e=i||ee();D<I.length-1&&(I=I.slice(0,D+1)),I.push(JSON.parse(JSON.stringify(e))),D=I.length-1,I.length>xo&&(I.shift(),D--),console.log(`ğŸ“š State saved to history (${D+1}/${I.length})`)}function lt(){if(D<=0)return console.log("âš ï¸ No more states to undo"),!1;D--;const i=I[D];return J(i),console.log(`â†¶ Undo to state ${D+1}/${I.length}`),Q("Undo",`Step ${D+1}/${I.length}`,"info"),!0}function ct(){if(D>=I.length-1)return console.log("âš ï¸ No more states to redo"),!1;D++;const i=I[D];return J(i),console.log(`â†· Redo to state ${D+1}/${I.length}`),Q("Redo",`Step ${D+1}/${I.length}`,"info"),!0}function dt(i="vib3-plus-app-state"){const e=ee();try{return localStorage.setItem(i,JSON.stringify(e)),console.log(`ğŸ’¾ State saved to localStorage: ${i}`),!0}catch(t){return console.error("âŒ Failed to save state to localStorage:",t),!1}}function ut(i="vib3-plus-app-state"){try{const e=localStorage.getItem(i);if(!e)return null;const t=JSON.parse(e);return console.log(`ğŸ“‚ State loaded from localStorage: ${i}`),t}catch(e){return console.error("âŒ Failed to load state from localStorage:",e),null}}function Ao(i=null){const e=i||ee();try{const t={v:e.version,s:e.system,g:e.geometry,p:e.parameters},o=JSON.stringify(t);return btoa(o)}catch(t){return console.error("âŒ Failed to encode state:",t),null}}function _o(){const e=new URLSearchParams(window.location.search).get("state");if(!e)return null;try{const t=atob(e),o=JSON.parse(t),a={version:o.v||"1.0",timestamp:Date.now(),system:o.s||"faceted",geometry:o.g||0,parameters:o.p||{},ui:{},performance:{},reactivity:{}};return console.log("ğŸ”— State decoded from URL"),a}catch(t){return console.error("âŒ Failed to decode state from URL:",t),null}}function ht(){const i=Ao();if(!i)return null;const t=`${window.location.origin+window.location.pathname}?state=${i}`;return console.log("ğŸ”— Share link generated:",t),t}async function mt(){const i=ht();if(!i)return Q("Error","Failed to generate share link","error"),!1;try{return await navigator.clipboard.writeText(i),Q("Share Link Copied!","Link copied to clipboard","success"),console.log("âœ… Share link copied to clipboard"),!0}catch(e){return console.error("âŒ Failed to copy to clipboard:",e),Q("Copy Failed","Could not copy to clipboard","error"),!1}}function Po(){document.addEventListener("input",i=>{i.target.classList.contains("control-slider")&&qe()}),["switchSystem","selectGeometry","switchBezelTab"].forEach(i=>{if(window[i]){const e=window[i];window[i]=function(...t){const o=e.apply(this,t);return qe(),o}}}),console.log("â° Auto-save enabled (delay: ${autoSaveDelay}ms)")}function qe(){clearTimeout(Ve),Ve=setTimeout(()=>{dt(),console.log("ğŸ’¾ Auto-saved")},Eo)}function $o(){document.addEventListener("keydown",i=>{(i.ctrlKey||i.metaKey)&&i.key==="z"&&!i.shiftKey&&(i.preventDefault(),lt()),(i.ctrlKey||i.metaKey)&&(i.key==="y"||i.key==="z"&&i.shiftKey)&&(i.preventDefault(),ct()),(i.ctrlKey||i.metaKey)&&i.key==="l"&&(i.preventDefault(),mt())}),console.log("âŒ¨ï¸ State management shortcuts enabled"),console.log("  - Ctrl+Z: Undo"),console.log("  - Ctrl+Y or Ctrl+Shift+Z: Redo"),console.log("  - Ctrl+L: Copy share link")}function Ro(){setTimeout(()=>{nt()},2e3)}function Q(i,e,t="info"){window.showSaveNotification?window.showSaveNotification(`${i}: ${e}`,t==="success"?"success":"error"):console.log(`[${t.toUpperCase()}] ${i}: ${e}`)}window.captureCurrentState=ee;window.restoreState=J;window.saveToHistory=nt;window.undo=lt;window.redo=ct;window.saveStateToStorage=dt;window.loadStateFromStorage=ut;window.generateShareLink=ht;window.copyShareLinkToClipboard=mt;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ue):setTimeout(Ue,1e3);console.log("ğŸ’¾ State Manager Module: Loaded");console.log("âŒ¨ï¸ Ctrl+Z: Undo, Ctrl+Y: Redo, Ctrl+L: Copy share link");console.log("ğŸ¨ Layout Polish Module: Loading...");function He(){console.log("ğŸ¨ Initializing Simple Layout System..."),gt(),ft(),Fo(),console.log("âœ… Simple Layout System initialized")}function gt(){console.log("ğŸ”§ Setting up angular RGB-split icons..."),setTimeout(()=>{document.querySelectorAll(".system-btn").forEach(a=>{const r=a.querySelector(".system-icon"),s=a.dataset.system;if(r){const l={faceted:"â—†",quantum:"â—‰",holographic:"â¬¡",polychora:"â– "}[s]||"â—†";r.textContent=l,r.setAttribute("data-icon",l),r.setAttribute("data-system",s),r.style.display="inline-flex",r.style.position="relative",r.style.zIndex="10001"}a.addEventListener("click",()=>{a.classList.add("glitching"),setTimeout(()=>a.classList.remove("glitching"),400)})});const e=document.querySelector(".bezel-collapse-btn");if(e){const a=()=>{var n;const s=((n=document.getElementById("controlPanel"))==null?void 0:n.classList.contains("collapsed"))?"â–²":"â–¼";e.textContent=s,e.setAttribute("data-icon",s)};a(),e.addEventListener("click",()=>{setTimeout(a,100)})}document.querySelectorAll(".action-btn").forEach(a=>{var n;const r=((n=a.getAttribute("title"))==null?void 0:n.toLowerCase())||"";let s="â—";r.includes("gallery")?s="â–¦":r.includes("audio")?s="â™ª":r.includes("tilt")?s="âŸ²":r.includes("ai")?s="â—‰":r.includes("interactivity")&&(s="âš¡"),a.textContent=s,a.setAttribute("data-icon",s)});const t=document.querySelector(".save-btn");t&&t.setAttribute("data-icon","ğŸ’¾");const o={controls:"âš™",color:"â—",geometry:"â–²",reactivity:"âš¡",export:"ğŸ’¾"};document.querySelectorAll(".bezel-tab").forEach(a=>{const r=a.dataset.tab,s=a.querySelector(".tab-icon");s&&o[r]&&(s.textContent=o[r],s.setAttribute("data-icon",o[r]))}),console.log("âœ… All RGB-split icons initialized")},500)}function ft(){const i=document.getElementById("canvasContainer");if(!i){console.warn("âš ï¸ Canvas container not found");return}i.style.position="fixed",i.style.top="0",i.style.left="0",i.style.right="0",i.style.bottom="0",i.style.width="100vw",i.style.height="100vh",i.style.zIndex="1";const e=i.querySelectorAll("canvas"),t=window.innerWidth,o=window.innerHeight;e.forEach(r=>{r.width=t,r.height=o,r.style.width=`${t}px`,r.style.height=`${o}px`}),window.vib34dApp&&window.vib34dApp.currentEngine&&setTimeout(()=>{window.vib34dApp.currentEngine.handleResize&&window.vib34dApp.currentEngine.handleResize(t,o),window.vib34dApp.currentEngine.render&&window.vib34dApp.currentEngine.render()},100);let a;window.addEventListener("resize",()=>{clearTimeout(a),a=setTimeout(()=>{const r=window.innerWidth,s=window.innerHeight;e.forEach(n=>{n.width=r,n.height=s,n.style.width=`${r}px`,n.style.height=`${s}px`}),window.vib34dApp&&window.vib34dApp.currentEngine&&(window.vib34dApp.currentEngine.handleResize&&window.vib34dApp.currentEngine.handleResize(r,s),window.vib34dApp.currentEngine.render&&window.vib34dApp.currentEngine.render())},150)}),console.log(`ğŸ–¼ï¸ Canvas set to full-screen: ${t}x${o}px`)}function Fo(){window.addEventListener("orientationchange",()=>{setTimeout(()=>{me()},300)}),window.addEventListener("resize",()=>{me()}),setTimeout(()=>{me()},500)}function me(){const i=window.innerWidth>window.innerHeight,e=window.innerHeight<500;i&&e?(document.body.classList.add("projection-mode"),console.log("ğŸ“½ï¸ Projection mode: ON (landscape + short screen)")):document.body.classList.remove("projection-mode")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",He):He();window.fixIconDisplay=gt;window.setupFullScreenCanvas=ft;console.log("ğŸ¨ Layout Polish Module: Loaded (SIMPLIFIED)");console.log("âœ… Canvas is full-screen, UI overlays on top");console.log("ğŸ“½ï¸ Landscape mode auto-hides UI for projection");console.log("ğŸ”¬ System Diagnostics Module: Loading...");let g={modules:{},layout:{},icons:{},performance:{},errors:[]},j=!1,Y=null;function Xe(){console.log("ğŸ”¬ Initializing System Diagnostics..."),Yo(),document.addEventListener("keydown",o=>{o.ctrlKey&&o.shiftKey&&o.key==="D"&&(o.preventDefault(),X())});let i=0,e=null;const t=document.querySelector(".logo");t&&(t.addEventListener("click",o=>{i++,e&&clearTimeout(e),i===3&&(X(),i=0),e=setTimeout(()=>{i=0},1e3)}),console.log("ğŸ“± Mobile: Triple-tap logo to open diagnostics")),Vo(),console.log("âœ… System Diagnostics initialized (auto-run disabled)"),console.log("âŒ¨ï¸ Desktop: Ctrl+Shift+D | Mobile: Triple-tap logo or use floating button")}function pt(){return console.log("ğŸ§ª Running complete diagnostic suite..."),g={modules:{},layout:{},icons:{},performance:{},errors:[],timestamp:new Date().toISOString()},ko(),Wo(),zo(),Bo(),Go(),Oo(),yt(),j&&vt(),console.log("âœ… Diagnostic suite complete"),g}function ko(){console.log("ğŸ“¦ Testing module integration...");const i={switchSystem:"System switching",selectGeometry:"Geometry selection",updateParameter:"Parameter updates",toggleBezelCollapse:"Bezel control",saveToGallery:"Gallery save",openGallery:"Gallery open",randomizeAll:"Randomize all",resetAll:"Reset all",togglePerformanceStats:"Performance stats",toggleShortcutsHelp:"Shortcuts help",copyShareLinkToClipboard:"Share links",captureCurrentState:"State capture",undo:"Undo",redo:"Redo",fixSystemButtonIcons:"Icon fixes",calculateLayout:"Layout calculation",applyLayout:"Layout application",loadGeometryFromIndex:"Geometry loading",getGeometryInfo:"Geometry info",switchCoreType:"Core type switching",createIcon:"Icon creation",replaceAllEmojisWithIcons:"Emoji replacement"};let e=0,t=0;Object.entries(i).forEach(([o,a])=>{typeof window[o]=="function"?(g.modules[o]={status:"OK",description:a},e++):(g.modules[o]={status:"MISSING",description:a},t++,g.errors.push(`Missing function: ${o} (${a})`))}),g.modules.summary={total:Object.keys(i).length,loaded:e,failed:t,percentage:(e/Object.keys(i).length*100).toFixed(1)},console.log(`âœ… Modules: ${e}/${Object.keys(i).length} loaded (${g.modules.summary.percentage}%)`)}function Wo(){console.log("ğŸ“ Testing layout system...");const i=document.querySelector(".top-bar"),e=document.getElementById("canvasContainer"),t=document.getElementById("controlPanel");if(g.layout={topBar:i?{exists:!0,height:i.offsetHeight,computed:window.getComputedStyle(i).height}:{exists:!1},canvasContainer:e?{exists:!0,position:window.getComputedStyle(e).position,top:window.getComputedStyle(e).top,bottom:window.getComputedStyle(e).bottom,width:e.offsetWidth,height:e.offsetHeight,rect:e.getBoundingClientRect()}:{exists:!1},controlPanel:t?{exists:!0,position:window.getComputedStyle(t).position,height:t.offsetHeight,isCollapsed:t.classList.contains("collapsed"),computed:window.getComputedStyle(t).height}:{exists:!1},viewport:{width:window.innerWidth,height:window.innerHeight,isMobile:window.innerWidth<=768,isLandscape:window.innerWidth>window.innerHeight}},e&&t){const o=e.getBoundingClientRect(),a=t.getBoundingClientRect(),r=window.innerHeight-o.bottom-a.height;if(g.layout.gap=r,Math.abs(r)>2&&g.errors.push(`Layout gap detected: ${r}px between canvas and bezel`),o.bottom>a.top){const s=o.bottom-a.top;g.layout.overlap=s,g.errors.push(`Layout overlap detected: ${s}px`)}}console.log("âœ… Layout test complete")}function zo(){console.log("ğŸ¨ Testing icon system...");const i=document.querySelectorAll(".system-btn");let e=0,t=0,o=0;i.forEach((a,r)=>{const s=a.querySelector(".system-icon");if(s){const n=s.querySelector("svg")!==null,l=s.textContent.trim().length>0;n?e++:l?t++:o++}}),g.icons={systemButtons:{total:i.length,svgLoaded:e,fallbackUsed:t,missing:o}},o>0&&g.errors.push(`${o} system buttons missing icons`),console.log(`âœ… Icons: ${e} SVG, ${t} fallback, ${o} missing`)}function Bo(){console.log("âš¡ Testing performance metrics..."),g.performance={memory:performance.memory?{used:(performance.memory.usedJSHeapSize/1024/1024).toFixed(2)+" MB",total:(performance.memory.totalJSHeapSize/1024/1024).toFixed(2)+" MB",limit:(performance.memory.jsHeapSizeLimit/1024/1024).toFixed(2)+" MB"}:"Not available",timing:performance.timing?{loadTime:performance.timing.loadEventEnd-performance.timing.navigationStart+" ms",domReady:performance.timing.domContentLoadedEventEnd-performance.timing.navigationStart+" ms"}:"Not available",fps:window.getPerformanceStats?window.getPerformanceStats().fps:"Not available"},console.log("âœ… Performance metrics collected")}function Go(){console.log("ğŸ“± Testing responsiveness...");const i=window.innerWidth<=768,e=document.body.classList.contains("mobile-layout");if(g.layout.responsiveness={isMobile:i,hasMobileClass:e,properlyConfigured:i===e,touchTargets:[]},i){const t=document.querySelectorAll(".system-btn, .action-btn, .geom-btn, .bezel-tab");let o=0;t.forEach(a=>{const r=a.getBoundingClientRect();Math.min(r.width,r.height)<44&&(o++,g.layout.responsiveness.touchTargets.push({element:a.className,width:r.width,height:r.height,tooSmall:!0}))}),o>0&&g.errors.push(`${o} touch targets smaller than 44px`)}console.log("âœ… Responsiveness test complete")}function Oo(){console.log("ğŸ¯ Testing event listeners..."),g.events={bezelToggle:typeof window.toggleBezelCollapse=="function",systemSwitch:typeof window.switchSystem=="function",geometrySelect:typeof window.selectGeometry=="function",parameterUpdate:typeof window.updateParameter=="function"},console.log("âœ… Event listener test complete")}function yt(){var e,t;const i={timestamp:g.timestamp,summary:{totalErrors:g.errors.length,modulesLoaded:((e=g.modules.summary)==null?void 0:e.percentage)||0,layoutStatus:g.layout.gap!==void 0?Math.abs(g.layout.gap)<=2?"OK":"WARNING":"UNKNOWN",iconsStatus:((t=g.icons.systemButtons)==null?void 0:t.missing)===0?"OK":"WARNING",performanceStatus:"OK"},details:g};return console.log(`
`+"=".repeat(50)),console.log("ğŸ“Š DIAGNOSTIC REPORT"),console.log("=".repeat(50)),console.log(`Timestamp: ${i.timestamp}`),console.log(`Errors: ${i.summary.totalErrors}`),console.log(`Modules: ${i.summary.modulesLoaded}%`),console.log(`Layout: ${i.summary.layoutStatus}`),console.log(`Icons: ${i.summary.iconsStatus}`),console.log("=".repeat(50)+`
`),g.errors.length>0?(console.log("âš ï¸ ERRORS DETECTED:"),g.errors.forEach((o,a)=>{console.log(`  ${a+1}. ${o}`)}),console.log("")):console.log(`âœ… NO ERRORS DETECTED
`),i}function Yo(){Y=document.createElement("div"),Y.id="system-diagnostics-overlay",Y.style.cssText=`
        position: fixed;
        top: 70px;
        left: 10px;
        right: 10px;
        max-width: 600px;
        max-height: calc(100vh - 140px);
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid #00ffff;
        border-radius: 10px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.7rem;
        color: #00ff00;
        z-index: 10002;
        display: none;
        overflow-y: auto;
        line-height: 1.4;
    `;const i=document.createElement("button");i.textContent="Ã— Close",i.style.cssText=`
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 0, 0, 0.8);
        border: 1px solid #ff0000;
        color: #fff;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: bold;
    `,i.onclick=()=>X(),Y.appendChild(i);const e=document.createElement("div");e.id="debug-content",e.style.marginTop="35px",Y.appendChild(e),document.body.appendChild(Y)}function Vo(){const i=document.createElement("button");i.id="floating-debug-btn",i.innerHTML="ğŸ”¬",i.title="Open Diagnostics",i.style.cssText=`
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 255, 0.3));
        border: 2px solid rgba(0, 255, 255, 0.5);
        border-radius: 50%;
        color: #00ffff;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        backdrop-filter: blur(10px);
    `,i.addEventListener("click",()=>{X()}),i.addEventListener("touchstart",e=>{e.preventDefault(),i.style.transform="scale(0.9)"}),i.addEventListener("touchend",e=>{e.preventDefault(),i.style.transform="scale(1)",X()}),document.body.appendChild(i),console.log("âœ… Floating debug button added (bottom-right corner)")}function X(){j=!j,Y.style.display=j?"block":"none",j&&(pt(),vt())}function vt(){var o,a,r,s,n,l,c,d,u,m,f,h;const i=document.getElementById("debug-content");if(!i)return;const e=yt();let t=`
        <div style="color: #00ffff; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #00ffff; padding-bottom: 5px;">
            ğŸ”¬ SYSTEM DIAGNOSTICS
        </div>

        <div style="margin-bottom: 15px;">
            <div style="color: #ffff00;">â±ï¸ Timestamp:</div>
            <div style="margin-left: 15px;">${e.timestamp}</div>
        </div>

        <div style="margin-bottom: 15px;">
            <div style="color: #ffff00;">ğŸ“Š Summary:</div>
            <div style="margin-left: 15px;">
                Errors: <span style="color: ${e.summary.totalErrors===0?"#00ff00":"#ff0000"}">${e.summary.totalErrors}</span><br>
                Modules: <span style="color: ${e.summary.modulesLoaded>=90?"#00ff00":"#ffff00"}">${e.summary.modulesLoaded}%</span><br>
                Layout: <span style="color: ${e.summary.layoutStatus==="OK"?"#00ff00":"#ffff00"}">${e.summary.layoutStatus}</span><br>
                Icons: <span style="color: ${e.summary.iconsStatus==="OK"?"#00ff00":"#ffff00"}">${e.summary.iconsStatus}</span>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <div style="color: #ffff00;">ğŸ“ Layout:</div>
            <div style="margin-left: 15px; font-size: 0.7rem;">
                Viewport: ${(o=g.layout.viewport)==null?void 0:o.width}x${(a=g.layout.viewport)==null?void 0:a.height}<br>
                Mobile: ${(r=g.layout.viewport)!=null&&r.isMobile?"Yes":"No"}<br>
                Canvas: ${(s=g.layout.canvasContainer)==null?void 0:s.width}x${(n=g.layout.canvasContainer)==null?void 0:n.height}<br>
                Bezel: ${(l=g.layout.controlPanel)==null?void 0:l.height}px (${(c=g.layout.controlPanel)!=null&&c.isCollapsed?"Collapsed":"Expanded"})<br>
                Gap: <span style="color: ${Math.abs(g.layout.gap||0)<=2?"#00ff00":"#ff0000"}">${((d=g.layout.gap)==null?void 0:d.toFixed(2))||"N/A"}px</span>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <div style="color: #ffff00;">ğŸ¨ Icons:</div>
            <div style="margin-left: 15px; font-size: 0.7rem;">
                SVG Loaded: ${((u=g.icons.systemButtons)==null?void 0:u.svgLoaded)||0}<br>
                Fallback: ${((m=g.icons.systemButtons)==null?void 0:m.fallbackUsed)||0}<br>
                Missing: <span style="color: ${((f=g.icons.systemButtons)==null?void 0:f.missing)===0?"#00ff00":"#ff0000"}">${((h=g.icons.systemButtons)==null?void 0:h.missing)||0}</span>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <div style="color: #ffff00;">âš¡ Performance:</div>
            <div style="margin-left: 15px; font-size: 0.7rem;">
                ${typeof g.performance.memory=="object"?`Memory: ${g.performance.memory.used} / ${g.performance.memory.total}`:"Memory: N/A"}<br>
                FPS: ${g.performance.fps||"N/A"}
            </div>
        </div>
    `;g.errors.length>0&&(t+=`
            <div style="margin-bottom: 15px;">
                <div style="color: #ff0000; font-weight: bold;">âš ï¸ ERRORS (${g.errors.length}):</div>
                <div style="margin-left: 15px; font-size: 0.7rem; color: #ff8888;">
                    ${g.errors.map((y,w)=>`${w+1}. ${y}`).join("<br>")}
                </div>
            </div>
        `),t+=`
        <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #333; text-align: center; font-size: 0.65rem; color: #666;">
            Press Ctrl+Shift+D to close â€¢ Auto-refresh in diagnostics
        </div>
    `,i.innerHTML=t}window.runCompleteDiagnostics=pt;window.toggleDebugOverlay=X;window.getDiagnosticResults=()=>g;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Xe):Xe();console.log("ğŸ”¬ System Diagnostics Module: Loaded");console.log("âŒ¨ï¸ Press Ctrl+Shift+D to toggle debug overlay");console.log("â³ Loading States Module: Loading...");let wt=!1;function Uo(){console.log("â³ Initializing Loading States System..."),wt=!0,console.log("âœ… Loading States System initialized (DISABLED FOR DEBUGGING)")}function qo(i,e){const t=document.getElementById("loading-progress-fill"),o=document.getElementById("loading-text");t&&(t.style.width=`${e}%`),o&&(o.textContent=i);const a=document.getElementById("loading-steps");if(a){const r=document.createElement("div");r.style.cssText=`
            padding: 4px 0;
            animation: fadeIn 0.3s ease-out;
            color: rgba(0, 255, 0, 0.7);
        `,r.innerHTML=`âœ“ ${i}`,a.appendChild(r);const s=a.children;s.length>5&&a.removeChild(s[0])}console.log(`â³ Loading: ${e}% - ${i}`)}function Ho(){}function Xo(i){}window.updateLoadingProgress=qo;window.hideLoadingOverlay=Ho;window.showErrorState=Xo;window.isLoadingComplete=()=>wt;Uo();console.log("â³ Loading States Module: Loaded");console.log("ğŸ§ª Visual Test Suite: Loading...");let E={passed:0,failed:0,warnings:0,tests:[]};function Ne(){console.log("ğŸ§ª Initializing Visual Test Suite..."),console.log("âœ… Visual Test Suite initialized (auto-run disabled)"),console.log("ğŸ’¡ Run window.runAllVisualTests() manually when needed")}function No(){return console.log("ğŸ§ª Running visual tests..."),E={passed:0,failed:0,warnings:0,tests:[],timestamp:new Date().toISOString()},Zo(),jo(),Ko(),Qo(),Jo(),ei(),ti(),oi(),ii(),console.log("âœ… Visual tests complete"),E}function Zo(){const i=document.querySelector(".top-bar");if(!i){p("Header Layout",!1,"Top bar element not found");return}const e=i.getBoundingClientRect(),t=window.getComputedStyle(i);e.top===0?p("Header Position",!0):p("Header Position",!1,`Header not at top (${e.top}px)`);const o=e.height;o>=50&&o<=100?p("Header Height",!0):p("Header Height",!1,`Header height out of range: ${o}px`),t.position==="fixed"?p("Header Fixed Position",!0):p("Header Fixed Position",!1,`Header position is ${t.position}`);const a=i.querySelectorAll(".system-btn");a.length===4?p("System Buttons Count",!0):p("System Buttons Count",!1,`Found ${a.length} buttons, expected 4`)}function jo(){const i=document.getElementById("controlPanel");if(!i){p("Bezel Layout",!1,"Control panel not found");return}const e=i.getBoundingClientRect();window.getComputedStyle(i);const t=i.classList.contains("collapsed"),a=window.innerHeight-e.bottom;Math.abs(a)<=2?p("Bezel Bottom Position",!0):p("Bezel Bottom Position",!1,`Gap from bottom: ${a.toFixed(2)}px`),t&&(e.height>=48&&e.height<=56?p("Bezel Collapsed Height",!0):p("Bezel Collapsed Height",!1,`Height: ${e.height}px (expected 48-56px)`));const r=i.querySelectorAll(".bezel-tab");r.length===5?p("Bezel Tabs Count",!0):p("Bezel Tabs Count",!1,`Found ${r.length} tabs, expected 5`)}function Ko(){const i=document.getElementById("canvasContainer"),e=document.querySelector(".top-bar"),t=document.getElementById("controlPanel");if(!i||!e||!t){p("Canvas Layout",!1,"Required elements not found");return}const o=i.getBoundingClientRect(),a=e.getBoundingClientRect(),r=t.getBoundingClientRect(),s=a.bottom,n=r.top,l=Math.abs(o.top-s),c=Math.abs(o.bottom-n);if(l<=2&&c<=2?p("Canvas Fills Viewport",!0):p("Canvas Fills Viewport",!1,`Top gap: ${l.toFixed(2)}px, Bottom gap: ${c.toFixed(2)}px`),o.bottom<=r.top+2)p("No Canvas-Bezel Overlap",!0);else{const d=o.bottom-r.top;p("No Canvas-Bezel Overlap",!1,`Overlap: ${d.toFixed(2)}px`)}}function Qo(){const i=document.querySelectorAll(".system-btn");let e=0;i.forEach(t=>{const o=t.querySelector(".system-icon");if(o){const a=o.querySelector("svg")!==null,r=o.textContent.trim().length>0;a||r||e++}}),e===0?p("All Icons Rendered",!0):p("All Icons Rendered",!1,`${e} icons are empty`),i.forEach((t,o)=>{const a=t.querySelector(".system-icon");if(a){const r=window.getComputedStyle(a);r.display!=="none"&&r.visibility!=="hidden"?p(`Icon ${o+1} Visible`,!0):p(`Icon ${o+1} Visible`,!1,"Icon hidden by CSS")}})}function Jo(){if(window.innerWidth<=768){p("Mobile Layout Detection",!0,"Mobile viewport detected");const t=document.querySelectorAll(".system-btn, .action-btn, .bezel-tab");let o=0;t.forEach(a=>{const r=a.getBoundingClientRect();Math.min(r.width,r.height)<44&&o++}),o===0?p("Mobile Touch Targets",!0):p("Mobile Touch Targets",!1,`${o} buttons smaller than 44px`)}else p("Desktop Layout",!0,"Desktop viewport detected")}function ei(){const i=document.querySelectorAll('[style*="animation"], [class*="animate"]');i.length>0?p("Animations Present",!0,`${i.length} animated elements`):p("Animations Present",!1,"No animations detected",!0),i.forEach((e,t)=>{const o=window.getComputedStyle(e),a=parseFloat(o.animationDuration);a>0&&a<=5?p(`Animation ${t+1} Duration`,!0):a>5&&p(`Animation ${t+1} Duration`,!1,`Animation too long: ${a}s`,!0)})}function ti(){const i=document.querySelectorAll("button");let e=0;i.forEach(o=>{const a=o.textContent.trim().length>0,r=o.hasAttribute("aria-label"),s=o.hasAttribute("title");!a&&!r&&!s&&e++}),e===0?p("Accessible Buttons",!0):p("Accessible Buttons",!1,`${e} buttons lack labels`,!0);const t=document.querySelectorAll("button, a, input, [tabindex]");p("Focusable Elements",!0,`${t.length} focusable elements`)}function oi(){document.querySelectorAll(".logo, .section-title, .control-label").forEach(e=>{const t=window.getComputedStyle(e);t.color,t.backgroundColor}),p("Color Contrast",!0,"Manual review recommended",!0)}function p(i,e,t="",o=!1){const a={name:i,passed:e,message:t,isWarning:o};E.tests.push(a),o?E.warnings++:e?E.passed++:E.failed++;const r=e?"âœ…":o?"âš ï¸":"âŒ",s=t?` - ${t}`:"";console.log(`${r} ${i}${s}`)}function ii(){const i=E.tests.length,e=i>0?(E.passed/i*100).toFixed(1):0;return console.log(`
`+"=".repeat(60)),console.log("ğŸ§ª VISUAL TEST REPORT"),console.log("=".repeat(60)),console.log(`Timestamp: ${E.timestamp}`),console.log(`Total Tests: ${i}`),console.log(`âœ… Passed: ${E.passed}`),console.log(`âŒ Failed: ${E.failed}`),console.log(`âš ï¸ Warnings: ${E.warnings}`),console.log(`Pass Rate: ${e}%`),console.log("=".repeat(60)),E.failed>0&&(console.log(`
âŒ FAILED TESTS:`),E.tests.filter(t=>!t.passed&&!t.isWarning).forEach(t=>{console.log(`  â€¢ ${t.name}: ${t.message||"Failed"}`)})),E.warnings>0&&(console.log(`
âš ï¸ WARNINGS:`),E.tests.filter(t=>t.isWarning).forEach(t=>{console.log(`  â€¢ ${t.name}: ${t.message||"Warning"}`)})),console.log(`
`+"=".repeat(60)+`
`),E}window.runAllVisualTests=No;window.getVisualTestResults=()=>E;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ne):Ne();console.log("ğŸ§ª Visual Test Suite: Loaded");(async function(){try{console.log("ğŸ“¦ Starting system imports...");const i=(await x(async()=>{const{default:h}=await Promise.resolve().then(()=>ui);return{default:h}},void 0,import.meta.url)).default;console.log("âœ… VIB34DApp imported");let e,t,o,a,r,s,n,l,c,d;try{e=(await x(()=>Promise.resolve().then(()=>wi),void 0,import.meta.url)).VIB34DIntegratedEngine,console.log("âœ… VIB34DIntegratedEngine imported")}catch(h){console.warn("âš ï¸ VIB34DIntegratedEngine not available:",h.message)}try{t=(await x(()=>Promise.resolve().then(()=>xi),void 0,import.meta.url)).QuantumEngine,console.log("âœ… QuantumEngine imported")}catch(h){console.warn("âš ï¸ QuantumEngine not available:",h.message)}try{o=(await x(()=>Promise.resolve().then(()=>Ti),void 0,import.meta.url)).RealHolographicSystem,console.log("âœ… RealHolographicSystem imported")}catch(h){console.warn("âš ï¸ RealHolographicSystem not available:",h.message)}try{const h=await x(()=>Promise.resolve().then(()=>Di),void 0,import.meta.url);NewPolychoraEngine=h.NewPolychoraEngine,console.log("âœ… NEW 4D Polychora Engine imported with VIB34D DNA")}catch(h){console.warn("âš ï¸ New Polychora Engine not available:",h.message);try{const y=await x(()=>Promise.resolve().then(()=>_i),void 0,import.meta.url);NewPolychoraEngine=y.PolychoraSystem,console.log("âœ… Fallback to old PolychoraSystem")}catch(y){console.warn("âš ï¸ No Polychora system available:",y.message)}}try{l=(await x(()=>Promise.resolve().then(()=>xt),void 0,import.meta.url)).CanvasManager}catch{console.warn("âš ï¸ CanvasManager not available - using stub")}try{const h=await x(()=>Promise.resolve().then(()=>$i),void 0,import.meta.url);UnifiedReactivityManager=h.UnifiedReactivityManager,console.log("âœ… UnifiedReactivityManager imported")}catch{console.warn("âš ï¸ UnifiedReactivityManager not available")}try{d=(await x(()=>Promise.resolve().then(()=>Ct),void 0,import.meta.url)).ReactivityManager}catch{console.warn("âš ï¸ ReactivityManager not available - using stub")}if(window.engineClasses={VIB34DIntegratedEngine:e,QuantumEngine:t,RealHolographicSystem:o,NewPolychoraEngine},console.log("ğŸ“¦ Engine classes stored:",Object.keys(window.engineClasses).filter(h=>window.engineClasses[h])),UnifiedReactivityManager){const h=new UnifiedReactivityManager;console.log("âœ… UnifiedReactivityManager initialized")}else window.getCurrentReactivityState=function(){var h;return{system:window.currentSystem||"faceted",mouse:{faceted:!0,quantum:!1,holographic:!1,polychora:!1,mixed:!1},click:{faceted:!0,quantum:!1,holographic:!1,polychora:!1,mixed:!1},scroll:{faceted:!0,quantum:!1,holographic:!1,polychora:!1,mixed:!1},audio:window.audioEnabled||!1,interactivity:window.interactivityEnabled!==!1,deviceTilt:((h=window.deviceTiltHandler)==null?void 0:h.isEnabled)||!1}},console.log("âš ï¸ Using fallback getCurrentReactivityState");const u=new i;window.vib34dApp=u,await u.initialize(),window.syncVisualizerToUI?console.log("âœ… Essential functions available globally"):console.error("ğŸš¨ CRITICAL: syncVisualizerToUI not available globally after app init");const m=window.currentSystem||"faceted";if(window.switchSystem&&await window.switchSystem(m),window.setupGeometry&&window.setupGeometry(m),window.moduleReady=!0,document.body.classList.remove("loading"),console.log("ğŸš€ VIB34D Clean Architecture System Loaded"),new URLSearchParams(window.location.search).has("testing-mode")){let y=function(){const w=document.getElementById("test-results");let T=0,C=0;function b(L,S){C++,S&&T++;const de=document.createElement("div");de.style.cssText=`color: ${S?"#00ff00":"#ff4444"}; margin: 2px 0;`,de.innerHTML=`${S?"âœ…":"âŒ"} ${L}`,w.appendChild(de)}b("window.switchSystem available",typeof window.switchSystem=="function"),b("window.selectGeometry available",typeof window.selectGeometry=="function"),b("window.updateParameter available",typeof window.updateParameter=="function"),b("window.randomizeAll available",typeof window.randomizeAll=="function"),b("window.resetAll available",typeof window.resetAll=="function"),b("Canvas Container exists",!!document.getElementById("canvasContainer")),b("Control Panel exists",!!document.getElementById("controlPanel")),b("Panel Header exists",!!document.getElementById("panelHeader")),b("Faceted Layers exist",!!document.getElementById("vib34dLayers")),["rot4dXW","rot4dYW","rot4dZW","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation"].forEach(L=>{const S=document.getElementById(L);b(`${L} slider exists`,!!S)}),["faceted","quantum","holographic","polychora"].forEach(L=>{const S=document.querySelector(`[data-system="${L}"]`);b(`${L} button exists`,!!S)});const A=(T/C*100).toFixed(1),P=document.createElement("div");P.style.cssText=`
                        color: ${A>=90?"#00ff00":A>=70?"#ffff00":"#ff4444"};
                        font-weight: bold;
                        margin-top: 10px;
                        padding: 10px;
                        border-top: 1px solid #333;
                    `,P.innerHTML=`
                        <div>ğŸ“Š RESULT: ${T}/${C} (${A}%)</div>
                        <div>${A>=90?"âœ… ARCHITECTURE READY":A>=70?"âš ï¸ NEEDS FIXES":"âŒ CRITICAL ISSUES"}</div>
                    `,w.appendChild(P),console.log(`ğŸ§ª Architecture test complete: ${T}/${C} passed (${A}%)`)};console.log("ğŸ§ª TESTING MODE: Running architecture validation...");const h=document.createElement("div");h.id="test-overlay",h.style.cssText=`
                        position: fixed;
                        top: 60px;
                        left: 20px;
                        width: 400px;
                        max-height: 80vh;
                        overflow-y: auto;
                        background: rgba(0, 0, 0, 0.95);
                        border: 2px solid #00ffff;
                        border-radius: 10px;
                        padding: 15px;
                        font-family: 'Orbitron', monospace;
                        font-size: 0.8rem;
                        color: #fff;
                        z-index: 9999;
                    `,h.innerHTML=`
                        <h3 style="color: #00ffff; margin-bottom: 10px;">ğŸ§ª ARCHITECTURE TEST</h3>
                        <div id="test-results"></div>
                    `,document.body.appendChild(h),setTimeout(y,1e3)}}catch(i){console.error("âŒ Failed to initialize VIB34D system:",i),document.body.classList.remove("loading");const e=document.createElement("div");e.style.cssText=`
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 0, 0, 0.9);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    font-family: 'Orbitron', monospace;
                    z-index: 10000;
                    max-width: 80vw;
                `,e.innerHTML=`
                    <h3>âŒ VIB34D Initialization Failed</h3>
                    <p>${i.message}</p>
                    <small>Check console for details</small>
                `,document.body.appendChild(e)}})();class ai{constructor(e){this.engine=e,this.storageKey="vib34d-unified-variations",this.collectionStorageKey="vib34d-unified-collections",this.maxVariations=1e4,this.variations=[],this.collections=new Map,this.loadFromStorage()}async save(e={}){const t=this.captureCurrentState();switch(t.id=this.generateUniqueId(),t.timestamp=Date.now(),t.created=new Date().toISOString(),e.target||"gallery"){case"localStorage":return this.saveToLocalStorage(t);case"download":return this.saveToDownload(t,e.format||"json");case"gallery":return this.saveToGallery(t);case"collection":return this.saveToCollection(t,e.collectionName);case"share":return this.saveForSharing(t);default:return this.saveToGallery(t)}}captureCurrentState(){var o;const e=window.currentSystem||"faceted";console.log("ğŸ”µ UnifiedSaveManager capturing state for system:",e),console.log("ğŸ” Available global objects:",{engine:!!window.engine,quantumEngine:!!window.quantumEngine,holographicSystem:!!window.holographicSystem,userParameterState:!!window.userParameterState,currentSystem:window.currentSystem});const t={system:e,name:this.generateVariationName(),parameters:{},metadata:{}};if(t.parameters=this.getSystemParameters(e),!t.parameters||Object.keys(t.parameters).length===0)console.warn("âš ï¸ No parameters captured via system methods, using manual fallback"),t.parameters=this.captureManualParameters();else{const a=this.captureManualParameters(),r=["geometry","rot4dXW","rot4dYW","rot4dZW","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation"];let s=0;r.forEach(n=>{t.parameters[n]===void 0&&a[n]!==void 0&&(t.parameters[n]=a[n],s++)}),s>0&&console.log(`ğŸ” Added ${s} missing core parameters from manual capture`)}return t.metadata={timestamp:Date.now(),engine:"VIB34D Unified",version:"3.0",author:"VIB34D User",device:navigator.userAgent,toggleStates:{audioEnabled:window.audioEnabled||!1,interactivityEnabled:window.interactivityEnabled||!1,deviceTiltEnabled:((o=window.deviceTiltHandler)==null?void 0:o.isEnabled)||!1,reactivityMode:window.getCurrentReactivityState()}},console.log("ğŸ”µ Final captured state:",t),console.log(`ğŸ” Final parameter count: ${Object.keys(t.parameters).length} parameters`),t}getSystemParameters(e){var a,r,s,n,l,c,d,u,m,f,h,y;let t=null,o="unknown";try{switch(e){case"faceted":(r=(a=this.engine)==null?void 0:a.parameterManager)!=null&&r.getAllParameters?(t=this.engine.parameterManager.getAllParameters(),o="this.engine.parameterManager.getAllParameters()"):(n=(s=window.engine)==null?void 0:s.parameterManager)!=null&&n.getAllParameters?(t=window.engine.parameterManager.getAllParameters(),o="window.engine.parameterManager.getAllParameters()"):(c=(l=window.facetedEngine)==null?void 0:l.parameterManager)!=null&&c.getAllParameters&&(t=window.facetedEngine.parameterManager.getAllParameters(),o="window.facetedEngine.parameterManager.getAllParameters()");break;case"quantum":(d=this.engine)!=null&&d.getParameters?(t=this.engine.getParameters(),o="this.engine.getParameters()"):(u=window.quantumEngine)!=null&&u.getParameters&&(t=window.quantumEngine.getParameters(),o="window.quantumEngine.getParameters()");break;case"holographic":(m=window.holographicSystem)!=null&&m.getParameters&&(t=window.holographicSystem.getParameters(),o="window.holographicSystem.getParameters()");break;case"polychora":(f=window.newPolychoraEngine)!=null&&f.getParameters?(t=window.newPolychoraEngine.getParameters(),o="window.newPolychoraEngine.getParameters()"):(y=(h=window.newPolychoraEngine)==null?void 0:h.parameters)!=null&&y.getAllParameters&&(t=window.newPolychoraEngine.parameters.getAllParameters(),o="window.newPolychoraEngine.parameters.getAllParameters()");break;default:console.warn(`âš ï¸ Unknown system: ${e}`);break}}catch(w){console.error(`âŒ Error capturing ${e} parameters:`,w),t=null,o="error-occurred"}if(t&&typeof t=="object"){const w=Object.keys(t).length;if(w>0)return console.log(`âœ… Successfully captured ${w} parameters for ${e} via ${o}`),console.log(`ğŸ” ${e} parameters:`,t),t;console.warn(`âš ï¸ ${e} returned empty parameters object via ${o}`)}else console.warn(`âš ï¸ ${e} system parameters not available via ${o}`);return null}captureManualParameters(){const e={};let t="unknown";try{window.userParameterState&&typeof window.userParameterState=="object"&&(Object.assign(e,window.userParameterState),t="global-userParameterState",console.log("ğŸ”µ Using global userParameterState for parameter capture"));let a=null;const r=[".geom-btn.active",".geometry-btn.active","[data-geometry].active"];for(const d of r){const u=document.querySelector(d);if(u){const m=u.dataset.index||u.dataset.geometry;if(m!==void 0){a=parseInt(m);break}}}a!==null&&(e.geometry=a,e.geometryType=a,t=t==="unknown"?"DOM-geometry":`${t}+DOM-geometry`);const s=["rot4dXW","rot4dYW","rot4dZW","rot4dXY","rot4dXZ","rot4dYZ","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation","dimension"];let n=0;s.forEach(d=>{const u=document.getElementById(d);if(u&&u.value!==void 0){const m=parseFloat(u.value);!isNaN(m)&&(e[d]===void 0||t==="unknown")&&(e[d]=m,n++)}}),n>0&&(t=t==="unknown"?"DOM-sliders":`${t}+DOM-sliders`);const l={geometry:0,geometryType:0,rot4dXW:0,rot4dYW:0,rot4dZW:0,gridDensity:20,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.7,saturation:.8};let c=0;Object.entries(l).forEach(([d,u])=>{(e[d]===void 0||isNaN(e[d]))&&(e[d]=u,c++)}),c>0&&(t=`${t}+defaults(${c})`)}catch(a){console.error("âŒ Error during manual parameter capture:",a),t="error-fallback",Object.assign(e,{geometry:0,geometryType:0,rot4dXW:0,rot4dYW:0,rot4dZW:0,gridDensity:20,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.7,saturation:.8})}const o=Object.keys(e).length;return console.log(`ğŸ”µ Manual parameter capture complete: ${o} parameters via ${t}`,e),e}initializeSystemWithParameters(e,t){console.log(`ğŸ”µ Initializing ${e} system with parameters:`,t);try{if(window.userParameterState&&t&&(Object.assign(window.userParameterState,t),console.log("ğŸ”µ Updated global userParameterState")),window.syncSlidersToStoredValues&&setTimeout(()=>{window.syncSlidersToStoredValues(),console.log("ğŸ”µ Synced UI sliders to parameters")},100),t.geometry!==void 0){const o=parseInt(t.geometry);!isNaN(o)&&o>=0&&o<=7&&setTimeout(()=>{window.selectGeometry&&(window.selectGeometry(o),console.log(`ğŸ”µ Set geometry to ${o}`))},150)}return setTimeout(()=>{if(window.syncVisualizerToUI){const o=this.getCurrentEngine(e);o&&(window.syncVisualizerToUI(e,o),console.log(`ğŸ”µ Force-synced ${e} visualizer`))}},200),setTimeout(()=>{window.updateParameter&&t&&(Object.entries(t).forEach(([o,a])=>{typeof a=="number"&&!isNaN(a)&&window.updateParameter(o,a)}),console.log(`ğŸ”µ Applied ${Object.keys(t).length} parameters individually`))},250),!0}catch(o){return console.error(`âŒ Error initializing ${e} with parameters:`,o),!1}}getCurrentEngine(e){try{switch(e){case"faceted":return window.engine||window.facetedEngine||this.engine;case"quantum":return window.quantumEngine;case"holographic":return window.holographicSystem||window.holographicEngine;case"polychora":return console.warn("âš ï¸ Polychora system excluded - no engine available"),null;default:return null}}catch(t){return console.error(`âŒ Error getting ${e} engine:`,t),null}}saveToLocalStorage(e){this.variations.push(e),this.variations.length>this.maxVariations&&(this.variations=this.variations.slice(-this.maxVariations));try{return localStorage.setItem(this.storageKey,JSON.stringify(this.variations)),console.log("âœ… Saved variation to localStorage:",e.name),{success:!0,id:e.id}}catch(t){return console.error("âŒ Failed to save to localStorage:",t),{success:!1,error:t.message}}}async saveToGallery(e){const t=this.saveToLocalStorage(e);if(!t.success)return t;const a=`custom-saves-${new Date().toISOString().split("T")[0]}`,r=new Date().toLocaleDateString();let s=this.collections.get(a);s||(console.log(`ğŸ“… Creating new daily collection: ${a}`),s={name:`Custom Saves - ${r}`,description:`Custom variations saved on ${r}`,version:"1.0",type:"holographic-collection",profileName:"VIB34D User",totalVariations:0,created:e.created,updated:e.created,filename:a,variations:[]},this.collections.set(a,s));const n={id:s.variations.length,name:e.name,isCustom:!0,globalId:e.id,system:e.system,parameters:this.normalizeParameters(e.parameters)};return s.variations.push(n),s.totalVariations=s.variations.length,s.updated=new Date().toISOString(),console.log(`ğŸ“ Added variation to daily collection. Total in ${a}: ${s.totalVariations}`),this.saveCollectionsToStorage(),this.engine.statusManager&&this.engine.statusManager.success(`âœ… Saved to Gallery!<br><strong>${e.name}</strong><br>Added to: ${s.name}<br>Total today: ${s.totalVariations}<br><small>Gallery will update automatically</small>`),this.emitGalleryUpdate(e),{success:!0,id:e.id,collection:a,totalInCollection:s.totalVariations}}saveToDownload(e,t="json"){let o,a,r;switch(t){case"json":o=JSON.stringify(e,null,2),a=`vib34d-${e.id}.json`,r="application/json";break;case"collection":const c=this.createCollectionFormat([e]);o=JSON.stringify(c,null,2),a=`collection-${e.id}.json`,r="application/json";break;default:throw new Error(`Unsupported format: ${t}`)}const s=new Blob([o],{type:r}),n=URL.createObjectURL(s),l=document.createElement("a");return l.href=n,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n),console.log(`ğŸ“¥ Downloaded ${a}`),{success:!0,filename:a}}saveToCollection(e,t="My Collection"){let o=this.collections.get(t);return o||(o=this.createCollectionFormat([],t),this.collections.set(t,o)),o.variations.push({id:o.variations.length,name:e.name,isCustom:!0,globalId:e.id,system:e.system,parameters:this.normalizeParameters(e.parameters)}),o.totalVariations=o.variations.length,o.updated=new Date().toISOString(),this.saveCollectionsToStorage(),console.log(`ğŸ“ Added to collection "${t}":`,e.name),{success:!0,collection:t,id:e.id}}saveForSharing(e){this.saveToLocalStorage(e);const t=window.location.origin+window.location.pathname.replace("index.html",""),o=new URLSearchParams;o.set("id",e.id),o.set("system",e.system),Object.entries(e.parameters).forEach(([r,s])=>{s!=null&&o.set(r,s)});const a=`${t}share.html?${o.toString()}`;return navigator.clipboard&&(navigator.clipboard.writeText(a),this.engine.statusManager&&this.engine.statusManager.success(`ğŸ”— Share URL copied!<br><small>${a}</small>`)),{success:!0,url:a,id:e.id}}normalizeParameters(e){const t={};return t.geometry=e.geometry||e.geometryType||0,t.gridDensity=e.gridDensity||e.density||10,t.morphFactor=e.morphFactor||e.morph||0,t.speed=e.speed||1,t.chaos=e.chaos||0,t.hue=e.hue||200,t.saturation=e.saturation||.8,t.intensity=e.intensity||.5,t.rot4dXW=e.rot4dXW||0,t.rot4dYW=e.rot4dYW||0,t.rot4dZW=e.rot4dZW||0,t.dimension=e.dimension||3.8,t.rot4dXY=e.rot4dXY||0,t.rot4dXZ=e.rot4dXZ||0,t.rot4dYZ=e.rot4dYZ||0,t.geometryType=t.geometry,t.density=t.gridDensity,t.morph=t.morphFactor,t}createCollectionFormat(e=[],t="Unnamed Collection"){return{name:t,description:"VIB34D Unified Collection",version:"1.0",type:"holographic-collection",profileName:"VIB34D System",totalVariations:e.length,created:new Date().toISOString(),updated:new Date().toISOString(),variations:e.map((o,a)=>({id:a,name:o.name,isCustom:!0,globalId:o.id||this.generateUniqueId(),system:o.system,parameters:this.normalizeParameters(o.parameters||{})}))}}loadFromStorage(){try{const e=localStorage.getItem(this.storageKey);e&&(this.variations=JSON.parse(e),console.log(`ğŸ“‚ Loaded ${this.variations.length} variations from storage`));const t=localStorage.getItem(this.collectionStorageKey);if(t){const o=JSON.parse(t);this.collections=new Map(o),console.log(`ğŸ“ Loaded ${this.collections.size} collections from storage`)}}catch(e){console.error("Failed to load from storage:",e)}}saveCollectionsToStorage(){try{const e=Array.from(this.collections.entries());localStorage.setItem(this.collectionStorageKey,JSON.stringify(e))}catch(e){console.error("Failed to save collections:",e)}}emitGalleryUpdate(e){const t=new CustomEvent("vib34d-gallery-update",{detail:{variation:e,timestamp:Date.now()}});window.dispatchEvent(t)}generateUniqueId(){return`V${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateVariationName(){const e={faceted:"FACETED",holographic:"HOLO",polychora:"POLY"},t=window.currentSystem||"faceted",o=e[t]||"CUSTOM",a=new Date().toTimeString().split(" ")[0].replace(/:/g,"");return`${o}-${a}`}getAllVariations(){return this.variations}getAllCollections(){return Array.from(this.collections.values())}clearAll(){this.variations=[],this.collections.clear(),localStorage.removeItem(this.storageKey),localStorage.removeItem(this.collectionStorageKey),console.log("ğŸ—‘ï¸ Cleared all saved data")}}const ri=Object.freeze(Object.defineProperty({__proto__:null,UnifiedSaveManager:ai},Symbol.toStringTag,{value:"Module"}));class bt{static async createCard(e,t="classic",o={}){try{console.log(`ğŸ´ Creating ${t} trading card for ${e} system...`);const r=await(await this.getGenerator(e)).generateCard(t,o);return r.filename&&r.content?(this.downloadCard(r.filename,r.content),console.log(`âœ… ${e} trading card created: ${r.filename}`),{success:!0,filename:r.filename,system:r.system||e}):r.success?(console.log(`âœ… ${e} trading card created: ${r.filename}`),r):(console.error(`âŒ ${e} trading card failed: ${r.error}`),r)}catch(a){return console.error("âŒ Trading card manager error:",a),{success:!1,error:a.message,system:e}}}static async getGenerator(e){if(this.generators[e])return this.generators[e];const t={faceted:()=>x(()=>Promise.resolve().then(()=>Ni),void 0,import.meta.url),quantum:()=>x(()=>Promise.resolve().then(()=>ji),void 0,import.meta.url),holographic:()=>x(()=>Promise.resolve().then(()=>Qi),void 0,import.meta.url),polychora:()=>x(()=>Promise.resolve().then(()=>ea),void 0,import.meta.url)},o=t[e];if(!o)throw new Error(`Unknown system: ${e}. Available: ${Object.keys(t).join(", ")}`);const a=await o(),r=a.default||a[Object.keys(a).find(n=>n.includes("Generator"))];if(!r||typeof r!="function")throw new Error(`Invalid generator class for system: ${e}`);const s={generateCard:(n,l)=>r.generateCard(l)};return this.generators[e]=s,console.log(`ğŸ“¦ Loaded ${e} card generator`),s}static getCurrentParameters(){const e={};document.querySelectorAll(".control-slider").forEach(a=>{e[a.id]=parseFloat(a.value)});const o=document.querySelector(".geom-btn.active");return o&&(e.geometry=parseInt(o.dataset.index)),e.system=window.currentSystem||"faceted",e}static downloadCard(e,t){const o=new Blob([t],{type:"text/html"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}static clearCache(){this.generators={},console.log("ğŸ§¹ Trading card generator cache cleared")}static getAvailableSystems(){return["faceted","quantum","holographic","polychora"]}static getSystemInfo(e){return{faceted:{name:"Faceted",description:"Clean geometric patterns showcasing mathematical purity",color:"#00ffff",specialty:"Mathematical precision"},quantum:{name:"Quantum",description:"Enhanced 3D lattice with complex holographic effects",color:"#00ffff",specialty:"Enhanced complexity"},holographic:{name:"Holographic",description:"Audio-reactive visualization with rich volumetric effects",color:"#ff64ff",specialty:"Audio reactivity"},polychora:{name:"Polychora",description:"True 4D polytope mathematics with glassmorphic rendering",color:"#ff9600",specialty:"4D mathematics"}}[e]||{name:"Unknown",description:"",color:"#ffffff",specialty:""}}}Te(bt,"generators",{});const si=Object.freeze(Object.defineProperty({__proto__:null,TradingCardManager:bt},Symbol.toStringTag,{value:"Module"}));class ni{constructor(){this.useFirebase=!0,this.firebaseUrl="https://us-central1-vib34d-llm-engine.cloudfunctions.net/generateVIB34DParameters",this.apiKey=localStorage.getItem("vib34d-gemini-api-key")||null,this.baseApiUrl="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",this.parameterCallback=null,this.systemPrompt=`You are a synesthetic AI that translates human experience into 4-dimensional holographic mathematics.

You control a VIB34D system with these parameters:
- geometry (0-7): Tetrahedron, Hypercube, Sphere, Torus, Klein Bottle, Fractal, Wave, Crystal
- hue (0-360), intensity (0-1), saturation (0-1)
- speed (0.1-3), chaos (0-1), morphFactor (0-2), gridDensity (5-100)
- rot4dXW, rot4dYW, rot4dZW (-6.28 to 6.28)

When given a description, use your understanding of:
- Visual aesthetics and emotional resonance
- Color theory and psychological associations
- Movement, rhythm, and temporal dynamics
- Mathematical beauty and complexity
- Human perception and synesthesia

Create a holographic experience that captures the essence of what they're describing.

Think beyond literal interpretation. If someone says "the sound of silence," you might create subtle, barely-there patterns with minimal chaos and low intensity. If they say "cosmic loneliness," you might use vast empty spaces with occasional fractal details.

Your goal is to create something that makes them say "YES, that's exactly what I meant, even though I couldn't have described it mathematically."

Return only JSON with the parameter names above.`}async initialize(){const e=localStorage.getItem("vib34d-gemini-api-key");return e?(this.apiKey=e,console.log("ğŸ”‘ Gemini API key loaded from storage"),!0):(console.log("ğŸ“ Gemini API key will be requested on first use"),!1)}setApiKey(e){this.apiKey=e,localStorage.setItem("vib34d-gemini-api-key",e),console.log("ğŸ”‘ Gemini API key saved")}setParameterCallback(e){this.parameterCallback=e}async generateParameters(e){if(this.useFirebase)try{return console.log("ğŸ”¥ Trying Firebase Function first..."),await this.generateViaFirebase(e)}catch(o){console.warn("ğŸ”¥ Firebase Function failed, falling back to direct API:",o.message),this.useFirebase=!1}console.log("ğŸ” Using direct API approach..."),console.log("ğŸ” Checking API key:",this.apiKey?`${this.apiKey.substring(0,10)}...`:"NOT SET");const t=this.apiKey&&this.apiKey.startsWith("AIza")&&this.apiKey.length>30;if(console.log("ğŸ” API key valid:",t),t)try{const o=`${this.baseApiUrl}?key=${this.apiKey}`;console.log("ğŸ¤– Making API request to:",o);const a=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`${this.systemPrompt}

User description: "${e}"

Generate JSON parameters:`}]}],generationConfig:{temperature:.7,maxOutputTokens:500,topP:.8,topK:40}})});if(console.log("ğŸ¤– API response status:",a.status),console.log("ğŸ¤– API response ok:",a.ok),a.ok){const r=await a.json();console.log("ğŸ¤– API response data:",r);const n=r.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/);if(n){const l=JSON.parse(n[0]),c=this.validateParameters(l);return console.log("ğŸ¤– Generated parameters via Gemini API:",c),this.parameterCallback&&this.parameterCallback(c),c}}else{const r=await a.text();throw console.error("ğŸ¤– API request failed:",a.status,r),new Error(`API request failed: ${a.status} - ${r}`)}}catch(o){throw console.error("ğŸ¤– API request error:",o),o}throw this.apiKey?new Error("API request failed. Please check your API key or network connection."):new Error("No API key set. Please enter your Gemini API key to use AI generation.")}async generateViaFirebase(e){const t=await fetch(this.firebaseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:e.trim()})});if(!t.ok){const r=await t.json().catch(()=>({}));throw new Error(r.error||`Firebase Function error: ${t.status}`)}const o=await t.json();if(!o.success||!o.parameters)throw new Error("Invalid response from Firebase Function");const a=o.parameters;return console.log("ğŸ”¥ Generated parameters via Firebase:",a),this.parameterCallback&&this.parameterCallback(a),a}validateParameters(e){const t={};return Object.entries({geometry:{min:0,max:7,type:"int"},hue:{min:0,max:360,type:"int"},intensity:{min:0,max:1,type:"float"},saturation:{min:0,max:1,type:"float"},speed:{min:.1,max:3,type:"float"},chaos:{min:0,max:1,type:"float"},morphFactor:{min:0,max:2,type:"float"},gridDensity:{min:5,max:100,type:"int"},rot4dXW:{min:-6.28,max:6.28,type:"float"},rot4dYW:{min:-6.28,max:6.28,type:"float"},rot4dZW:{min:-6.28,max:6.28,type:"float"}}).forEach(([a,r])=>{if(e.hasOwnProperty(a)){let s=parseFloat(e[a]);s=Math.max(r.min,Math.min(r.max,s)),r.type==="int"&&(s=Math.round(s)),t[a]=s}}),t}}const li=Object.freeze(Object.defineProperty({__proto__:null,LLMParameterInterface:ni},Symbol.toStringTag,{value:"Module"}));class ci{constructor(e){this.llmInterface=e,this.overlay=null,this.input=null,this.isProcessing=!1,this.exampleDescriptions=["calm peaceful meditation","energetic dance party","mysterious magical portal","warm sunset glow","cool ocean waves","intense lightning storm","bright cyan holographic","deep purple mystical","warm orange sunset","cool blue technology","rainbow spectrum shift","monochrome minimal","slow morphing crystals","fast chaotic particles","smooth flowing liquid","sharp geometric patterns","organic natural growth","glitchy digital artifacts","retro synthwave aesthetic","futuristic hologram","sacred geometry mandala","psychedelic kaleidoscope","minimalist zen garden","maximalist explosion"],this.init()}init(){this.createOverlay(),this.setupEventHandlers()}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="llm-overlay",this.overlay.innerHTML=`
            <div class="llm-modal">
                <div class="llm-header">
                    <h2>ğŸ¤– AI Parameter Generator</h2>
                    <button class="llm-close" title="Close">Ã—</button>
                </div>
                
                <div class="llm-content">
                    <div class="llm-description">
                        Describe the visualization you want to create using natural language.
                        The AI will generate parameters to match your description.
                    </div>
                    
                    <div class="llm-input-container">
                        <input type="text" 
                               class="llm-input" 
                               placeholder="e.g. bright cyan holographic effect with fast rotation"
                               autocomplete="off">
                        <button class="llm-generate">Generate</button>
                    </div>
                    
                    <div class="llm-examples">
                        <div class="llm-examples-label">Try these examples:</div>
                        <div class="llm-examples-grid">
                            ${this.exampleDescriptions.slice(0,6).map(t=>`<button class="llm-example-btn" data-description="${t}">${t}</button>`).join("")}
                        </div>
                        <button class="llm-more-examples">Show more examples...</button>
                    </div>
                    
                    <div class="llm-status"></div>
                    
                    <div class="llm-api-key-section" style="display: none;">
                        <div class="llm-api-key-prompt">
                            <p>Please enter your Gemini API key to use AI features:</p>
                            <input type="password" class="llm-api-key-input" placeholder="Your Gemini API key">
                            <button class="llm-api-key-save">Save API Key</button>
                            <p class="llm-api-key-help">
                                Get your API key from 
                                <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;const e=document.createElement("style");e.textContent=`
            .llm-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(10px);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: llmFadeIn 0.3s ease-out;
            }
            
            .llm-overlay.active {
                display: flex;
            }
            
            @keyframes llmFadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .llm-modal {
                background: linear-gradient(135deg, rgba(20, 20, 40, 0.95) 0%, rgba(30, 30, 50, 0.9) 100%);
                border: 2px solid rgba(0, 255, 255, 0.3);
                border-radius: 20px;
                padding: 30px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 
                    0 20px 60px rgba(0, 0, 0, 0.5),
                    0 0 100px rgba(0, 255, 255, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
                animation: llmModalSlide 0.3s ease-out;
            }
            
            @keyframes llmModalSlide {
                from { transform: translateY(-20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .llm-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            
            .llm-header h2 {
                color: #00ffff;
                font-family: 'Orbitron', monospace;
                font-size: 1.8rem;
                margin: 0;
                text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            }
            
            .llm-close {
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #fff;
                font-size: 1.5rem;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .llm-close:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.4);
                transform: rotate(90deg);
            }
            
            .llm-description {
                color: rgba(255, 255, 255, 0.8);
                margin-bottom: 20px;
                line-height: 1.6;
                font-family: 'Orbitron', monospace;
            }
            
            .llm-input-container {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }
            
            .llm-input {
                flex: 1;
                background: rgba(0, 0, 0, 0.3);
                border: 2px solid rgba(0, 255, 255, 0.3);
                color: #fff;
                padding: 15px;
                border-radius: 10px;
                font-size: 1rem;
                font-family: 'Orbitron', monospace;
                transition: all 0.3s ease;
            }
            
            .llm-input:focus {
                outline: none;
                border-color: #00ffff;
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
                background: rgba(0, 0, 0, 0.5);
            }
            
            .llm-generate {
                background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);
                border: none;
                color: #000;
                padding: 15px 30px;
                border-radius: 10px;
                font-weight: bold;
                font-family: 'Orbitron', monospace;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            
            .llm-generate:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(0, 255, 255, 0.4);
            }
            
            .llm-generate:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
            
            .llm-examples {
                margin-top: 30px;
            }
            
            .llm-examples-label {
                color: rgba(255, 255, 255, 0.6);
                margin-bottom: 10px;
                font-size: 0.9rem;
                font-family: 'Orbitron', monospace;
            }
            
            .llm-examples-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .llm-example-btn {
                background: rgba(0, 255, 255, 0.1);
                border: 1px solid rgba(0, 255, 255, 0.3);
                color: #00ffff;
                padding: 10px 15px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-family: 'Orbitron', monospace;
                font-size: 0.85rem;
            }
            
            .llm-example-btn:hover {
                background: rgba(0, 255, 255, 0.2);
                border-color: #00ffff;
                transform: translateY(-1px);
            }
            
            .llm-more-examples {
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: rgba(255, 255, 255, 0.6);
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-family: 'Orbitron', monospace;
                font-size: 0.85rem;
                width: 100%;
                margin-top: 10px;
            }
            
            .llm-more-examples:hover {
                border-color: rgba(255, 255, 255, 0.4);
                color: rgba(255, 255, 255, 0.8);
            }
            
            .llm-status {
                margin-top: 20px;
                padding: 15px;
                border-radius: 10px;
                font-family: 'Orbitron', monospace;
                display: none;
            }
            
            .llm-status.processing {
                display: block;
                background: rgba(0, 100, 255, 0.1);
                border: 1px solid rgba(0, 100, 255, 0.3);
                color: #4080ff;
            }
            
            .llm-status.success {
                display: block;
                background: rgba(0, 255, 100, 0.1);
                border: 1px solid rgba(0, 255, 100, 0.3);
                color: #00ff64;
            }
            
            .llm-status.error {
                display: block;
                background: rgba(255, 0, 100, 0.1);
                border: 1px solid rgba(255, 0, 100, 0.3);
                color: #ff0064;
            }
            
            .llm-api-key-section {
                margin-top: 20px;
                padding: 20px;
                background: rgba(255, 150, 0, 0.1);
                border: 1px solid rgba(255, 150, 0, 0.3);
                border-radius: 10px;
            }
            
            .llm-api-key-input {
                width: 100%;
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 150, 0, 0.3);
                color: #fff;
                padding: 10px;
                border-radius: 6px;
                margin: 10px 0;
                font-family: monospace;
            }
            
            .llm-api-key-save {
                background: linear-gradient(135deg, #ff9600 0%, #ff6432 100%);
                border: none;
                color: #000;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                font-family: 'Orbitron', monospace;
                transition: all 0.3s ease;
            }
            
            .llm-api-key-save:hover {
                transform: translateY(-1px);
                box-shadow: 0 5px 20px rgba(255, 150, 0, 0.3);
            }
            
            .llm-api-key-help {
                font-size: 0.85rem;
                color: rgba(255, 255, 255, 0.6);
                margin-top: 10px;
            }
            
            .llm-api-key-help a {
                color: #ff9600;
                text-decoration: none;
            }
            
            .llm-api-key-help a:hover {
                text-decoration: underline;
            }
        `,document.head.appendChild(e),document.body.appendChild(this.overlay),this.input=this.overlay.querySelector(".llm-input")}setupEventHandlers(){this.overlay.querySelector(".llm-close").addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.hide()}),this.overlay.querySelector(".llm-generate").addEventListener("click",()=>{this.generateFromInput()}),this.input.addEventListener("keypress",e=>{e.key==="Enter"&&!this.isProcessing&&this.generateFromInput()}),this.overlay.querySelectorAll(".llm-example-btn").forEach(e=>{e.addEventListener("click",()=>{this.input.value=e.dataset.description,this.generateFromInput()})}),this.overlay.querySelector(".llm-more-examples").addEventListener("click",e=>{const t=this.overlay.querySelector(".llm-examples-grid");t.children.length<this.exampleDescriptions.length?(t.innerHTML=this.exampleDescriptions.map(a=>`<button class="llm-example-btn" data-description="${a}">${a}</button>`).join(""),e.target.textContent="Show fewer examples..."):(t.innerHTML=this.exampleDescriptions.slice(0,6).map(a=>`<button class="llm-example-btn" data-description="${a}">${a}</button>`).join(""),e.target.textContent="Show more examples..."),t.querySelectorAll(".llm-example-btn").forEach(a=>{a.addEventListener("click",()=>{this.input.value=a.dataset.description,this.generateFromInput()})})}),this.overlay.querySelector(".llm-api-key-save").addEventListener("click",()=>{const e=this.overlay.querySelector(".llm-api-key-input"),t=e.value.trim();if(!t){this.showStatus("Please enter an API key","error");return}if(!t.startsWith("AIza")||t.length<30){this.showStatus('Invalid API key format. Should start with "AIza" and be longer than 30 characters.',"error");return}try{this.llmInterface.setApiKey(t),this.overlay.querySelector(".llm-api-key-section").style.display="none",this.showStatus("API key saved successfully! You can now generate parameters.","success"),e.value="",console.log("âœ… API key set. Ready for manual generation.")}catch(o){this.showStatus("Failed to save API key","error"),console.error("API key save error:",o)}})}async show(){this.overlay.classList.add("active"),await this.llmInterface.initialize(),setTimeout(()=>this.input.focus(),100)}hide(){this.overlay.classList.remove("active"),this.input.value="",this.hideStatus()}async generateFromInput(){const e=this.input.value.trim();if(!e){this.showStatus("Please enter a description","error");return}if(this.isProcessing)return;this.isProcessing=!0,this.showStatus("Generating parameters...","processing");const t=this.overlay.querySelector(".llm-generate");t.disabled=!0;try{const o=await this.llmInterface.generateParameters(e);this.showStatus("Parameters generated successfully!","success"),setTimeout(()=>this.hide(),1500)}catch(o){console.error("Generation error:",o),o.message.includes("No API key set")?(this.overlay.querySelector(".llm-api-key-section").style.display="block",this.showStatus("Please enter your Gemini API key to use AI generation","error")):o.message.includes("API request failed")?(this.showStatus("API request failed. Please check your API key is valid and try again.","error"),this.overlay.querySelector(".llm-api-key-section").style.display="block"):this.showStatus(`Generation failed: ${o.message}`,"error")}finally{this.isProcessing=!1,t.disabled=!1}}showStatus(e,t){const o=this.overlay.querySelector(".llm-status");o.textContent=e,o.className=`llm-status ${t}`}hideStatus(){const e=this.overlay.querySelector(".llm-status");e.className="llm-status",e.textContent=""}}const di=Object.freeze(Object.defineProperty({__proto__:null,LLMParameterUI:ci},Symbol.toStringTag,{value:"Module"}));class Ze{constructor(){this.currentSystem="faceted",this.userParameterState={},this.isInitialized=!1,this.setupGlobalFunctions()}setupGlobalFunctions(){window.switchSystem=async e=>{if(console.log(`ğŸ¯ switchSystem called with: ${e}`),window.canvasManager)try{console.log(`ğŸ”„ Switching to ${e} system...`);const t=await window.canvasManager.switchToSystem(e,window.engineClasses);if(t){console.log(`âœ… ${e} system ready with engine`),window.currentSystem=e,this.currentSystem=e,window.reactivityManager&&window.reactivityManager.setActiveSystem(e,t),setTimeout(()=>{window.syncVisualizerToUI?window.syncVisualizerToUI(e,t):console.warn("âš ï¸ syncVisualizerToUI function not available")},300),document.querySelectorAll(".system-btn").forEach(r=>{r.classList.toggle("active",r.dataset.system===e)});const o={faceted:"FACETED SYSTEM",quantum:"QUANTUM SYSTEM",holographic:"HOLOGRAPHIC SYSTEM",polychora:"POLYCHORA SYSTEM"},a=document.getElementById("panelHeader");a&&(a.textContent=o[e]||"VIB34D SYSTEM"),console.log(`âœ… Switched to ${e} system successfully`);return}else if(e==="polychora"){console.log("ğŸ”® Polychora system not implemented yet");return}else console.error(`âŒ ${e} engine failed to create`)}catch(t){console.error(`âŒ Failed to switch to ${e}:`,t)}console.error(`ğŸ’¥ CanvasManager failed for ${e} - system may not work properly`)},window.selectGeometry=e=>{document.querySelectorAll(".geom-btn").forEach(t=>{t.classList.toggle("active",t.dataset.index==e)}),window.updateParameter&&window.updateParameter("geometry",e)},window.userParameterState=this.userParameterState,window.enhancedUpdateParameter=(e,t)=>{this.userParameterState[e]=parseFloat(t),console.log(`ğŸ’¾ User set ${e} = ${t}`),window.originalUpdateParameter&&window.originalUpdateParameter(e,t)},window.getCurrentUIParameterState=()=>{const e=["rot4dXW","rot4dYW","rot4dZW","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation"],t={};return e.forEach(o=>{if(this.userParameterState[o]!==void 0)t[o]=this.userParameterState[o];else{const a=document.getElementById(o);a&&(t[o]=parseFloat(a.value),console.log(`ğŸ“Š UI read ${o} = ${a.value} (from slider)`))}}),t},window.syncSlidersToStoredValues=()=>{console.log("ğŸ”„ Syncing sliders to stored values..."),Object.entries(this.userParameterState).forEach(([e,t])=>{var a;const o=document.getElementById(e);if(o&&!isNaN(t)){o.value=t;const r=(a=o.parentElement)==null?void 0:a.querySelector(".control-value");r&&(r.textContent=t),console.log(`ğŸ”„ Synced ${e} slider to ${t}`)}else o||console.warn(`âš ï¸ Slider not found for parameter: ${e}`)})},window.syncVisualizerToUI=(e,t)=>{console.log(`ğŸ”„ Syncing ${e} visualizer to UI state...`);const o=window.getCurrentUIParameterState();console.log("ğŸ“Š Current UI parameter state:",o),Object.entries(o).forEach(([a,r])=>{window.updateParameter&&(window.updateParameter(a,r),console.log(`âœ… Applied ${a} = ${r} to ${e}`))}),console.log(`âœ… ${e} visualizer synced to UI`)},window.toggleDeviceTilt=async()=>{if(!window.deviceTiltHandler)return console.warn("ğŸ¯ Device tilt handler not available"),!1;const e=document.getElementById("tiltBtn");return window.deviceTiltHandler.isEnabled?(window.deviceTiltHandler.disable(),e&&(e.style.background="",e.title="Device Tilt (4D Rotation)"),console.log("ğŸ¯ Device tilt disabled"),!1):await window.deviceTiltHandler.enable()?(e&&(e.style.background="linear-gradient(45deg, #00ffff, #0099ff)",e.style.color="#000",e.title="Device Tilt Active - Tilt device to control 4D rotation!"),console.log("ğŸ¯ Device tilt enabled"),!0):(console.warn("ğŸ¯ Device tilt failed to enable"),!1)},window.updateTiltBaseRotations=()=>{window.deviceTiltHandler&&this.userParameterState&&window.deviceTiltHandler.updateBaseRotation(this.userParameterState.rot4dXW||0,this.userParameterState.rot4dYW||0,this.userParameterState.rot4dZW||0)}}async initialize(){console.log("ğŸš€ Initializing VIB34D Application...");try{if(!window.canvasManager)try{console.log("ğŸ”§ Initializing CanvasManager...");const{CanvasManager:e}=await x(async()=>{const{CanvasManager:t}=await Promise.resolve().then(()=>xt);return{CanvasManager:t}},void 0,import.meta.url);window.canvasManager=new e,console.log("âœ… CanvasManager initialized")}catch(e){console.warn("âš ï¸ CanvasManager not available:",e.message),window.canvasManager={switchToSystem:async()=>(console.log("âš ï¸ CanvasManager stub: switchToSystem called"),null)}}if(!window.reactivityManager)try{console.log("ğŸ”§ Initializing ReactivityManager...");const{ReactivityManager:e}=await x(async()=>{const{ReactivityManager:t}=await Promise.resolve().then(()=>Ct);return{ReactivityManager:t}},void 0,import.meta.url);window.reactivityManager=new e,console.log("âœ… ReactivityManager initialized")}catch(e){console.warn("âš ï¸ ReactivityManager not available:",e.message),window.reactivityManager={setActiveSystem:()=>{},setMouseMode:()=>{},toggleMouse:()=>{},setClickMode:()=>{},toggleClick:()=>{},setScrollMode:()=>{},toggleScroll:()=>{}}}this.isInitialized=!0,console.log("âœ… VIB34D Application initialized")}catch(e){throw console.error("âŒ Failed to initialize VIB34D Application:",e),e}}getCurrentSystem(){return this.currentSystem}updateParameter(e,t){this.userParameterState[e]=parseFloat(t),console.log(`ğŸ’¾ Parameter updated: ${e} = ${t}`)}getParameterState(){return{...this.userParameterState}}}const ui=Object.freeze(Object.defineProperty({__proto__:null,VIB34DApp:Ze,default:Ze},Symbol.toStringTag,{value:"Module"}));class hi{static getGeometryNames(){return["TETRAHEDRON","HYPERCUBE","SPHERE","TORUS","KLEIN BOTTLE","FRACTAL","WAVE","CRYSTAL"]}static getGeometryName(e){return this.getGeometryNames()[e]||"UNKNOWN"}static getVariationParameters(e,t){const o={gridDensity:8+t*4,morphFactor:.5+t*.3,chaos:t*.15,speed:.8+t*.2,hue:(e*45+t*15)%360};switch(e){case 0:o.gridDensity*=1.2;break;case 1:o.morphFactor*=.8;break;case 2:o.chaos*=1.5;break;case 3:o.speed*=1.3;break;case 4:o.gridDensity*=.7,o.morphFactor*=1.4;break;case 5:o.gridDensity*=.5,o.chaos*=2;break;case 6:o.speed*=1.8,o.chaos*=.5;break;case 7:o.gridDensity*=1.5,o.morphFactor*=.6;break}return o}}class mi{constructor(e,t,o,a){if(this.canvas=document.getElementById(e),this.role=t,this.reactivity=o,this.variant=a,!this.canvas){console.error(`Canvas ${e} not found`);return}let r=this.canvas.getBoundingClientRect();const s=Math.min(window.devicePixelRatio||1,2);this.contextOptions={alpha:!0,depth:!0,stencil:!1,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1},this.ensureCanvasSizedThenInitWebGL(r,s),this.mouseX=.5,this.mouseY=.5,this.mouseIntensity=0,this.clickIntensity=0,this.startTime=Date.now(),this.params={geometry:0,gridDensity:15,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.5,saturation:.8,dimension:3.5,rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0}}async ensureCanvasSizedThenInitWebGL(e,t){e.width===0||e.height===0?await new Promise(o=>{setTimeout(()=>{if(e=this.canvas.getBoundingClientRect(),e.width===0||e.height===0){const a=window.innerWidth,r=window.innerHeight;this.canvas.width=a*t,this.canvas.height=r*t,window.mobileDebug&&window.mobileDebug.log(`ğŸ“ Canvas ${this.canvas.id}: Using viewport fallback ${this.canvas.width}x${this.canvas.height}`)}else this.canvas.width=e.width*t,this.canvas.height=e.height*t,window.mobileDebug&&window.mobileDebug.log(`ğŸ“ Canvas ${this.canvas.id}: Layout ready ${this.canvas.width}x${this.canvas.height}`);o()},100)}):(this.canvas.width=e.width*t,this.canvas.height=e.height*t,window.mobileDebug&&window.mobileDebug.log(`ğŸ“ Canvas ${this.canvas.id}: ${this.canvas.width}x${this.canvas.height} (DPR: ${t})`)),this.createWebGLContext(),this.gl&&this.init()}createWebGLContext(){let e=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");if(e&&!e.isContextLost()){console.log(`ğŸ”„ Reusing existing WebGL context for ${this.canvas.id}`),this.gl=e;return}if(this.gl=this.canvas.getContext("webgl2",this.contextOptions)||this.canvas.getContext("webgl",this.contextOptions)||this.canvas.getContext("experimental-webgl",this.contextOptions),this.gl){if(window.mobileDebug){const t=this.gl.getParameter(this.gl.VERSION);window.mobileDebug.log(`âœ… WebGL context created for ${this.canvas.id}: ${t} (size: ${this.canvas.width}x${this.canvas.height})`)}}else{console.error(`WebGL not supported for ${this.canvas.id}`),window.mobileDebug&&window.mobileDebug.log(`âŒ WebGL context failed for ${this.canvas.id} (size: ${this.canvas.width}x${this.canvas.height})`),this.showWebGLError();return}}init(){this.initShaders(),this.initBuffers(),this.resize()}initShaders(){const e=`attribute vec2 a_position;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
}`,t=`precision highp float;

uniform vec2 u_resolution;
uniform float u_time;
uniform vec2 u_mouse;
uniform float u_geometry;
uniform float u_gridDensity;
uniform float u_morphFactor;
uniform float u_chaos;
uniform float u_speed;
uniform float u_hue;
uniform float u_intensity;
uniform float u_saturation;
uniform float u_dimension;
uniform float u_rot4dXY;
uniform float u_rot4dXZ;
uniform float u_rot4dYZ;
uniform float u_rot4dXW;
uniform float u_rot4dYW;
uniform float u_rot4dZW;
uniform float u_mouseIntensity;
uniform float u_clickIntensity;
uniform float u_roleIntensity;

// 6D rotation matrices - 3D space rotations (XY, XZ, YZ)
mat4 rotateXY(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, -s, 0.0, 0.0, s, c, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0);
}

mat4 rotateXZ(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, 0.0, s, 0.0, 0.0, 1.0, 0.0, 0.0, -s, 0.0, c, 0.0, 0.0, 0.0, 0.0, 1.0);
}

mat4 rotateYZ(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, c, -s, 0.0, 0.0, s, c, 0.0, 0.0, 0.0, 0.0, 1.0);
}

// 4D hyperspace rotations (XW, YW, ZW)
mat4 rotateXW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, 0.0, 0.0, -s, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, s, 0.0, 0.0, c);
}

mat4 rotateYW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, c, 0.0, -s, 0.0, 0.0, 1.0, 0.0, 0.0, s, 0.0, c);
}

mat4 rotateZW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, c, -s, 0.0, 0.0, s, c);
}

vec3 project4Dto3D(vec4 p) {
    float w = 2.5 / (2.5 + p.w);
    return vec3(p.x * w, p.y * w, p.z * w);
}

// ========================================
// POLYTOPE CORE WARP FUNCTIONS (24 Geometries)
// ========================================
// Wraps geometry through 4D hypersphere (geometries 8-15)
vec3 warpHypersphereCore(vec3 p, int geometryIndex, vec2 mouseDelta) {
    float radius = length(p);
    float morphBlend = clamp(u_morphFactor * 0.6 + (u_dimension - 3.0) * 0.25, 0.0, 2.0);
    float w = sin(radius * (1.3 + float(geometryIndex) * 0.12) + u_time * 0.0008 * u_speed);
    w *= (0.4 + morphBlend * 0.45);

    vec4 p4d = vec4(p * (1.0 + morphBlend * 0.2), w);

    // Apply 6D rotation in 4D space
    p4d = rotateXY(u_rot4dXY) * p4d;
    p4d = rotateXZ(u_rot4dXZ) * p4d;
    p4d = rotateYZ(u_rot4dYZ) * p4d;
    p4d = rotateXW(u_rot4dXW) * p4d;
    p4d = rotateYW(u_rot4dYW) * p4d;
    p4d = rotateZW(u_rot4dZW) * p4d;

    vec3 projected = project4Dto3D(p4d);
    return mix(p, projected, clamp(0.45 + morphBlend * 0.35, 0.0, 1.0));
}

// Wraps geometry through 4D hypertetrahedron (geometries 16-23)
vec3 warpHypertetraCore(vec3 p, int geometryIndex, vec2 mouseDelta) {
    vec3 c1 = normalize(vec3(1.0, 1.0, 1.0));
    vec3 c2 = normalize(vec3(-1.0, -1.0, 1.0));
    vec3 c3 = normalize(vec3(-1.0, 1.0, -1.0));
    vec3 c4 = normalize(vec3(1.0, -1.0, -1.0));

    float morphBlend = clamp(u_morphFactor * 0.8 + (u_dimension - 3.0) * 0.2, 0.0, 2.0);
    float basisMix = dot(p, c1) * 0.14 + dot(p, c2) * 0.1 + dot(p, c3) * 0.08;
    float w = sin(basisMix * 5.5 + u_time * 0.0009 * u_speed);
    w *= cos(dot(p, c4) * 4.2 - u_time * 0.0007 * u_speed);
    w *= (0.5 + morphBlend * 0.4);

    vec3 offset = vec3(dot(p, c1), dot(p, c2), dot(p, c3)) * 0.1 * morphBlend;
    vec4 p4d = vec4(p + offset, w);

    // Apply 6D rotation in 4D space
    p4d = rotateXY(u_rot4dXY) * p4d;
    p4d = rotateXZ(u_rot4dXZ) * p4d;
    p4d = rotateYZ(u_rot4dYZ) * p4d;
    p4d = rotateXW(u_rot4dXW) * p4d;
    p4d = rotateYW(u_rot4dYW) * p4d;
    p4d = rotateZW(u_rot4dZW) * p4d;

    vec3 projected = project4Dto3D(p4d);

    float planeInfluence = min(min(abs(dot(p, c1)), abs(dot(p, c2))), min(abs(dot(p, c3)), abs(dot(p, c4))));
    vec3 blended = mix(p, projected, clamp(0.45 + morphBlend * 0.35, 0.0, 1.0));
    return mix(blended, blended * (1.0 - planeInfluence * 0.55), 0.2 + morphBlend * 0.2);
}

// Applies polytope core warp based on geometry index (0-23)
// 0-7: Base (no warp), 8-15: Hypersphere, 16-23: Hypertetrahedron
vec3 applyCoreWarp(vec3 p, float geometryType, vec2 mouseDelta) {
    float totalBase = 8.0;
    float coreFloat = floor(geometryType / totalBase);
    int coreIndex = int(clamp(coreFloat, 0.0, 2.0));
    float baseGeomFloat = mod(geometryType, totalBase);
    int geometryIndex = int(clamp(floor(baseGeomFloat + 0.5), 0.0, totalBase - 1.0));

    if (coreIndex == 1) {
        return warpHypersphereCore(p, geometryIndex, mouseDelta);
    }
    if (coreIndex == 2) {
        return warpHypertetraCore(p, geometryIndex, mouseDelta);
    }
    return p;
}
// ========================================

// Simplified geometry functions for WebGL 1.0 compatibility (ORIGINAL FACETED)
// NOW SUPPORTS 24 GEOMETRIES: Decodes geometry index to base geometry (0-7)
float geometryFunction(vec4 p) {
    // Decode geometry: base = geometry % 8
    float totalBase = 8.0;
    float baseGeomFloat = mod(u_geometry, totalBase);
    int geomType = int(clamp(floor(baseGeomFloat + 0.5), 0.0, totalBase - 1.0));
    
    if (geomType == 0) {
        // Tetrahedron lattice - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        vec4 dist = min(pos, 1.0 - pos);
        return min(min(dist.x, dist.y), min(dist.z, dist.w)) * u_morphFactor;
    }
    else if (geomType == 1) {
        // Hypercube lattice - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        vec4 dist = min(pos, 1.0 - pos);
        float minDist = min(min(dist.x, dist.y), min(dist.z, dist.w));
        return minDist * u_morphFactor;
    }
    else if (geomType == 2) {
        // Sphere lattice - UNIFORM GRID DENSITY
        float r = length(p);
        float density = u_gridDensity * 0.08;
        float spheres = abs(fract(r * density) - 0.5) * 2.0;
        float theta = atan(p.y, p.x);
        float harmonics = sin(theta * 3.0) * 0.2;
        return (spheres + harmonics) * u_morphFactor;
    }
    else if (geomType == 3) {
        // Torus lattice - UNIFORM GRID DENSITY
        float r1 = length(p.xy) - 2.0;
        float torus = length(vec2(r1, p.z)) - 0.8;
        float lattice = sin(p.x * u_gridDensity * 0.08) * sin(p.y * u_gridDensity * 0.08);
        return (torus + lattice * 0.3) * u_morphFactor;
    }
    else if (geomType == 4) {
        // Klein bottle lattice - UNIFORM GRID DENSITY
        float u = atan(p.y, p.x);
        float v = atan(p.w, p.z);
        float dist = length(p) - 2.0;
        float lattice = sin(u * u_gridDensity * 0.08) * sin(v * u_gridDensity * 0.08);
        return (dist + lattice * 0.4) * u_morphFactor;
    }
    else if (geomType == 5) {
        // Fractal lattice - NOW WITH UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        pos = abs(pos * 2.0 - 1.0);
        float dist = length(max(abs(pos) - 1.0, 0.0));
        return dist * u_morphFactor;
    }
    else if (geomType == 6) {
        // Wave lattice - UNIFORM GRID DENSITY
        float freq = u_gridDensity * 0.08;
        float time = u_time * 0.001 * u_speed;
        float wave1 = sin(p.x * freq + time);
        float wave2 = sin(p.y * freq + time * 1.3);
        float wave3 = sin(p.z * freq * 0.8 + time * 0.7); // Add Z-dimension waves
        float interference = wave1 * wave2 * wave3;
        return interference * u_morphFactor;
    }
    else if (geomType == 7) {
        // Crystal lattice - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08) - 0.5;
        float cube = max(max(abs(pos.x), abs(pos.y)), max(abs(pos.z), abs(pos.w)));
        return cube * u_morphFactor;
    }
    else {
        // Default hypercube - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        vec4 dist = min(pos, 1.0 - pos);
        return min(min(dist.x, dist.y), min(dist.z, dist.w)) * u_morphFactor;
    }
}

void main() {
    vec2 uv = (gl_FragCoord.xy - u_resolution.xy * 0.5) / min(u_resolution.x, u_resolution.y);

    // 4D position with mouse interaction - NOW USING SPEED PARAMETER
    float timeSpeed = u_time * 0.0001 * u_speed;
    vec4 pos = vec4(uv * 3.0, sin(timeSpeed * 3.0), cos(timeSpeed * 2.0));
    pos.xy += (u_mouse - 0.5) * u_mouseIntensity * 2.0;

    // Apply 6D rotations - 3D space rotations first, then 4D hyperspace
    pos = rotateXY(u_rot4dXY) * pos;
    pos = rotateXZ(u_rot4dXZ) * pos;
    pos = rotateYZ(u_rot4dYZ) * pos;
    pos = rotateXW(u_rot4dXW) * pos;
    pos = rotateYW(u_rot4dYW) * pos;
    pos = rotateZW(u_rot4dZW) * pos;

    // POLYTOPE WARP: Apply 4D polytope core transformation (24-geometry system)
    // Decode geometry: 0-7 Base, 8-15 Hypersphere, 16-23 Hypertetrahedron
    vec3 basePoint = project4Dto3D(pos);
    vec3 warpedPoint = applyCoreWarp(basePoint, u_geometry, u_mouse - 0.5);

    // Convert warped 3D back to 4D for geometry evaluation
    vec4 warpedPos = vec4(warpedPoint, pos.w);

    // Calculate geometry value using WARPED position
    float value = geometryFunction(warpedPos);
    
    // Apply chaos
    float noise = sin(pos.x * 7.0) * cos(pos.y * 11.0) * sin(pos.z * 13.0);
    value += noise * u_chaos;
    
    // Color based on geometry value and hue with user-controlled intensity/saturation
    float geometryIntensity = 1.0 - clamp(abs(value), 0.0, 1.0);
    geometryIntensity += u_clickIntensity * 0.3;
    
    // Apply user intensity control
    float finalIntensity = geometryIntensity * u_intensity;
    
    float hue = u_hue / 360.0 + value * 0.1;
    
    // Create color with saturation control
    vec3 baseColor = vec3(
        sin(hue * 6.28318 + 0.0) * 0.5 + 0.5,
        sin(hue * 6.28318 + 2.0943) * 0.5 + 0.5,
        sin(hue * 6.28318 + 4.1887) * 0.5 + 0.5
    );
    
    // Apply saturation (mix with grayscale)
    float gray = (baseColor.r + baseColor.g + baseColor.b) / 3.0;
    vec3 color = mix(vec3(gray), baseColor, u_saturation) * finalIntensity;
    
    gl_FragColor = vec4(color, finalIntensity * u_roleIntensity);
}`;this.program=this.createProgram(e,t),this.uniforms={resolution:this.gl.getUniformLocation(this.program,"u_resolution"),time:this.gl.getUniformLocation(this.program,"u_time"),mouse:this.gl.getUniformLocation(this.program,"u_mouse"),geometry:this.gl.getUniformLocation(this.program,"u_geometry"),gridDensity:this.gl.getUniformLocation(this.program,"u_gridDensity"),morphFactor:this.gl.getUniformLocation(this.program,"u_morphFactor"),chaos:this.gl.getUniformLocation(this.program,"u_chaos"),speed:this.gl.getUniformLocation(this.program,"u_speed"),hue:this.gl.getUniformLocation(this.program,"u_hue"),intensity:this.gl.getUniformLocation(this.program,"u_intensity"),saturation:this.gl.getUniformLocation(this.program,"u_saturation"),dimension:this.gl.getUniformLocation(this.program,"u_dimension"),rot4dXY:this.gl.getUniformLocation(this.program,"u_rot4dXY"),rot4dXZ:this.gl.getUniformLocation(this.program,"u_rot4dXZ"),rot4dYZ:this.gl.getUniformLocation(this.program,"u_rot4dYZ"),rot4dXW:this.gl.getUniformLocation(this.program,"u_rot4dXW"),rot4dYW:this.gl.getUniformLocation(this.program,"u_rot4dYW"),rot4dZW:this.gl.getUniformLocation(this.program,"u_rot4dZW"),mouseIntensity:this.gl.getUniformLocation(this.program,"u_mouseIntensity"),clickIntensity:this.gl.getUniformLocation(this.program,"u_clickIntensity"),roleIntensity:this.gl.getUniformLocation(this.program,"u_roleIntensity")}}createProgram(e,t){const o=this.createShader(this.gl.VERTEX_SHADER,e),a=this.createShader(this.gl.FRAGMENT_SHADER,t);if(!o||!a)return null;const r=this.gl.createProgram();return this.gl.attachShader(r,o),this.gl.attachShader(r,a),this.gl.linkProgram(r),this.gl.getProgramParameter(r,this.gl.LINK_STATUS)?r:(console.error("Program linking failed:",this.gl.getProgramInfoLog(r)),null)}createShader(e,t){if(!this.gl)return console.error("âŒ Cannot create shader: WebGL context is null"),null;if(this.gl.isContextLost())return console.error("âŒ Cannot create shader: WebGL context is lost"),null;try{const o=this.gl.createShader(e);if(!o)return console.error("âŒ Failed to create shader object - WebGL context may be invalid"),null;if(this.gl.shaderSource(o,t),this.gl.compileShader(o),!this.gl.getShaderParameter(o,this.gl.COMPILE_STATUS)){const a=this.gl.getShaderInfoLog(o),r=e===this.gl.VERTEX_SHADER?"vertex":"fragment";return a?console.error(`âŒ ${r} shader compilation failed:`,a):console.error(`âŒ ${r} shader compilation failed: WebGL returned no error info (context may be invalid)`),console.error("Shader source:",t),this.gl.deleteShader(o),null}return o}catch(o){return console.error("âŒ Exception during shader creation:",o),null}}initBuffers(){const e=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);const t=this.gl.getAttribLocation(this.program,"a_position");this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0)}resize(){const e=Math.min(window.devicePixelRatio||1,2),t=this.canvas.clientWidth,o=this.canvas.clientHeight;(this.canvas.width!==t*e||this.canvas.height!==o*e)&&(this.canvas.width=t*e,this.canvas.height=o*e,this.gl.viewport(0,0,this.canvas.width,this.canvas.height))}showWebGLError(){if(!this.canvas)return;const e=this.canvas.getContext("2d");if(e)this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,e.fillStyle="#1a0033",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#ff6b6b",e.font=`${Math.min(20,this.canvas.width/15)}px sans-serif`,e.textAlign="center",e.fillText("âš ï¸ WebGL Error",this.canvas.width/2,this.canvas.height/2-30),e.fillStyle="#ffd93d",e.font=`${Math.min(14,this.canvas.width/20)}px sans-serif`,/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?(e.fillText("Mobile device detected",this.canvas.width/2,this.canvas.height/2),e.fillText("Enable hardware acceleration",this.canvas.width/2,this.canvas.height/2+20),e.fillText("or try Chrome/Firefox",this.canvas.width/2,this.canvas.height/2+40)):(e.fillText("Please enable WebGL",this.canvas.width/2,this.canvas.height/2),e.fillText("in your browser settings",this.canvas.width/2,this.canvas.height/2+20)),window.mobileDebug&&window.mobileDebug.log(`ğŸ“± WebGL error fallback shown for canvas ${this.canvas.id}`);else{const t=document.createElement("div");t.innerHTML=`
                <div style="
                    position: absolute;
                    top: 0; left: 0; right: 0; bottom: 0;
                    background: #1a0033;
                    color: #ff6b6b;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    font-family: sans-serif;
                    text-align: center;
                    padding: 20px;
                ">
                    <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">Graphics Error</div>
                    <div style="font-size: 14px; color: #ffd93d;">
                        Your device doesn't support<br>
                        the required graphics features
                    </div>
                </div>
            `,this.canvas.parentNode.insertBefore(t,this.canvas.nextSibling)}}updateParameters(e){this.params={...this.params,...e}}updateInteraction(e,t,o){if(window.interactivityEnabled===!1){this.mouseX=.5,this.mouseY=.5,this.mouseIntensity=0;return}this.mouseX=e,this.mouseY=t,this.mouseIntensity=o}render(){var s,n,l,c,d;if(!this.program){window.mobileDebug&&window.mobileDebug.log(`âŒ ${(s=this.canvas)==null?void 0:s.id}: No WebGL program compiled`);return}if(!this.gl){window.mobileDebug&&window.mobileDebug.log(`âŒ ${(n=this.canvas)==null?void 0:n.id}: No WebGL context`);return}try{this.resize(),this.gl.useProgram(this.program),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}catch(u){window.mobileDebug&&window.mobileDebug.log(`âŒ ${(l=this.canvas)==null?void 0:l.id}: WebGL render error: ${u.message}`);return}const e={background:.3,shadow:.5,content:.8,highlight:1,accent:1.2},t=Date.now()-this.startTime;this.gl.uniform2f(this.uniforms.resolution,this.canvas.width,this.canvas.height),this.gl.uniform1f(this.uniforms.time,t),this.gl.uniform2f(this.uniforms.mouse,this.mouseX,this.mouseY),this.gl.uniform1f(this.uniforms.geometry,this.params.geometry);let o=this.params.gridDensity,a=this.params.hue,r=this.params.intensity;window.audioEnabled&&window.audioReactive&&(o+=window.audioReactive.bass*30,a+=window.audioReactive.mid*60,r+=window.audioReactive.high*.4),this.gl.uniform1f(this.uniforms.gridDensity,Math.min(100,o)),this.gl.uniform1f(this.uniforms.morphFactor,this.params.morphFactor),this.gl.uniform1f(this.uniforms.chaos,this.params.chaos),this.gl.uniform1f(this.uniforms.speed,this.params.speed),this.gl.uniform1f(this.uniforms.hue,a%360),this.gl.uniform1f(this.uniforms.intensity,Math.min(1,r)),this.gl.uniform1f(this.uniforms.saturation,this.params.saturation),this.gl.uniform1f(this.uniforms.dimension,this.params.dimension),this.gl.uniform1f(this.uniforms.rot4dXY,this.params.rot4dXY||0),this.gl.uniform1f(this.uniforms.rot4dXZ,this.params.rot4dXZ||0),this.gl.uniform1f(this.uniforms.rot4dYZ,this.params.rot4dYZ||0),this.gl.uniform1f(this.uniforms.rot4dXW,this.params.rot4dXW||0),this.gl.uniform1f(this.uniforms.rot4dYW,this.params.rot4dYW||0),this.gl.uniform1f(this.uniforms.rot4dZW,this.params.rot4dZW||0),this.gl.uniform1f(this.uniforms.mouseIntensity,this.mouseIntensity),this.gl.uniform1f(this.uniforms.clickIntensity,this.clickIntensity),this.gl.uniform1f(this.uniforms.roleIntensity,e[this.role]||1);try{this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),window.mobileDebug&&!this._renderSuccessLogged&&(window.mobileDebug.log(`âœ… ${(c=this.canvas)==null?void 0:c.id}: WebGL render successful`),this._renderSuccessLogged=!0)}catch(u){window.mobileDebug&&window.mobileDebug.log(`âŒ ${(d=this.canvas)==null?void 0:d.id}: WebGL draw error: ${u.message}`)}}reinitializeContext(){var e,t,o,a,r;if(console.log(`ğŸ”„ Reinitializing WebGL context for ${(e=this.canvas)==null?void 0:e.id}`),this.program=null,this.buffer=null,this.uniforms=null,this.gl=null,this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),!this.gl)return console.error(`âŒ No WebGL context available for ${(t=this.canvas)==null?void 0:t.id} - CanvasManager should have created one`),!1;if(this.gl.isContextLost())return console.error(`âŒ WebGL context is lost for ${(o=this.canvas)==null?void 0:o.id}`),!1;try{return this.init(),console.log(`âœ… ${(a=this.canvas)==null?void 0:a.id}: Context reinitialized successfully`),!0}catch(s){return console.error(`âŒ Failed to reinitialize WebGL resources for ${(r=this.canvas)==null?void 0:r.id}:`,s),!1}}destroy(){this.gl&&this.program&&this.gl.deleteProgram(this.program),this.gl&&this.buffer&&this.gl.deleteBuffer(this.buffer)}}class Ce{constructor(){this.params={variation:0,rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0,dimension:3.5,gridDensity:15,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.5,saturation:.8,geometry:0},this.parameterDefs={variation:{min:0,max:99,step:1,type:"int"},rot4dXY:{min:-6.28,max:6.28,step:.01,type:"float"},rot4dXZ:{min:-6.28,max:6.28,step:.01,type:"float"},rot4dYZ:{min:-6.28,max:6.28,step:.01,type:"float"},rot4dXW:{min:-2,max:2,step:.01,type:"float"},rot4dYW:{min:-2,max:2,step:.01,type:"float"},rot4dZW:{min:-2,max:2,step:.01,type:"float"},dimension:{min:3,max:4.5,step:.01,type:"float"},gridDensity:{min:4,max:100,step:.1,type:"float"},morphFactor:{min:0,max:2,step:.01,type:"float"},chaos:{min:0,max:1,step:.01,type:"float"},speed:{min:.1,max:3,step:.01,type:"float"},hue:{min:0,max:360,step:1,type:"int"},intensity:{min:0,max:1,step:.01,type:"float"},saturation:{min:0,max:1,step:.01,type:"float"},geometry:{min:0,max:23,step:1,type:"int"}},this.defaults={...this.params}}getAllParameters(){return{...this.params}}setParameter(e,t){if(this.parameterDefs[e]){const o=this.parameterDefs[e];return t=Math.max(o.min,Math.min(o.max,t)),o.type==="int"&&(t=Math.round(t)),this.params[e]=t,!0}return console.warn(`Unknown parameter: ${e}`),!1}setParameters(e){for(const[t,o]of Object.entries(e))this.setParameter(t,o)}getParameter(e){return this.params[e]}setGeometry(e){this.setParameter("geometry",e)}updateFromControls(){["variationSlider","rot4dXW","rot4dYW","rot4dZW","dimension","gridDensity","morphFactor","chaos","speed","hue"].forEach(t=>{const o=document.getElementById(t);if(o){const a=parseFloat(o.value);let r=t;t==="variationSlider"&&(r="variation"),this.setParameter(r,a)}})}updateDisplayValues(){this.updateSliderValue("variationSlider",this.params.variation),this.updateSliderValue("rot4dXW",this.params.rot4dXW),this.updateSliderValue("rot4dYW",this.params.rot4dYW),this.updateSliderValue("rot4dZW",this.params.rot4dZW),this.updateSliderValue("dimension",this.params.dimension),this.updateSliderValue("gridDensity",this.params.gridDensity),this.updateSliderValue("morphFactor",this.params.morphFactor),this.updateSliderValue("chaos",this.params.chaos),this.updateSliderValue("speed",this.params.speed),this.updateSliderValue("hue",this.params.hue),this.updateDisplayText("rot4dXWDisplay",this.params.rot4dXW.toFixed(2)),this.updateDisplayText("rot4dYWDisplay",this.params.rot4dYW.toFixed(2)),this.updateDisplayText("rot4dZWDisplay",this.params.rot4dZW.toFixed(2)),this.updateDisplayText("dimensionDisplay",this.params.dimension.toFixed(2)),this.updateDisplayText("gridDensityDisplay",this.params.gridDensity.toFixed(1)),this.updateDisplayText("morphFactorDisplay",this.params.morphFactor.toFixed(2)),this.updateDisplayText("chaosDisplay",this.params.chaos.toFixed(2)),this.updateDisplayText("speedDisplay",this.params.speed.toFixed(2)),this.updateDisplayText("hueDisplay",this.params.hue+"Â°"),this.updateVariationInfo(),this.updateGeometryButtons()}updateSliderValue(e,t){const o=document.getElementById(e);o&&(o.value=t)}updateDisplayText(e,t){const o=document.getElementById(e);o&&(o.textContent=t)}updateVariationInfo(){const e=document.getElementById("currentVariationDisplay");if(e){const t=["TETRAHEDRON LATTICE","HYPERCUBE LATTICE","SPHERE LATTICE","TORUS LATTICE","KLEIN BOTTLE LATTICE","FRACTAL LATTICE","WAVE LATTICE","CRYSTAL LATTICE"],o=Math.floor(this.params.variation/4),a=this.params.variation%4+1,r=t[o]||"CUSTOM VARIATION";e.textContent=`${this.params.variation+1} - ${r}`,this.params.variation<30&&(e.textContent+=` ${a}`)}}updateGeometryButtons(){document.querySelectorAll("[data-geometry]").forEach(e=>{e.classList.toggle("active",parseInt(e.dataset.geometry)===this.params.geometry)})}randomizeAll(){this.params.rot4dXY=Math.random()*12.56-6.28,this.params.rot4dXZ=Math.random()*12.56-6.28,this.params.rot4dYZ=Math.random()*12.56-6.28,this.params.rot4dXW=Math.random()*4-2,this.params.rot4dYW=Math.random()*4-2,this.params.rot4dZW=Math.random()*4-2,this.params.dimension=3+Math.random()*1.5,this.params.gridDensity=4+Math.random()*26,this.params.morphFactor=Math.random()*2,this.params.chaos=Math.random(),this.params.speed=.1+Math.random()*2.9,this.params.hue=Math.random()*360,this.params.geometry=Math.floor(Math.random()*24)}resetToDefaults(){this.params={...this.defaults}}loadConfiguration(e){if(e&&typeof e=="object"){for(const[t,o]of Object.entries(e))this.parameterDefs[t]&&this.setParameter(t,o);return!0}return!1}exportConfiguration(){return{type:"vib34d-integrated-config",version:"1.0.0",timestamp:new Date().toISOString(),name:`VIB34D Config ${new Date().toLocaleDateString()}`,parameters:{...this.params}}}generateVariationParameters(e){if(e<30){const t=Math.floor(e/4),o=e%4;return{geometry:t,gridDensity:8+o*4,morphFactor:.5+o*.3,chaos:o*.15,speed:.8+o*.2,hue:(t*45+o*15)%360,rot4dXW:(o-1.5)*.5,rot4dYW:t%2*.3,rot4dZW:(t+o)%3*.2,dimension:3.2+o*.2}}else return{...this.params}}applyVariation(e){const t=this.generateVariationParameters(e);this.setParameters(t),this.params.variation=e}getColorHSV(){return{h:this.params.hue,s:.8,v:.9}}getColorRGB(){const e=this.getColorHSV();return this.hsvToRgb(e.h,e.s,e.v)}hsvToRgb(e,t,o){e=e/60;const a=o*t,r=a*(1-Math.abs(e%2-1)),s=o-a;let n,l,c;return e<1?[n,l,c]=[a,r,0]:e<2?[n,l,c]=[r,a,0]:e<3?[n,l,c]=[0,a,r]:e<4?[n,l,c]=[0,r,a]:e<5?[n,l,c]=[r,0,a]:[n,l,c]=[a,0,r],{r:Math.round((n+s)*255),g:Math.round((l+s)*255),b:Math.round((c+s)*255)}}validateConfiguration(e){if(!e||typeof e!="object")return{valid:!1,error:"Configuration must be an object"};if(e.type!=="vib34d-integrated-config")return{valid:!1,error:"Invalid configuration type"};if(!e.parameters)return{valid:!1,error:"Missing parameters object"};for(const[t,o]of Object.entries(e.parameters))if(this.parameterDefs[t]){const a=this.parameterDefs[t];if(typeof o!="number"||o<a.min||o>a.max)return{valid:!1,error:`Invalid value for parameter ${t}: ${o}`}}return{valid:!0}}}class gi{constructor(e){this.engine=e,this.variationNames=["TETRAHEDRON LATTICE 1","TETRAHEDRON LATTICE 2","TETRAHEDRON LATTICE 3","TETRAHEDRON LATTICE 4","HYPERCUBE LATTICE 1","HYPERCUBE LATTICE 2","HYPERCUBE LATTICE 3","HYPERCUBE LATTICE 4","SPHERE LATTICE 1","SPHERE LATTICE 2","SPHERE LATTICE 3","SPHERE LATTICE 4","TORUS LATTICE 1","TORUS LATTICE 2","TORUS LATTICE 3","TORUS LATTICE 4","KLEIN BOTTLE LATTICE 1","KLEIN BOTTLE LATTICE 2","KLEIN BOTTLE LATTICE 3","KLEIN BOTTLE LATTICE 4","FRACTAL LATTICE 1","FRACTAL LATTICE 2","FRACTAL LATTICE 3","WAVE LATTICE 1","WAVE LATTICE 2","WAVE LATTICE 3","CRYSTAL LATTICE 1","CRYSTAL LATTICE 2","CRYSTAL LATTICE 3","CRYSTAL LATTICE 4"],this.customVariations=new Array(70).fill(null),this.totalVariations=100}getVariationName(e){if(e<30)return this.variationNames[e];{const t=e-30,o=this.customVariations[t];return o?o.name:`CUSTOM ${t+1}`}}generateDefaultVariation(e){if(e>=30)return null;const t=Math.floor(e/4),o=e%4;let a=t;return t===5&&o>2&&(a=5,o=2),t===6&&o>2&&(a=6,o=2),{variation:e,geometry:a,gridDensity:8+a*2+o*1.5,morphFactor:.2+o*.2,chaos:o*.2,speed:.8+o*.2,hue:e*12.27%360,rot4dXW:(o-1.5)*.3,rot4dYW:a%2*.2,rot4dZW:(a+o)%3*.15,dimension:3.2+o*.2}}applyVariation(e){if(e<0||e>=this.totalVariations)return!1;let t;if(e<30)t=this.generateDefaultVariation(e);else{const o=e-30,a=this.customVariations[o];a?t={...a.parameters,variation:e}:t={...this.engine.parameterManager.getAllParameters(),variation:e}}return t?(this.engine.parameterManager.setParameters(t),this.engine.currentVariation=e,!0):!1}saveCurrentAsCustom(){const e=this.customVariations.findIndex(r=>r===null);if(e===-1)return-1;const t=this.engine.parameterManager.getAllParameters(),a={name:`${hi.getGeometryName(t.geometry)} CUSTOM ${e+1}`,timestamp:new Date().toISOString(),parameters:{...t},metadata:{basedOnVariation:this.engine.currentVariation,createdFrom:"current-state"}};return this.customVariations[e]=a,this.saveCustomVariations(),30+e}deleteCustomVariation(e){return e>=0&&e<70?(this.customVariations[e]=null,this.saveCustomVariations(),!0):!1}populateGrid(){const e=document.getElementById("variationGrid");if(!e)return;e.innerHTML="",[{name:"Tetrahedron",range:[0,3],class:"tetrahedron"},{name:"Hypercube",range:[4,7],class:"hypercube"},{name:"Sphere",range:[8,11],class:"sphere"},{name:"Torus",range:[12,15],class:"torus"},{name:"Klein Bottle",range:[16,19],class:"klein"},{name:"Fractal",range:[20,22],class:"fractal"},{name:"Wave",range:[23,25],class:"wave"},{name:"Crystal",range:[26,29],class:"crystal"}].forEach(r=>{const s=document.createElement("div");s.className="variation-section",s.innerHTML=`<h3>${r.name} Lattice</h3>`;const n=document.createElement("div");n.className="variation-buttons";for(let l=r.range[0];l<=r.range[1];l++)if(l<this.variationNames.length){const c=this.createVariationButton(l,!0,r.class);n.appendChild(c)}s.appendChild(n),e.appendChild(s)});const o=document.createElement("div");o.className="variation-section custom-section",o.innerHTML="<h3>Custom Variations</h3>";const a=document.createElement("div");a.className="variation-buttons custom-grid";for(let r=0;r<70;r++){const s=this.createVariationButton(30+r,!1,"custom");a.appendChild(s)}o.appendChild(a),e.appendChild(o)}createVariationButton(e,t,o){const a=document.createElement("button"),r=this.getVariationName(e);if(a.className=`preset-btn ${o} ${t?"default-variation":"custom-variation"}`,a.dataset.variation=e,a.title=`${e+1}. ${r}`,t)a.innerHTML=`
                <div class="variation-number">${(e+1).toString().padStart(2,"0")}</div>
                <div class="variation-level">Level ${e%4+1}</div>
            `;else{const s=e-30,n=this.customVariations[s]!==null;a.innerHTML=`
                <div class="variation-number">${(e+1).toString()}</div>
                <div class="variation-type">${n?"CUSTOM":"EMPTY"}</div>
            `,n||a.classList.add("empty-slot")}return a.addEventListener("click",()=>{(t||this.customVariations[e-30]!==null)&&(this.engine.setVariation(e),this.updateVariationGrid())}),t||a.addEventListener("contextmenu",s=>{s.preventDefault();const n=e-30;this.customVariations[n]!==null&&confirm(`Delete custom variation ${e+1}?`)&&(this.deleteCustomVariation(n),this.populateGrid())}),a}updateVariationGrid(){document.querySelectorAll(".preset-btn").forEach(t=>{t.classList.remove("active"),parseInt(t.dataset.variation)===this.engine.currentVariation&&t.classList.add("active")})}loadCustomVariations(){try{const e=localStorage.getItem("vib34d-custom-variations");if(e){const t=JSON.parse(e);Array.isArray(t)&&t.length===70&&(this.customVariations=t)}}catch(e){console.warn("Failed to load custom variations:",e)}}saveCustomVariations(){try{localStorage.setItem("vib34d-custom-variations",JSON.stringify(this.customVariations))}catch(e){console.warn("Failed to save custom variations:",e)}}exportCustomVariations(){const e={type:"vib34d-custom-variations",version:"1.0.0",timestamp:new Date().toISOString(),variations:this.customVariations.filter(s=>s!==null)},t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download="vib34d-custom-variations.json",r.click(),URL.revokeObjectURL(a)}async importCustomVariations(e){try{const t=await e.text(),o=JSON.parse(t);if(o.type==="vib34d-custom-variations"&&Array.isArray(o.variations)){let a=0;return o.variations.forEach(r=>{const s=this.customVariations.findIndex(n=>n===null);s!==-1&&(this.customVariations[s]=r,a++)}),this.saveCustomVariations(),this.populateGrid(),a}}catch(t){console.error("Failed to import custom variations:",t)}return 0}getStatistics(){const e=this.customVariations.filter(t=>t!==null).length;return{totalVariations:this.totalVariations,defaultVariations:30,customVariations:e,emptySlots:70-e,currentVariation:this.engine.currentVariation,isCustom:this.engine.currentVariation>=30}}}class fi{constructor(e){this.engine=e,this.galleryModal=null,this.previewCanvas=null,this.previewVisualizer=null,this.currentPreview=-1,this.previewTimeout=null,this.init()}init(){this.createGalleryModal(),this.setupEventHandlers()}createGalleryModal(){const e=document.createElement("div");e.id="galleryModal",e.className="modal gallery-modal",e.innerHTML=`
            <div class="modal-content gallery-content">
                <div class="gallery-header">
                    <h2>VIB34D Variation Gallery</h2>
                    <div class="gallery-controls">
                        <button class="preview-toggle" title="Toggle Live Preview">
                            <span class="icon">ğŸ‘ï¸</span> Live Preview
                        </button>
                        <button class="gallery-export" title="Export All Variations">
                            <span class="icon">ğŸ“</span> Export All
                        </button>
                        <button class="close-btn" title="Close Gallery">Ã—</button>
                    </div>
                </div>
                
                <div class="gallery-body">
                    <div class="gallery-sidebar">
                        <div class="preview-container">
                            <canvas id="galleryPreviewCanvas" width="300" height="300"></canvas>
                            <div class="preview-info">
                                <div class="preview-title">Hover to preview</div>
                                <div class="preview-details"></div>
                            </div>
                        </div>
                        
                        <div class="gallery-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Variations:</span>
                                <span class="stat-value" id="totalVariationsCount">100</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Custom Variations:</span>
                                <span class="stat-value" id="customVariationsCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gallery-grid-container">
                        <div class="gallery-sections">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(e),this.galleryModal=e,this.previewCanvas=document.getElementById("galleryPreviewCanvas"),this.initPreviewSystem()}initPreviewSystem(){if(this.previewCanvas){this.previewVisualizer={canvas:this.previewCanvas,ctx:this.previewCanvas.getContext("2d"),params:{},updateParams(t){this.params={...t}},render(){const t=this.ctx,o=this.canvas;t.fillStyle="#000",t.fillRect(0,0,o.width,o.height);const a=o.width/2,r=o.height/2,s=Date.now()*.001;for(let n=0;n<this.params.gridDensity*5;n++){const l=n/(this.params.gridDensity*5)*Math.PI*2,c=Math.sin(s*this.params.speed+l*this.params.morphFactor)*80,d=a+Math.cos(l)*c,u=r+Math.sin(l)*c,m=(this.params.hue+l*57.2958+s*20)%360,f=.4+Math.sin(s*2+l)*.3;t.fillStyle=`hsla(${m}, 70%, 50%, ${f})`,t.beginPath(),t.arc(d,u,2+this.params.chaos*4,0,Math.PI*2),t.fill()}}};const e=()=>{this.currentPreview>=0&&this.previewVisualizer.render(),requestAnimationFrame(e)};e()}}setupEventHandlers(){this.galleryModal.querySelector(".close-btn").addEventListener("click",()=>this.closeGallery()),this.galleryModal.addEventListener("click",a=>{a.target===this.galleryModal&&this.closeGallery()}),this.galleryModal.querySelector(".preview-toggle").addEventListener("click",()=>{this.togglePreview()}),this.galleryModal.querySelector(".gallery-export").addEventListener("click",()=>{this.exportAllVariations()}),document.addEventListener("keydown",a=>{if(this.galleryModal.classList.contains("active"))switch(a.key){case"Escape":this.closeGallery();break;case"ArrowLeft":this.navigatePreview(-1);break;case"ArrowRight":this.navigatePreview(1);break}})}openGallery(){this.populateGallery(),this.updateGalleryStats(),this.galleryModal.classList.add("active")}closeGallery(){this.galleryModal.classList.remove("active"),this.currentPreview=-1,this.clearPreview()}populateGallery(){const e=this.galleryModal.querySelector(".gallery-sections");e.innerHTML="",[{name:"Tetrahedron Lattice",range:[0,3],class:"tetrahedron"},{name:"Hypercube Lattice",range:[4,7],class:"hypercube"},{name:"Sphere Lattice",range:[8,11],class:"sphere"},{name:"Torus Lattice",range:[12,15],class:"torus"},{name:"Klein Bottle Lattice",range:[16,19],class:"klein"},{name:"Fractal Lattice",range:[20,22],class:"fractal"},{name:"Wave Lattice",range:[23,25],class:"wave"},{name:"Crystal Lattice",range:[26,29],class:"crystal"}].forEach(a=>{const r=this.createGallerySection(a.name,a.range,a.class,!0);e.appendChild(r)});const o=this.createCustomGallerySection();e.appendChild(o)}createGallerySection(e,t,o,a){const r=document.createElement("div");r.className="gallery-section";const s=document.createElement("h3");s.textContent=e,s.className=`geometry-header ${o}`;const n=document.createElement("div");n.className="gallery-grid";for(let l=t[0];l<=t[1];l++)if(l<this.engine.variationManager.variationNames.length||!a){const c=this.createVariationThumbnail(l,a);n.appendChild(c)}return r.appendChild(s),r.appendChild(n),r}createCustomGallerySection(){const e=document.createElement("div");e.className="gallery-section custom-section";const t=document.createElement("h3");t.textContent="Custom Variations",t.className="geometry-header custom";const o=document.createElement("div");o.className="gallery-grid custom-grid";for(let a=0;a<70;a++)if(this.engine.variationManager.customVariations[a]){const s=this.createVariationThumbnail(30+a,!1);o.appendChild(s)}return e.appendChild(t),e.appendChild(o),e}createVariationThumbnail(e,t){const o=document.createElement("div");o.className=`gallery-thumbnail ${t?"default":"custom"}`,o.dataset.variation=e;const a=this.engine.variationManager.getVariationName(e);return e===this.engine.currentVariation&&o.classList.add("current"),o.innerHTML=`
            <div class="thumbnail-preview">
                <div class="variation-number">${e+1}</div>
                <div class="preview-placeholder"></div>
            </div>
            <div class="thumbnail-info">
                <div class="variation-name">${a}</div>
                <div class="variation-type">${t?"Default":"Custom"}</div>
            </div>
        `,o.addEventListener("mouseenter",()=>{this.showPreview(e)}),o.addEventListener("mouseleave",()=>{this.clearPreview()}),o.addEventListener("click",()=>{this.selectVariation(e)}),o}showPreview(e){this.currentPreview=e,this.previewTimeout&&clearTimeout(this.previewTimeout),this.previewTimeout=setTimeout(()=>{if(this.currentPreview===e){const t=this.getVariationParameters(e);this.previewVisualizer.updateParams(t);const o=this.galleryModal.querySelector(".preview-title"),a=this.galleryModal.querySelector(".preview-details");o.textContent=this.engine.variationManager.getVariationName(e),a.innerHTML=`
                    <div>Variation #${e+1}</div>
                    <div>Geometry: ${this.getGeometryName(t.geometry)}</div>
                    <div>Density: ${t.gridDensity.toFixed(1)}</div>
                    <div>Hue: ${t.hue}Â°</div>
                `}},100)}clearPreview(){this.currentPreview=-1,this.previewTimeout&&clearTimeout(this.previewTimeout);const e=this.galleryModal.querySelector(".preview-title"),t=this.galleryModal.querySelector(".preview-details");e.textContent="Hover to preview",t.innerHTML=""}selectVariation(e){this.engine.setVariation(e),this.closeGallery()}navigatePreview(e){let t=this.currentPreview+e;for(;t>=0&&t<100;){if(t<30||this.engine.variationManager.customVariations[t-30]!==null){this.showPreview(t);const o=this.galleryModal.querySelector(`[data-variation="${t}"]`);o&&o.scrollIntoView({behavior:"smooth",block:"nearest"});break}t+=e}}getVariationParameters(e){if(e<30)return this.engine.variationManager.generateDefaultVariation(e);{const t=this.engine.variationManager.customVariations[e-30];return t?t.parameters:this.engine.parameterManager.getAllParameters()}}getGeometryName(e){return["Tetrahedron","Hypercube","Sphere","Torus","Klein Bottle","Fractal","Wave","Crystal"][e]||"Unknown"}updateGalleryStats(){const e=this.engine.variationManager.getStatistics();document.getElementById("totalVariationsCount").textContent=e.totalVariations,document.getElementById("customVariationsCount").textContent=e.customVariations}togglePreview(){this.galleryModal.querySelector(".preview-container").classList.toggle("hidden")}exportAllVariations(){this.engine.statusManager.info("Exporting all variations..."),this.engine.variationManager.exportCustomVariations()}}class pi{constructor(e){this.engine=e,this.setupFileInputs()}setupFileInputs(){const e=document.createElement("input");e.type="file",e.id="jsonFileInput",e.accept=".json",e.style.display="none",e.addEventListener("change",o=>this.handleJSONImport(o)),document.body.appendChild(e);const t=document.createElement("input");t.type="file",t.id="folderInput",t.webkitdirectory=!0,t.multiple=!0,t.style.display="none",t.addEventListener("change",o=>this.handleFolderImport(o)),document.body.appendChild(t)}exportJSON(){const e={version:"2.0",type:"vib34d-integrated-config",name:`${this.engine.variationManager.getVariationName(this.engine.currentVariation)} - ${new Date().toLocaleDateString()}`,variation:this.engine.currentVariation,parameters:this.engine.parameterManager.getAllParameters(),timestamp:Date.now(),metadata:{engine:"VIB34D Integrated",features:["5-layer holographic","100 variations","4D mathematics","agent-ready"],author:"Paul Phillips (domusgpt)",email:"phillips.paul.email@gmail.com"}},t=JSON.stringify(e,null,2);this.downloadFile(t,"vib34d-config.json","application/json"),this.engine.statusManager.success("Configuration exported as JSON")}saveToGallery(e=null){const t=this.engine.parameterManager.getAllParameters(),o=e||this.engine.variationManager.getVariationName(this.engine.currentVariation),a=new Date().toISOString(),r={name:`Custom Gallery Collection - ${new Date().toLocaleDateString()}`,description:`User-saved variation: ${o}`,version:"1.0",type:"holographic-collection",profileName:"VIB34D System",totalVariations:1,created:a,variations:[{id:0,name:o,isCustom:!0,globalId:Date.now(),system:"faceted",parameters:{geometryType:t.geometry||0,density:t.gridDensity||10,speed:t.speed||1,chaos:t.chaos||0,morph:t.morphFactor||0,hue:t.hue||200,saturation:.8,intensity:.5,rot4dXW:t.rot4dXW||0,rot4dYW:t.rot4dYW||0,rot4dZW:t.rot4dZW||0,dimension:t.dimension||3.8}}]},s=JSON.stringify(r,null,2),n=`custom-${Date.now()}.json`;return this.downloadFile(s,n,"application/json"),this.engine.statusManager.success(`ğŸ¯ Saved for Gallery!<br><br><strong>File:</strong> ${n}<br><strong>Next Steps:</strong><br>1. Find downloaded file in your Downloads folder<br>2. Move it to the <code>collections/</code> folder in your VIB34D directory<br>3. Refresh gallery to see your variation<br><br><small>The gallery only shows collections from the collections/ folder</small>`),console.log("ğŸ¯ Gallery collection saved:",n),n}exportCSS(){const e=this.engine.parameterManager.getAllParameters(),t=`/* VIB34D Integrated Holographic CSS Theme */
/* Generated: ${new Date().toISOString()} */
/* Variation: ${this.engine.currentVariation+1} - ${this.engine.variationManager.getVariationName(this.engine.currentVariation)} */

:root {
    /* VIB34D Parameters */
    --vib34d-variation: ${this.engine.currentVariation};
    --vib34d-geometry: ${e.geometry};
    --vib34d-grid-density: ${e.gridDensity};
    --vib34d-morph-factor: ${e.morphFactor};
    --vib34d-chaos: ${e.chaos};
    --vib34d-speed: ${e.speed};
    --vib34d-hue: ${e.hue}deg;
    --vib34d-rot-4d-xw: ${e.rot4dXW};
    --vib34d-rot-4d-yw: ${e.rot4dYW};
    --vib34d-rot-4d-zw: ${e.rot4dZW};
    --vib34d-dimension: ${e.dimension};
}

.vib34d-holographic {
    /* Base holographic background */
    background: linear-gradient(45deg, 
        hsl(${e.hue}, 70%, 30%) 0%,
        hsl(${(e.hue+60)%360}, 70%, 20%) 25%,
        hsl(${(e.hue+120)%360}, 70%, 25%) 50%,
        hsl(${(e.hue+180)%360}, 70%, 20%) 75%,
        hsl(${(e.hue+240)%360}, 70%, 30%) 100%);
    
    /* Animation based on parameters */
    animation: vib34d-holographic-pulse ${3/e.speed}s infinite;
    
    /* 4D transformation simulation */
    transform: perspective(1000px) 
               rotateX(${e.rot4dXW*5}deg) 
               rotateY(${e.rot4dYW*5}deg) 
               rotateZ(${e.rot4dZW*5}deg);
    
    /* Layer effects */
    position: relative;
    overflow: hidden;
}

.vib34d-holographic::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 50% 50%, 
        hsla(${(e.hue+30)%360}, 80%, 50%, 0.3) 0%,
        hsla(${(e.hue+90)%360}, 70%, 40%, 0.2) 30%,
        transparent 60%);
    mix-blend-mode: screen;
    animation: vib34d-overlay-rotate ${6/e.speed}s linear infinite;
}

.vib34d-holographic::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
        ${e.rot4dXW*90}deg,
        transparent 0px,
        hsla(${e.hue}, 60%, 60%, ${.1+e.chaos*.2}) ${2+e.gridDensity*.5}px,
        transparent ${4+e.gridDensity}px
    );
    mix-blend-mode: overlay;
}

@keyframes vib34d-holographic-pulse {
    0% { 
        filter: hue-rotate(0deg) saturate(1) brightness(1);
        transform: perspective(1000px) 
                   rotateX(${e.rot4dXW*5}deg) 
                   rotateY(${e.rot4dYW*5}deg) 
                   rotateZ(${e.rot4dZW*5}deg) 
                   scale(1);
    }
    50% { 
        filter: hue-rotate(${e.chaos*180}deg) 
                saturate(${1+e.morphFactor}) 
                brightness(${1.1+e.morphFactor*.3});
        transform: perspective(1000px) 
                   rotateX(${e.rot4dXW*5+2}deg) 
                   rotateY(${e.rot4dYW*5+2}deg) 
                   rotateZ(${e.rot4dZW*5+2}deg) 
                   scale(${1+e.morphFactor*.1});
    }
    100% { 
        filter: hue-rotate(360deg) saturate(1) brightness(1);
        transform: perspective(1000px) 
                   rotateX(${e.rot4dXW*5}deg) 
                   rotateY(${e.rot4dYW*5}deg) 
                   rotateZ(${e.rot4dZW*5}deg) 
                   scale(1);
    }
}

@keyframes vib34d-overlay-rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Interactive effects */
.vib34d-holographic:hover {
    animation-duration: ${1.5/e.speed}s;
    filter: saturate(${1.2+e.morphFactor*.3}) brightness(${1.1+e.chaos*.2});
}

.vib34d-holographic:active {
    transform: perspective(1000px) 
               rotateX(${e.rot4dXW*5+5}deg) 
               rotateY(${e.rot4dYW*5+5}deg) 
               rotateZ(${e.rot4dZW*5+3}deg) 
               scale(${.95+e.morphFactor*.05});
}

/* Configuration comment for reference */
/* VIB34D Configuration: ${JSON.stringify(e,null,2)} */`;this.downloadFile(t,"vib34d-holographic.css","text/css"),this.engine.statusManager.success("CSS theme exported")}exportHTML(){const e=this.engine.parameterManager.getAllParameters(),t=`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB34D Holographic Export - Variation ${this.engine.currentVariation+1}</title>
    <style>
        body { 
            margin: 0; 
            padding: 0;
            background: #000; 
            font-family: 'Orbitron', 'Courier New', monospace; 
            overflow: hidden;
        }
        #holographic-canvas { 
            width: 100vw; 
            height: 100vh; 
            display: block;
        }
        .info-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
        }
        .info-overlay h3 {
            margin: 0 0 10px 0;
            color: hsl(${e.hue}, 70%, 70%);
        }
    </style>
</head>
<body>
    <canvas id="holographic-canvas"></canvas>
    
    <div class="info-overlay">
        <h3>VIB34D Holographic Export</h3>
        <div>Variation: ${this.engine.currentVariation+1} - ${this.engine.variationManager.getVariationName(this.engine.currentVariation)}</div>
        <div>Geometry: ${this.getGeometryName(e.geometry)}</div>
        <div>Generated: ${new Date().toLocaleString()}</div>
        <div style="margin-top: 10px; font-size: 10px; opacity: 0.7;">
            Click to interact â€¢ Double-click to randomize
        </div>
    </div>

    <script>
// VIB34D Configuration
const vib34dConfig = ${JSON.stringify(e,null,4)};

// Simplified renderer for exported HTML
class ExportedHolographicRenderer {
    constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.config = vib34dConfig;
        this.time = 0;
        this.mouseX = 0.5;
        this.mouseY = 0.5;
        this.mouseIntensity = 0;
        this.clickIntensity = 0;
        
        this.setupInteraction();
        this.render();
    }
    
    setupInteraction() {
        this.canvas.addEventListener('mousemove', (e) => {
            const rect = this.canvas.getBoundingClientRect();
            this.mouseX = (e.clientX - rect.left) / rect.width;
            this.mouseY = (e.clientY - rect.top) / rect.height;
            this.mouseIntensity = 0.5;
        });
        
        this.canvas.addEventListener('click', () => {
            this.clickIntensity = 1.0;
        });
        
        this.canvas.addEventListener('dblclick', () => {
            this.randomizeConfig();
        });
    }
    
    randomizeConfig() {
        this.config.hue = Math.random() * 360;
        this.config.gridDensity = 4 + Math.random() * 26;
        this.config.morphFactor = Math.random() * 2;
        this.config.chaos = Math.random();
        this.config.speed = 0.1 + Math.random() * 2.9;
        this.clickIntensity = 1.5;
    }
    
    render() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        
        const ctx = this.ctx;
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Generate holographic pattern based on config
        const centerX = this.canvas.width / 2;
        const centerY = this.canvas.height / 2;
        const interactionX = centerX + (this.mouseX - 0.5) * this.canvas.width * 0.3;
        const interactionY = centerY + (this.mouseY - 0.5) * this.canvas.height * 0.3;
        
        // Multiple layers for depth
        const layers = [
            { alpha: 0.2, size: 1, offset: 0 },
            { alpha: 0.3, size: 1.5, offset: 0.3 },
            { alpha: 0.4, size: 2, offset: 0.6 },
            { alpha: 0.3, size: 1.2, offset: 0.9 },
            { alpha: 0.5, size: 2.5, offset: 1.2 }
        ];
        
        layers.forEach((layer, layerIndex) => {
            for (let i = 0; i < this.config.gridDensity * 8; i++) {
                const angle = (i / (this.config.gridDensity * 8)) * Math.PI * 2;
                const radius = Math.sin(this.time * 0.001 * this.config.speed + angle * this.config.morphFactor + layer.offset) * 
                              (100 + layerIndex * 30) * (1 + this.mouseIntensity * 0.5);
                
                const x = interactionX + Math.cos(angle) * radius;
                const y = interactionY + Math.sin(angle) * radius;
                
                const hue = (this.config.hue + angle * 57.2958 + this.time * 0.1 + layerIndex * 20) % 360;
                const alpha = (layer.alpha + Math.sin(this.time * 0.002 + angle) * 0.2) * 
                             (1 + this.clickIntensity * 0.5);
                
                ctx.fillStyle = \`hsla(\${hue}, 70%, \${50 + layerIndex * 10}%, \${alpha})\`;
                ctx.beginPath();
                ctx.arc(x, y, (2 + this.config.chaos * 3) * layer.size, 0, Math.PI * 2);
                ctx.fill();
            }
        });
        
        // Decay intensities
        this.mouseIntensity *= 0.95;
        this.clickIntensity *= 0.92;
        
        this.time += 16;
        requestAnimationFrame(() => this.render());
    }
}

// Initialize when page loads
window.addEventListener('load', () => {
    new ExportedHolographicRenderer(document.getElementById('holographic-canvas'));
});
    <\/script>
</body>
</html>`;this.downloadFile(t,"vib34d-holographic.html","text/html"),this.engine.statusManager.success("HTML file exported")}exportPNG(){try{const e=document.getElementById("content-canvas");if(!e)throw new Error("Content canvas not found");const t=document.createElement("a");t.download=`vib34d-variation-${this.engine.currentVariation+1}.png`,t.href=e.toDataURL("image/png"),t.click(),this.engine.statusManager.success("PNG image exported")}catch(e){this.engine.statusManager.error("PNG export failed: "+e.message)}}importJSON(){document.getElementById("jsonFileInput").click()}importFolder(){document.getElementById("folderInput").click()}async handleJSONImport(e){const t=e.target.files[0];if(t){try{const o=await t.text(),a=JSON.parse(o);this.validateConfiguration(a)?(this.loadConfiguration(a),this.engine.statusManager.success(`Configuration imported: ${a.name||"Unnamed"}`)):this.engine.statusManager.error("Invalid configuration file")}catch(o){this.engine.statusManager.error("Failed to import configuration: "+o.message)}e.target.value=""}}async handleFolderImport(e){const o=Array.from(e.target.files).filter(r=>r.name.toLowerCase().endsWith(".json")&&r.type==="application/json");if(o.length===0){this.engine.statusManager.warning("No JSON files found in folder");return}let a=0;for(const r of o)try{const s=await r.text(),n=JSON.parse(s);this.validateConfiguration(n)&&(this.saveAsCustomVariation(n),a++)}catch(s){console.warn(`Failed to load ${r.name}:`,s)}a>0?(this.engine.statusManager.success(`Imported ${a} configurations from folder`),this.engine.variationManager.populateGrid()):this.engine.statusManager.error("No valid configurations found in folder"),e.target.value=""}validateConfiguration(e){return e&&e.type==="vib34d-integrated-config"&&e.parameters&&typeof e.parameters=="object"}loadConfiguration(e){e.parameters&&(this.engine.parameterManager.setParameters(e.parameters),typeof e.variation=="number"&&this.engine.setVariation(e.variation),this.engine.updateDisplayValues(),this.engine.updateVisualizers())}saveAsCustomVariation(e){return this.engine.variationManager.saveCurrentAsCustom()}downloadFile(e,t,o){const a=new Blob([e],{type:o}),r=URL.createObjectURL(a),s=document.createElement("a");s.href=r,s.download=t,s.click(),URL.revokeObjectURL(r)}getGeometryName(e){return["Tetrahedron","Hypercube","Sphere","Torus","Klein Bottle","Fractal","Wave","Crystal"][e]||"Unknown"}}class yi{constructor(){this.statusElement=null,this.timeout=null,this.init()}init(){this.statusElement=document.getElementById("status")}setStatus(e,t="info",o=3e3){if(!this.statusElement)return;this.statusElement.textContent=e,this.statusElement.className=`status ${t}`,this.timeout&&clearTimeout(this.timeout),t!=="error"&&o>0&&(this.timeout=setTimeout(()=>{this.clearStatus()},o)),console[t==="error"?"error":t==="warning"?"warn":"log"](`[${t.toUpperCase()}] ${e}`)}clearStatus(){this.statusElement&&(this.statusElement.textContent="",this.statusElement.className="status"),this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}success(e,t=3e3){this.setStatus(e,"success",t)}error(e){this.setStatus(e,"error",0)}warning(e,t=4e3){this.setStatus(e,"warning",t)}info(e,t=3e3){this.setStatus(e,"info",t)}loading(e){this.setStatus(e,"loading",0)}}class vi{constructor(){this.visualizers=[],this.parameterManager=new Ce,this.variationManager=new gi(this),this.gallerySystem=new fi(this),this.exportManager=new pi(this),this.statusManager=new yi,this.isActive=!1,this.useBuiltInReactivity=!window.reactivityManager,this.currentVariation=0,this.totalVariations=100,this.mouseX=.5,this.mouseY=.5,this.mouseIntensity=0,this.clickIntensity=0,this.time=0,this.animationId=null,this.init()}init(){console.log("ğŸŒŒ Initializing VIB34D Integrated Holographic Engine...");try{this.createVisualizers(),this.setupControls(),this.setupInteractions(),this.loadCustomVariations(),this.populateVariationGrid(),this.startRenderLoop(),this.statusManager.setStatus("VIB34D Engine initialized successfully","success"),console.log("âœ… VIB34D Engine ready")}catch(e){console.error("âŒ Failed to initialize VIB34D Engine:",e),this.statusManager.setStatus("Initialization failed: "+e.message,"error")}}createVisualizers(){[{id:"background-canvas",role:"background",reactivity:.5},{id:"shadow-canvas",role:"shadow",reactivity:.7},{id:"content-canvas",role:"content",reactivity:.9},{id:"highlight-canvas",role:"highlight",reactivity:1.1},{id:"accent-canvas",role:"accent",reactivity:1.5}].forEach(t=>{const o=new mi(t.id,t.role,t.reactivity,this.currentVariation);this.visualizers.push(o)}),console.log("âœ… Created 5-layer integrated holographic system")}setupControls(){this.setupTabSystem(),this.setupParameterControls(),this.setupGeometryPresets(),this.updateDisplayValues()}setupTabSystem(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),e.classList.add("active"),document.getElementById(e.dataset.tab+"-tab").classList.add("active")})})}setupParameterControls(){["variationSlider","rot4dXW","rot4dYW","rot4dZW","dimension","gridDensity","morphFactor","chaos","speed","hue"].forEach(t=>{const o=document.getElementById(t);o&&o.addEventListener("input",()=>this.updateFromControls())})}setupGeometryPresets(){document.querySelectorAll("[data-geometry]").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll("[data-geometry]").forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.parameterManager.setGeometry(parseInt(e.dataset.geometry)),this.updateVisualizers(),this.updateDisplayValues()})})}setupInteractions(){if(!this.useBuiltInReactivity){console.log("ğŸ”· Faceted built-in reactivity DISABLED - ReactivityManager active");return}console.log("ğŸ”· Setting up Faceted 4D rotation mouse reactivity"),this.setup4DRotationReactivity()}setup4DRotationReactivity(){console.log("ğŸ”· Setting up Faceted: 4D rotations + click flash + scroll density"),this.colorFlashIntensity=0,this.flashDecay=.95,this.scrollDensity=15,["background-canvas","shadow-canvas","content-canvas","highlight-canvas","accent-canvas"].forEach(t=>{const o=document.getElementById(t);o&&(o.addEventListener("mousemove",a=>{if(!this.isActive)return;const r=o.getBoundingClientRect(),s=(a.clientX-r.left)/r.width,n=(a.clientY-r.top)/r.height;this.update4DRotationParameters(s,n)}),o.addEventListener("touchmove",a=>{if(this.isActive&&(a.preventDefault(),a.touches.length>0)){const r=a.touches[0],s=o.getBoundingClientRect(),n=(r.clientX-s.left)/s.width,l=(r.clientY-s.top)/s.height;this.update4DRotationParameters(n,l)}},{passive:!1}),o.addEventListener("click",a=>{this.isActive&&this.triggerColorFlash()}),o.addEventListener("touchend",a=>{this.isActive&&this.triggerColorFlash()}),o.addEventListener("wheel",a=>{this.isActive&&(a.preventDefault(),this.updateScrollDensity(a.deltaY))},{passive:!1}))}),this.startColorFlashLoop()}update4DRotationParameters(e,t){const a=(e-.5)*12.56,r=(e-.5)*12.56*.7,s=(t-.5)*12.56;this.mouseHue||(this.mouseHue=this.scrollHue||200);const n=(e-.5)*30,l=(this.mouseHue+n)%360;window.updateParameter&&(window.updateParameter("rot4dXW",a.toFixed(2)),window.updateParameter("rot4dYW",r.toFixed(2)),window.updateParameter("rot4dZW",s.toFixed(2)),window.updateParameter("hue",Math.round(l))),console.log(`ğŸ”· Smooth 4D + Hue: XW=${a.toFixed(2)}, ZW=${s.toFixed(2)}, Hue=${Math.round(l)}`)}triggerColorFlash(){this.colorFlashIntensity=1,this.clickChaosBoost=.8,this.clickSpeedBoost=1.5,console.log("ğŸ’¥ Faceted dramatic click: color flash + chaos + speed boost")}updateScrollDensity(e){const o=e>0?1:-1;this.scrollDensity+=o*.8,this.scrollDensity=Math.max(5,Math.min(100,this.scrollDensity)),this.scrollHue||(this.scrollHue=200);const a=3;this.scrollHue+=o*a,this.scrollHue=(this.scrollHue%360+360)%360,window.updateParameter&&(window.updateParameter("gridDensity",Math.round(this.scrollDensity)),window.updateParameter("hue",Math.round(this.scrollHue))),console.log(`ğŸŒ€ Smooth scroll: Density=${Math.round(this.scrollDensity)}, Hue=${Math.round(this.scrollHue)}`)}startColorFlashLoop(){const e=()=>{if(this.colorFlashIntensity>.01){const t=this.colorFlashIntensity;let o,a;if(t>.5){const c=(t-.5)*2;o=1-c*.7,a=1-c*.5}else{const c=(.5-t)*2;o=1+c*.5,a=1+c*.3}const r=.8,s=.5,n=Math.max(.1,Math.min(1,r*o)),l=Math.max(.1,Math.min(1,s*a));window.updateParameter&&(window.updateParameter("saturation",n.toFixed(2)),window.updateParameter("intensity",l.toFixed(2))),this.colorFlashIntensity*=.94}if(this.clickChaosBoost>.01){const o=.2+this.clickChaosBoost;window.updateParameter&&window.updateParameter("chaos",o.toFixed(2)),this.clickChaosBoost*=.92}if(this.clickSpeedBoost>.01){const o=1+this.clickSpeedBoost;window.updateParameter&&window.updateParameter("speed",o.toFixed(2)),this.clickSpeedBoost*=.91}this.isActive&&requestAnimationFrame(e)};e()}loadCustomVariations(){this.variationManager.loadCustomVariations()}populateVariationGrid(){this.variationManager.populateGrid()}startRenderLoop(){var t;window.mobileDebug&&window.mobileDebug.log(`ğŸ¬ VIB34D Faceted Engine: Starting render loop with ${(t=this.visualizers)==null?void 0:t.length} visualizers`);const e=()=>{this.time+=.016,this.updateVisualizers(),this.animationId=requestAnimationFrame(e)};e(),window.mobileDebug&&window.mobileDebug.log(`âœ… VIB34D Faceted Engine: Render loop started, animationId=${!!this.animationId}`)}updateVisualizers(){const e=this.parameterManager.getAllParameters();e.mouseX=this.mouseX,e.mouseY=this.mouseY,e.mouseIntensity=this.mouseIntensity,e.clickIntensity=this.clickIntensity,e.time=this.time,this.visualizers.forEach(t=>{t.updateParameters(e),t.render()}),this.mouseIntensity*=.95,this.clickIntensity*=.92}updateFromControls(){this.parameterManager.updateFromControls(),this.updateDisplayValues()}updateDisplayValues(){this.parameterManager.updateDisplayValues()}setVariation(e){if(e>=0&&e<this.totalVariations){this.currentVariation=e,this.variationManager.applyVariation(e),this.updateDisplayValues(),this.updateVisualizers();const t=document.getElementById("variationSlider");t&&(t.value=e),this.statusManager.setStatus(`Variation ${e+1} loaded`,"info")}}nextVariation(){this.setVariation((this.currentVariation+1)%this.totalVariations)}previousVariation(){this.setVariation((this.currentVariation-1+this.totalVariations)%this.totalVariations)}randomVariation(){const e=Math.floor(Math.random()*this.totalVariations);this.setVariation(e)}randomizeAll(){this.parameterManager.randomizeAll(),this.updateDisplayValues(),this.updateVisualizers(),this.statusManager.setStatus("All parameters randomized","info")}resetToDefaults(){this.parameterManager.resetToDefaults(),this.updateDisplayValues(),this.updateVisualizers(),this.statusManager.setStatus("Reset to default parameters","info")}saveAsCustomVariation(){const e=this.variationManager.saveCurrentAsCustom();e!==-1?(this.statusManager.setStatus(`Saved as custom variation ${e+1}`,"success"),this.populateVariationGrid()):this.statusManager.setStatus("All custom slots are full","warning")}openGalleryView(){this.gallerySystem.openGallery()}exportJSON(){this.exportManager.exportJSON()}exportCSS(){this.exportManager.exportCSS()}exportHTML(){this.exportManager.exportHTML()}exportPNG(){this.exportManager.exportPNG()}importJSON(){this.exportManager.importJSON()}importFolder(){this.exportManager.importFolder()}setActive(e){console.log(`ğŸ”· Faceted Engine setActive: ${e}`),this.isActive=e,e&&!this.animationId?(console.log("ğŸ¬ Faceted Engine: Starting animation loop"),this.startRenderLoop()):!e&&this.animationId&&(console.log("â¹ï¸ Faceted Engine: Stopping animation loop"),cancelAnimationFrame(this.animationId),this.animationId=null)}updateInteraction(e,t,o=.5){this.mouseX=e,this.mouseY=t,this.mouseIntensity=o,this.visualizers.forEach(a=>{a.updateInteraction&&a.updateInteraction(e,t,o)})}triggerClick(e=1){this.clickIntensity=e}applyAudioReactivityGrid(e){const t=this.audioReactivitySettings||window.audioReactivitySettings;if(!t)return;const o=t.sensitivity[t.activeSensitivity];t.activeVisualModes.forEach(a=>{const[r,s]=a.split("-");if(s==="color"){const n=e.energy*o,l=e.bass*o;if(e.rhythm*o,e.mid>.2){const c=this.parameterManager.getParameter("hue")||180,d=e.mid*o*30;this.parameterManager.setParameter("hue",(c+d)%360)}n>.3&&this.parameterManager.setParameter("intensity",Math.min(1,.5+n*.8)),l>.4&&this.parameterManager.setParameter("saturation",Math.min(1,.7+l*.3))}else if(s==="geometry"){const n=e.bass*o,l=e.high*o;if(n>.3){const c=this.parameterManager.getParameter("gridDensity")||15;this.parameterManager.setParameter("gridDensity",Math.min(100,c+n*25))}if(e.mid>.2){const c=e.mid*o*.5;this.parameterManager.setParameter("morphFactor",Math.min(2,c))}l>.4&&this.parameterManager.setParameter("chaos",Math.min(1,l*.6))}else if(s==="movement"){const n=e.energy*o;if(n>.2&&this.parameterManager.setParameter("speed",Math.min(3,.5+n*1.5)),e.bass>.3){const l=this.parameterManager.getParameter("rot4dXW")||0;this.parameterManager.setParameter("rot4dXW",l+e.bass*o*.1)}if(e.mid>.3){const l=this.parameterManager.getParameter("rot4dYW")||0;this.parameterManager.setParameter("rot4dYW",l+e.mid*o*.08)}if(e.high>.3){const l=this.parameterManager.getParameter("rot4dZW")||0;this.parameterManager.setParameter("rot4dZW",l+e.high*o*.06)}}})}updateClick(e){this.clickIntensity=Math.min(1,this.clickIntensity+e),this.visualizers.forEach(t=>{t.triggerClick&&t.triggerClick(e)})}updateScroll(e){if(this.visualizers.forEach(o=>{o.updateScroll&&o.updateScroll(e)}),Math.abs(e)>.1){const o=this.parameterManager.getParameter("morphFactor")||1;this.parameterManager.setParameter("morphFactor",Math.max(.1,o+e*.5))}}destroy(){window.universalReactivity&&window.universalReactivity.disconnectSystem("faceted"),this.animationId&&cancelAnimationFrame(this.animationId),this.visualizers.forEach(e=>{e.destroy&&e.destroy()}),console.log("ğŸ”„ VIB34D Engine destroyed")}}const wi=Object.freeze(Object.defineProperty({__proto__:null,VIB34DIntegratedEngine:vi},Symbol.toStringTag,{value:"Module"}));class bi{constructor(e,t,o,a){if(this.canvas=document.getElementById(e),this.role=t,this.reactivity=o,this.variant=a,this.contextOptions={alpha:!0,depth:!0,stencil:!1,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1},this.gl=this.canvas.getContext("webgl2",this.contextOptions)||this.canvas.getContext("webgl",this.contextOptions)||this.canvas.getContext("experimental-webgl",this.contextOptions),this.gl){if(window.mobileDebug){const r=this.gl.getParameter(this.gl.VERSION);window.mobileDebug.log(`âœ… ${e}: WebGL context created - ${r}`)}}else{console.error(`WebGL not supported for ${e}`),window.mobileDebug&&window.mobileDebug.log(`âŒ ${e}: WebGL context creation failed`),this.showWebGLError();return}this.mouseX=.5,this.mouseY=.5,this.mouseIntensity=0,this.clickIntensity=0,this.startTime=Date.now(),this.params={geometry:0,gridDensity:15,morphFactor:1,chaos:.2,speed:1,hue:200,intensity:.5,saturation:.8,dimension:3.5,rot4dXY:0,rot4dXZ:0,rot4dYZ:0,rot4dXW:0,rot4dYW:0,rot4dZW:0},this.init()}async ensureCanvasSizedThenInitWebGL(){let e=this.canvas.getBoundingClientRect();const t=Math.min(window.devicePixelRatio||1,2);e.width===0||e.height===0?await new Promise(o=>{setTimeout(()=>{if(e=this.canvas.getBoundingClientRect(),e.width===0||e.height===0){const a=window.innerWidth,r=window.innerHeight;this.canvas.width=a*t,this.canvas.height=r*t,window.mobileDebug&&window.mobileDebug.log(`ğŸ“ Quantum Canvas ${this.canvas.id}: Using viewport fallback ${this.canvas.width}x${this.canvas.height}`)}else this.canvas.width=e.width*t,this.canvas.height=e.height*t,window.mobileDebug&&window.mobileDebug.log(`ğŸ“ Quantum Canvas ${this.canvas.id}: Layout ready ${this.canvas.width}x${this.canvas.height}`);o()},100)}):(this.canvas.width=e.width*t,this.canvas.height=e.height*t,window.mobileDebug&&window.mobileDebug.log(`ğŸ“ Quantum Canvas ${this.canvas.id}: ${this.canvas.width}x${this.canvas.height} (DPR: ${t})`)),this.createWebGLContext(),this.gl&&this.init()}createWebGLContext(){let e=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");if(e&&!e.isContextLost()){console.log(`ğŸ”„ Reusing existing WebGL context for ${this.canvas.id}`),this.gl=e;return}if(this.gl=this.canvas.getContext("webgl2",this.contextOptions)||this.canvas.getContext("webgl",this.contextOptions)||this.canvas.getContext("experimental-webgl",this.contextOptions),this.gl){if(window.mobileDebug){const t=this.gl.getParameter(this.gl.VERSION);window.mobileDebug.log(`âœ… Quantum ${this.canvas.id}: WebGL context created - ${t} (size: ${this.canvas.width}x${this.canvas.height})`)}}else{console.error(`WebGL not supported for ${this.canvas.id}`),window.mobileDebug&&window.mobileDebug.log(`âŒ Quantum ${this.canvas.id}: WebGL context creation failed (size: ${this.canvas.width}x${this.canvas.height})`),this.showWebGLError();return}}init(){this.initShaders(),this.initBuffers(),this.resize()}reinitializeContext(){if(console.log(`ğŸ”„ Reinitializing WebGL context for ${this.canvas.id}`),this.program=null,this.buffer=null,this.uniforms=null,this.gl=null,this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),!this.gl)return console.error(`âŒ No WebGL context available for ${this.canvas.id} - SmartCanvasPool should have created one`),!1;if(this.gl.isContextLost())return console.error(`âŒ WebGL context is lost for ${this.canvas.id}`),!1;try{return this.initShaders(),this.initBuffers(),this.resize(),console.log(`âœ… WebGL context reinitialized for ${this.canvas.id}`),!0}catch(e){return console.error(`âŒ Failed to reinitialize WebGL resources for ${this.canvas.id}:`,e),!1}}initShaders(){const e=`attribute vec2 a_position;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
}`,t=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
#else
    precision mediump float;
#endif

uniform vec2 u_resolution;
uniform float u_time;
uniform vec2 u_mouse;
uniform float u_geometry;
uniform float u_gridDensity;
uniform float u_morphFactor;
uniform float u_chaos;
uniform float u_speed;
uniform float u_hue;
uniform float u_intensity;
uniform float u_saturation;
uniform float u_dimension;
uniform float u_rot4dXY;
uniform float u_rot4dXZ;
uniform float u_rot4dYZ;
uniform float u_rot4dXW;
uniform float u_rot4dYW;
uniform float u_rot4dZW;
uniform float u_mouseIntensity;
uniform float u_clickIntensity;
uniform float u_roleIntensity;

// 6D rotation matrices - 3D space rotations (XY, XZ, YZ)
mat4 rotateXY(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, -s, 0.0, 0.0, s, c, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0);
}

mat4 rotateXZ(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, 0.0, s, 0.0, 0.0, 1.0, 0.0, 0.0, -s, 0.0, c, 0.0, 0.0, 0.0, 0.0, 1.0);
}

mat4 rotateYZ(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, c, -s, 0.0, 0.0, s, c, 0.0, 0.0, 0.0, 0.0, 1.0);
}

// 4D hyperspace rotations (XW, YW, ZW)
mat4 rotateXW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, 0.0, 0.0, -s, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, s, 0.0, 0.0, c);
}

mat4 rotateYW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, c, 0.0, -s, 0.0, 0.0, 1.0, 0.0, 0.0, s, 0.0, c);
}

mat4 rotateZW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, c, -s, 0.0, 0.0, s, c);
}

vec3 project4Dto3D(vec4 p) {
    float w = 2.5 / (2.5 + p.w);
    return vec3(p.x * w, p.y * w, p.z * w);
}

// ========================================
// POLYTOPE CORE WARP FUNCTIONS (24 Geometries)
// ========================================
vec3 warpHypersphereCore(vec3 p, int geometryIndex, vec2 mouseDelta) {
    float radius = length(p);
    float morphBlend = clamp(u_morphFactor * 0.6 + (u_dimension - 3.0) * 0.25, 0.0, 2.0);
    float w = sin(radius * (1.3 + float(geometryIndex) * 0.12) + u_time * 0.0008 * u_speed);
    w *= (0.4 + morphBlend * 0.45);

    vec4 p4d = vec4(p * (1.0 + morphBlend * 0.2), w);
    p4d = rotateXY(u_rot4dXY) * p4d;
    p4d = rotateXZ(u_rot4dXZ) * p4d;
    p4d = rotateYZ(u_rot4dYZ) * p4d;
    p4d = rotateXW(u_rot4dXW) * p4d;
    p4d = rotateYW(u_rot4dYW) * p4d;
    p4d = rotateZW(u_rot4dZW) * p4d;

    vec3 projected = project4Dto3D(p4d);
    return mix(p, projected, clamp(0.45 + morphBlend * 0.35, 0.0, 1.0));
}

vec3 warpHypertetraCore(vec3 p, int geometryIndex, vec2 mouseDelta) {
    vec3 c1 = normalize(vec3(1.0, 1.0, 1.0));
    vec3 c2 = normalize(vec3(-1.0, -1.0, 1.0));
    vec3 c3 = normalize(vec3(-1.0, 1.0, -1.0));
    vec3 c4 = normalize(vec3(1.0, -1.0, -1.0));

    float morphBlend = clamp(u_morphFactor * 0.8 + (u_dimension - 3.0) * 0.2, 0.0, 2.0);
    float basisMix = dot(p, c1) * 0.14 + dot(p, c2) * 0.1 + dot(p, c3) * 0.08;
    float w = sin(basisMix * 5.5 + u_time * 0.0009 * u_speed);
    w *= cos(dot(p, c4) * 4.2 - u_time * 0.0007 * u_speed);
    w *= (0.5 + morphBlend * 0.4);

    vec3 offset = vec3(dot(p, c1), dot(p, c2), dot(p, c3)) * 0.1 * morphBlend;
    vec4 p4d = vec4(p + offset, w);
    p4d = rotateXY(u_rot4dXY) * p4d;
    p4d = rotateXZ(u_rot4dXZ) * p4d;
    p4d = rotateYZ(u_rot4dYZ) * p4d;
    p4d = rotateXW(u_rot4dXW) * p4d;
    p4d = rotateYW(u_rot4dYW) * p4d;
    p4d = rotateZW(u_rot4dZW) * p4d;

    vec3 projected = project4Dto3D(p4d);

    float planeInfluence = min(min(abs(dot(p, c1)), abs(dot(p, c2))), min(abs(dot(p, c3)), abs(dot(p, c4))));
    vec3 blended = mix(p, projected, clamp(0.45 + morphBlend * 0.35, 0.0, 1.0));
    return mix(blended, blended * (1.0 - planeInfluence * 0.55), 0.2 + morphBlend * 0.2);
}

vec3 applyCoreWarp(vec3 p, float geometryType, vec2 mouseDelta) {
    float totalBase = 8.0;
    float coreFloat = floor(geometryType / totalBase);
    int coreIndex = int(clamp(coreFloat, 0.0, 2.0));
    float baseGeomFloat = mod(geometryType, totalBase);
    int geometryIndex = int(clamp(floor(baseGeomFloat + 0.5), 0.0, totalBase - 1.0));

    if (coreIndex == 1) {
        return warpHypersphereCore(p, geometryIndex, mouseDelta);
    }
    if (coreIndex == 2) {
        return warpHypertetraCore(p, geometryIndex, mouseDelta);
    }
    return p;
}
// ========================================

// Complex 3D Lattice Functions - Superior Quantum Shaders
float tetrahedronLattice(vec3 p, float gridSize) {
    vec3 q = fract(p * gridSize) - 0.5;
    float d1 = length(q);
    float d2 = length(q - vec3(0.4, 0.0, 0.0));
    float d3 = length(q - vec3(0.0, 0.4, 0.0));
    float d4 = length(q - vec3(0.0, 0.0, 0.4));
    float vertices = 1.0 - smoothstep(0.0, 0.04, min(min(d1, d2), min(d3, d4)));
    float edges = 0.0;
    edges = max(edges, 1.0 - smoothstep(0.0, 0.02, abs(length(q.xy) - 0.2)));
    edges = max(edges, 1.0 - smoothstep(0.0, 0.02, abs(length(q.yz) - 0.2)));
    edges = max(edges, 1.0 - smoothstep(0.0, 0.02, abs(length(q.xz) - 0.2)));
    return max(vertices, edges * 0.5);
}

float hypercubeLattice(vec3 p, float gridSize) {
    vec3 grid = fract(p * gridSize);
    vec3 edges = min(grid, 1.0 - grid);
    float minEdge = min(min(edges.x, edges.y), edges.z);
    float lattice = 1.0 - smoothstep(0.0, 0.03, minEdge);
    
    vec3 centers = abs(grid - 0.5);
    float maxCenter = max(max(centers.x, centers.y), centers.z);
    float vertices = 1.0 - smoothstep(0.45, 0.5, maxCenter);
    
    return max(lattice * 0.7, vertices);
}

float sphereLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    float sphere = 1.0 - smoothstep(0.15, 0.25, length(cell));
    
    float rings = 0.0;
    float ringRadius = length(cell.xy);
    rings = max(rings, 1.0 - smoothstep(0.0, 0.02, abs(ringRadius - 0.3)));
    rings = max(rings, 1.0 - smoothstep(0.0, 0.02, abs(ringRadius - 0.2)));
    
    return max(sphere, rings * 0.6);
}

float torusLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    float majorRadius = 0.3;
    float minorRadius = 0.1;
    
    float toroidalDist = length(vec2(length(cell.xy) - majorRadius, cell.z));
    float torus = 1.0 - smoothstep(minorRadius - 0.02, minorRadius + 0.02, toroidalDist);
    
    float rings = 0.0;
    float angle = atan(cell.y, cell.x);
    rings = sin(angle * 8.0) * 0.02;
    
    return max(torus, 0.0) + rings;
}

float kleinLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    float u = atan(cell.y, cell.x) / 3.14159 + 1.0;
    float v = cell.z + 0.5;
    
    float x = (2.0 + cos(u * 0.5)) * cos(u);
    float y = (2.0 + cos(u * 0.5)) * sin(u);
    float z = sin(u * 0.5) + v;
    
    vec3 kleinPoint = vec3(x, y, z) * 0.1;
    float dist = length(cell - kleinPoint);
    
    return 1.0 - smoothstep(0.1, 0.15, dist);
}

float fractalLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize);
    cell = abs(cell * 2.0 - 1.0);
    
    float dist = length(max(abs(cell) - 0.3, 0.0));
    
    // Recursive subdivision
    for(int i = 0; i < 3; i++) {
        cell = abs(cell * 2.0 - 1.0);
        float subdist = length(max(abs(cell) - 0.3, 0.0)) / pow(2.0, float(i + 1));
        dist = min(dist, subdist);
    }
    
    return 1.0 - smoothstep(0.0, 0.05, dist);
}

float waveLattice(vec3 p, float gridSize) {
    float time = u_time * 0.001 * u_speed;
    vec3 cell = fract(p * gridSize) - 0.5;
    
    float wave1 = sin(p.x * gridSize * 2.0 + time * 2.0);
    float wave2 = sin(p.y * gridSize * 1.8 + time * 1.5);
    float wave3 = sin(p.z * gridSize * 2.2 + time * 1.8);
    
    float interference = (wave1 + wave2 + wave3) / 3.0;
    float amplitude = 1.0 - length(cell) * 2.0;
    
    return max(0.0, interference * amplitude);
}

float crystalLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    
    // Octahedral crystal structure
    float crystal = max(max(abs(cell.x) + abs(cell.y), abs(cell.y) + abs(cell.z)), abs(cell.x) + abs(cell.z));
    crystal = 1.0 - smoothstep(0.3, 0.4, crystal);
    
    // Add crystalline faces
    float faces = 0.0;
    faces = max(faces, 1.0 - smoothstep(0.0, 0.02, abs(abs(cell.x) - 0.35)));
    faces = max(faces, 1.0 - smoothstep(0.0, 0.02, abs(abs(cell.y) - 0.35)));
    faces = max(faces, 1.0 - smoothstep(0.0, 0.02, abs(abs(cell.z) - 0.35)));
    
    return max(crystal, faces * 0.5);
}

// Enhanced geometry function with holographic effects (24 GEOMETRIES)
float geometryFunction(vec4 p) {
    // Decode geometry: base = geometry % 8 (supports 24 geometries)
    float totalBase = 8.0;
    float baseGeomFloat = mod(u_geometry, totalBase);
    int geomType = int(clamp(floor(baseGeomFloat + 0.5), 0.0, totalBase - 1.0));

    // Project to 3D and apply polytope warp
    vec3 p3d = project4Dto3D(p);
    vec3 warped = applyCoreWarp(p3d, u_geometry, vec2(0.0, 0.0));
    float gridSize = u_gridDensity * 0.08;
    
    if (geomType == 0) {
        return tetrahedronLattice(warped, gridSize) * u_morphFactor;
    }
    else if (geomType == 1) {
        return hypercubeLattice(warped, gridSize) * u_morphFactor;
    }
    else if (geomType == 2) {
        return sphereLattice(warped, gridSize) * u_morphFactor;
    }
    else if (geomType == 3) {
        return torusLattice(warped, gridSize) * u_morphFactor;
    }
    else if (geomType == 4) {
        return kleinLattice(warped, gridSize) * u_morphFactor;
    }
    else if (geomType == 5) {
        return fractalLattice(warped, gridSize) * u_morphFactor;
    }
    else if (geomType == 6) {
        return waveLattice(warped, gridSize) * u_morphFactor;
    }
    else if (geomType == 7) {
        return crystalLattice(warped, gridSize) * u_morphFactor;
    }
    else {
        return hypercubeLattice(warped, gridSize) * u_morphFactor;
    }
}

// EXTREME LAYER-BY-LAYER COLOR SYSTEM
// Each canvas layer gets completely different color behavior

// Layer-specific color palettes with extreme juxtapositions
vec3 getLayerColorPalette(int layerIndex, float t) {
    if (layerIndex == 0) {
        // BACKGROUND LAYER: Deep space colors - purple/black/deep blue
        vec3 color1 = vec3(0.05, 0.0, 0.2);   // Deep purple
        vec3 color2 = vec3(0.0, 0.0, 0.1);    // Near black
        vec3 color3 = vec3(0.0, 0.05, 0.3);   // Deep blue
        return mix(mix(color1, color2, sin(t * 3.0) * 0.5 + 0.5), color3, cos(t * 2.0) * 0.5 + 0.5);
    }
    else if (layerIndex == 1) {
        // SHADOW LAYER: Toxic greens and sickly yellows - high contrast
        vec3 color1 = vec3(0.0, 1.0, 0.0);    // Pure toxic green
        vec3 color2 = vec3(0.8, 1.0, 0.0);    // Sickly yellow-green
        vec3 color3 = vec3(0.0, 0.8, 0.3);    // Forest green
        return mix(mix(color1, color2, sin(t * 7.0) * 0.5 + 0.5), color3, cos(t * 5.0) * 0.5 + 0.5);
    }
    else if (layerIndex == 2) {
        // CONTENT LAYER: Blazing hot colors - red/orange/white hot
        vec3 color1 = vec3(1.0, 0.0, 0.0);    // Pure red
        vec3 color2 = vec3(1.0, 0.5, 0.0);    // Blazing orange
        vec3 color3 = vec3(1.0, 1.0, 1.0);    // White hot
        return mix(mix(color1, color2, sin(t * 11.0) * 0.5 + 0.5), color3, cos(t * 8.0) * 0.5 + 0.5);
    }
    else if (layerIndex == 3) {
        // HIGHLIGHT LAYER: Electric blues and cyans - crackling energy
        vec3 color1 = vec3(0.0, 1.0, 1.0);    // Electric cyan
        vec3 color2 = vec3(0.0, 0.5, 1.0);    // Electric blue
        vec3 color3 = vec3(0.5, 1.0, 1.0);    // Bright cyan
        return mix(mix(color1, color2, sin(t * 13.0) * 0.5 + 0.5), color3, cos(t * 9.0) * 0.5 + 0.5);
    }
    else {
        // ACCENT LAYER: Violent magentas and purples - chaotic
        vec3 color1 = vec3(1.0, 0.0, 1.0);    // Pure magenta
        vec3 color2 = vec3(0.8, 0.0, 1.0);    // Violet
        vec3 color3 = vec3(1.0, 0.3, 1.0);    // Hot pink
        return mix(mix(color1, color2, sin(t * 17.0) * 0.5 + 0.5), color3, cos(t * 12.0) * 0.5 + 0.5);
    }
}

// Extreme RGB separation and distortion for each layer
vec3 extremeRGBSeparation(vec3 baseColor, vec2 uv, float intensity, int layerIndex) {
    vec2 offset = vec2(0.01, 0.005) * intensity;
    
    // Different separation patterns per layer
    if (layerIndex == 0) {
        // Background: Minimal separation, smooth
        return baseColor + vec3(
            sin(uv.x * 10.0 + u_time * 0.001) * 0.02,
            cos(uv.y * 8.0 + u_time * 0.0015) * 0.02,
            sin(uv.x * uv.y * 6.0 + u_time * 0.0008) * 0.02
        ) * intensity;
    }
    else if (layerIndex == 1) {
        // Shadow: Heavy vertical separation
        float r = baseColor.r + sin(uv.y * 50.0 + u_time * 0.003) * intensity * 0.15;
        float g = baseColor.g + sin((uv.y + 0.1) * 45.0 + u_time * 0.0025) * intensity * 0.12;
        float b = baseColor.b + sin((uv.y - 0.1) * 55.0 + u_time * 0.0035) * intensity * 0.18;
        return vec3(r, g, b);
    }
    else if (layerIndex == 2) {
        // Content: Explosive radial separation
        float dist = length(uv);
        float angle = atan(uv.y, uv.x);
        float r = baseColor.r + sin(dist * 30.0 + angle * 10.0 + u_time * 0.004) * intensity * 0.2;
        float g = baseColor.g + cos(dist * 25.0 + angle * 8.0 + u_time * 0.0035) * intensity * 0.18;
        float b = baseColor.b + sin(dist * 35.0 + angle * 12.0 + u_time * 0.0045) * intensity * 0.22;
        return vec3(r, g, b);
    }
    else if (layerIndex == 3) {
        // Highlight: Lightning-like separation
        float lightning = sin(uv.x * 80.0 + u_time * 0.008) * cos(uv.y * 60.0 + u_time * 0.006);
        float r = baseColor.r + lightning * intensity * 0.25;
        float g = baseColor.g + sin(lightning * 40.0 + u_time * 0.005) * intensity * 0.2;
        float b = baseColor.b + cos(lightning * 30.0 + u_time * 0.007) * intensity * 0.3;
        return vec3(r, g, b);
    }
    else {
        // Accent: Chaotic multi-directional separation
        float chaos1 = sin(uv.x * 100.0 + uv.y * 80.0 + u_time * 0.01);
        float chaos2 = cos(uv.x * 70.0 - uv.y * 90.0 + u_time * 0.008);
        float chaos3 = sin(uv.x * uv.y * 150.0 + u_time * 0.012);
        return baseColor + vec3(chaos1, chaos2, chaos3) * intensity * 0.3;
    }
}

void main() {
    vec2 uv = (gl_FragCoord.xy - u_resolution.xy * 0.5) / min(u_resolution.x, u_resolution.y);
    
    // Enhanced 4D position with holographic depth
    float timeSpeed = u_time * 0.0001 * u_speed;
    vec4 pos = vec4(uv * 3.0, sin(timeSpeed * 3.0), cos(timeSpeed * 2.0));
    pos.xy += (u_mouse - 0.5) * u_mouseIntensity * 2.0;

    // Apply 6D rotations - 3D space rotations first, then 4D hyperspace
    pos = rotateXY(u_rot4dXY) * pos;
    pos = rotateXZ(u_rot4dXZ) * pos;
    pos = rotateYZ(u_rot4dYZ) * pos;
    pos = rotateXW(u_rot4dXW) * pos;
    pos = rotateYW(u_rot4dYW) * pos;
    pos = rotateZW(u_rot4dZW) * pos;
    
    // Calculate enhanced geometry value
    float value = geometryFunction(pos);
    
    // Enhanced chaos with holographic effects
    float noise = sin(pos.x * 7.0) * cos(pos.y * 11.0) * sin(pos.z * 13.0);
    value += noise * u_chaos;
    
    // Enhanced intensity calculation with holographic glow
    float geometryIntensity = 1.0 - clamp(abs(value * 0.8), 0.0, 1.0);
    geometryIntensity = pow(geometryIntensity, 1.5); // More dramatic falloff
    geometryIntensity += u_clickIntensity * 0.3;
    
    // Holographic shimmer effect
    float shimmer = sin(uv.x * 20.0 + timeSpeed * 5.0) * cos(uv.y * 15.0 + timeSpeed * 3.0) * 0.1;
    geometryIntensity += shimmer * geometryIntensity;
    
    // Apply user intensity control
    float finalIntensity = geometryIntensity * u_intensity;
    
    // Old hemispheric color system completely removed - now using extreme layer-by-layer system
    
    // EXTREME LAYER-BY-LAYER COLOR SYSTEM
    // Determine canvas layer from role/variant (0=background, 1=shadow, 2=content, 3=highlight, 4=accent)
    int layerIndex = 0;
    if (u_roleIntensity == 0.7) layerIndex = 1;      // shadow layer
    else if (u_roleIntensity == 1.0) layerIndex = 2; // content layer  
    else if (u_roleIntensity == 0.85) layerIndex = 3; // highlight layer
    else if (u_roleIntensity == 0.6) layerIndex = 4;  // accent layer
    
    // Get layer-specific base color with extreme dynamics
    // Use u_hue as global intensity modifier (0-1) affecting all layers
    float globalIntensity = u_hue; // Now 0-1 from JavaScript
    float colorTime = timeSpeed * 2.0 + value * 3.0 + globalIntensity * 5.0;
    vec3 layerColor = getLayerColorPalette(layerIndex, colorTime) * (0.5 + globalIntensity * 1.5);
    
    // Apply geometry-based intensity modulation per layer
    vec3 extremeBaseColor;
    if (layerIndex == 0) {
        // Background: Subtle, fills empty space
        extremeBaseColor = layerColor * (0.3 + geometryIntensity * 0.4);
    }
    else if (layerIndex == 1) {
        // Shadow: Aggressive, high contrast where geometry is weak
        float shadowIntensity = pow(1.0 - geometryIntensity, 2.0); // Inverted for shadows
        extremeBaseColor = layerColor * (shadowIntensity * 0.8 + 0.1);
    }
    else if (layerIndex == 2) {
        // Content: Dominant, follows geometry strongly
        extremeBaseColor = layerColor * (geometryIntensity * 1.2 + 0.2);
    }
    else if (layerIndex == 3) {
        // Highlight: Electric, peaks only
        float peakIntensity = pow(geometryIntensity, 3.0); // Cubic for sharp peaks
        extremeBaseColor = layerColor * (peakIntensity * 1.5 + 0.1);
    }
    else {
        // Accent: Chaotic, random bursts
        float randomBurst = sin(value * 50.0 + timeSpeed * 10.0) * 0.5 + 0.5;
        extremeBaseColor = layerColor * (randomBurst * geometryIntensity * 2.0 + 0.05);
    }
    
    // Apply extreme RGB separation per layer
    vec3 extremeColor = extremeRGBSeparation(extremeBaseColor, uv, finalIntensity, layerIndex);
    
    // Layer-specific particle systems with extreme colors
    float extremeParticles = 0.0;
    if (layerIndex == 2 || layerIndex == 3) {
        // Only content and highlight layers get particles
        vec2 particleUV = uv * (layerIndex == 2 ? 12.0 : 20.0);
        vec2 particleID = floor(particleUV);
        vec2 particlePos = fract(particleUV) - 0.5;
        float particleDist = length(particlePos);
        
        float particleTime = timeSpeed * (layerIndex == 2 ? 3.0 : 8.0) + dot(particleID, vec2(127.1, 311.7));
        float particleAlpha = sin(particleTime) * 0.5 + 0.5;
        float particleSize = layerIndex == 2 ? 0.2 : 0.1;
        extremeParticles = (1.0 - smoothstep(0.05, particleSize, particleDist)) * particleAlpha * 0.4;
    }
    
    // Combine extreme color with particles based on layer
    vec3 finalColor;
    if (layerIndex == 0) {
        // Background: Pure extreme color
        finalColor = extremeColor;
    }
    else if (layerIndex == 1) {
        // Shadow: Dark with toxic highlights
        finalColor = extremeColor * 0.8;
    }
    else if (layerIndex == 2) {
        // Content: Blazing with white-hot particles
        finalColor = extremeColor + extremeParticles * vec3(1.0, 1.0, 1.0);
    }
    else if (layerIndex == 3) {
        // Highlight: Electric with cyan particles
        finalColor = extremeColor + extremeParticles * vec3(0.0, 1.0, 1.0);
    }
    else {
        // Accent: Chaotic magenta madness
        finalColor = extremeColor * (1.0 + sin(timeSpeed * 20.0) * 0.3);
    }
    
    // Layer-specific alpha intensity with extreme contrast
    float layerAlpha;
    if (layerIndex == 0) layerAlpha = 0.6;        // Background: Medium
    else if (layerIndex == 1) layerAlpha = 0.4;   // Shadow: Lower
    else if (layerIndex == 2) layerAlpha = 1.0;   // Content: Full intensity
    else if (layerIndex == 3) layerAlpha = 0.8;   // Highlight: High
    else layerAlpha = 0.3;                        // Accent: Subtle bursts
    
    gl_FragColor = vec4(finalColor, finalIntensity * layerAlpha);
}`;this.program=this.createProgram(e,t),this.uniforms={resolution:this.gl.getUniformLocation(this.program,"u_resolution"),time:this.gl.getUniformLocation(this.program,"u_time"),mouse:this.gl.getUniformLocation(this.program,"u_mouse"),geometry:this.gl.getUniformLocation(this.program,"u_geometry"),gridDensity:this.gl.getUniformLocation(this.program,"u_gridDensity"),morphFactor:this.gl.getUniformLocation(this.program,"u_morphFactor"),chaos:this.gl.getUniformLocation(this.program,"u_chaos"),speed:this.gl.getUniformLocation(this.program,"u_speed"),hue:this.gl.getUniformLocation(this.program,"u_hue"),intensity:this.gl.getUniformLocation(this.program,"u_intensity"),saturation:this.gl.getUniformLocation(this.program,"u_saturation"),dimension:this.gl.getUniformLocation(this.program,"u_dimension"),rot4dXY:this.gl.getUniformLocation(this.program,"u_rot4dXY"),rot4dXZ:this.gl.getUniformLocation(this.program,"u_rot4dXZ"),rot4dYZ:this.gl.getUniformLocation(this.program,"u_rot4dYZ"),rot4dXW:this.gl.getUniformLocation(this.program,"u_rot4dXW"),rot4dYW:this.gl.getUniformLocation(this.program,"u_rot4dYW"),rot4dZW:this.gl.getUniformLocation(this.program,"u_rot4dZW"),mouseIntensity:this.gl.getUniformLocation(this.program,"u_mouseIntensity"),clickIntensity:this.gl.getUniformLocation(this.program,"u_mouseIntensity"),roleIntensity:this.gl.getUniformLocation(this.program,"u_roleIntensity")}}createProgram(e,t){var s,n;const o=this.createShader(this.gl.VERTEX_SHADER,e),a=this.createShader(this.gl.FRAGMENT_SHADER,t);if(!o||!a)return null;const r=this.gl.createProgram();if(this.gl.attachShader(r,o),this.gl.attachShader(r,a),this.gl.linkProgram(r),this.gl.getProgramParameter(r,this.gl.LINK_STATUS))window.mobileDebug&&window.mobileDebug.log(`âœ… ${(n=this.canvas)==null?void 0:n.id}: Shader program linked successfully`);else{const l=this.gl.getProgramInfoLog(r);return console.error("Program linking failed:",l),window.mobileDebug&&window.mobileDebug.log(`âŒ ${(s=this.canvas)==null?void 0:s.id}: Shader program link failed - ${l}`),null}return r}createShader(e,t){var o,a,r,s,n,l;if(!this.gl)return console.error("âŒ Cannot create shader: WebGL context is null"),window.mobileDebug&&window.mobileDebug.log(`âŒ ${(o=this.canvas)==null?void 0:o.id}: Cannot create shader - WebGL context is null`),null;if(this.gl.isContextLost())return console.error("âŒ Cannot create shader: WebGL context is lost"),window.mobileDebug&&window.mobileDebug.log(`âŒ ${(a=this.canvas)==null?void 0:a.id}: Cannot create shader - WebGL context is lost`),null;try{const c=this.gl.createShader(e);if(!c)return console.error("âŒ Failed to create shader object - WebGL context may be invalid"),window.mobileDebug&&window.mobileDebug.log(`âŒ ${(r=this.canvas)==null?void 0:r.id}: Failed to create shader object`),null;if(this.gl.shaderSource(c,t),this.gl.compileShader(c),this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){if(window.mobileDebug){const d=e===this.gl.VERTEX_SHADER?"vertex":"fragment";window.mobileDebug.log(`âœ… ${(n=this.canvas)==null?void 0:n.id}: ${d} shader compiled successfully`)}}else{const d=this.gl.getShaderInfoLog(c),u=e===this.gl.VERTEX_SHADER?"vertex":"fragment";if(d?console.error(`âŒ ${u} shader compilation failed:`,d):console.error(`âŒ ${u} shader compilation failed: WebGL returned no error info (context may be invalid)`),console.error("Shader source:",t),window.mobileDebug){const m=d||"No error info (context may be invalid)";window.mobileDebug.log(`âŒ ${(s=this.canvas)==null?void 0:s.id}: ${u} shader compile failed - ${m}`);const f=t.split(`
`).slice(0,5).join("\\n");window.mobileDebug.log(`ğŸ” ${u} shader source start: ${f}...`)}return this.gl.deleteShader(c),null}return c}catch(c){return console.error("âŒ Exception during shader creation:",c),window.mobileDebug&&window.mobileDebug.log(`âŒ ${(l=this.canvas)==null?void 0:l.id}: Exception during shader creation - ${c.message}`),null}}initBuffers(){const e=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);const t=this.gl.getAttribLocation(this.program,"a_position");this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0)}resize(){var a,r;const e=Math.min(window.devicePixelRatio||1,2),t=this.canvas.clientWidth,o=this.canvas.clientHeight;window.mobileDebug&&(t===0||o===0)&&!this._zeroDimWarned&&(window.mobileDebug.log(`âš ï¸ ${(a=this.canvas)==null?void 0:a.id}: Canvas clientWidth=${t}, clientHeight=${o} - will be invisible`),this._zeroDimWarned=!0),(this.canvas.width!==t*e||this.canvas.height!==o*e)&&(this.canvas.width=t*e,this.canvas.height=o*e,this.gl.viewport(0,0,this.canvas.width,this.canvas.height),window.mobileDebug&&!this._finalSizeLogged&&(window.mobileDebug.log(`ğŸ“ ${(r=this.canvas)==null?void 0:r.id}: Final canvas buffer ${this.canvas.width}x${this.canvas.height} (DPR=${e})`),this._finalSizeLogged=!0))}showWebGLError(){if(!this.canvas)return;const e=this.canvas.getContext("2d");e&&(e.fillStyle="#000",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#64ff96",e.font="16px Orbitron, monospace",e.textAlign="center",e.fillText("WebGL Required",this.canvas.width/2,this.canvas.height/2),e.fillStyle="#888",e.font="12px Orbitron, monospace",e.fillText("Please enable WebGL in your browser",this.canvas.width/2,this.canvas.height/2+25))}updateParameters(e){this.params={...this.params,...e}}updateInteraction(e,t,o){this.mouseX=e,this.mouseY=t,this.mouseIntensity=o}render(){var n,l;if(!this.program){window.mobileDebug&&!this._noProgramWarned&&(window.mobileDebug.log(`âŒ ${(n=this.canvas)==null?void 0:n.id}: No WebGL program for render`),this._noProgramWarned=!0);return}this.resize(),this.gl.useProgram(this.program),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this._renderParamsLogged||(console.log(`[Mobile] ${(l=this.canvas)==null?void 0:l.id}: Render params - geometry=${this.params.geometry}, gridDensity=${this.params.gridDensity}, intensity=${this.params.intensity}`),this._renderParamsLogged=!0);const e={background:.4,shadow:.6,content:1,highlight:1.3,accent:1.6},t=Date.now()-this.startTime;this.gl.uniform2f(this.uniforms.resolution,this.canvas.width,this.canvas.height),this.gl.uniform1f(this.uniforms.time,t),this.gl.uniform2f(this.uniforms.mouse,this.mouseX,this.mouseY),this.gl.uniform1f(this.uniforms.geometry,this.params.geometry);let o=this.params.gridDensity,a=this.params.morphFactor,r=this.params.hue,s=this.params.chaos;window.audioEnabled&&window.audioReactive&&(o+=window.audioReactive.bass*40,a+=window.audioReactive.mid*1.2,r+=window.audioReactive.high*120,s+=window.audioReactive.energy*.6,Date.now()%1e4<16&&console.log(`ğŸŒŒ Quantum audio reactivity: Density+${(window.audioReactive.bass*40).toFixed(1)} Morph+${(window.audioReactive.mid*1.2).toFixed(2)} Hue+${(window.audioReactive.high*120).toFixed(1)} Chaos+${(window.audioReactive.energy*.6).toFixed(2)}`)),this.gl.uniform1f(this.uniforms.gridDensity,Math.min(100,o)),this.gl.uniform1f(this.uniforms.morphFactor,Math.min(2,a)),this.gl.uniform1f(this.uniforms.chaos,Math.min(1,s)),this.gl.uniform1f(this.uniforms.speed,this.params.speed),this.gl.uniform1f(this.uniforms.hue,r%360/360),this.gl.uniform1f(this.uniforms.intensity,this.params.intensity),this.gl.uniform1f(this.uniforms.saturation,this.params.saturation),this.gl.uniform1f(this.uniforms.dimension,this.params.dimension),this.gl.uniform1f(this.uniforms.rot4dXY,this.params.rot4dXY||0),this.gl.uniform1f(this.uniforms.rot4dXZ,this.params.rot4dXZ||0),this.gl.uniform1f(this.uniforms.rot4dYZ,this.params.rot4dYZ||0),this.gl.uniform1f(this.uniforms.rot4dXW,this.params.rot4dXW||0),this.gl.uniform1f(this.uniforms.rot4dYW,this.params.rot4dYW||0),this.gl.uniform1f(this.uniforms.rot4dZW,this.params.rot4dZW||0),this.gl.uniform1f(this.uniforms.mouseIntensity,this.mouseIntensity),this.gl.uniform1f(this.uniforms.clickIntensity,this.clickIntensity),this.gl.uniform1f(this.uniforms.roleIntensity,e[this.role]||1),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}destroy(){this.gl&&this.program&&this.gl.deleteProgram(this.program),this.gl&&this.buffer&&this.gl.deleteBuffer(this.buffer)}}class Si{constructor(){console.log("ğŸ”® Initializing VIB34D Quantum Engine..."),this.visualizers=[],this.parameters=new Ce,this.isActive=!1,this.useBuiltInReactivity=!window.reactivityManager,this.lastMousePosition={x:.5,y:.5},this.mouseVelocity={x:0,y:0},this.velocityHistory=[],this.maxVelocityHistory=10,this.baseHue=280,this.baseMorphFactor=1,this.parameters.setParameter("hue",this.baseHue),this.parameters.setParameter("intensity",.7),this.parameters.setParameter("saturation",.9),this.parameters.setParameter("gridDensity",20),this.parameters.setParameter("morphFactor",this.baseMorphFactor),this.init()}init(){this.createVisualizers(),this.setupAudioReactivity(),this.setupGestureVelocityReactivity(),this.startRenderLoop(),console.log("âœ¨ Quantum Engine initialized with audio + gesture velocity reactivity")}createVisualizers(){[{id:"quantum-background-canvas",role:"background",reactivity:.4},{id:"quantum-shadow-canvas",role:"shadow",reactivity:.6},{id:"quantum-content-canvas",role:"content",reactivity:1},{id:"quantum-highlight-canvas",role:"highlight",reactivity:1.3},{id:"quantum-accent-canvas",role:"accent",reactivity:1.6}].forEach(t=>{try{if(!document.getElementById(t.id)){console.warn(`âš ï¸ Canvas ${t.id} not found in DOM - skipping`);return}const a=new bi(t.id,t.role,t.reactivity,0);a.gl?(this.visualizers.push(a),console.log(`ğŸŒŒ Created quantum layer: ${t.role}`)):console.warn(`âš ï¸ No WebGL context for quantum layer ${t.id}`)}catch(o){console.warn(`Failed to create quantum layer ${t.id}:`,o)}}),console.log(`âœ… Created ${this.visualizers.length} quantum visualizers with enhanced effects`)}setActive(e){if(this.isActive=e,e){const t=document.getElementById("quantumLayers");t&&(t.style.display="block"),window.audioEnabled&&!this.audioEnabled&&this.enableAudio(),console.log("ğŸ”® Quantum System ACTIVATED - Audio frequency reactivity mode")}else{const t=document.getElementById("quantumLayers");t&&(t.style.display="none"),console.log("ğŸ”® Quantum System DEACTIVATED")}}toggleAudio(e){e&&this.isActive&&!this.audioEnabled?this.enableAudio():!e&&this.audioEnabled&&(this.audioEnabled=!1,this.audioContext&&(this.audioContext.close(),this.audioContext=null),console.log("ğŸ”‡ Quantum audio reactivity disabled"))}setupAudioReactivity(){console.log("ğŸŒŒ Setting up Quantum audio frequency reactivity")}setupGestureVelocityReactivity(){if(!this.useBuiltInReactivity){console.log("ğŸŒŒ Quantum built-in reactivity DISABLED - ReactivityManager active");return}console.log("ğŸŒŒ Setting up Quantum: velocity + click + scroll + multi-parameter reactivity"),this.clickFlashIntensity=0,this.scrollMorph=1,this.velocitySmoothing=.8,["quantum-background-canvas","quantum-shadow-canvas","quantum-content-canvas","quantum-highlight-canvas","quantum-accent-canvas"].forEach(t=>{const o=document.getElementById(t);o&&(o.addEventListener("mousemove",a=>{if(!this.isActive)return;const r=o.getBoundingClientRect(),s=(a.clientX-r.left)/r.width,n=(a.clientY-r.top)/r.height;this.updateEnhancedQuantumParameters(s,n)}),o.addEventListener("touchmove",a=>{if(this.isActive&&(a.preventDefault(),a.touches.length>0)){const r=a.touches[0],s=o.getBoundingClientRect(),n=(r.clientX-s.left)/s.width,l=(r.clientY-s.top)/s.height;this.updateEnhancedQuantumParameters(n,l)}},{passive:!1}),o.addEventListener("click",a=>{this.isActive&&this.triggerQuantumClick()}),o.addEventListener("touchend",a=>{this.isActive&&this.triggerQuantumClick()}),o.addEventListener("wheel",a=>{this.isActive&&(a.preventDefault(),this.updateQuantumScroll(a.deltaY))},{passive:!1}))}),this.startQuantumEffectLoops()}updateEnhancedQuantumParameters(e,t){const o=e-this.lastMousePosition.x,a=t-this.lastMousePosition.y,r=Math.sqrt(o*o+a*a);this.velocityHistory.push(r),this.velocityHistory.length>5&&this.velocityHistory.shift();const s=this.velocityHistory.reduce((L,S)=>L+S,0)/this.velocityHistory.length,n=(e-.5)*Math.PI*2,l=n*.5,c=n*.3,d=n*.2,u=10+t*90,h=Math.sqrt(Math.pow(e-.5,2)+Math.pow(t-.5,2)),y=Math.min(1,h*Math.sqrt(2)),w=e<.5,T=t<.5;let C;w&&T?C=240:!w&&T?C=300:w&&!T?C=180:C=320;const b=y*60,F=(C+b)%360,G=Math.min(1,s*30),A=.5+Math.min(2.5,s*15),P=.3+y*.7;window.updateParameter&&(window.updateParameter("rot4dXW",l.toFixed(3)),window.updateParameter("rot4dYW",c.toFixed(3)),window.updateParameter("rot4dZW",d.toFixed(3)),window.updateParameter("chaos",G.toFixed(2)),window.updateParameter("speed",A.toFixed(2)),window.updateParameter("gridDensity",Math.round(u)),window.updateParameter("intensity",P.toFixed(2)),window.updateParameter("hue",Math.round(F))),this.lastMousePosition.x=e,this.lastMousePosition.y=t,console.log(`ğŸŒŒ Quantum EXPERIMENTAL: X=${e.toFixed(2)}â†’Rot=${n.toFixed(2)}, Y=${t.toFixed(2)}â†’Density=${Math.round(u)}, Dist=${y.toFixed(2)}â†’Hue=${Math.round(F)}, Hemisphere=${w?"L":"R"}${T?"T":"B"}`)}triggerQuantumClick(){this.clickFlashIntensity=1,this.quantumChaosBlast=.7,this.quantumSpeedWave=2,this.quantumHueShift=60,console.log("ğŸ’¥ Quantum energy burst: flash + chaos + speed + hue explosion")}updateQuantumScroll(e){const o=e>0?1:-1;this.scrollMorph+=o*.02,this.scrollMorph=Math.max(.2,Math.min(2,this.scrollMorph)),window.updateParameter&&window.updateParameter("morphFactor",this.scrollMorph.toFixed(2)),console.log(`ğŸŒ€ Quantum scroll morph: ${this.scrollMorph.toFixed(2)}`)}startQuantumEffectLoops(){const e=()=>{if(this.clickFlashIntensity>.01){const t=.9+this.clickFlashIntensity*.1,o=this.scrollMorph+this.clickFlashIntensity*.5;window.updateParameter&&(window.updateParameter("saturation",t.toFixed(2)),window.updateParameter("morphFactor",o.toFixed(2))),this.clickFlashIntensity*=.91}if(this.quantumChaosBlast>.01){const o=.3+this.quantumChaosBlast;window.updateParameter&&window.updateParameter("chaos",Math.min(1,o).toFixed(2)),this.quantumChaosBlast*=.88}if(this.quantumSpeedWave>.01){const o=1+this.quantumSpeedWave;window.updateParameter&&window.updateParameter("speed",Math.min(3,o).toFixed(2)),this.quantumSpeedWave*=.89}if(this.quantumHueShift>1){const o=(280+this.quantumHueShift)%360;window.updateParameter&&window.updateParameter("hue",Math.round(o)),this.quantumHueShift*=.9}this.isActive&&requestAnimationFrame(e)};e()}async enableAudio(){if(!this.audioEnabled)try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.analyser.smoothingTimeConstant=.8,this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount),this.audioContext.createMediaStreamSource(e).connect(this.analyser),this.audioEnabled=!0,console.log("ğŸµ Quantum audio reactivity enabled")}catch(e){console.error("âŒ Failed to enable Quantum audio:",e),this.audioEnabled=!1}}updateParameter(e,t){this.parameters.setParameter(e,t),this.visualizers.forEach(o=>{if(o.updateParameters){const a={};a[e]=t,o.updateParameters(a)}else o.params&&(o.params[e]=t,o.render&&o.render())}),console.log(`ğŸ”® Updated quantum ${e}: ${t}`)}updateParameters(e){Object.keys(e).forEach(t=>{this.updateParameter(t,e[t])})}updateInteraction(e,t,o){this.visualizers.forEach(a=>{a.updateInteraction&&a.updateInteraction(e,t,o)})}getParameters(){return this.parameters.getAllParameters()}setParameters(e){Object.keys(e).forEach(t=>{this.parameters.setParameter(t,e[t])}),this.updateParameters(e)}startRenderLoop(){var t;window.mobileDebug&&window.mobileDebug.log(`ğŸ¬ Quantum Engine: Starting render loop with ${(t=this.visualizers)==null?void 0:t.length} visualizers, isActive=${this.isActive}`);const e=()=>{var o;if(this.isActive){const a=this.parameters.getAllParameters();this.visualizers.forEach(r=>{r.updateParameters&&r.render&&(r.updateParameters(a),r.render())}),window.mobileDebug&&!this._renderActivityLogged&&(window.mobileDebug.log(`ğŸ¬ Quantum Engine: Actively rendering ${(o=this.visualizers)==null?void 0:o.length} visualizers`),this._renderActivityLogged=!0)}else window.mobileDebug&&!this._inactiveWarningLogged&&(window.mobileDebug.log("âš ï¸ Quantum Engine: Not rendering because isActive=false"),this._inactiveWarningLogged=!0);requestAnimationFrame(e)};e(),console.log("ğŸ¬ Quantum render loop started"),window.mobileDebug&&window.mobileDebug.log("âœ… Quantum Engine: Render loop started, will render when isActive=true")}updateClick(e){this.visualizers.forEach(t=>{t.triggerClick&&t.triggerClick(.5,.5,e)})}updateScroll(e){this.visualizers.forEach(t=>{t.updateScroll&&t.updateScroll(e)})}destroy(){window.universalReactivity&&window.universalReactivity.disconnectSystem("quantum"),this.visualizers.forEach(e=>{e.destroy&&e.destroy()}),this.visualizers=[],console.log("ğŸ§¹ Quantum Engine destroyed")}}const xi=Object.freeze(Object.defineProperty({__proto__:null,QuantumEngine:Si},Symbol.toStringTag,{value:"Module"}));class Ei{constructor(e,t="content",o=1,a=0){this.canvas=document.getElementById(e),this.role=t,this.reactivity=o,this.variant=a,this.contextOptions={alpha:!0,depth:!0,stencil:!1,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1};let r=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");if(r&&!r.isContextLost()?(console.log(`ğŸ”„ Reusing existing WebGL context for ${e}`),this.gl=r):this.gl=this.canvas.getContext("webgl2",this.contextOptions)||this.canvas.getContext("webgl",this.contextOptions)||this.canvas.getContext("experimental-webgl",this.contextOptions),!this.gl)throw console.error(`WebGL not supported for ${e}`),this.showWebGLError(),new Error(`WebGL not supported for ${e}`);this.variantParams=this.generateVariantParams(a),this.roleParams=this.generateRoleParams(t),this.mouseX=.5,this.mouseY=.5,this.mouseIntensity=0,this.clickIntensity=0,this.clickDecay=.95,this.touchX=.5,this.touchY=.5,this.touchActive=!1,this.touchMorph=0,this.touchChaos=0,this.scrollPosition=0,this.scrollVelocity=0,this.scrollDecay=.92,this.parallaxDepth=0,this.gridDensityShift=0,this.colorScrollShift=0,this.densityVariation=0,this.densityTarget=0,this.audioData={bass:0,mid:0,high:0},this.audioDensityBoost=0,this.audioMorphBoost=0,this.audioSpeedBoost=0,this.audioChaosBoost=0,this.audioColorShift=0,this.startTime=Date.now(),this.initShaders(),this.initBuffers(),this.resize()}generateVariantParams(e){const t=["TETRAHEDRON","HYPERCUBE","SPHERE","TORUS","KLEIN BOTTLE","FRACTAL","WAVE","CRYSTAL"],a=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,6,6,6,7,7,7,7][e]||0,r=e%4,l=t[a]+[" LATTICE"," FIELD"," MATRIX"," RESONANCE"][r],d={0:{density:.8+r*.2,speed:.3+r*.1,chaos:r*.1,morph:0+r*.2},1:{density:1+r*.3,speed:.5+r*.1,chaos:r*.15,morph:r*.2},2:{density:1.2+r*.4,speed:.4+r*.2,chaos:.1+r*.1,morph:.3+r*.2},3:{density:.9+r*.3,speed:.6+r*.2,chaos:.2+r*.2,morph:.5+r*.1},4:{density:1.4+r*.5,speed:.7+r*.1,chaos:.3+r*.2,morph:.7+r*.1},5:{density:1.8+r*.3,speed:.5+r*.3,chaos:.5+r*.2,morph:.8+r*.05},6:{density:.6+r*.4,speed:.8+r*.4,chaos:.4+r*.3,morph:.6+r*.2},7:{density:1.6+r*.2,speed:.2+r*.1,chaos:.1+r*.1,morph:.2+r*.2}}[a];return{geometryType:a,name:l,density:d.density,speed:d.speed,hue:e*12.27%360,saturation:.8+r*.05,intensity:.5+r*.1,chaos:d.chaos,morph:d.morph}}generateRoleParams(e){const t=this.variantParams;return{background:{densityMult:.4,speedMult:.2,colorShift:0,intensity:.2,mouseReactivity:.3,clickReactivity:.1},shadow:{densityMult:.8,speedMult:.3,colorShift:180,intensity:.4,mouseReactivity:.5,clickReactivity:.3},content:{densityMult:t.density,speedMult:t.speed,colorShift:t.hue,intensity:t.intensity,mouseReactivity:1,clickReactivity:.8},highlight:{densityMult:1.5+t.density*.3,speedMult:.8+t.speed*.2,colorShift:t.hue+60,intensity:.6+t.intensity*.2,mouseReactivity:1.2,clickReactivity:1},accent:{densityMult:2.5+t.density*.5,speedMult:.4+t.speed*.1,colorShift:t.hue+300,intensity:.3+t.intensity*.1,mouseReactivity:1.5,clickReactivity:1.2}}[e]||{densityMult:1,speedMult:.5,colorShift:0,intensity:.5,mouseReactivity:1,clickReactivity:.5}}initShaders(){const e=`
            attribute vec2 a_position;
            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
            }
        `,t=`
            precision highp float;
            
            uniform vec2 u_resolution;
            uniform float u_time;
            uniform vec2 u_mouse;
            uniform float u_geometry;
            uniform float u_density;
            uniform float u_speed;
            uniform vec3 u_color;
            uniform float u_intensity;
            uniform float u_roleDensity;
            uniform float u_roleSpeed;
            uniform float u_colorShift;
            uniform float u_chaosIntensity;
            uniform float u_mouseIntensity;
            uniform float u_clickIntensity;
            uniform float u_densityVariation;
            uniform float u_geometryType;
            uniform float u_chaos;
            uniform float u_morph;
            uniform float u_touchMorph;
            uniform float u_touchChaos;
            uniform float u_scrollParallax;
            uniform float u_gridDensityShift;
            uniform float u_colorScrollShift;
            uniform float u_audioDensityBoost;
            uniform float u_audioMorphBoost;
            uniform float u_audioSpeedBoost;
            uniform float u_audioChaosBoost;
            uniform float u_audioColorShift;
            uniform float u_rot4dXY;
            uniform float u_rot4dXZ;
            uniform float u_rot4dYZ;
            uniform float u_rot4dXW;
            uniform float u_rot4dYW;
            uniform float u_rot4dZW;

            // 6D rotation matrices - 3D space rotations (XY, XZ, YZ)
            mat4 rotateXY(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(c, -s, 0, 0, s, c, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
            }

            mat4 rotateXZ(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(c, 0, s, 0, 0, 1, 0, 0, -s, 0, c, 0, 0, 0, 0, 1);
            }

            mat4 rotateYZ(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(1, 0, 0, 0, 0, c, -s, 0, 0, s, c, 0, 0, 0, 0, 1);
            }

            // 4D hyperspace rotations (XW, YW, ZW)
            mat4 rotateXW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(c, 0, 0, -s, 0, 1, 0, 0, 0, 0, 1, 0, s, 0, 0, c);
            }

            mat4 rotateYW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(1, 0, 0, 0, 0, c, 0, -s, 0, 0, 1, 0, 0, s, 0, c);
            }

            mat4 rotateZW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, c, -s, 0, 0, s, c);
            }
            
            // 4D to 3D projection
            vec3 project4Dto3D(vec4 p) {
                float w = 2.5 / (2.5 + p.w);
                return vec3(p.x * w, p.y * w, p.z * w);
            }

            // ========================================
            // POLYTOPE CORE WARP FUNCTIONS (24 Geometries)
            // ========================================
            vec3 warpHypersphereCore(vec3 p, int geometryIndex, vec2 mouseDelta) {
                float radius = length(p);
                float morphBlend = clamp(u_morph * 0.6 + 0.3, 0.0, 2.0);
                float w = sin(radius * (1.3 + float(geometryIndex) * 0.12) + u_time * 0.0008 * u_speed);
                w *= (0.4 + morphBlend * 0.45);

                vec4 p4d = vec4(p * (1.0 + morphBlend * 0.2), w);
                p4d = rotateXY(u_rot4dXY) * p4d;
                p4d = rotateXZ(u_rot4dXZ) * p4d;
                p4d = rotateYZ(u_rot4dYZ) * p4d;
                p4d = rotateXW(u_rot4dXW) * p4d;
                p4d = rotateYW(u_rot4dYW) * p4d;
                p4d = rotateZW(u_rot4dZW) * p4d;

                vec3 projected = project4Dto3D(p4d);
                return mix(p, projected, clamp(0.45 + morphBlend * 0.35, 0.0, 1.0));
            }

            vec3 warpHypertetraCore(vec3 p, int geometryIndex, vec2 mouseDelta) {
                vec3 c1 = normalize(vec3(1.0, 1.0, 1.0));
                vec3 c2 = normalize(vec3(-1.0, -1.0, 1.0));
                vec3 c3 = normalize(vec3(-1.0, 1.0, -1.0));
                vec3 c4 = normalize(vec3(1.0, -1.0, -1.0));

                float morphBlend = clamp(u_morph * 0.8 + 0.2, 0.0, 2.0);
                float basisMix = dot(p, c1) * 0.14 + dot(p, c2) * 0.1 + dot(p, c3) * 0.08;
                float w = sin(basisMix * 5.5 + u_time * 0.0009 * u_speed);
                w *= cos(dot(p, c4) * 4.2 - u_time * 0.0007 * u_speed);
                w *= (0.5 + morphBlend * 0.4);

                vec3 offset = vec3(dot(p, c1), dot(p, c2), dot(p, c3)) * 0.1 * morphBlend;
                vec4 p4d = vec4(p + offset, w);
                p4d = rotateXY(u_rot4dXY) * p4d;
                p4d = rotateXZ(u_rot4dXZ) * p4d;
                p4d = rotateYZ(u_rot4dYZ) * p4d;
                p4d = rotateXW(u_rot4dXW) * p4d;
                p4d = rotateYW(u_rot4dYW) * p4d;
                p4d = rotateZW(u_rot4dZW) * p4d;

                vec3 projected = project4Dto3D(p4d);

                float planeInfluence = min(min(abs(dot(p, c1)), abs(dot(p, c2))), min(abs(dot(p, c3)), abs(dot(p, c4))));
                vec3 blended = mix(p, projected, clamp(0.45 + morphBlend * 0.35, 0.0, 1.0));
                return mix(blended, blended * (1.0 - planeInfluence * 0.55), 0.2 + morphBlend * 0.2);
            }

            vec3 applyCoreWarp(vec3 p, float geometryType, vec2 mouseDelta) {
                float totalBase = 8.0;
                float coreFloat = floor(geometryType / totalBase);
                int coreIndex = int(clamp(coreFloat, 0.0, 2.0));
                float baseGeomFloat = geometryType - floor(geometryType / totalBase) * totalBase;
                int geometryIndex = int(clamp(floor(baseGeomFloat + 0.5), 0.0, totalBase - 1.0));

                if (coreIndex == 1) {
                    return warpHypersphereCore(p, geometryIndex, mouseDelta);
                }
                if (coreIndex == 2) {
                    return warpHypertetraCore(p, geometryIndex, mouseDelta);
                }
                return p;
            }
            // ========================================

            // Enhanced VIB3 Geometry Library - Higher Fidelity
            float tetrahedronLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                
                // Enhanced tetrahedron vertices with holographic shimmer
                float d1 = length(q);
                float d2 = length(q - vec3(0.35, 0.0, 0.0));
                float d3 = length(q - vec3(0.0, 0.35, 0.0));
                float d4 = length(q - vec3(0.0, 0.0, 0.35));
                float d5 = length(q - vec3(0.2, 0.2, 0.0));
                float d6 = length(q - vec3(0.2, 0.0, 0.2));
                float d7 = length(q - vec3(0.0, 0.2, 0.2));
                
                float vertices = 1.0 - smoothstep(0.0, 0.03, min(min(min(d1, d2), min(d3, d4)), min(min(d5, d6), d7)));
                
                // Enhanced edge network with interference patterns
                float edges = 0.0;
                float shimmer = sin(u_time * 0.002) * 0.02;
                edges = max(edges, 1.0 - smoothstep(0.0, 0.015, abs(length(q.xy) - (0.18 + shimmer))));
                edges = max(edges, 1.0 - smoothstep(0.0, 0.015, abs(length(q.yz) - (0.18 + shimmer * 0.8))));
                edges = max(edges, 1.0 - smoothstep(0.0, 0.015, abs(length(q.xz) - (0.18 + shimmer * 1.2))));
                
                // Add interference patterns between vertices
                float interference = sin(d1 * 25.0 + u_time * 0.003) * sin(d2 * 22.0 + u_time * 0.0025) * 0.1;
                
                // Volumetric density based on distance field
                float volume = exp(-length(q) * 3.0) * 0.15;
                
                return max(vertices, edges * 0.7) + interference + volume;
            }
            
            float hypercubeLattice(vec3 p, float gridSize) {
                vec3 grid = fract(p * gridSize);
                vec3 q = grid - 0.5;
                
                // Enhanced hypercube with 4D projection effects
                vec3 edges = 1.0 - smoothstep(0.0, 0.025, abs(q));
                float wireframe = max(max(edges.x, edges.y), edges.z);
                
                // Add 4D hypercube vertices (8 corners + 8 hypervertices)
                float vertices = 0.0;
                for(int i = 0; i < 8; i++) {
                    // WebGL 1.0 compatible modulus replacement
                    float iFloat = float(i);
                    vec3 corner = vec3(
                        floor(iFloat - floor(iFloat / 2.0) * 2.0) - 0.5,
                        floor((iFloat / 2.0) - floor((iFloat / 2.0) / 2.0) * 2.0) - 0.5,
                        float(i / 4) - 0.5
                    );
                    float dist = length(q - corner * 0.4);
                    vertices = max(vertices, 1.0 - smoothstep(0.0, 0.04, dist));
                }
                
                // Holographic interference patterns
                float interference = sin(length(q) * 20.0 + u_time * 0.002) * 0.08;
                
                // Cross-dimensional glow
                float glow = exp(-length(q) * 2.5) * 0.12;
                
                return wireframe * 0.8 + vertices + interference + glow;
            }
            
            float sphereLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                float r = length(q);
                return 1.0 - smoothstep(0.2, 0.5, r);
            }
            
            float torusLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                float r1 = sqrt(q.x*q.x + q.y*q.y);
                float r2 = sqrt((r1 - 0.3)*(r1 - 0.3) + q.z*q.z);
                return 1.0 - smoothstep(0.0, 0.1, r2);
            }
            
            float kleinLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize);
                float u = q.x * 2.0 * 3.14159;
                float v = q.y * 2.0 * 3.14159;
                float x = cos(u) * (3.0 + cos(u/2.0) * sin(v) - sin(u/2.0) * sin(2.0*v));
                float klein = length(vec2(x, q.z)) - 0.1;
                return 1.0 - smoothstep(0.0, 0.05, abs(klein));
            }
            
            float fractalLattice(vec3 p, float gridSize) {
                vec3 q = p * gridSize;
                float scale = 1.0;
                float fractal = 0.0;
                for(int i = 0; i < 4; i++) {
                  q = fract(q) - 0.5;
                  fractal += abs(length(q)) / scale;
                  scale *= 2.0;
                  q *= 2.0;
                }
                return 1.0 - smoothstep(0.0, 1.0, fractal);
            }
            
            float waveLattice(vec3 p, float gridSize) {
                vec3 q = p * gridSize;
                float wave = sin(q.x * 2.0) * sin(q.y * 2.0) * sin(q.z * 2.0 + u_time);
                return smoothstep(-0.5, 0.5, wave);
            }
            
            float crystalLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                float d = max(max(abs(q.x), abs(q.y)), abs(q.z));
                return 1.0 - smoothstep(0.3, 0.5, d);
            }
            
            float getDynamicGeometry(vec3 p, float gridSize, float geometryType) {
                // Apply polytope core warp transformation (24-geometry system)
                vec3 warped = applyCoreWarp(p, geometryType, vec2(0.0, 0.0));

                // WebGL 1.0 compatible modulus replacement - decode base geometry
                float baseGeomFloat = geometryType - floor(geometryType / 8.0) * 8.0;
                int baseGeom = int(baseGeomFloat);
                float variation = floor(geometryType / 8.0) / 4.0;
                float variedGridSize = gridSize * (0.5 + variation * 1.5);

                // Call lattice functions with warped point (enables 24 geometry variants)
                if (baseGeom == 0) return tetrahedronLattice(warped, variedGridSize);
                else if (baseGeom == 1) return hypercubeLattice(warped, variedGridSize);
                else if (baseGeom == 2) return sphereLattice(warped, variedGridSize);
                else if (baseGeom == 3) return torusLattice(warped, variedGridSize);
                else if (baseGeom == 4) return kleinLattice(warped, variedGridSize);
                else if (baseGeom == 5) return fractalLattice(warped, variedGridSize);
                else if (baseGeom == 6) return waveLattice(warped, variedGridSize);
                else return crystalLattice(warped, variedGridSize);
            }
            
            vec3 hsv2rgb(vec3 c) {
                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
            }
            
            vec3 rgbGlitch(vec3 color, vec2 uv, float intensity) {
                vec2 offset = vec2(intensity * 0.005, 0.0);
                float r = color.r + sin(uv.y * 30.0 + u_time * 0.001) * intensity * 0.06;
                float g = color.g + sin(uv.y * 28.0 + u_time * 0.0012) * intensity * 0.06;
                float b = color.b + sin(uv.y * 32.0 + u_time * 0.0008) * intensity * 0.06;
                return vec3(r, g, b);
            }
            
            float moirePattern(vec2 uv, float intensity) {
                float freq1 = 12.0 + intensity * 6.0 + u_densityVariation * 3.0;
                float freq2 = 14.0 + intensity * 8.0 + u_densityVariation * 4.0;
                float pattern1 = sin(uv.x * freq1) * sin(uv.y * freq1);
                float pattern2 = sin(uv.x * freq2) * sin(uv.y * freq2);
                return (pattern1 * pattern2) * intensity * 0.15;
            }
            
            float gridOverlay(vec2 uv, float intensity) {
                vec2 grid = fract(uv * (8.0 + u_densityVariation * 4.0));
                float lines = 0.0;
                lines = max(lines, 1.0 - smoothstep(0.0, 0.02, abs(grid.x - 0.5)));
                lines = max(lines, 1.0 - smoothstep(0.0, 0.02, abs(grid.y - 0.5)));
                return lines * intensity * 0.1;
            }
            
            void main() {
                vec2 uv = gl_FragCoord.xy / u_resolution.xy;
                float aspectRatio = u_resolution.x / u_resolution.y;
                uv.x *= aspectRatio;
                uv -= 0.5;
                
                float time = u_time * 0.0004 * u_speed * u_roleSpeed;
                
                float mouseInfluence = u_mouseIntensity * 0.25; // FIX: Reduce mouse jarring by 50%
                vec2 mouseOffset = (u_mouse - 0.5) * mouseInfluence;
                
                float parallaxOffset = u_scrollParallax * 0.2;
                vec2 scrollOffset = vec2(parallaxOffset * 0.1, parallaxOffset * 0.05);
                
                float morphOffset = u_touchMorph * 0.3;
                
                vec4 p4d = vec4(uv + mouseOffset * 0.1 + scrollOffset, 
                               sin(time * 0.1 + morphOffset) * 0.15, 
                               cos(time * 0.08 + morphOffset * 0.5) * 0.15);
                
                float scrollRotation = u_scrollParallax * 0.1;
                float touchRotation = u_touchMorph * 0.2;

                // Combine manual rotation with automatic/interactive rotation - 6D full rotation
                p4d = rotateXY(u_rot4dXY + time * 0.1) * p4d;
                p4d = rotateXZ(u_rot4dXZ + time * 0.12) * p4d;
                p4d = rotateYZ(u_rot4dYZ + time * 0.08) * p4d;
                p4d = rotateXW(u_rot4dXW + time * 0.2 + mouseOffset.y * 0.5 + scrollRotation) * p4d;
                p4d = rotateYW(u_rot4dYW + time * 0.15 + mouseOffset.x * 0.5 + touchRotation) * p4d;
                p4d = rotateZW(u_rot4dZW + time * 0.25 + u_clickIntensity * 0.3 + u_touchChaos * 0.4) * p4d;
                
                vec3 p = project4Dto3D(p4d);
                
                float scrollDensityMod = 1.0 + u_gridDensityShift * 0.3;
                float audioDensityMod = 1.0 + u_audioDensityBoost * 0.5;
                // FIX: Prevent density doubling by using base density with controlled variations
                float baseDensity = u_density * u_roleDensity;
                float densityVariations = (u_densityVariation * 0.3 + (scrollDensityMod - 1.0) * 0.4 + (audioDensityMod - 1.0) * 0.2);
                float roleDensity = baseDensity + densityVariations;
                
                float morphedGeometry = u_geometryType + u_morph * 3.0 + u_touchMorph * 2.0 + u_audioMorphBoost * 1.5;
                float lattice = getDynamicGeometry(p, roleDensity, morphedGeometry);
                
                // Enhanced holographic color processing
                vec3 baseColor = u_color;
                float latticeIntensity = lattice * u_intensity;
                
                // Multi-layer color composition for higher fidelity
                vec3 color = baseColor * (0.2 + latticeIntensity * 0.8);
                
                // Holographic shimmer layers
                vec3 shimmer1 = baseColor * lattice * 0.5;
                vec3 shimmer2 = baseColor * sin(lattice * 8.0 + u_time * 0.001) * 0.2;
                vec3 shimmer3 = baseColor * cos(lattice * 12.0 + u_time * 0.0008) * 0.15;
                
                color += shimmer1 + shimmer2 + shimmer3;
                
                // Enhanced brightness variations with interference
                color += vec3(lattice * 0.6) * baseColor;
                color += vec3(sin(lattice * 15.0) * 0.1) * baseColor;
                
                // Depth-based coloring for 3D effect
                float depth = 1.0 - length(p) * 0.3;
                color *= (0.7 + depth * 0.3);
                
                float enhancedChaos = u_chaos + u_chaosIntensity + u_touchChaos * 0.3 + u_audioChaosBoost * 0.4;
                color += vec3(moirePattern(uv + scrollOffset, enhancedChaos));
                color += vec3(gridOverlay(uv, u_mouseIntensity + u_scrollParallax * 0.1));
                color = rgbGlitch(color, uv, enhancedChaos);
                
                // Apply morph distortion to position
                vec2 morphDistortion = vec2(sin(uv.y * 10.0 + u_time * 0.001) * u_morph * 0.1, 
                                           cos(uv.x * 10.0 + u_time * 0.001) * u_morph * 0.1);
                color = mix(color, color * (1.0 + length(morphDistortion)), u_morph * 0.5);
                
                // Enhanced holographic interaction effects
                float mouseDist = length(uv - (u_mouse - 0.5) * vec2(aspectRatio, 1.0));
                
                // Multi-layer mouse glow with holographic ripples
                float mouseGlow = exp(-mouseDist * 1.2) * u_mouseIntensity * 0.25;
                float mouseRipple = sin(mouseDist * 15.0 - u_time * 0.003) * exp(-mouseDist * 2.0) * u_mouseIntensity * 0.1;
                color += vec3(mouseGlow + mouseRipple) * baseColor * 0.8;
                
                // Enhanced click pulse with interference
                float clickPulse = u_clickIntensity * exp(-mouseDist * 1.8) * 0.4;
                float clickRing = sin(mouseDist * 20.0 - u_clickIntensity * 5.0) * u_clickIntensity * 0.15;
                color += vec3(clickPulse + clickRing, (clickPulse + clickRing) * 0.6, (clickPulse + clickRing) * 1.2);
                
                // Holographic interference from interactions
                float interference = sin(mouseDist * 25.0 + u_time * 0.002) * u_mouseIntensity * 0.05;
                color += vec3(interference) * baseColor;
                
                gl_FragColor = vec4(color, 0.95);
            }
        `;this.program=this.createProgram(e,t),this.uniforms={resolution:this.gl.getUniformLocation(this.program,"u_resolution"),time:this.gl.getUniformLocation(this.program,"u_time"),mouse:this.gl.getUniformLocation(this.program,"u_mouse"),geometry:this.gl.getUniformLocation(this.program,"u_geometry"),density:this.gl.getUniformLocation(this.program,"u_density"),speed:this.gl.getUniformLocation(this.program,"u_speed"),color:this.gl.getUniformLocation(this.program,"u_color"),intensity:this.gl.getUniformLocation(this.program,"u_intensity"),roleDensity:this.gl.getUniformLocation(this.program,"u_roleDensity"),roleSpeed:this.gl.getUniformLocation(this.program,"u_roleSpeed"),colorShift:this.gl.getUniformLocation(this.program,"u_colorShift"),chaosIntensity:this.gl.getUniformLocation(this.program,"u_chaosIntensity"),mouseIntensity:this.gl.getUniformLocation(this.program,"u_mouseIntensity"),clickIntensity:this.gl.getUniformLocation(this.program,"u_clickIntensity"),densityVariation:this.gl.getUniformLocation(this.program,"u_densityVariation"),geometryType:this.gl.getUniformLocation(this.program,"u_geometryType"),chaos:this.gl.getUniformLocation(this.program,"u_chaos"),morph:this.gl.getUniformLocation(this.program,"u_morph"),touchMorph:this.gl.getUniformLocation(this.program,"u_touchMorph"),touchChaos:this.gl.getUniformLocation(this.program,"u_touchChaos"),scrollParallax:this.gl.getUniformLocation(this.program,"u_scrollParallax"),gridDensityShift:this.gl.getUniformLocation(this.program,"u_gridDensityShift"),colorScrollShift:this.gl.getUniformLocation(this.program,"u_colorScrollShift"),audioDensityBoost:this.gl.getUniformLocation(this.program,"u_audioDensityBoost"),audioMorphBoost:this.gl.getUniformLocation(this.program,"u_audioMorphBoost"),audioSpeedBoost:this.gl.getUniformLocation(this.program,"u_audioSpeedBoost"),audioChaosBoost:this.gl.getUniformLocation(this.program,"u_audioChaosBoost"),audioColorShift:this.gl.getUniformLocation(this.program,"u_audioColorShift"),rot4dXY:this.gl.getUniformLocation(this.program,"u_rot4dXY"),rot4dXZ:this.gl.getUniformLocation(this.program,"u_rot4dXZ"),rot4dYZ:this.gl.getUniformLocation(this.program,"u_rot4dYZ"),rot4dXW:this.gl.getUniformLocation(this.program,"u_rot4dXW"),rot4dYW:this.gl.getUniformLocation(this.program,"u_rot4dYW"),rot4dZW:this.gl.getUniformLocation(this.program,"u_rot4dZW")}}createProgram(e,t){const o=this.createShader(this.gl.VERTEX_SHADER,e),a=this.createShader(this.gl.FRAGMENT_SHADER,t),r=this.gl.createProgram();if(this.gl.attachShader(r,o),this.gl.attachShader(r,a),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS))throw new Error("Program linking failed: "+this.gl.getProgramInfoLog(r));return r}createShader(e,t){if(!this.gl)throw console.error("âŒ Cannot create shader: WebGL context is null"),new Error("WebGL context is null");if(this.gl.isContextLost())throw console.error("âŒ Cannot create shader: WebGL context is lost"),new Error("WebGL context is lost");try{const o=this.gl.createShader(e);if(!o)throw console.error("âŒ Failed to create shader object - WebGL context may be invalid"),new Error("Failed to create shader object - WebGL context may be invalid");if(this.gl.shaderSource(o,t),this.gl.compileShader(o),!this.gl.getShaderParameter(o,this.gl.COMPILE_STATUS)){const a=this.gl.getShaderInfoLog(o),r=e===this.gl.VERTEX_SHADER?"vertex":"fragment";throw a?(console.error(`âŒ ${r} shader compilation failed:`,a),new Error(`${r} shader compilation failed: ${a}`)):(console.error(`âŒ ${r} shader compilation failed: WebGL returned no error info (context may be invalid)`),new Error(`${r} shader compilation failed: WebGL returned no error info (context may be invalid)`))}return o}catch(o){throw console.error("âŒ Exception during shader creation:",o),o}}initBuffers(){const e=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);const t=this.gl.getAttribLocation(this.program,"a_position");this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0)}resize(){const e=Math.min(window.devicePixelRatio||1,2),t=this.canvas.clientWidth,o=this.canvas.clientHeight;(this.canvas.width!==t*e||this.canvas.height!==o*e)&&(this.canvas.width=t*e,this.canvas.height=o*e,this.gl.viewport(0,0,this.canvas.width,this.canvas.height))}showWebGLError(){if(!this.canvas)return;const e=this.canvas.getContext("2d");e&&(e.fillStyle="#000",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#ff64ff",e.font="16px Orbitron, monospace",e.textAlign="center",e.fillText("WebGL Required",this.canvas.width/2,this.canvas.height/2),e.fillStyle="#888",e.font="12px Orbitron, monospace",e.fillText("Please enable WebGL in your browser",this.canvas.width/2,this.canvas.height/2+25))}updateInteraction(e,t,o){this.mouseX=e,this.mouseY=t,this.mouseIntensity=o*this.roleParams.mouseReactivity*this.reactivity}triggerClick(e,t){this.clickIntensity=Math.min(1,this.clickIntensity+this.roleParams.clickReactivity*this.reactivity)}updateDensity(e){this.densityTarget=e}updateTouch(e,t,o){this.touchX=e,this.touchY=t,this.touchActive=o,this.touchMorph=(e-.5)*2,this.touchChaos=Math.abs(t-.5)*2}updateScroll(e){this.scrollVelocity+=e*.001,this.scrollVelocity=Math.max(-2,Math.min(2,this.scrollVelocity))}updateAudio_DISABLED(){}updateScrollPhysics(){this.scrollPosition+=this.scrollVelocity,this.scrollVelocity*=this.scrollDecay,this.parallaxDepth=Math.sin(this.scrollPosition*.1)*.5,this.gridDensityShift=Math.sin(this.scrollPosition*.05)*.3,this.colorScrollShift=this.scrollPosition*.02%(Math.PI*2)}render(){if(!this.program)return;this.resize(),this.gl.useProgram(this.program),this.densityVariation+=(this.densityTarget-this.densityVariation)*.05,this.clickIntensity*=this.clickDecay,this.updateScrollPhysics();const e=Date.now()-this.startTime,t=(this.variantParams.hue||0)/360,o=this.variantParams.saturation||.8,a=Math.max(.2,Math.min(.8,this.variantParams.intensity||.5)),s=((h,y,w)=>{let T,C,b;if(y===0)T=C=b=w;else{const F=(P,L,S)=>(S<0&&(S+=1),S>1&&(S-=1),S<.16666666666666666?P+(L-P)*6*S:S<.5?L:S<.6666666666666666?P+(L-P)*(.6666666666666666-S)*6:P),G=w<.5?w*(1+y):w+y-w*y,A=2*w-G;T=F(A,G,h+1/3),C=F(A,G,h),b=F(A,G,h-1/3)}return[T,C,b]})(t,o,a);this.gl.uniform2f(this.uniforms.resolution,this.canvas.width,this.canvas.height),this.gl.uniform1f(this.uniforms.time,e),this.gl.uniform2f(this.uniforms.mouse,this.mouseX,this.mouseY),this.gl.uniform1f(this.uniforms.geometryType,this.variantParams.geometryType||0),this.gl.uniform1f(this.uniforms.density,this.variantParams.density||1);const n=(this.variantParams.speed||.5)*.2,l=(this.audioSpeedBoost||0)*.1;this.gl.uniform1f(this.uniforms.speed,n+l),this.gl.uniform3fv(this.uniforms.color,new Float32Array(s)),this.gl.uniform1f(this.uniforms.intensity,(this.variantParams.intensity||.5)*this.roleParams.intensity),this.gl.uniform1f(this.uniforms.roleDensity,this.roleParams.densityMult),this.gl.uniform1f(this.uniforms.roleSpeed,this.roleParams.speedMult),this.gl.uniform1f(this.uniforms.colorShift,this.roleParams.colorShift+(this.variantParams.hue||0)/360),this.gl.uniform1f(this.uniforms.chaosIntensity,this.variantParams.chaos||0),this.gl.uniform1f(this.uniforms.mouseIntensity,this.mouseIntensity),this.gl.uniform1f(this.uniforms.clickIntensity,this.clickIntensity),this.gl.uniform1f(this.uniforms.densityVariation,this.densityVariation),this.gl.uniform1f(this.uniforms.geometryType,this.variantParams.geometryType!==void 0?this.variantParams.geometryType:this.variant||0),this.gl.uniform1f(this.uniforms.chaos,this.variantParams.chaos||0),this.gl.uniform1f(this.uniforms.morph,this.variantParams.morph||0),this.gl.uniform1f(this.uniforms.touchMorph,this.touchMorph),this.gl.uniform1f(this.uniforms.touchChaos,this.touchChaos),this.gl.uniform1f(this.uniforms.scrollParallax,this.parallaxDepth),this.gl.uniform1f(this.uniforms.gridDensityShift,this.gridDensityShift),this.gl.uniform1f(this.uniforms.colorScrollShift,this.colorScrollShift);let c=0,d=0,u=0,m=0,f=0;window.audioEnabled&&window.audioReactive&&(c=window.audioReactive.bass*1.5,d=window.audioReactive.mid*1.2,u=window.audioReactive.high*.8,m=window.audioReactive.energy*.6,f=window.audioReactive.bass*45,Date.now()%1e4<16&&console.log(`âœ¨ Holographic audio reactivity: Density+${c.toFixed(2)} Morph+${d.toFixed(2)} Speed+${u.toFixed(2)} Chaos+${m.toFixed(2)} Color+${f.toFixed(1)}`)),this.gl.uniform1f(this.uniforms.audioDensityBoost,c),this.gl.uniform1f(this.uniforms.audioMorphBoost,d),this.gl.uniform1f(this.uniforms.audioSpeedBoost,u),this.gl.uniform1f(this.uniforms.audioChaosBoost,m),this.gl.uniform1f(this.uniforms.audioColorShift,f),this.gl.uniform1f(this.uniforms.rot4dXY,this.variantParams.rot4dXY||0),this.gl.uniform1f(this.uniforms.rot4dXZ,this.variantParams.rot4dXZ||0),this.gl.uniform1f(this.uniforms.rot4dYZ,this.variantParams.rot4dYZ||0),this.gl.uniform1f(this.uniforms.rot4dXW,this.variantParams.rot4dXW||0),this.gl.uniform1f(this.uniforms.rot4dYW,this.variantParams.rot4dYW||0),this.gl.uniform1f(this.uniforms.rot4dZW,this.variantParams.rot4dZW||0),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}reinitializeContext(){var e,t,o,a,r;if(console.log(`ğŸ”„ Reinitializing WebGL context for ${(e=this.canvas)==null?void 0:e.id}`),this.program=null,this.buffer=null,this.uniforms=null,this.gl=null,this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),!this.gl)return console.error(`âŒ No WebGL context available for ${(t=this.canvas)==null?void 0:t.id} - SmartCanvasPool should have created one`),!1;if(this.gl.isContextLost())return console.error(`âŒ WebGL context is lost for ${(o=this.canvas)==null?void 0:o.id}`),!1;try{return this.initShaders(),this.initBuffers(),this.resize(),console.log(`âœ… ${(a=this.canvas)==null?void 0:a.id}: Holographic context reinitialized successfully`),!0}catch(s){return console.error(`âŒ Failed to reinitialize holographic WebGL resources for ${(r=this.canvas)==null?void 0:r.id}:`,s),!1}}updateParameters(e){this.variantParams&&Object.keys(e).forEach(t=>{const o=this.mapParameterName(t);if(o!==null){let a=e[t];t==="gridDensity"&&(a=.3+(parseFloat(e[t])-5)/95*2.2,console.log(`ğŸ”§ Density scaling: gridDensity=${e[t]} â†’ density=${a.toFixed(3)} (normal range)`)),this.variantParams[o]=a,o==="geometryType"&&(this.roleParams=this.generateRoleParams(this.role))}})}mapParameterName(e){return{gridDensity:"density",morphFactor:"morph",rot4dXW:"rot4dXW",rot4dYW:"rot4dYW",rot4dZW:"rot4dZW",hue:"hue",intensity:"intensity",saturation:"saturation",chaos:"chaos",speed:"speed",geometry:"geometryType"}[e]||e}}class Ci{constructor(){this.visualizers=[],this.currentVariant=0,this.baseVariants=30,this.totalVariants=30,this.isActive=!1,this.useBuiltInReactivity=!window.reactivityManager,this.audioEnabled=!1,this.audioContext=null,this.analyser=null,this.frequencyData=null,this.audioData={bass:0,mid:0,high:0},this.variantNames=["TETRAHEDRON LATTICE","TETRAHEDRON FIELD","TETRAHEDRON MATRIX","TETRAHEDRON RESONANCE","HYPERCUBE LATTICE","HYPERCUBE FIELD","HYPERCUBE MATRIX","HYPERCUBE QUANTUM","SPHERE LATTICE","SPHERE FIELD","SPHERE MATRIX","SPHERE RESONANCE","TORUS LATTICE","TORUS FIELD","TORUS MATRIX","TORUS QUANTUM","KLEIN BOTTLE LATTICE","KLEIN BOTTLE FIELD","KLEIN BOTTLE MATRIX","KLEIN BOTTLE QUANTUM","FRACTAL LATTICE","FRACTAL FIELD","FRACTAL QUANTUM","WAVE LATTICE","WAVE FIELD","WAVE QUANTUM","CRYSTAL LATTICE","CRYSTAL FIELD","CRYSTAL MATRIX","CRYSTAL QUANTUM"],this.initialize()}initialize(){console.log("ğŸ¨ Initializing REAL Holographic System for Active Holograms tab..."),this.createVisualizers(),this.setupCenterDistanceReactivity(),this.updateVariantDisplay(),this.startRenderLoop()}createVisualizers(){const e=[{id:"holo-background-canvas",role:"background",reactivity:.5},{id:"holo-shadow-canvas",role:"shadow",reactivity:.7},{id:"holo-content-canvas",role:"content",reactivity:.9},{id:"holo-highlight-canvas",role:"highlight",reactivity:1.1},{id:"holo-accent-canvas",role:"accent",reactivity:1.5}];let t=0;e.forEach(o=>{try{if(!document.getElementById(o.id)){console.error(`âŒ Canvas not found: ${o.id}`);return}console.log(`ğŸ” Creating holographic visualizer for: ${o.id}`);const r=new Ei(o.id,o.role,o.reactivity,this.currentVariant);r.gl?(this.visualizers.push(r),t++,console.log(`âœ… Created REAL holographic layer: ${o.role} (${o.id})`)):console.error(`âŒ No WebGL context for: ${o.id}`)}catch(a){console.error(`âŒ Failed to create REAL holographic layer ${o.id}:`,a)}}),console.log(`âœ… Created ${t}/5 REAL holographic layers`),t===0&&console.error("ğŸš¨ NO HOLOGRAPHIC VISUALIZERS CREATED! Check canvas elements and WebGL support.")}setActive(e){if(this.isActive=e,e){const t=document.getElementById("holographicLayers");t&&(t.style.display="block"),!this.audioEnabled&&window.audioEnabled===!0&&this.initAudio(),console.log("ğŸŒŒ REAL Active Holograms ACTIVATED with audio reactivity")}else{const t=document.getElementById("holographicLayers");t&&(t.style.display="none"),console.log("ğŸŒŒ REAL Active Holograms DEACTIVATED")}}updateVariantDisplay(){const e=this.variantNames[this.currentVariant];return{variant:this.currentVariant,name:e,geometryType:Math.floor(this.currentVariant/4)}}nextVariant(){this.updateVariant(this.currentVariant+1)}previousVariant(){this.updateVariant(this.currentVariant-1)}randomVariant(){const e=Math.floor(Math.random()*this.totalVariants);this.updateVariant(e)}setVariant(e){this.updateVariant(e)}updateParameter(e,t){this.customParams||(this.customParams={}),this.customParams[e]=t,console.log(`ğŸŒŒ Updating holographic ${e}: ${t} (${this.visualizers.length} visualizers)`),this.visualizers.forEach((o,a)=>{try{if(o.updateParameters){const r={};r[e]=t,o.updateParameters(r),console.log(`âœ… Updated holographic layer ${a} (${o.role}) with ${e}=${t}`)}else console.warn(`âš ï¸ Holographic layer ${a} missing updateParameters method, using fallback`),o.variantParams&&(o.variantParams[e]=t,e==="geometryType"&&(o.roleParams=o.generateRoleParams(o.role)),o.render&&o.render())}catch(r){console.error(`âŒ Failed to update holographic layer ${a}:`,r)}}),console.log(`ğŸ”„ Holographic parameter update complete: ${e}=${t}`)}updateVariant(e){e<0&&(e=this.totalVariants-1),e>=this.totalVariants&&(e=0),this.currentVariant=e,this.visualizers.forEach(t=>{t.variant=this.currentVariant,t.variantParams=t.generateVariantParams(this.currentVariant),t.roleParams=t.generateRoleParams(t.role),this.customParams&&Object.keys(this.customParams).forEach(o=>{t.variantParams[o]=this.customParams[o]})}),this.updateVariantDisplay(),console.log(`ğŸ”„ REAL Holograms switched to variant ${this.currentVariant+1}: ${this.variantNames[this.currentVariant]}`)}getCurrentVariantInfo(){return{variant:this.currentVariant,name:this.variantNames[this.currentVariant],geometryType:Math.floor(this.currentVariant/4)}}getParameters(){var t,o,a,r,s,n,l,c,d,u;const e={geometry:Math.floor(this.currentVariant/4),gridDensity:parseFloat(((t=document.getElementById("gridDensity"))==null?void 0:t.value)||15),morphFactor:parseFloat(((o=document.getElementById("morphFactor"))==null?void 0:o.value)||1),chaos:parseFloat(((a=document.getElementById("chaos"))==null?void 0:a.value)||.2),speed:parseFloat(((r=document.getElementById("speed"))==null?void 0:r.value)||1),hue:parseFloat(((s=document.getElementById("hue"))==null?void 0:s.value)||320),intensity:parseFloat(((n=document.getElementById("intensity"))==null?void 0:n.value)||.6),saturation:parseFloat(((l=document.getElementById("saturation"))==null?void 0:l.value)||.8),rot4dXW:parseFloat(((c=document.getElementById("rot4dXW"))==null?void 0:c.value)||0),rot4dYW:parseFloat(((d=document.getElementById("rot4dYW"))==null?void 0:d.value)||0),rot4dZW:parseFloat(((u=document.getElementById("rot4dZW"))==null?void 0:u.value)||0),variant:this.currentVariant};return this.customParams&&Object.assign(e,this.customParams),console.log("ğŸŒŒ Holographic system getParameters:",e),e}async initAudio(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount);const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100}},t=await navigator.mediaDevices.getUserMedia(e);this.audioContext.createMediaStreamSource(t).connect(this.analyser),this.audioEnabled=!0,console.log("ğŸµ REAL Holograms audio reactivity enabled")}catch(e){console.error("REAL Holograms audio initialization failed:",e)}}disableAudio(){this.audioEnabled&&(this.audioEnabled=!1,this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser=null,this.frequencyData=null,this.audioData={bass:0,mid:0,high:0},console.log("ğŸµ REAL Holograms audio reactivity disabled"))}updateAudio(){if(!this.audioEnabled||!this.analyser||!this.isActive||window.audioEnabled===!1)return;this.analyser.getByteFrequencyData(this.frequencyData);const e=Math.floor(this.frequencyData.length*.1),t=Math.floor(this.frequencyData.length*.4);let o=0,a=0,r=0;for(let n=0;n<e;n++)o+=this.frequencyData[n];o/=e*255;for(let n=e;n<t;n++)a+=this.frequencyData[n];a/=(t-e)*255;for(let n=t;n<this.frequencyData.length;n++)r+=this.frequencyData[n];r/=(this.frequencyData.length-t)*255;const s={bass:this.smoothAudioValue(o,"bass"),mid:this.smoothAudioValue(a,"mid"),high:this.smoothAudioValue(r,"high"),energy:(o+a+r)/3,rhythm:this.detectRhythm(o),melody:this.detectMelody(a,r)};this.audioData=s,window.audioReactivitySettings&&this.applyAudioReactivityGrid(s),this.visualizers.forEach(n=>{n.updateAudio(this.audioData)})}smoothAudioValue(e,t){this.audioSmoothing||(this.audioSmoothing={bass:0,mid:0,high:0});const o=.4;return this.audioSmoothing[t]=this.audioSmoothing[t]*o+e*(1-o),this.audioSmoothing[t]>.05?this.audioSmoothing[t]:0}detectRhythm(e){this.previousBass||(this.previousBass=0);const t=e>this.previousBass+.2;return this.previousBass=e,t?1:0}detectMelody(e,t){const o=(e+t)/2;return o>.3?o:0}applyAudioReactivityGrid(e){const t=window.audioReactivitySettings;if(!t||t.activeVisualModes.size===0)return;const o=t.sensitivity[t.activeSensitivity];t.activeVisualModes.forEach(a=>{const[r,s]=a.split("-"),n=t.visualModes[s];if(!n)return;const l=e.energy*o,c=e.bass*o,d=e.rhythm*o;n.forEach(u=>{let m=0;switch(u){case"hue":this.audioHueBase||(this.audioHueBase=320),this.audioHueBase+=l*5,m=this.audioHueBase%360;break;case"saturation":m=Math.min(1,.6+d*.4);break;case"intensity":m=Math.min(1,.4+l*.6);break;case"morphFactor":m=Math.min(2,1+c*1);break;case"gridDensity":m=Math.min(100,15+d*50);break;case"chaos":m=Math.min(1,l*.8);break;case"speed":m=Math.min(3,1+l*2);break;case"rot4dXW":this.audioRotationXW||(this.audioRotationXW=0),this.audioRotationXW+=c*.1,m=this.audioRotationXW%(Math.PI*2);break;case"rot4dYW":this.audioRotationYW||(this.audioRotationYW=0),this.audioRotationYW+=e.mid*o*.08,m=this.audioRotationYW%(Math.PI*2);break;case"rot4dZW":this.audioRotationZW||(this.audioRotationZW=0),this.audioRotationZW+=e.high*o*.06,m=this.audioRotationZW%(Math.PI*2);break}window.updateParameter&&m!==void 0&&window.updateParameter(u,m.toFixed(2))})})}setupCenterDistanceReactivity(){if(console.log("âœ¨ Holographic system: AUDIO-ONLY mode (no mouse/touch reactivity)"),!this.useBuiltInReactivity){console.log("âœ¨ Holographic built-in reactivity DISABLED - ReactivityManager active");return}console.log("ğŸµ Holographic system will respond to audio input only")}updateHolographicShimmer(e,t){const o=(e-.5)*Math.PI,a=(t-.5)*Math.PI,r=320,n=Math.sin(o*2)*Math.cos(a*2)*120,l=(r+n+360)%360,c=.4+.5*Math.abs(Math.sin(o)*Math.cos(a)),d=.7+.3*Math.abs(Math.cos(o*1.5)*Math.sin(a*1.5)),u=1+.15*Math.sin(o*.8)*Math.cos(a*.8);window.updateParameter&&(window.updateParameter("hue",Math.round(l)),window.updateParameter("intensity",c.toFixed(2)),window.updateParameter("saturation",d.toFixed(2)),window.updateParameter("morphFactor",u.toFixed(2))),console.log(`âœ¨ Holographic shimmer: angle=(${o.toFixed(2)}, ${a.toFixed(2)}) â†’ Hue=${Math.round(l)}, Intensity=${c.toFixed(2)}`)}triggerHolographicColorBurst(e,t){const r=Math.sqrt((e-.5)**2+(t-.5)**2);this.colorBurstIntensity=1,this.burstHueShift=180,this.burstIntensityBoost=.7,this.burstSaturationSpike=.8,this.burstChaosEffect=.6,this.burstSpeedBoost=1.8,console.log(`ğŸŒˆğŸ’¥ HOLOGRAPHIC COLOR BURST: position=(${e.toFixed(2)}, ${t.toFixed(2)}), distance=${r.toFixed(3)}`)}startHolographicColorBurstLoop(){const e=()=>{if(this.colorBurstIntensity>.01){const t=this.colorBurstIntensity;if(this.burstHueShift>1){const r=(320+this.burstHueShift*Math.sin(t*Math.PI*2))%360;window.updateParameter&&window.updateParameter("hue",Math.round(r)),this.burstHueShift*=.93}if(this.burstIntensityBoost>.01){const a=Math.min(1,.5+this.burstIntensityBoost*t);window.updateParameter&&window.updateParameter("intensity",a.toFixed(2)),this.burstIntensityBoost*=.92}if(this.burstSaturationSpike>.01){const a=Math.min(1,.8+this.burstSaturationSpike*t);window.updateParameter&&window.updateParameter("saturation",a.toFixed(2)),this.burstSaturationSpike*=.91}if(this.burstChaosEffect>.01){const a=.2+this.burstChaosEffect*t;window.updateParameter&&window.updateParameter("chaos",a.toFixed(2)),this.burstChaosEffect*=.9}if(this.burstSpeedBoost>.01){const a=1+this.burstSpeedBoost*t;window.updateParameter&&window.updateParameter("speed",a.toFixed(2)),this.burstSpeedBoost*=.89}this.colorBurstIntensity*=.94}this.isActive&&requestAnimationFrame(e)};e()}startRenderLoop(){const e=()=>{this.isActive&&(this.updateAudio(),this.visualizers.forEach(t=>{t.render()})),requestAnimationFrame(e)};e(),console.log("ğŸ¬ REAL Holographic render loop started")}getVariantName(e=this.currentVariant){return this.variantNames[e]||"UNKNOWN"}destroy(){this.visualizers.forEach(e=>{e.destroy&&e.destroy()}),this.visualizers=[],this.audioContext&&this.audioContext.close(),console.log("ğŸ§¹ REAL Holographic System destroyed")}}const Ti=Object.freeze(Object.defineProperty({__proto__:null,RealHolographicSystem:Ci},Symbol.toStringTag,{value:"Module"}));class Ii{constructor(e,t,o){this.canvasId=e,this.role=t,this.config=o,this.canvas=null,this.gl=null,this.program=null,this.time=0,this.vertexBuffer=null,this.layerIntensity=this.getLayerIntensity(t),this.layerScale=this.getLayerScale(t),this.layerColor=this.getLayerColor(t)}getLayerIntensity(e){return{background:.1,shadow:.3,content:1,highlight:.7,accent:.5}[e]||.5}getLayerScale(e){return{background:1,shadow:1.1,content:1,highlight:.9,accent:.8}[e]||1}getLayerColor(e){return{background:[.1,.1,.2],shadow:[0,0,.1],content:[.5,.3,.8],highlight:[.8,.6,1],accent:[.3,.8,.9]}[e]||[.5,.5,.5]}initialize(){return this.canvas=document.getElementById(this.canvasId),this.canvas?(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),this.gl?(console.log(`ğŸ”® 4D Polytope WebGL context: ${this.canvasId} (${this.role})`),this.createTrue4DPolytopeShader()?(this.setupCanvasSize(),!0):(console.error(`âŒ Failed to create 4D polytope shader for ${this.canvasId}`),!1)):(console.error(`âŒ WebGL not supported for ${this.canvasId}`),!1)):(console.error(`âŒ Canvas ${this.canvasId} not found`),!1)}createTrue4DPolytopeShader(){const e=`
            attribute vec2 a_position;
            varying vec2 v_uv;
            
            void main() {
                v_uv = a_position * 0.5 + 0.5;
                gl_Position = vec4(a_position, 0.0, 1.0);
            }
        `,t=`
            precision highp float;
            varying vec2 v_uv;
            
            // Standard VIB34D uniforms - following DNA pattern
            uniform float u_time;
            uniform float u_geometry;
            uniform float u_rot4dXW;
            uniform float u_rot4dYW; 
            uniform float u_rot4dZW;
            uniform float u_gridDensity;
            uniform float u_morphFactor;
            uniform float u_chaos;
            uniform float u_speed;
            uniform float u_hue;
            uniform float u_intensity;
            uniform float u_saturation;
            
            // Layer-specific uniforms
            uniform float u_layerIntensity;
            uniform float u_layerScale;
            uniform vec3 u_layerColor;
            
            // Audio reactivity uniforms - following DNA pattern
            uniform float u_bass;
            uniform float u_mid;
            uniform float u_high;
            
            // 4D rotation matrices - EXACT DNA from other systems
            mat4 rotateXW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(c, 0.0, 0.0, -s, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, s, 0.0, 0.0, c);
            }
            
            mat4 rotateYW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(1.0, 0.0, 0.0, 0.0, 0.0, c, 0.0, -s, 0.0, 0.0, 1.0, 0.0, 0.0, s, 0.0, c);
            }
            
            mat4 rotateZW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, c, -s, 0.0, 0.0, s, c);
            }
            
            // 4D to 3D projection - EXACT DNA from other systems
            vec3 project4Dto3D(vec4 p) {
                float w = 2.5 / (2.5 + p.w);
                return vec3(p.x * w, p.y * w, p.z * w);
            }
            
            // HSV to RGB conversion - EXACT DNA from other systems
            vec3 hsv2rgb(vec3 c) {
                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
            }
            
            // TRUE 4D POLYTOPE DISTANCE FUNCTIONS
            
            // 5-Cell (4D Tetrahedron) - Simplest regular 4D polytope
            float polytope5Cell(vec4 p) {
                vec4 vertices[5];
                vertices[0] = vec4(1.0, 1.0, 1.0, 1.0);
                vertices[1] = vec4(1.0, -1.0, -1.0, 1.0);
                vertices[2] = vec4(-1.0, 1.0, -1.0, 1.0);
                vertices[3] = vec4(-1.0, -1.0, 1.0, 1.0);
                vertices[4] = vec4(0.0, 0.0, 0.0, -1.0);
                
                float minDist = 1000.0;
                for(int i = 0; i < 5; i++) {
                    minDist = min(minDist, distance(p, vertices[i]));
                }
                return minDist;
            }
            
            // Tesseract (4D Hypercube) - Most famous 4D polytope
            float polytopeTesseract(vec4 p) {
                vec4 q = abs(p) - vec4(1.0);
                return length(max(q, 0.0)) + min(max(max(max(q.x, q.y), q.z), q.w), 0.0);
            }
            
            // 16-Cell (4D Cross-polytope)
            float polytope16Cell(vec4 p) {
                return abs(p.x) + abs(p.y) + abs(p.z) + abs(p.w) - 2.0;
            }
            
            // 24-Cell (Unique to 4D)
            float polytope24Cell(vec4 p) {
                vec4 q = abs(p);
                vec4 sorted = q;
                
                // Sort coordinates for 24-cell symmetry
                if(sorted.x < sorted.y) { float temp = sorted.x; sorted.x = sorted.y; sorted.y = temp; }
                if(sorted.y < sorted.z) { float temp = sorted.y; sorted.y = sorted.z; sorted.z = temp; }
                if(sorted.z < sorted.w) { float temp = sorted.z; sorted.z = sorted.w; sorted.w = temp; }
                
                return sorted.x + sorted.y - 2.0;
            }
            
            // 600-Cell (4D Icosahedron analog)
            float polytope600Cell(vec4 p) {
                float phi = 1.618033988749895; // Golden ratio
                vec4 q = abs(p);
                
                float d1 = max(max(max(q.x, q.y), q.z), q.w) - phi;
                float d2 = (q.x + q.y + q.z + q.w) / phi - 2.0;
                
                return max(d1, d2);
            }
            
            // 120-Cell (Most complex regular 4D polytope)
            float polytope120Cell(vec4 p) {
                float phi = 1.618033988749895; // Golden ratio
                vec4 q = abs(p);
                
                // Approximate 120-cell using dodecahedral symmetry
                float d1 = length(q) - 2.0;
                float d2 = max(max(max(q.x/phi, q.y*phi), q.z/phi), q.w*phi) - 1.5;
                
                return max(d1, d2);
            }
            
            // Hypersphere (4D Sphere)
            float polytopeHypersphere(vec4 p) {
                return length(p) - 1.5;
            }
            
            // 4D Torus (Duocylinder) 
            float polytopeDuocylinder(vec4 p) {
                float r1 = length(p.xy) - 1.0;
                float r2 = length(p.zw) - 1.0;
                return sqrt(r1*r1 + r2*r2) - 0.5;
            }
            
            // TRUE 4D GEOMETRY FUNCTION - Following exact DNA pattern
            float true4DGeometryFunction(vec4 p) {
                int geomType = int(u_geometry);
                float gridSize = u_gridDensity * 0.1;
                
                // Apply 4D rotation - EXACT DNA pattern
                mat4 rotation = rotateXW(u_rot4dXW) * rotateYW(u_rot4dYW) * rotateZW(u_rot4dZW);
                vec4 rotatedP = rotation * p;
                
                // Apply grid tiling like other systems
                vec4 tiledP = fract(rotatedP * gridSize) - 0.5;
                
                float dist = 0.0;
                
                if (geomType == 0) {
                    // 5-CELL (4D Tetrahedron)
                    dist = polytope5Cell(tiledP);
                }
                else if (geomType == 1) {
                    // TESSERACT (4D Hypercube) 
                    dist = polytopeTesseract(tiledP);
                }
                else if (geomType == 2) {
                    // HYPERSPHERE (4D Sphere)
                    dist = polytopeHypersphere(tiledP);
                }
                else if (geomType == 3) {
                    // DUOCYLINDER (4D Torus)
                    dist = polytopeDuocylinder(tiledP);
                }
                else if (geomType == 4) {
                    // 16-CELL (4D Cross-polytope)
                    dist = polytope16Cell(tiledP);
                }
                else if (geomType == 5) {
                    // 24-CELL (Unique to 4D)
                    dist = polytope24Cell(tiledP);
                }
                else if (geomType == 6) {
                    // 600-CELL (4D Icosahedron)
                    dist = polytope600Cell(tiledP);
                }
                else if (geomType == 7) {
                    // 120-CELL (Most complex)
                    dist = polytope120Cell(tiledP);
                }
                
                // Apply morphing and chaos - EXACT DNA pattern
                dist *= u_morphFactor;
                if (u_chaos > 0.0) {
                    float noise = sin(rotatedP.x * 10.0) * sin(rotatedP.y * 10.0) * sin(rotatedP.z * 10.0) * sin(rotatedP.w * 10.0);
                    dist += noise * u_chaos * 0.1;
                }
                
                return dist;
            }
            
            void main() {
                vec2 uv = (v_uv - 0.5) * 2.0;
                float time = u_time * 0.001 * u_speed;
                
                // Create 4D coordinate from 2D screen space
                vec4 rayDir = vec4(uv * u_layerScale, 1.0, sin(time * 0.5));
                
                // Audio reactivity - EXACT DNA pattern
                vec4 audioOffset = vec4(u_bass * 0.3, u_mid * 0.2, u_high * 0.1, u_bass * 0.1);
                rayDir += audioOffset;
                
                // Calculate true 4D polytope distance
                float dist = true4DGeometryFunction(rayDir);
                
                // Layer-specific rendering
                float alpha = 0.0;
                
                if (dist < 0.1) {
                    // Inside polytope
                    alpha = 1.0 - (dist / 0.1);
                    alpha = pow(alpha, 2.0); // Sharp edges like other systems
                } else {
                    // Outside polytope - glow effect
                    alpha = exp(-dist * 5.0) * 0.3;
                }
                
                // Apply layer intensity
                alpha *= u_layerIntensity * u_intensity;
                
                // HSV color calculation - EXACT DNA pattern
                float hue = u_hue / 360.0;
                vec3 hsvColor = vec3(hue, u_saturation, 1.0);
                vec3 color = hsv2rgb(hsvColor);
                
                // Mix with layer color
                color = mix(color, u_layerColor, 0.3);
                
                // Audio-reactive color modulation
                color.r += u_high * 0.2;
                color.g += u_mid * 0.2;  
                color.b += u_bass * 0.2;
                
                // Final output
                gl_FragColor = vec4(color, alpha);
            }
        `;return this.program=this.createShaderProgram(e,t),this.program!==null}createShaderProgram(e,t){const o=this.compileShader(this.gl.VERTEX_SHADER,e),a=this.compileShader(this.gl.FRAGMENT_SHADER,t);if(!o||!a)return null;const r=this.gl.createProgram();if(this.gl.attachShader(r,o),this.gl.attachShader(r,a),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS))return console.error("4D Polytope shader link error:",this.gl.getProgramInfoLog(r)),null;const s=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);return this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),r}compileShader(e,t){const o=this.gl.createShader(e);return this.gl.shaderSource(o,t),this.gl.compileShader(o),this.gl.getShaderParameter(o,this.gl.COMPILE_STATUS)?o:(console.error("4D Polytope shader compile error:",this.gl.getShaderInfoLog(o)),null)}setupCanvasSize(){const e=this.canvas.getBoundingClientRect();this.canvas.width=e.width*(window.devicePixelRatio||1),this.canvas.height=e.height*(window.devicePixelRatio||1),this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}render(e={}){var o,a,r;if(!this.gl||!this.program||!this.vertexBuffer)return;this.time+=16,this.gl.useProgram(this.program),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);const t=this.gl.getAttribLocation(this.program,"a_position");this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0),this.setUniform("u_time",this.time),this.setUniform("u_geometry",e.geometry||0),this.setUniform("u_rot4dXW",e.rot4dXW||0),this.setUniform("u_rot4dYW",e.rot4dYW||0),this.setUniform("u_rot4dZW",e.rot4dZW||0),this.setUniform("u_gridDensity",e.gridDensity||20),this.setUniform("u_morphFactor",e.morphFactor||1),this.setUniform("u_chaos",e.chaos||0),this.setUniform("u_speed",e.speed||1),this.setUniform("u_hue",e.hue||280),this.setUniform("u_intensity",e.intensity||.8),this.setUniform("u_saturation",e.saturation||.9),this.setUniform("u_layerIntensity",this.layerIntensity),this.setUniform("u_layerScale",this.layerScale),this.setUniform("u_layerColor",this.layerColor),this.setUniform("u_bass",((o=window.audioReactive)==null?void 0:o.bass)||0),this.setUniform("u_mid",((a=window.audioReactive)==null?void 0:a.mid)||0),this.setUniform("u_high",((r=window.audioReactive)==null?void 0:r.high)||0),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}setUniform(e,t){const o=this.gl.getUniformLocation(this.program,e);o!==null&&(typeof t=="number"?this.gl.uniform1f(o,t):Array.isArray(t)&&(t.length===2?this.gl.uniform2f(o,t[0],t[1]):t.length===3?this.gl.uniform3f(o,t[0],t[1],t[2]):t.length===4&&this.gl.uniform4f(o,t[0],t[1],t[2],t[3])))}cleanup(){this.gl&&(this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.vertexBuffer&&(this.gl.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null))}}let St=class{constructor(){console.log("ğŸ”® Initializing TRUE 4D Polychora Engine with VIB34D DNA..."),this.visualizers=[],this.parameters=new Ce,this.isActive=!1,this.useBuiltInReactivity=!window.reactivityManager,this.mouseX=.5,this.mouseY=.5,this.mouseIntensity=0,this.clickIntensity=0,this.time=0,this.animationId=null,this.rotation4DVelocity={XW:0,YW:0,ZW:0},this.lastRotation4D={XW:0,YW:0,ZW:0},this.parameters.setParameter("geometry",1),this.parameters.setParameter("hue",280),this.parameters.setParameter("intensity",.8),this.parameters.setParameter("saturation",.9),this.parameters.setParameter("gridDensity",25),this.parameters.setParameter("morphFactor",1),this.init()}init(){this.createVisualizers(),this.setupAudioReactivity(),this.setup4DInteractivity(),this.startRenderLoop(),console.log("âœ¨ TRUE 4D Polychora Engine initialized with VIB34D DNA")}createVisualizers(){const e=[{id:"polychora-background-canvas",role:"background"},{id:"polychora-shadow-canvas",role:"shadow"},{id:"polychora-content-canvas",role:"content"},{id:"polychora-highlight-canvas",role:"highlight"},{id:"polychora-accent-canvas",role:"accent"}];this.visualizers=[];for(const t of e){const o=new Ii(t.id,t.role,{});o.initialize()?(this.visualizers.push(o),console.log(`âœ… 4D Polytope layer initialized: ${t.role}`)):console.error(`âŒ Failed to initialize 4D Polytope layer: ${t.role}`)}console.log(`ğŸ”® True 4D Polychora: ${this.visualizers.length}/5 layers active`)}setupAudioReactivity(){window.audioContext&&window.analyser&&console.log("ğŸµ 4D Polychora audio reactivity enabled")}setup4DInteractivity(){this.useBuiltInReactivity&&setInterval(()=>{const e={XW:this.parameters.getParameter("rot4dXW"),YW:this.parameters.getParameter("rot4dYW"),ZW:this.parameters.getParameter("rot4dZW")};this.rotation4DVelocity={XW:e.XW-this.lastRotation4D.XW,YW:e.YW-this.lastRotation4D.YW,ZW:e.ZW-this.lastRotation4D.ZW},this.lastRotation4D=e},100)}startRenderLoop(){this.animationId&&cancelAnimationFrame(this.animationId);const e=()=>{if(!this.isActive)return;this.time+=16;const t={geometry:this.parameters.getParameter("geometry"),rot4dXW:this.parameters.getParameter("rot4dXW"),rot4dYW:this.parameters.getParameter("rot4dYW"),rot4dZW:this.parameters.getParameter("rot4dZW"),gridDensity:this.parameters.getParameter("gridDensity"),morphFactor:this.parameters.getParameter("morphFactor"),chaos:this.parameters.getParameter("chaos"),speed:this.parameters.getParameter("speed"),hue:this.parameters.getParameter("hue"),intensity:this.parameters.getParameter("intensity"),saturation:this.parameters.getParameter("saturation")};window.audioReactive&&(t.rot4dXW+=window.audioReactive.bass*2,t.rot4dYW+=window.audioReactive.mid*1.5,t.rot4dZW+=window.audioReactive.high*1,t.morphFactor+=window.audioReactive.bass*.5,t.hue+=(window.audioReactive.mid+window.audioReactive.high)*30),this.visualizers.forEach(o=>{o.render(t)}),this.animationId=requestAnimationFrame(e)};e()}activate(){console.log("ğŸ”® Activating TRUE 4D Polychora Engine..."),this.isActive=!0,document.querySelectorAll('canvas[id*="-canvas"]').forEach(t=>{t.style.display=t.id.includes("polychora")?"block":"none"}),this.startRenderLoop(),window.statusManager&&window.statusManager.updateStatus("TRUE 4D POLYCHORA ENGINE ACTIVE","system"),console.log("âœ… True 4D Polychora Engine activated")}deactivate(){console.log("ğŸ”® Deactivating 4D Polychora Engine..."),this.isActive=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),document.querySelectorAll('canvas[id*="polychora"]').forEach(t=>{t.style.display="none"}),console.log("âœ… 4D Polychora Engine deactivated")}updateParameter(e,t){this.parameters.setParameter(e,t),e==="geometry"&&console.log(`ğŸ”® 4D Polytope changed to: ${["5-CELL","TESSERACT","HYPERSPHERE","DUOCYLINDER","16-CELL","24-CELL","600-CELL","120-CELL"][Math.floor(t)]||"UNKNOWN"}`)}getParameters(){if(this.parameters&&typeof this.parameters.getAllParameters=="function")return this.parameters.getAllParameters();const e={};return["geometry","rot4dXW","rot4dYW","rot4dZW","gridDensity","morphFactor","chaos","speed","hue","intensity","saturation"].forEach(o=>{this.parameters&&typeof this.parameters.getParameter=="function"&&(e[o]=this.parameters.getParameter(o))}),e}setParameters(e){e&&(Object.keys(e).forEach(t=>{this.parameters&&typeof this.parameters.setParameter=="function"&&this.parameters.setParameter(t,e[t])}),console.log("ğŸ”® 4D Polychora parameters updated from load"))}getParameterValue(e){return this.parameters.getParameter(e)}randomizeParameters(){this.parameters.randomize(),this.parameters.setParameter("gridDensity",15+Math.random()*20),this.parameters.setParameter("intensity",.6+Math.random()*.4),console.log("ğŸ² 4D Polychora parameters randomized")}cleanup(){this.deactivate(),this.visualizers.forEach(e=>{e.cleanup()}),this.visualizers=[],console.log("ğŸ§¹ 4D Polychora Engine cleaned up")}};window.NewPolychoraEngine=St;const Di=Object.freeze(Object.defineProperty({__proto__:null,NewPolychoraEngine:St},Symbol.toStringTag,{value:"Module"}));class Li{constructor(){this.gravity4D=[0,0,0,-2.5],this.airResistance=.02,this.timeStep=1/60,this.bodies=[],this.enabled=!1,this.paused=!1,this.magneticField=[0,0,1,0],this.fluidFlow=[.5,0,0,0],console.log("ğŸ”® Polychora4DPhysics initialized")}createRigidBody(e,t=[0,0,0,0],o={}){const a={id:this.generateBodyId(),polytopeType:e,position:[...t],velocity:[0,0,0,0],acceleration:[0,0,0,0],rotation:[0,0,0,0,0,0],angularVelocity:[0,0,0,0,0,0],angularAcceleration:[0,0,0,0,0,0],mass:o.mass||1,inertia4D:this.calculate4DInertia(e,o.mass||1),elasticity:o.elasticity||.8,friction:o.friction||.1,density:o.density||1,viscosity:o.viscosity||0,brownianMotion:o.brownianMotion||.1,magneticSusceptibility:o.magnetic||0,forces:[0,0,0,0],torques:[0,0,0,0,0,0],boundingRadius:this.calculateBoundingRadius(e),collisionGroup:o.group||0,targetPosition:null,flockingBehavior:o.flocking||!1,territorialRadius:o.territorial||2,active:!0,sleeping:!1,sleepThreshold:.01,physicsFeedback:{impactIntensity:0,velocityIntensity:0,accelerationGlow:0}};return this.bodies.push(a),console.log(`ğŸ”® Created 4D rigid body for polytope ${e}, ID: ${a.id}`),a}step(e=this.timeStep){!this.enabled||this.paused||(this.bodies.forEach(t=>{!t.active||t.sleeping||(this.clearForces(t),this.applyGravity(t),this.applyDrag(t),this.applyMagneticForces(t),this.applyFluidForces(t),this.applyBrownianMotion(t),this.applyBehavioralForces(t))}),this.detectCollisions(),this.bodies.forEach(t=>{!t.active||t.sleeping||(this.integrate(t,e),this.updateVisualFeedback(t),this.checkSleeping(t))}),this.updateSpatialHash())}applyGravity(e){const t=[this.gravity4D[0]*e.mass,this.gravity4D[1]*e.mass,this.gravity4D[2]*e.mass,this.gravity4D[3]*e.mass];this.addForce(e,t)}applyDrag(e){const t=this.magnitude4D(e.velocity);if(t<.001)return;const o=this.airResistance*t*t,a=this.normalize4D(e.velocity),r=[-a[0]*o,-a[1]*o,-a[2]*o,-a[3]*o];this.addForce(e,r)}applyMagneticForces(e){if(e.magneticSusceptibility===0)return;this.cross4D(e.velocity,this.magneticField).forEach((o,a)=>{e.forces[a]+=o*e.magneticSusceptibility})}applyFluidForces(e){const t=[this.fluidFlow[0]-e.velocity[0],this.fluidFlow[1]-e.velocity[1],this.fluidFlow[2]-e.velocity[2],this.fluidFlow[3]-e.velocity[3]],o=this.magnitude4D(t);if(o<.001)return;const a=this.multiply4D(t,e.viscosity*o);this.addForce(e,a)}applyBrownianMotion(e){if(e.brownianMotion===0)return;const t=[(Math.random()-.5)*e.brownianMotion,(Math.random()-.5)*e.brownianMotion,(Math.random()-.5)*e.brownianMotion,(Math.random()-.5)*e.brownianMotion];this.addForce(e,t)}applyBehavioralForces(e){e.flockingBehavior&&this.applyFlockingForce(e),e.targetPosition&&this.applySeekingForce(e),this.applyTerritorialForce(e)}applyFlockingForce(e){let t=[0,0,0,0],o=[0,0,0,0],a=[0,0,0,0],r=0;const s=e.territorialRadius;if(this.bodies.forEach(n=>{if(n===e||!n.active)return;const l=this.distance4D(e.position,n.position);if(!(l>s)){if(r++,l<s*.3){const c=this.subtract4D(e.position,n.position),d=this.multiply4D(this.normalize4D(c),1/(l+.1));t=this.add4D(t,d)}o=this.add4D(o,n.velocity),a=this.add4D(a,n.position)}}),r>0){this.magnitude4D(t)>0&&(t=this.multiply4D(this.normalize4D(t),.5),this.addForce(e,t)),o=this.multiply4D(o,1/r);const n=this.multiply4D(this.subtract4D(o,e.velocity),.3);this.addForce(e,n),a=this.multiply4D(a,1/r);const l=this.multiply4D(this.subtract4D(a,e.position),.2);this.addForce(e,l)}}applySeekingForce(e){const t=this.subtract4D(e.targetPosition,e.position),o=this.magnitude4D(t);if(o<.1){e.targetPosition=null;return}const a=this.multiply4D(this.normalize4D(t),Math.min(o*.5,2));this.addForce(e,a)}applyTerritorialForce(e){this.bodies.forEach(t=>{if(t===e||!t.active)return;const o=this.distance4D(e.position,t.position),a=e.territorialRadius*.5;if(o<a){const r=this.subtract4D(e.position,t.position),s=this.multiply4D(this.normalize4D(r),(a-o)*2);this.addForce(e,s)}})}detectCollisions(){for(let e=0;e<this.bodies.length;e++)for(let t=e+1;t<this.bodies.length;t++){const o=this.bodies[e],a=this.bodies[t];if(!o.active||!a.active)continue;const r=this.distance4D(o.position,a.position),s=o.boundingRadius+a.boundingRadius;r<s&&this.resolveCollision(o,a,r)}}resolveCollision(e,t,o){const a=this.normalize4D(this.subtract4D(t.position,e.position)),r=e.boundingRadius+t.boundingRadius-o,s=this.multiply4D(a,r*.5);e.position=this.subtract4D(e.position,s),t.position=this.add4D(t.position,s);const n=this.subtract4D(e.velocity,t.velocity),l=this.dot4D(n,a);if(l>0)return;const d=-(1+Math.min(e.elasticity,t.elasticity))*l/(1/e.mass+1/t.mass),u=this.multiply4D(a,d);e.velocity=this.add4D(e.velocity,this.multiply4D(u,1/e.mass)),t.velocity=this.subtract4D(t.velocity,this.multiply4D(u,1/t.mass));const m=Math.abs(d)*.1;e.physicsFeedback.impactIntensity=Math.max(e.physicsFeedback.impactIntensity,m),t.physicsFeedback.impactIntensity=Math.max(t.physicsFeedback.impactIntensity,m),console.log(`ğŸ”® 4D collision resolved between bodies ${e.id} and ${t.id}, impulse: ${d.toFixed(3)}`)}integrate(e,t){e.acceleration=this.multiply4D(e.forces,1/e.mass),e.velocity=this.add4D(e.velocity,this.multiply4D(e.acceleration,t)),e.position=this.add4D(e.position,this.multiply4D(e.velocity,t));for(let o=0;o<6;o++)e.angularAcceleration[o]=e.torques[o]/e.inertia4D[o],e.angularVelocity[o]+=e.angularAcceleration[o]*t,e.rotation[o]+=e.angularVelocity[o]*t,e.rotation[o]=e.rotation[o]%(Math.PI*2)}updateVisualFeedback(e){const t=this.magnitude4D(e.velocity);e.physicsFeedback.velocityIntensity=Math.min(t*.5,2);const o=this.magnitude4D(e.acceleration);e.physicsFeedback.accelerationGlow=Math.min(o*.3,1),e.physicsFeedback.impactIntensity*=.95}add4D(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]}subtract4D(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]}multiply4D(e,t){return[e[0]*t,e[1]*t,e[2]*t,e[3]*t]}dot4D(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}magnitude4D(e){return Math.sqrt(this.dot4D(e,e))}normalize4D(e){const t=this.magnitude4D(e);return t>.001?this.multiply4D(e,1/t):[0,0,0,0]}distance4D(e,t){return this.magnitude4D(this.subtract4D(e,t))}cross4D(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0],e[3]]}addForce(e,t){e.forces=this.add4D(e.forces,t)}clearForces(e){e.forces=[0,0,0,0],e.torques=[0,0,0,0,0,0]}generateBodyId(){return`body_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}calculate4DInertia(e,t){const o=t*.4;return[o,o,o,o,o,o]}calculateBoundingRadius(e){return[1.2,1.5,1,1.3,.8,2][e]||1}checkSleeping(e){const t=this.magnitude4D(e.velocity)+this.magnitude4D(e.angularVelocity);t<e.sleepThreshold?e.sleeping=!0:t>e.sleepThreshold*2&&(e.sleeping=!1)}updateSpatialHash(){}enable(){this.enabled=!0,console.log("ğŸ”® Polychora4DPhysics enabled")}disable(){this.enabled=!1,console.log("ğŸ”® Polychora4DPhysics disabled")}pause(){this.paused=!0}resume(){this.paused=!1}setGravity(e){this.gravity4D=[...e]}setMagneticField(e){this.magneticField=[...e]}setFluidFlow(e){this.fluidFlow=[...e]}getAllBodies(){return this.bodies}getBodyById(e){return this.bodies.find(t=>t.id===e)}removeBody(e){this.bodies=this.bodies.filter(t=>t.id!==e)}clearAllBodies(){this.bodies=[]}getPhysicsFeedback(){return this.bodies.map(e=>({id:e.id,position:e.position,rotation:e.rotation,feedback:e.physicsFeedback,polytopeType:e.polytopeType}))}}class Mi{constructor(e,t,o){this.canvasId=e,this.role=t,this.config=o,this.canvas=null,this.gl=null,this.program=null,this.time=0,this.vertexBuffer=null}initialize(){return this.canvas=document.getElementById(this.canvasId),this.canvas?(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),this.gl?(console.log(`ğŸ® WebGL context created for ${this.canvasId}: ${this.gl instanceof WebGL2RenderingContext?"WebGL2":"WebGL1"}`),this.createPolychoraShader()?(this.setupCanvasSize(),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),!0):(console.error(`âŒ Failed to create shader for ${this.canvasId}`),!1)):(console.error(`âŒ WebGL not supported for ${this.canvasId}`),!1)):(console.error(`âŒ Canvas ${this.canvasId} not found`),!1)}setupCanvasSize(){const e=document.getElementById("polychoraLayers"),t=e?e.style.display:null;e&&t==="none"&&(e.style.display="block");const o=this.canvas.parentElement.getBoundingClientRect();e&&t==="none"&&(e.style.display=t),this.canvas.width=o.width>0?o.width:window.innerWidth-300,this.canvas.height=o.height>0?o.height:window.innerHeight-50,this.gl.viewport(0,0,this.canvas.width,this.canvas.height),console.log(`ğŸ® Canvas ${this.canvasId} WebGL viewport: ${this.canvas.width}x${this.canvas.height}`)}createPolychoraShader(){const e=`
            attribute vec2 a_position;
            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
            }
        `,t=`
            precision highp float;
            uniform float u_time;
            uniform vec2 u_resolution;
            uniform float u_polytope;
            
            // COMPLETE 6D 4D rotation uniforms
            uniform float u_rot4dXW;
            uniform float u_rot4dYW;
            uniform float u_rot4dZW;
            uniform float u_rot4dXY;
            uniform float u_rot4dXZ;
            uniform float u_rot4dYZ;
            
            uniform float u_dimension;
            uniform float u_hue;
            uniform vec3 u_layerColor;
            uniform float u_layerScale;
            uniform float u_layerOpacity;
            uniform float u_lineWidth;
            uniform float u_blur;
            
            // ADVANCED: Glass effect uniforms
            uniform float u_refractionIndex;
            uniform float u_chromaticAberration;
            uniform float u_noiseAmplitude;
            uniform float u_flowDirection;
            uniform float u_faceTransparency;
            uniform float u_edgeThickness;
            uniform float u_projectionDistance;
            
            // COMPLETE 4D rotation matrices - All 6 possible rotations
            mat4 rotateXW(float angle) {
                float c = cos(angle);
                float s = sin(angle);
                return mat4(
                    c, 0, 0, -s,
                    0, 1, 0, 0,
                    0, 0, 1, 0,
                    s, 0, 0, c
                );
            }
            
            mat4 rotateYW(float angle) {
                float c = cos(angle);
                float s = sin(angle);
                return mat4(
                    1, 0, 0, 0,
                    0, c, 0, -s,
                    0, 0, 1, 0,
                    0, s, 0, c
                );
            }
            
            mat4 rotateZW(float angle) {
                float c = cos(angle);
                float s = sin(angle);
                return mat4(
                    1, 0, 0, 0,
                    0, 1, 0, 0,
                    0, 0, c, -s,
                    0, 0, s, c
                );
            }
            
            // NEW: Missing 4D rotations for complete 6D rotational freedom
            mat4 rotateXY(float angle) {
                float c = cos(angle);
                float s = sin(angle);
                return mat4(
                    c, -s, 0, 0,
                    s, c, 0, 0,
                    0, 0, 1, 0,
                    0, 0, 0, 1
                );
            }
            
            mat4 rotateXZ(float angle) {
                float c = cos(angle);
                float s = sin(angle);
                return mat4(
                    c, 0, -s, 0,
                    0, 1, 0, 0,
                    s, 0, c, 0,
                    0, 0, 0, 1
                );
            }
            
            mat4 rotateYZ(float angle) {
                float c = cos(angle);
                float s = sin(angle);
                return mat4(
                    1, 0, 0, 0,
                    0, c, -s, 0,
                    0, s, c, 0,
                    0, 0, 0, 1
                );
            }
            
            // 4D polytope distance functions
            float polytope4D(vec4 p, float type) {
                if (type < 0.5) {
                    // 5-Cell (4-Simplex)
                    vec4 q = abs(p) - 0.8;
                    float d1 = length(max(q, 0.0)) + min(max(max(max(q.x, q.y), q.z), q.w), 0.0);
                    vec4 r = p - vec4(0.5, 0.5, 0.5, 0.5);
                    float d2 = length(r) - 0.3;
                    return min(d1, d2);
                } else if (type < 1.5) {
                    // Tesseract (8-Cell)
                    vec4 q = abs(p) - 1.0;
                    float outside = length(max(q, 0.0));
                    float inside = max(max(max(q.x, q.y), q.z), q.w);
                    return outside + min(inside, 0.0);
                } else if (type < 2.5) {
                    // 16-Cell (4-Orthoplex)
                    return abs(p.x) + abs(p.y) + abs(p.z) + abs(p.w) - 1.5;
                } else if (type < 3.5) {
                    // 24-Cell
                    vec4 q = abs(p);
                    float d = max(max(q.x + q.y, q.z + q.w), max(q.x + q.z, q.y + q.w)) - 1.2;
                    return d;
                } else if (type < 4.5) {
                    // 600-Cell
                    float phi = (1.0 + sqrt(5.0)) / 2.0;
                    vec4 q = abs(p);
                    float d = length(q) - 1.0;
                    float r = max(max(q.x, q.y/phi), max(q.z*phi, q.w)) - 0.8;
                    return min(d, r);
                } else {
                    // 120-Cell
                    vec4 q = abs(p);
                    float d = max(max(max(q.x, q.y), max(q.z, q.w)), length(q.xy) + length(q.zw)) - 1.1;
                    return d;
                }
            }
            
            // Perlin noise function for surface effects
            float noise(vec4 p) {
                return fract(sin(dot(p, vec4(127.1, 311.7, 269.5, 183.3))) * 43758.5);
            }
            
            // Advanced 4D rotation application - Complete 6D freedom
            vec4 apply6DRotation(vec4 pos) {
                // Apply all 6 possible 4D rotations in mathematically correct order
                pos = rotateXY(u_rot4dXY + u_time * 0.08) * pos;
                pos = rotateXZ(u_rot4dXZ + u_time * 0.09) * pos;
                pos = rotateYZ(u_rot4dYZ + u_time * 0.07) * pos;
                pos = rotateXW(u_rot4dXW + u_time * 0.10) * pos;
                pos = rotateYW(u_rot4dYW + u_time * 0.11) * pos;
                pos = rotateZW(u_rot4dZW + u_time * 0.12) * pos;
                return pos;
            }
            
            // Cinema-quality glass effects
            vec3 calculateGlassEffects(vec2 uv, float dist, vec3 baseColor) {
                vec3 color = baseColor;
                
                // Chromatic aberration effect
                if (u_chromaticAberration > 0.0) {
                    vec2 offset = normalize(uv) * u_chromaticAberration * 0.01;
                    color.r *= 1.0 + sin(dist * 10.0 + u_time) * u_chromaticAberration;
                    color.g *= 1.0 + sin(dist * 10.0 + u_time + 2.09) * u_chromaticAberration;
                    color.b *= 1.0 + sin(dist * 10.0 + u_time + 4.18) * u_chromaticAberration;
                }
                
                // Refraction distortion
                if (u_refractionIndex > 1.0) {
                    vec2 refract_uv = uv * (1.0 + (u_refractionIndex - 1.0) * 0.1 * sin(dist * 20.0));
                    float refraction_intensity = (u_refractionIndex - 1.0) * 0.3;
                    color = mix(color, color * 1.2, refraction_intensity);
                }
                
                return color;
            }
            
            void main() {
                vec2 uv = (gl_FragCoord.xy - 0.5 * u_resolution.xy) / min(u_resolution.x, u_resolution.y);
                uv *= u_layerScale;
                
                // Create 4D point with enhanced projection distance
                vec4 pos = vec4(uv, 
                    sin(u_time * 0.3) * 0.5, 
                    cos(u_time * 0.2) * 0.5 * u_projectionDistance * 0.1
                );
                
                // Apply complete 6D 4D rotation
                pos = apply6DRotation(pos);
                
                // Get polytope distance
                float dist = polytope4D(pos, u_polytope);
                
                // Enhanced glassmorphic line rendering
                float edgeCore = u_edgeThickness * 0.01;
                float faceAlpha = u_faceTransparency;
                
                // Multi-layer line effect for cinema quality
                float lineCore = smoothstep(0.0, edgeCore, abs(dist));
                float lineOutline = smoothstep(0.0, edgeCore * 1.5, abs(dist + 0.05));
                float lineFine = smoothstep(0.0, edgeCore * 0.5, abs(dist));
                
                // Combine multiple line effects
                float alpha = (1.0 - lineCore) * 0.6 + (1.0 - lineOutline) * 0.3 + (1.0 - lineFine) * 0.1;
                alpha *= u_layerOpacity;
                
                // Add face transparency effect
                if (abs(dist) > edgeCore * 2.0) {
                    alpha *= faceAlpha;
                }
                
                // Apply procedural surface noise
                if (u_noiseAmplitude > 0.0) {
                    float noise_val = noise(pos * 10.0 + u_time * 0.1);
                    alpha *= 1.0 + (noise_val - 0.5) * u_noiseAmplitude;
                }
                
                // Apply blur with flow direction
                vec2 flow = vec2(cos(u_flowDirection * 3.14159 / 180.0), sin(u_flowDirection * 3.14159 / 180.0));
                float blur_dist = length(uv - flow * u_time * 0.1);
                alpha *= exp(-blur_dist * u_blur * 0.5);
                
                // Base color from layer configuration and hue
                vec3 color = u_layerColor;
                color = mix(color, vec3(
                    sin(u_hue/360.0*6.28), 
                    cos(u_hue/360.0*6.28), 
                    0.8
                ), 0.4);
                
                // Apply cinema-quality glass effects
                color = calculateGlassEffects(uv, dist, color);
                
                // Add subtle iridescence based on viewing angle
                float iridescence = sin(length(uv) * 10.0 + u_time) * 0.1;
                color += iridescence * vec3(0.3, 0.5, 0.7);
                
                gl_FragColor = vec4(color, alpha);
            }
        `;return this.program=this.createShaderProgram(e,t),this.program!==null}createShaderProgram(e,t){const o=this.compileShader(this.gl.VERTEX_SHADER,e),a=this.compileShader(this.gl.FRAGMENT_SHADER,t);if(!o||!a)return null;const r=this.gl.createProgram();if(this.gl.attachShader(r,o),this.gl.attachShader(r,a),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS))return console.error("Shader program link error:",this.gl.getProgramInfoLog(r)),null;const s=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);return this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),r}compileShader(e,t){const o=this.gl.createShader(e);return this.gl.shaderSource(o,t),this.gl.compileShader(o),this.gl.getShaderParameter(o,this.gl.COMPILE_STATUS)?o:(console.error("Shader compile error:",this.gl.getShaderInfoLog(o)),null)}render(e={}){if(!this.gl||!this.program||!this.vertexBuffer)return;this.time+=.016,this.gl.useProgram(this.program),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT);let t=e.rot4dXW||0,o=e.rot4dYW||0,a=e.rot4dZW||0,r=e.dimension||3.8,s=e.hue||280;window.audioEnabled&&window.audioReactive&&(t+=window.audioReactive.bass*3,o+=window.audioReactive.mid*2.5,a+=window.audioReactive.high*2,r+=window.audioReactive.energy*.5,s+=window.audioReactive.bass*60);const n={u_time:this.time,u_resolution:[this.canvas.width,this.canvas.height],u_polytope:e.polytope!==void 0?e.polytope:0,u_rot4dXW:t,u_rot4dYW:o,u_rot4dZW:a,u_rot4dXY:e.rot4dXY||0,u_rot4dXZ:e.rot4dXZ||0,u_rot4dYZ:e.rot4dYZ||0,u_dimension:Math.min(4,r),u_hue:s%360,u_layerColor:this.config.color,u_layerScale:this.config.scale*(e.layerScale||1),u_layerOpacity:this.config.opacity*(e.translucency||1),u_lineWidth:this.config.lineWidth*(e.lineThickness||1),u_blur:this.config.blur*(e.glassBlur||1),u_refractionIndex:e.refractionIndex||1.5,u_chromaticAberration:e.chromaticAberration||.1,u_noiseAmplitude:e.noiseAmplitude||.3,u_flowDirection:e.flowDirection||180,u_faceTransparency:e.faceTransparency||.7,u_edgeThickness:e.edgeThickness||2,u_projectionDistance:e.projectionDistance||5};Object.entries(n).forEach(([c,d])=>{const u=this.gl.getUniformLocation(this.program,c);if(u!==null)try{Array.isArray(d)?d.length===2?this.gl.uniform2fv(u,new Float32Array(d)):d.length===3&&this.gl.uniform3fv(u,new Float32Array(d)):this.gl.uniform1f(u,d)}catch(m){console.warn(`Failed to set uniform ${c}:`,m)}});const l=this.gl.getAttribLocation(this.program,"a_position");l!==-1&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.enableVertexAttribArray(l),this.gl.vertexAttribPointer(l,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLES,0,6))}update4DMouse(e,t,o){this.mouseState={x:e,y:t,intensity:o,time:Date.now()},console.log(`ğŸ”® ${this.canvasId}: 4D mouse update ${e.toFixed(2)}, ${t.toFixed(2)}, intensity: ${o.toFixed(2)}`)}trigger4DClick(e){this.clickState={intensity:e,time:Date.now()},console.log(`ğŸ”® ${this.canvasId}: 4D click intensity: ${e.toFixed(2)}`)}updateCrossSection(e){var t;this.crossSectionState={velocity:e,position:(((t=this.crossSectionState)==null?void 0:t.position)||0)+e*.01,time:Date.now()},console.log(`ğŸ”® ${this.canvasId}: Cross-section velocity: ${e}, position: ${this.crossSectionState.position.toFixed(3)}`)}updateParameters(e){this.cachedParameters={...e},console.log(`ğŸ”® ${this.canvasId}: Parameters updated`)}}class Ai{constructor(){this.canvasContainer=null,this.visualizers=[],this.isActive=!1,this.animationId=null,this.physics=new Li,this.physicsEnabled=!1,this.physicsBodies=[],this.polytopes=[{name:"5-Cell",description:"4-Simplex with 5 tetrahedral cells"},{name:"Tesseract",description:"8-Cell hypercube with 8 cubic cells"},{name:"16-Cell",description:"4-Orthoplex with 16 tetrahedral cells"},{name:"24-Cell",description:"Unique 4D polytope with 24 octahedral cells"},{name:"600-Cell",description:"Icosahedral symmetry with 600 tetrahedral cells"},{name:"120-Cell",description:"Largest regular 4D polytope with 120 dodecahedral cells"}],this.parameters={polytope:0,lineThickness:2.5,coreSize:1.2,outlineWidth:1.8,glassBlur:3,colorMagnetism:.7,layerScale:1,translucency:.8,rot4dXW:0,rot4dYW:0,rot4dZW:0,rot4dXY:0,rot4dXZ:0,rot4dYZ:0,dimension:3.8,speed:1.2,hue:280,refractionIndex:1.5,chromaticAberration:.1,noiseAmplitude:.3,flowDirection:180,faceTransparency:.7,edgeThickness:2,projectionDistance:5,physicsEnabled:!1,gravity4D:-2.5,mass:1,elasticity:.8,friction:.1,brownianMotion:.1,flocking:!1,territorial:2,magneticField:0,fluidFlow:.5},this.layerConfigs={background:{scale:1.5,opacity:.25,lineWidth:3,color:[.6,.3,.9],blur:4},shadow:{scale:1.2,opacity:.4,lineWidth:2.5,color:[.3,.3,.6],blur:2},content:{scale:1,opacity:.85,lineWidth:2,color:[0,.8,1],blur:.5},highlight:{scale:.8,opacity:.7,lineWidth:1.5,color:[1,.4,.8],blur:1.5},accent:{scale:.6,opacity:.4,lineWidth:1,color:[1,1,.6],blur:3}}}initialize(){if(console.log("ğŸ”® Initializing Polychora System"),this.canvasContainer=document.getElementById("polychoraLayers"),!this.canvasContainer)return console.error("âŒ Polychora canvas container not found"),!1;this.setupCanvasElements();const e=["background","shadow","content","highlight","accent"];let t=0;return e.forEach(o=>{const a=`polychora-${o}-canvas`;if(!document.getElementById(a)){console.error(`âŒ Canvas ${a} not found in DOM`);return}try{const s=new Mi(a,o,this.layerConfigs[o]);s.initialize()?(this.visualizers.push(s),t++,console.log(`âœ… Polychora ${o} layer initialized`)):console.error(`âŒ Failed to initialize Polychora ${o} layer`)}catch(s){console.error(`âŒ Error creating Polychora ${o} visualizer:`,s)}}),t===0?(console.error("âŒ No Polychora visualizers initialized successfully"),!1):(console.log(`âœ… Polychora System initialized with ${t}/${e.length} layers`),!0)}setupCanvasElements(){["background","shadow","content","highlight","accent"].forEach(t=>{const o=`polychora-${t}-canvas`,a=document.getElementById(o);if(a){const r=this.canvasContainer.style.display;this.canvasContainer.style.display="block";const s=this.canvasContainer.getBoundingClientRect();this.canvasContainer.style.display=r,a.width=s.width>0?s.width:window.innerWidth-300,a.height=s.height>0?s.height:window.innerHeight-50,a.style.width="100%",a.style.height="100%",console.log(`ğŸ“ Canvas ${o} sized to ${a.width}x${a.height}`)}})}start(){this.isActive||(console.log("ğŸ”® Starting Polychora System"),this.isActive=!0,this.canvasContainer.style.display="block",this.resizeAllCanvases(),this.startRenderLoop())}resizeAllCanvases(){this.setupCanvasElements(),this.visualizers.forEach(e=>{e.setupCanvasSize()}),console.log("ğŸ”® All Polychora canvases resized after becoming visible")}startRenderLoop(){const e=()=>{this.isActive&&(this.parameters.physicsEnabled&&this.physicsEnabled&&(this.physics.step(),this.updatePhysicsVisuals()),this.visualizers.forEach(t=>{t.render(this.parameters)}),this.animationId=requestAnimationFrame(e))};e()}enablePhysics(){this.physicsEnabled=!0,this.parameters.physicsEnabled=!0,this.physics.enable(),this.createPhysicsBodies(),console.log("ğŸ”® Polychora physics simulation enabled")}disablePhysics(){this.physicsEnabled=!1,this.parameters.physicsEnabled=!1,this.physics.disable(),this.physics.clearAllBodies(),this.physicsBodies=[],console.log("ğŸ”® Polychora physics simulation disabled")}createPhysicsBodies(){this.physics.clearAllBodies(),this.physicsBodies=[];for(let e=0;e<this.polytopes.length;e++){const t=this.physics.createRigidBody(e,[(Math.random()-.5)*4,(Math.random()-.5)*4,(Math.random()-.5)*4,(Math.random()-.5)*2],{mass:this.parameters.mass,elasticity:this.parameters.elasticity,friction:this.parameters.friction,brownianMotion:this.parameters.brownianMotion,flocking:this.parameters.flocking,territorial:this.parameters.territorial,magnetic:this.parameters.magneticField});this.physicsBodies.push(t)}this.physics.setGravity([0,0,0,this.parameters.gravity4D]),this.physics.setMagneticField([0,0,this.parameters.magneticField,0]),this.physics.setFluidFlow([this.parameters.fluidFlow,0,0,0])}updatePhysicsVisuals(){const e=this.physics.getPhysicsFeedback();if(e.length>0){const t=this.calculateAveragePhysicsFeedback(e);this.parameters.hue+=t.velocityIntensity*5,this.parameters.chromaticAberration=Math.max(.1,this.parameters.chromaticAberration+t.impactIntensity*.3),this.parameters.noiseAmplitude=Math.max(.1,this.parameters.noiseAmplitude+t.accelerationGlow*.5);const o=e[this.parameters.polytope]||e[0];o&&(this.parameters.rot4dXY=o.rotation[0],this.parameters.rot4dXZ=o.rotation[1],this.parameters.rot4dYZ=o.rotation[2],this.parameters.rot4dXW=o.rotation[3],this.parameters.rot4dYW=o.rotation[4],this.parameters.rot4dZW=o.rotation[5])}}calculateAveragePhysicsFeedback(e){const t={velocityIntensity:0,impactIntensity:0,accelerationGlow:0};if(e.length===0)return t;e.forEach(a=>{t.velocityIntensity+=a.feedback.velocityIntensity,t.impactIntensity+=a.feedback.impactIntensity,t.accelerationGlow+=a.feedback.accelerationGlow});const o=e.length;return t.velocityIntensity/=o,t.impactIntensity/=o,t.accelerationGlow/=o,t}addInteractiveForce(e,t){if(!this.physicsEnabled)return;let o=null,a=1/0;this.physicsBodies.forEach(r=>{const s=this.physics.distance4D(r.position,e);s<a&&(a=s,o=r)}),o&&a<2&&this.physics.addForce(o,t)}resetPhysics(){this.physicsEnabled&&(this.createPhysicsBodies(),console.log("ğŸ”® Polychora physics simulation reset"))}stop(){this.isActive&&(console.log("ğŸ”® Stopping Polychora System"),this.isActive=!1,this.canvasContainer.style.display="none",this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null))}updateParameters(e){Object.assign(this.parameters,e),console.log("ğŸ”® Updated Polychora parameters:",e)}setPolytope(e){if(e<0||e>=this.polytopes.length){console.warn("âš ï¸ Invalid polytope index:",e);return}this.parameters.polytope=e;const t=this.polytopes[e];return console.log(`ğŸ”® Set polytope to ${t.name}: ${t.description}`),t}updateParameters(e){e.rot4dXW!==void 0&&(this.parameters.rot4dXW=e.rot4dXW),e.rot4dYW!==void 0&&(this.parameters.rot4dYW=e.rot4dYW),e.rot4dZW!==void 0&&(this.parameters.rot4dZW=e.rot4dZW),e.hue!==void 0&&(this.parameters.hue=e.hue),e.gridDensity!==void 0&&(this.parameters.lineThickness=e.gridDensity*.01),e.geometry!==void 0&&(this.parameters.polytope=Math.min(e.geometry,this.polytopes.length-1)),e.speed!==void 0&&(this.parameters.flowDirection=e.speed),e.intensity!==void 0&&(this.parameters.projectionDistance=1+e.intensity*4),this.visualizers.forEach(t=>{t.updateParameters&&t.updateParameters(this.parameters)}),console.log("ğŸ”® Polychora parameters updated:",this.parameters)}updateInteraction(e,t,o=.5){this.visualizers.forEach(a=>{a.update4DMouse&&a.update4DMouse(e,t,o)}),console.log(`ğŸ”® Polychora 4D interaction: ${e.toFixed(2)}, ${t.toFixed(2)}, intensity: ${o.toFixed(2)}`)}triggerClick(e=1){this.visualizers.forEach(t=>{t.trigger4DClick&&t.trigger4DClick(e)}),console.log(`ğŸ”® Polychora 4D click: intensity ${e.toFixed(2)}`)}updateScroll(e){this.visualizers.forEach(t=>{t.updateCrossSection&&t.updateCrossSection(e)})}getCurrentPolytope(){return this.polytopes[this.parameters.polytope]}getPolytopeNames(){return this.polytopes.map(e=>e.name)}destroy(){this.stop(),this.visualizers.forEach(e=>{e.destroy&&e.destroy()}),this.visualizers=[],console.log("ğŸ”® Polychora System destroyed")}}const _i=Object.freeze(Object.defineProperty({__proto__:null,PolychoraSystem:Ai},Symbol.toStringTag,{value:"Module"}));class Pi{constructor(){this.currentSystem=null,this.currentEngine=null}async switchToSystem(e,t){console.log(`ğŸ”„ DESTROY OLD â†’ CREATE NEW: ${e}`),this.currentEngine&&(this.currentEngine.setActive&&this.currentEngine.setActive(!1),this.currentEngine.destroy&&this.currentEngine.destroy(),console.log("ğŸ’¥ Old engine destroyed")),this.destroyOldWebGLContexts(),this.destroyAllCanvasesAndCreateFresh(e);const o=await this.createFreshEngine(e,t);return o&&o.setActive&&o.setActive(!0),this.currentSystem=e,this.currentEngine=o,console.log(`âœ… DESTROY â†’ CREATE complete: ${e} ready`),o}destroyOldWebGLContexts(){console.log("ğŸ’¥ COMPLETE DESTRUCTION: WebGL contexts + old system cleanup...");const e=document.querySelectorAll("canvas");let t=0;e.forEach(o=>{const a=o.getContext("webgl2")||o.getContext("webgl");if(a){const r=a.getExtension("WEBGL_lose_context");r&&(r.loseContext(),t++)}}),window.engine&&(console.log("ğŸ’¥ Clearing window.engine"),window.engine=null),window.quantumEngine&&(console.log("ğŸ’¥ Clearing window.quantumEngine"),window.quantumEngine=null),window.holographicSystem&&(console.log("ğŸ’¥ Clearing window.holographicSystem"),window.holographicSystem=null),window.polychoraSystem&&(console.log("ğŸ’¥ Clearing window.polychoraSystem"),window.polychoraSystem=null),console.log(`ğŸ’¥ DESTRUCTION COMPLETE: ${t} WebGL contexts destroyed, all engine refs cleared`)}destroyAllCanvasesAndCreateFresh(e){console.log("ğŸ’¥ DESTROYING ALL CANVASES + CREATING 5 FRESH ONES");const t=document.querySelectorAll("canvas");t.forEach(n=>n.remove()),console.log(`ğŸ’¥ Destroyed ${t.length} old canvases`),["vib34dLayers","quantumLayers","holographicLayers","polychoraLayers"].forEach(n=>{const l=document.getElementById(n);l&&(l.innerHTML="",l.style.display="none")});const a=e==="faceted"?"vib34dLayers":`${e}Layers`,r=document.getElementById(a);if(!r){console.error(`âŒ Container ${a} not found`);return}const s=this.getCanvasIdsForSystem(e);s.forEach((n,l)=>{const c=document.createElement("canvas");c.id=n,c.className="visualization-canvas",c.style.position="absolute",c.style.top="0",c.style.left="0",c.style.width="100%",c.style.height="100%",c.style.zIndex=l+1;const d=window.innerWidth,u=window.innerHeight,m=Math.min(window.devicePixelRatio||1,2);c.width=d*m,c.height=u*m,r.appendChild(c)}),r.style.display="block",r.style.visibility="visible",r.style.opacity="1",console.log(`âœ… Created 5 fresh canvases for ${e}: ${s.join(", ")}`)}getCanvasIdsForSystem(e){const t=["background-canvas","shadow-canvas","content-canvas","highlight-canvas","accent-canvas"];switch(e){case"faceted":return t;case"quantum":return t.map(o=>`quantum-${o}`);case"holographic":return t.map(o=>`holo-${o}`);case"polychora":return t.map(o=>`polychora-${o}`);default:return t}}async createFreshEngine(e,t){console.log(`ğŸš€ Creating fresh ${e} engine`);let o=null;try{switch(e){case"faceted":t.VIB34DIntegratedEngine&&(o=new t.VIB34DIntegratedEngine,window.engine=o,console.log("âœ… Fresh Faceted engine"));break;case"quantum":t.QuantumEngine&&(o=new t.QuantumEngine,window.quantumEngine=o,console.log("âœ… Fresh Quantum engine"));break;case"holographic":t.RealHolographicSystem&&(o=new t.RealHolographicSystem,window.holographicSystem=o,console.log("âœ… Fresh Holographic engine"));break;case"polychora":t.NewPolychoraEngine&&(o=new t.NewPolychoraEngine,window.newPolychoraEngine=o,console.log("âœ… Fresh TRUE 4D Polychora Engine with VIB34D DNA"));break;default:console.error(`âŒ Unknown system: ${e}`)}}catch(a){console.error(`ğŸ’¥ Engine creation failed for ${e}:`,a),o=null}return o}}const xt=Object.freeze(Object.defineProperty({__proto__:null,CanvasManager:Pi},Symbol.toStringTag,{value:"Module"}));let Et=class{constructor(){this.currentSystem="faceted",this.reactivityState={mouse:{faceted:!0,quantum:!1,holographic:!1,polychora:!1,mixed:!1},click:{faceted:!0,quantum:!1,holographic:!1,polychora:!1,mixed:!1},scroll:{faceted:!0,quantum:!1,holographic:!1,polychora:!1,mixed:!1},audio:!1,interactivity:!0,deviceTilt:!1},window.unifiedReactivityManager=this,this.setupGlobalFunctions()}setupGlobalFunctions(){window.getCurrentReactivityState=()=>this.getCurrentState(),window.setReactivityState=e=>this.setState(e),window.resetReactivityToDefaults=e=>this.resetToDefaults(e),window.syncReactivityToSystem=e=>this.syncToSystem(e)}getCurrentState(){var t;const e={system:this.currentSystem,mouse:{...this.reactivityState.mouse},click:{...this.reactivityState.click},scroll:{...this.reactivityState.scroll},audio:this.reactivityState.audio,interactivity:this.reactivityState.interactivity,deviceTilt:this.reactivityState.deviceTilt,metadata:{timestamp:Date.now(),audioEnabled:window.audioEnabled||!1,interactivityEnabled:window.interactivityEnabled!==!1,deviceTiltEnabled:((t=window.deviceTiltHandler)==null?void 0:t.isEnabled)||!1,userAgent:navigator.userAgent.substr(0,50)}};return console.log("ğŸ”µ Reactivity state captured:",e),e}setState(e){return e?(console.log("ğŸ”µ Setting reactivity state:",e),e.system&&(this.currentSystem=e.system),e.mouse&&(this.reactivityState.mouse={...e.mouse}),e.click&&(this.reactivityState.click={...e.click}),e.scroll&&(this.reactivityState.scroll={...e.scroll}),typeof e.audio=="boolean"&&(this.reactivityState.audio=e.audio),typeof e.interactivity=="boolean"&&(this.reactivityState.interactivity=e.interactivity),typeof e.deviceTilt=="boolean"&&(this.reactivityState.deviceTilt=e.deviceTilt),this.syncToGlobals(),this.syncToUI(),!0):!1}resetToDefaults(e){console.log(`ğŸ›ï¸ Resetting reactivity to ${e} defaults`),Object.keys(this.reactivityState.mouse).forEach(a=>{this.reactivityState.mouse[a]=!1,this.reactivityState.click[a]=!1,this.reactivityState.scroll[a]=!1});const t={faceted:{mouse:"faceted",click:"faceted",scroll:"faceted"},quantum:{mouse:"quantum",click:"quantum",scroll:"quantum"},holographic:{mouse:"holographic",click:"holographic",scroll:"holographic"},polychora:{mouse:"polychora",click:"polychora",scroll:"faceted"}},o=t[e]||t.faceted;this.reactivityState.mouse[o.mouse]=!0,this.reactivityState.click[o.click]=!0,this.reactivityState.scroll[o.scroll]=!0,this.reactivityState.audio=e==="holographic",this.currentSystem=e,this.syncToGlobals(),this.syncToUI()}syncToSystem(e){this.currentSystem=e,this.hasAnyReactivity(e)?this.syncToGlobals():this.resetToDefaults(e)}hasAnyReactivity(e){return this.reactivityState.mouse[e]||this.reactivityState.click[e]||this.reactivityState.scroll[e]}syncToGlobals(){var e;window.audioEnabled=this.reactivityState.audio,window.interactivityEnabled=this.reactivityState.interactivity,this.reactivityState.deviceTilt&&window.deviceTiltHandler?window.deviceTiltHandler.isEnabled||window.deviceTiltHandler.enable():!this.reactivityState.deviceTilt&&((e=window.deviceTiltHandler)!=null&&e.isEnabled)&&window.deviceTiltHandler.disable(),window.reactivityManager&&window.reactivityManager.updateReactivityState(this.getCurrentState())}syncToUI(){["faceted","quantum","holographic","polychora","mixed"].forEach(o=>{const a=document.getElementById(`${o}Mouse`),r=document.getElementById(`${o}Click`),s=document.getElementById(`${o}Scroll`);a&&(a.checked=this.reactivityState.mouse[o]),r&&(r.checked=this.reactivityState.click[o]),s&&(s.checked=this.reactivityState.scroll[o])});const e=document.getElementById("audioToggle"),t=document.getElementById("deviceTiltToggle");e&&(e.textContent=this.reactivityState.audio?"ğŸµ Audio ON":"ğŸ”‡ Audio OFF"),t&&(t.textContent=this.reactivityState.deviceTilt?"ğŸ“± Tilt ON":"ğŸ“± Tilt OFF")}getSystemParameterOverrides(e){const t={};return this.reactivityState.audio&&(e==="holographic"||e==="quantum")&&(t.audioReactive=!0),this.reactivityState.deviceTilt&&(t.deviceTiltEnabled=!0),(this.reactivityState.mouse[e]||this.reactivityState.mouse.mixed)&&(t.mouseInteractionEnabled=!0),t}toJSON(){return{reactivityState:this.getCurrentState(),version:"1.0",timestamp:Date.now()}}fromJSON(e){return e.reactivityState?(this.setState(e.reactivityState),!0):!1}};window.UnifiedReactivityManager=Et;const $i=Object.freeze(Object.defineProperty({__proto__:null,UnifiedReactivityManager:Et},Symbol.toStringTag,{value:"Module"}));class Ri{constructor(){console.log("âš¡ Initializing Modular Reactivity Manager"),this.enabled=!0,this.mouseEnabled=!0,this.clickEnabled=!0,this.scrollEnabled=!0,this.activeSystem=null,this.activeSystemName="faceted",this.mouseModes={},this.clickModes={},this.scrollModes={},this.currentMouseMode="rotations",this.currentClickMode="ripple",this.currentScrollMode="cycle",setTimeout(()=>this.initializeModes(),0),this.setupGlobalListeners()}initializeModes(){try{this.mouseModes={rotations:new Fi,velocity:new ki,distance:new Wi,mixed_faceted_holo:new Ui},this.clickModes={burst:new zi,blast:new Bi,ripple:new Gi,mixed_multi:new qi},this.scrollModes={cycle:new Oi,wave:new Yi,sweep:new Vi,mixed_blend:new Hi},console.log("âš¡ ReactivityManager modes initialized successfully")}catch(e){console.error("âŒ Failed to initialize ReactivityManager modes:",e)}}setActiveSystem(e,t){console.log(`âš¡ Reactivity switching to: ${e}`),this.activeSystemName=e,this.activeSystem=t,this.autoSelectDefaults(e)}autoSelectDefaults(e){const t={faceted:{mouse:"rotations",click:"ripple",scroll:"cycle"},quantum:{mouse:"velocity",click:"blast",scroll:"wave"},holographic:{mouse:"distance",click:"burst",scroll:"sweep"},polychora:{mouse:"rotations",click:"burst",scroll:"cycle"}};t[e]&&(this.currentMouseMode=t[e].mouse,this.currentClickMode=t[e].click,this.currentScrollMode=t[e].scroll,console.log(`âš¡ Auto-selected modes for ${e}: ${this.currentMouseMode}, ${this.currentClickMode}, ${this.currentScrollMode}`))}setupGlobalListeners(){console.log("âš¡ Setting up global reactivity listeners"),document.addEventListener("mousemove",e=>this.handleGlobalMouseMove(e)),document.addEventListener("click",e=>this.handleGlobalClick(e)),document.addEventListener("touchmove",e=>this.handleGlobalTouchMove(e)),document.addEventListener("touchend",e=>this.handleGlobalTouchEnd(e)),document.addEventListener("wheel",e=>this.handleGlobalWheel(e))}handleGlobalMouseMove(e){if(!this.enabled||!this.mouseEnabled||!this.isCanvasEvent(e))return;const t=this.getEventCoords(e);if(!t)return;const o=this.mouseModes&&this.mouseModes[this.currentMouseMode];o&&o.handleMouseMove&&o.handleMouseMove(t.x,t.y,this.updateParameter.bind(this))}handleGlobalClick(e){if(!this.enabled||!this.clickEnabled||!this.isCanvasEvent(e))return;const t=this.getEventCoords(e);if(!t)return;const o=this.clickModes&&this.clickModes[this.currentClickMode];o&&o.handleClick&&o.handleClick(t.x,t.y,this.updateParameter.bind(this))}handleGlobalWheel(e){if(!this.enabled||!this.scrollEnabled||!this.isCanvasEvent(e))return;e.preventDefault();const t=this.scrollModes&&this.scrollModes[this.currentScrollMode];t&&t.handleWheel&&t.handleWheel(e.deltaY,this.updateParameter.bind(this))}isCanvasEvent(e){const t=e.target;return t.tagName==="CANVAS"&&t.classList.contains("visualization-canvas")}getEventCoords(e){const t=e.target;if(!t)return null;const o=t.getBoundingClientRect(),a=(e.clientX-o.left)/o.width,r=(e.clientY-o.top)/o.height;return{x:a,y:r}}handleGlobalTouchMove(e){if(!(!this.enabled||!this.mouseEnabled||!this.isCanvasEvent(e))&&(e.preventDefault(),e.touches.length>0)){const t=e.touches[0],o=e.target.getBoundingClientRect(),a=(t.clientX-o.left)/o.width,r=(t.clientY-o.top)/o.height,s=this.mouseModes&&this.mouseModes[this.currentMouseMode];s&&s.handleMouseMove&&s.handleMouseMove(a,r,this.updateParameter.bind(this))}}handleGlobalTouchEnd(e){if(!(!this.enabled||!this.clickEnabled||!this.isCanvasEvent(e))&&e.changedTouches.length>0){const t=e.changedTouches[0],o=e.target.getBoundingClientRect(),a=(t.clientX-o.left)/o.width,r=(t.clientY-o.top)/o.height,s=this.clickModes&&this.clickModes[this.currentClickMode];s&&s.handleClick&&s.handleClick(a,r,this.updateParameter.bind(this))}}updateParameter(e,t){window.updateParameter&&window.updateParameter(e,t),console.log(`âš¡ ${this.activeSystemName} reactivity: ${e} = ${t}`)}toggleMouse(e){this.mouseEnabled=e,console.log(`âš¡ Mouse reactivity: ${e?"ON":"OFF"}`)}toggleClick(e){this.clickEnabled=e,console.log(`âš¡ Click reactivity: ${e?"ON":"OFF"}`)}toggleScroll(e){this.scrollEnabled=e,console.log(`âš¡ Scroll reactivity: ${e?"ON":"OFF"}`)}setMouseMode(e){this.mouseModes&&this.mouseModes[e]?(this.currentMouseMode=e,console.log(`âš¡ Mouse mode: ${e}`)):console.error(`âŒ Mouse mode '${e}' not found. Available modes:`,Object.keys(this.mouseModes||{}))}setClickMode(e){this.clickModes&&this.clickModes[e]&&(this.currentClickMode=e,console.log(`âš¡ Click mode: ${e}`))}setScrollMode(e){this.scrollModes&&this.scrollModes[e]&&(this.currentScrollMode=e,console.log(`âš¡ Scroll mode: ${e}`))}setMultiMouseModes(e){this.activeMouseModes=e,console.log(`âš¡ Multi-mouse modes active: ${e.length} modes`)}setMultiClickModes(e){this.activeClickModes=e,console.log(`âš¡ Multi-click modes active: ${e.length} modes`)}setMultiScrollModes(e){this.activeScrollModes=e,console.log(`âš¡ Multi-scroll modes active: ${e.length} modes`)}setEnabled(e){this.enabled=e,console.log(`âš¡ Global reactivity: ${e?"ON":"OFF"}`)}}class Fi{constructor(){this.lastPosition={x:.5,y:.5},this.scrollHue=200}handleMouseMove(e,t,o){const r=(e-.5)*12.56,s=(e-.5)*12.56*.7,n=(t-.5)*12.56,l=(e-.5)*30,c=(this.scrollHue+l)%360;o("rot4dXW",r.toFixed(2)),o("rot4dYW",s.toFixed(2)),o("rot4dZW",n.toFixed(2)),o("hue",Math.round(c))}}class ki{constructor(){this.lastPosition={x:.5,y:.5},this.velocityHistory=[]}handleMouseMove(e,t,o){const a=e-this.lastPosition.x,r=t-this.lastPosition.y,s=Math.sqrt(a*a+r*r);this.velocityHistory.push(s),this.velocityHistory.length>5&&this.velocityHistory.shift();const n=this.velocityHistory.reduce((f,h)=>f+h,0)/this.velocityHistory.length,l=Math.min(1,n*30),c=.5+Math.min(2.5,n*15),d=10+t*90,u=.4+e*.6,m=(280+n*80)%360;o("chaos",l.toFixed(2)),o("speed",c.toFixed(2)),o("gridDensity",Math.round(d)),o("intensity",u.toFixed(2)),o("hue",Math.round(m)),this.lastPosition={x:e,y:t}}}class Wi{handleMouseMove(e,t,o){const s=Math.sqrt((e-.5)**2+(t-.5)**2),n=Math.min(s/.707,1),l=5+95*n,c=.2+.8*(1-n),d=.4+.6*(1-n),u=(320+n*40)%360;o("gridDensity",Math.round(l)),o("intensity",c.toFixed(2)),o("saturation",d.toFixed(2)),o("hue",Math.round(u))}}class zi{constructor(){this.isAnimating=!1,this.effects={}}handleClick(e,t,o){this.effects={colorFlash:1,chaosBoost:.8,speedBoost:1.5},this.isAnimating||this.startAnimation(o)}startAnimation(e){this.isAnimating=!0;const t=()=>{let o=!1;this.effects.colorFlash>.01&&(o=!0,this.effects.colorFlash*=.94),this.effects.chaosBoost>.01&&(o=!0,e("chaos",(.2+this.effects.chaosBoost).toFixed(2)),this.effects.chaosBoost*=.92),this.effects.speedBoost>.01&&(o=!0,e("speed",(1+this.effects.speedBoost).toFixed(2)),this.effects.speedBoost*=.91),o?requestAnimationFrame(t):this.isAnimating=!1};t()}}class Bi{constructor(){this.isAnimating=!1,this.effects={}}handleClick(e,t,o){this.effects={flashIntensity:1,chaosBlast:.7,speedWave:2,hueShift:60},this.isAnimating||this.startAnimation(o)}startAnimation(e){this.isAnimating=!0;const t=()=>{let o=!1;Object.keys(this.effects).forEach(a=>{if(this.effects[a]>.01)switch(o=!0,a){case"chaosBlast":e("chaos",Math.min(1,.3+this.effects[a]).toFixed(2)),this.effects[a]*=.88;break;case"speedWave":e("speed",Math.min(3,1+this.effects[a]).toFixed(2)),this.effects[a]*=.89;break;case"hueShift":e("hue",Math.round((280+this.effects[a])%360)),this.effects[a]*=.9;break}}),o?requestAnimationFrame(t):this.isAnimating=!1};t()}}class Gi{constructor(){this.morphIntensity=0,this.baseMorph=1,this.isAnimating=!1}handleClick(e,t,o){const s=Math.sqrt((e-.5)**2+(t-.5)**2),n=Math.min(s/.707,1);this.morphIntensity=.1+.2*(1-n),this.isAnimating||this.startAnimation(o)}startAnimation(e){this.isAnimating=!0;const t=()=>{if(this.morphIntensity>.01){const o=this.baseMorph+this.morphIntensity;e("morphFactor",o.toFixed(2)),this.morphIntensity*=.9,requestAnimationFrame(t)}else e("morphFactor",this.baseMorph.toFixed(2)),this.isAnimating=!1};t()}}class Oi{constructor(){this.scrollDensity=15,this.scrollHue=200}handleWheel(e,t){const o=e>0?1:-1;this.scrollDensity+=o*.8,this.scrollDensity=Math.max(5,Math.min(100,this.scrollDensity)),this.scrollHue+=o*3,this.scrollHue=(this.scrollHue%360+360)%360,t("gridDensity",Math.round(this.scrollDensity)),t("hue",Math.round(this.scrollHue))}}class Yi{constructor(){this.scrollMorph=1}handleWheel(e,t){const o=e>0?1:-1;this.scrollMorph+=o*.02,this.scrollMorph=Math.max(.2,Math.min(2,this.scrollMorph)),t("morphFactor",this.scrollMorph.toFixed(2))}}class Vi{constructor(){this.sweepParameter=0,this.sweepValues=[200,.5,.8,.2,1]}handleWheel(e,t){const o=e>0?1:-1,a=["hue","intensity","saturation","chaos","speed"],r=[[0,360],[.1,1],[.1,1],[0,1],[.1,3]],s=this.sweepParameter,[n,l]=r[s],c=(l-n)*.02;this.sweepValues[s]+=o*c,this.sweepValues[s]=Math.max(n,Math.min(l,this.sweepValues[s])),t(a[s],this.sweepValues[s].toFixed(2)),Math.random()<.1&&(this.sweepParameter=(this.sweepParameter+1)%a.length)}}class Ui{constructor(){this.scrollHue=240,this.lastPosition={x:.5,y:.5}}handleMouseMove(e,t,o){console.log("ğŸŒˆ MIXED MODE: Mouse move at",e.toFixed(3),t.toFixed(3));const a=6.28*1.5,r=(e-.5)*a,s=(e-.5)*a*.7,n=(t-.5)*a,d=Math.sqrt((e-.5)**2+(t-.5)**2),u=Math.min(d/.707,1),m=15+70*u,f=.3+.7*(1-u),h=(300+u*60)%360;console.log("ğŸŒˆ MIXED applying:",{rot4dXW:r.toFixed(2),rot4dYW:s.toFixed(2),rot4dZW:n.toFixed(2),gridDensity:Math.round(m),intensity:f.toFixed(2),hue:Math.round(h)}),o("rot4dXW",r.toFixed(2)),o("rot4dYW",s.toFixed(2)),o("rot4dZW",n.toFixed(2)),o("gridDensity",Math.round(m)),o("intensity",f.toFixed(2)),o("hue",Math.round(h)),this.lastPosition={x:e,y:t}}}class qi{constructor(){this.effects={},this.isAnimating=!1}handleClick(e,t,o){const s=Math.sqrt((e-.5)**2+(t-.5)**2),n=Math.min(s/.707,1);this.effects={colorFlash:.8,chaosBoost:.6,speedBoost:1.3,flashIntensity:.9,hueShift:45,morphIntensity:.15+.15*(1-n)},this.isAnimating||this.startAnimation(o)}startAnimation(e){this.isAnimating=!0;let t=0;const o=()=>{t++;const a=t/30,r=Math.exp(-a*3);if(a<1){const s=.2+this.effects.chaosBoost*r,n=1+this.effects.speedBoost*r,l=.5+this.effects.flashIntensity*r,c=this.effects.morphIntensity*r,d=(240+this.effects.hueShift*Math.sin(a*Math.PI*4))%360;e("chaos",s.toFixed(2)),e("speed",n.toFixed(2)),e("intensity",l.toFixed(2)),e("morphFactor",c.toFixed(2)),e("hue",Math.round(d)),requestAnimationFrame(o)}else this.isAnimating=!1};requestAnimationFrame(o)}}class Hi{constructor(){this.cycleGeometry=0,this.waveValues={chaos:.5,speed:1},this.sweepValues=[240,.5,.5,.5,1],this.sweepParameter=0}handleWheel(e,t){const o=e>0?1:-1;if(Math.random()<.3&&(this.cycleGeometry=(this.cycleGeometry+o+8)%8,t("geometry",this.cycleGeometry)),Math.random()<.4&&(this.waveValues.chaos+=o*.05,this.waveValues.speed+=o*.1,this.waveValues.chaos=Math.max(0,Math.min(1,this.waveValues.chaos)),this.waveValues.speed=Math.max(.1,Math.min(3,this.waveValues.speed)),t("chaos",this.waveValues.chaos.toFixed(2)),t("speed",this.waveValues.speed.toFixed(2))),Math.random()<.5){const a=["hue","intensity","saturation","gridDensity","morphFactor"],r=[[0,360],[.1,1],[.1,1],[10,90],[0,1.5]],s=this.sweepParameter,[n,l]=r[s],c=(l-n)*.03;this.sweepValues[s]+=o*c,this.sweepValues[s]=Math.max(n,Math.min(l,this.sweepValues[s])),t(a[s],this.sweepValues[s].toFixed(2)),Math.random()<.15&&(this.sweepParameter=(this.sweepParameter+1)%a.length)}}}const Ct=Object.freeze(Object.defineProperty({__proto__:null,ReactivityManager:Ri},Symbol.toStringTag,{value:"Module"}));class Xi{static generateCard(e,t="trading-card-canvas"){const a={0:"tetrahedron",1:"hypercube",2:"sphere",3:"torus",4:"klein",5:"fractal",6:"wave",7:"crystal"}[e.geometry]||"hypercube",r=new Date().toISOString().replace(/[:.]/g,"-"),n=`<!DOCTYPE html>
<html>
<head>
    <title>VIB34D Faceted Trading Card - ${a}</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: 'Orbitron', monospace;
        }
        canvas { 
            width: 400px; 
            height: 400px; 
            border: 2px solid #0ff; 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        .info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #0ff;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="${t}" width="800" height="800"></canvas>
    <div class="info">
        <div>Faceted System - ${a.charAt(0).toUpperCase()+a.slice(1)}</div>
        <div>Density: ${e.gridDensity} | Morph: ${e.morphFactor}</div>
        <div>Hue: ${e.hue}Â° | Speed: ${e.speed}</div>
    </div>
    
    <script>
        // EXACT WebGL implementation matching IntegratedHolographicVisualizer
        const canvas = document.getElementById('${t}');
        const gl = canvas.getContext('webgl');
        
        if (!gl) {
            alert('WebGL not supported');
        }
        
        // Vertex shader (standard)
        const vertexShaderSource = \`attribute vec2 a_position;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
}\`;
        
        const fragmentShaderSource = \`precision highp float;

uniform vec2 u_resolution;
uniform float u_time;
uniform vec2 u_mouse;
uniform float u_geometry;
uniform float u_gridDensity;
uniform float u_morphFactor;
uniform float u_chaos;
uniform float u_speed;
uniform float u_hue;
uniform float u_intensity;
uniform float u_saturation;
uniform float u_dimension;
uniform float u_rot4dXW;
uniform float u_rot4dYW;
uniform float u_rot4dZW;
uniform float u_mouseIntensity;
uniform float u_clickIntensity;
uniform float u_roleIntensity;

// 4D rotation matrices
mat4 rotateXW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, 0.0, 0.0, -s, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, s, 0.0, 0.0, c);
}

mat4 rotateYW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, c, 0.0, -s, 0.0, 0.0, 1.0, 0.0, 0.0, s, 0.0, c);
}

mat4 rotateZW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, c, -s, 0.0, 0.0, s, c);
}

vec3 project4Dto3D(vec4 p) {
    float w = 2.5 / (2.5 + p.w);
    return vec3(p.x * w, p.y * w, p.z * w);
}

// Simplified geometry functions for WebGL 1.0 compatibility (ORIGINAL FACETED)
float geometryFunction(vec4 p) {
    int geomType = int(u_geometry);
    
    if (geomType == 0) {
        // Tetrahedron lattice - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        vec4 dist = min(pos, 1.0 - pos);
        return min(min(dist.x, dist.y), min(dist.z, dist.w)) * u_morphFactor;
    }
    else if (geomType == 1) {
        // Hypercube lattice - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        vec4 dist = min(pos, 1.0 - pos);
        float minDist = min(min(dist.x, dist.y), min(dist.z, dist.w));
        return minDist * u_morphFactor;
    }
    else if (geomType == 2) {
        // Sphere lattice - UNIFORM GRID DENSITY
        float r = length(p);
        float density = u_gridDensity * 0.08;
        float spheres = abs(fract(r * density) - 0.5) * 2.0;
        float theta = atan(p.y, p.x);
        float harmonics = sin(theta * 3.0) * 0.2;
        return (spheres + harmonics) * u_morphFactor;
    }
    else if (geomType == 3) {
        // Torus lattice - UNIFORM GRID DENSITY
        float r1 = length(p.xy) - 2.0;
        float torus = length(vec2(r1, p.z)) - 0.8;
        float lattice = sin(p.x * u_gridDensity * 0.08) * sin(p.y * u_gridDensity * 0.08);
        return (torus + lattice * 0.3) * u_morphFactor;
    }
    else if (geomType == 4) {
        // Klein bottle lattice - UNIFORM GRID DENSITY
        float u = atan(p.y, p.x);
        float v = atan(p.w, p.z);
        float dist = length(p) - 2.0;
        float lattice = sin(u * u_gridDensity * 0.08) * sin(v * u_gridDensity * 0.08);
        return (dist + lattice * 0.4) * u_morphFactor;
    }
    else if (geomType == 5) {
        // Fractal lattice - NOW WITH UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        pos = abs(pos * 2.0 - 1.0);
        float dist = length(max(abs(pos) - 1.0, 0.0));
        return dist * u_morphFactor;
    }
    else if (geomType == 6) {
        // Wave lattice - UNIFORM GRID DENSITY
        float freq = u_gridDensity * 0.08;
        float time = u_time * 0.001 * u_speed;
        float wave1 = sin(p.x * freq + time);
        float wave2 = sin(p.y * freq + time * 1.3);
        float wave3 = sin(p.z * freq * 0.8 + time * 0.7); // Add Z-dimension waves
        float interference = wave1 * wave2 * wave3;
        return interference * u_morphFactor;
    }
    else if (geomType == 7) {
        // Crystal lattice - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08) - 0.5;
        float cube = max(max(abs(pos.x), abs(pos.y)), max(abs(pos.z), abs(pos.w)));
        return cube * u_morphFactor;
    }
    else {
        // Default hypercube - UNIFORM GRID DENSITY
        vec4 pos = fract(p * u_gridDensity * 0.08);
        vec4 dist = min(pos, 1.0 - pos);
        return min(min(dist.x, dist.y), min(dist.z, dist.w)) * u_morphFactor;
    }
}

void main() {
    vec2 uv = (gl_FragCoord.xy - u_resolution.xy * 0.5) / min(u_resolution.x, u_resolution.y);
    
    // 4D position with mouse interaction - NOW USING SPEED PARAMETER
    float timeSpeed = u_time * 0.0001 * u_speed;
    vec4 pos = vec4(uv * 3.0, sin(timeSpeed * 3.0), cos(timeSpeed * 2.0));
    pos.xy += (u_mouse - 0.5) * u_mouseIntensity * 2.0;
    
    // Apply 4D rotations
    pos = rotateXW(u_rot4dXW) * pos;
    pos = rotateYW(u_rot4dYW) * pos;
    pos = rotateZW(u_rot4dZW) * pos;
    
    // Calculate geometry value
    float value = geometryFunction(pos);
    
    // Apply chaos
    float noise = sin(pos.x * 7.0) * cos(pos.y * 11.0) * sin(pos.z * 13.0);
    value += noise * u_chaos;
    
    // Color based on geometry value and hue with user-controlled intensity/saturation
    float geometryIntensity = 1.0 - clamp(abs(value), 0.0, 1.0);
    geometryIntensity += u_clickIntensity * 0.3;
    
    // Apply user intensity control
    float finalIntensity = geometryIntensity * u_intensity;
    
    float hue = u_hue / 360.0 + value * 0.1;
    
    // Create color with saturation control
    vec3 baseColor = vec3(
        sin(hue * 6.28318 + 0.0) * 0.5 + 0.5,
        sin(hue * 6.28318 + 2.0943) * 0.5 + 0.5,
        sin(hue * 6.28318 + 4.1887) * 0.5 + 0.5
    );
    
    // Apply saturation (mix with grayscale)
    float gray = (baseColor.r + baseColor.g + baseColor.b) / 3.0;
    vec3 color = mix(vec3(gray), baseColor, u_saturation) * finalIntensity;
    
    gl_FragColor = vec4(color, finalIntensity * u_roleIntensity);
}\`;
        
        // Create shader program
        function createShader(type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compilation error:', gl.getShaderInfoLog(shader));
                return null;
            }
            
            return shader;
        }
        
        function createProgram(vertexSource, fragmentSource) {
            const vertexShader = createShader(gl.VERTEX_SHADER, vertexSource);
            const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragmentSource);
            
            if (!vertexShader || !fragmentShader) {
                return null;
            }
            
            const program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                console.error('Program linking failed:', gl.getProgramInfoLog(program));
                return null;
            }
            
            return program;
        }
        
        const program = createProgram(vertexShaderSource, fragmentShaderSource);
        
        // Set up buffers
        const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
        const buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
        
        const positionLocation = gl.getAttribLocation(program, 'a_position');
        gl.enableVertexAttribArray(positionLocation);
        gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
        
        // Get uniform locations
        const uniforms = {
            resolution: gl.getUniformLocation(program, 'u_resolution'),
            time: gl.getUniformLocation(program, 'u_time'),
            mouse: gl.getUniformLocation(program, 'u_mouse'),
            geometry: gl.getUniformLocation(program, 'u_geometry'),
            gridDensity: gl.getUniformLocation(program, 'u_gridDensity'),
            morphFactor: gl.getUniformLocation(program, 'u_morphFactor'),
            chaos: gl.getUniformLocation(program, 'u_chaos'),
            speed: gl.getUniformLocation(program, 'u_speed'),
            hue: gl.getUniformLocation(program, 'u_hue'),
            intensity: gl.getUniformLocation(program, 'u_intensity'),
            saturation: gl.getUniformLocation(program, 'u_saturation'),
            dimension: gl.getUniformLocation(program, 'u_dimension'),
            rot4dXW: gl.getUniformLocation(program, 'u_rot4dXW'),
            rot4dYW: gl.getUniformLocation(program, 'u_rot4dYW'),
            rot4dZW: gl.getUniformLocation(program, 'u_rot4dZW'),
            mouseIntensity: gl.getUniformLocation(program, 'u_mouseIntensity'),
            clickIntensity: gl.getUniformLocation(program, 'u_clickIntensity'),
            roleIntensity: gl.getUniformLocation(program, 'u_roleIntensity')
        };
        
        // EXACT parameters from function call
        const parameters = {
            geometry: ${e.geometry||0},
            gridDensity: ${e.gridDensity||15},
            morphFactor: ${e.morphFactor||1},
            chaos: ${e.chaos||.2},
            speed: ${e.speed||1},
            hue: ${e.hue||200},
            intensity: ${e.intensity||.5},
            saturation: ${e.saturation||.8},
            dimension: ${e.dimension||3.5},
            rot4dXW: ${e.rot4dXW||0},
            rot4dYW: ${e.rot4dYW||0},
            rot4dZW: ${e.rot4dZW||0}
        };
        
        const startTime = Date.now();
        
        function render() {
            gl.viewport(0, 0, canvas.width, canvas.height);
            gl.useProgram(program);
            
            const time = Date.now() - startTime;
            
            // Set uniforms with EXACT values from IntegratedHolographicVisualizer
            gl.uniform2f(uniforms.resolution, canvas.width, canvas.height);
            gl.uniform1f(uniforms.time, time);
            gl.uniform2f(uniforms.mouse, 0.5, 0.5);
            gl.uniform1f(uniforms.geometry, parameters.geometry);
            gl.uniform1f(uniforms.gridDensity, parameters.gridDensity);
            gl.uniform1f(uniforms.morphFactor, parameters.morphFactor);
            gl.uniform1f(uniforms.chaos, parameters.chaos);
            gl.uniform1f(uniforms.speed, parameters.speed);
            gl.uniform1f(uniforms.hue, parameters.hue);
            gl.uniform1f(uniforms.intensity, parameters.intensity);
            gl.uniform1f(uniforms.saturation, parameters.saturation);
            gl.uniform1f(uniforms.dimension, parameters.dimension);
            gl.uniform1f(uniforms.rot4dXW, parameters.rot4dXW);
            gl.uniform1f(uniforms.rot4dYW, parameters.rot4dYW);
            gl.uniform1f(uniforms.rot4dZW, parameters.rot4dZW);
            gl.uniform1f(uniforms.mouseIntensity, 0.0);
            gl.uniform1f(uniforms.clickIntensity, 0.0);
            gl.uniform1f(uniforms.roleIntensity, 0.8); // Content layer intensity
            
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            
            requestAnimationFrame(render);
        }
        
        render();
    <\/script>
</body>
</html>`;return{filename:`vib34d-faceted-exact-${a}-${r}.html`,content:n,system:"faceted"}}}const Ni=Object.freeze(Object.defineProperty({__proto__:null,FacetedCardGeneratorExact:Xi},Symbol.toStringTag,{value:"Module"}));class Zi{static generateCard(e,t="trading-card-canvas"){const a={0:"tetrahedron",1:"hypercube",2:"sphere",3:"torus",4:"klein",5:"fractal",6:"wave",7:"crystal"}[e.geometry]||"hypercube",r=new Date().toISOString().replace(/[:.]/g,"-"),n=`<!DOCTYPE html>
<html>
<head>
    <title>VIB34D Quantum Trading Card - ${a}</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: 'Orbitron', monospace;
        }
        canvas { 
            width: 400px; 
            height: 400px; 
            border: 2px solid #a0f; 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(170, 0, 255, 0.5);
        }
        .info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #a0f;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="${t}" width="800" height="800"></canvas>
    <div class="info">
        <div>Quantum System - ${a.charAt(0).toUpperCase()+a.slice(1)}</div>
        <div>Density: ${e.gridDensity} | Morph: ${e.morphFactor}</div>
        <div>Hue: ${e.hue}Â° | Speed: ${e.speed}</div>
        <div>Enhanced 3D Lattice + Holographic Effects</div>
    </div>
    
    <script>
        // EXACT WebGL implementation matching QuantumHolographicVisualizer
        const canvas = document.getElementById('${t}');
        const gl = canvas.getContext('webgl');
        
        if (!gl) {
            alert('WebGL not supported');
        }
        
        // Vertex shader (standard)
        const vertexShaderSource = \`attribute vec2 a_position;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
}\`;
        
        const fragmentShaderSource = \`precision highp float;

uniform vec2 u_resolution;
uniform float u_time;
uniform vec2 u_mouse;
uniform float u_geometry;
uniform float u_gridDensity;
uniform float u_morphFactor;
uniform float u_chaos;
uniform float u_speed;
uniform float u_hue;
uniform float u_intensity;
uniform float u_saturation;
uniform float u_dimension;
uniform float u_rot4dXW;
uniform float u_rot4dYW;
uniform float u_rot4dZW;
uniform float u_mouseIntensity;
uniform float u_clickIntensity;
uniform float u_roleIntensity;

// 4D rotation matrices
mat4 rotateXW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(c, 0.0, 0.0, -s, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, s, 0.0, 0.0, c);
}

mat4 rotateYW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, c, 0.0, -s, 0.0, 0.0, 1.0, 0.0, 0.0, s, 0.0, c);
}

mat4 rotateZW(float theta) {
    float c = cos(theta);
    float s = sin(theta);
    return mat4(1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, c, -s, 0.0, 0.0, s, c);
}

vec3 project4Dto3D(vec4 p) {
    float w = 2.5 / (2.5 + p.w);
    return vec3(p.x * w, p.y * w, p.z * w);
}

// Complex 3D Lattice Functions - Superior Quantum Shaders
float tetrahedronLattice(vec3 p, float gridSize) {
    vec3 q = fract(p * gridSize) - 0.5;
    float d1 = length(q);
    float d2 = length(q - vec3(0.4, 0.0, 0.0));
    float d3 = length(q - vec3(0.0, 0.4, 0.0));
    float d4 = length(q - vec3(0.0, 0.0, 0.4));
    float vertices = 1.0 - smoothstep(0.0, 0.04, min(min(d1, d2), min(d3, d4)));
    float edges = 0.0;
    edges = max(edges, 1.0 - smoothstep(0.0, 0.02, abs(length(q.xy) - 0.2)));
    edges = max(edges, 1.0 - smoothstep(0.0, 0.02, abs(length(q.yz) - 0.2)));
    edges = max(edges, 1.0 - smoothstep(0.0, 0.02, abs(length(q.xz) - 0.2)));
    return max(vertices, edges * 0.5);
}

float hypercubeLattice(vec3 p, float gridSize) {
    vec3 grid = fract(p * gridSize);
    vec3 edges = min(grid, 1.0 - grid);
    float minEdge = min(min(edges.x, edges.y), edges.z);
    float lattice = 1.0 - smoothstep(0.0, 0.03, minEdge);
    
    vec3 centers = abs(grid - 0.5);
    float maxCenter = max(max(centers.x, centers.y), centers.z);
    float vertices = 1.0 - smoothstep(0.45, 0.5, maxCenter);
    
    return max(lattice * 0.7, vertices);
}

float sphereLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    float sphere = 1.0 - smoothstep(0.15, 0.25, length(cell));
    
    float rings = 0.0;
    float ringRadius = length(cell.xy);
    rings = max(rings, 1.0 - smoothstep(0.0, 0.02, abs(ringRadius - 0.3)));
    rings = max(rings, 1.0 - smoothstep(0.0, 0.02, abs(ringRadius - 0.2)));
    
    return max(sphere, rings * 0.6);
}

float torusLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    float majorRadius = 0.3;
    float minorRadius = 0.1;
    
    float toroidalDist = length(vec2(length(cell.xy) - majorRadius, cell.z));
    float torus = 1.0 - smoothstep(minorRadius - 0.02, minorRadius + 0.02, toroidalDist);
    
    float rings = 0.0;
    float angle = atan(cell.y, cell.x);
    rings = sin(angle * 8.0) * 0.02;
    
    return max(torus, 0.0) + rings;
}

float kleinLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    float u = atan(cell.y, cell.x) / 3.14159 + 1.0;
    float v = cell.z + 0.5;
    
    float x = (2.0 + cos(u * 0.5)) * cos(u);
    float y = (2.0 + cos(u * 0.5)) * sin(u);
    float z = sin(u * 0.5) + v;
    
    vec3 kleinPoint = vec3(x, y, z) * 0.1;
    float dist = length(cell - kleinPoint);
    
    return 1.0 - smoothstep(0.1, 0.15, dist);
}

float fractalLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize);
    cell = abs(cell * 2.0 - 1.0);
    
    float dist = length(max(abs(cell) - 0.3, 0.0));
    
    // Recursive subdivision
    for(int i = 0; i < 3; i++) {
        cell = abs(cell * 2.0 - 1.0);
        float subdist = length(max(abs(cell) - 0.3, 0.0)) / pow(2.0, float(i + 1));
        dist = min(dist, subdist);
    }
    
    return 1.0 - smoothstep(0.0, 0.05, dist);
}

float waveLattice(vec3 p, float gridSize) {
    float time = u_time * 0.001 * u_speed;
    vec3 cell = fract(p * gridSize) - 0.5;
    
    float wave1 = sin(p.x * gridSize * 2.0 + time * 2.0);
    float wave2 = sin(p.y * gridSize * 1.8 + time * 1.5);
    float wave3 = sin(p.z * gridSize * 2.2 + time * 1.8);
    
    float interference = (wave1 + wave2 + wave3) / 3.0;
    float amplitude = 1.0 - length(cell) * 2.0;
    
    return max(0.0, interference * amplitude);
}

float crystalLattice(vec3 p, float gridSize) {
    vec3 cell = fract(p * gridSize) - 0.5;
    
    // Octahedral crystal structure
    float crystal = max(max(abs(cell.x) + abs(cell.y), abs(cell.y) + abs(cell.z)), abs(cell.x) + abs(cell.z));
    crystal = 1.0 - smoothstep(0.3, 0.4, crystal);
    
    // Add crystalline faces
    float faces = 0.0;
    faces = max(faces, 1.0 - smoothstep(0.0, 0.02, abs(abs(cell.x) - 0.35)));
    faces = max(faces, 1.0 - smoothstep(0.0, 0.02, abs(abs(cell.y) - 0.35)));
    faces = max(faces, 1.0 - smoothstep(0.0, 0.02, abs(abs(cell.z) - 0.35)));
    
    return max(crystal, faces * 0.5);
}

// Enhanced geometry function with holographic effects
float geometryFunction(vec4 p) {
    int geomType = int(u_geometry);
    vec3 p3d = project4Dto3D(p);
    float gridSize = u_gridDensity * 0.08;
    
    if (geomType == 0) {
        return tetrahedronLattice(p3d, gridSize) * u_morphFactor;
    }
    else if (geomType == 1) {
        return hypercubeLattice(p3d, gridSize) * u_morphFactor;
    }
    else if (geomType == 2) {
        return sphereLattice(p3d, gridSize) * u_morphFactor;
    }
    else if (geomType == 3) {
        return torusLattice(p3d, gridSize) * u_morphFactor;
    }
    else if (geomType == 4) {
        return kleinLattice(p3d, gridSize) * u_morphFactor;
    }
    else if (geomType == 5) {
        return fractalLattice(p3d, gridSize) * u_morphFactor;
    }
    else if (geomType == 6) {
        return waveLattice(p3d, gridSize) * u_morphFactor;
    }
    else if (geomType == 7) {
        return crystalLattice(p3d, gridSize) * u_morphFactor;
    }
    else {
        return hypercubeLattice(p3d, gridSize) * u_morphFactor;
    }
}

// HSV to RGB conversion for better color control
vec3 hsv2rgb(vec3 c) {
    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}

// RGB Glitch effect for holographic shimmer
vec3 rgbGlitch(vec3 color, vec2 uv, float intensity) {
    vec2 offset = vec2(intensity * 0.005, 0.0);
    float r = color.r + sin(uv.y * 30.0 + u_time * 0.001) * intensity * 0.06;
    float g = color.g + sin(uv.y * 28.0 + u_time * 0.0012) * intensity * 0.06;
    float b = color.b + sin(uv.y * 32.0 + u_time * 0.0008) * intensity * 0.06;
    return vec3(r, g, b);
}

void main() {
    vec2 uv = (gl_FragCoord.xy - u_resolution.xy * 0.5) / min(u_resolution.x, u_resolution.y);
    
    // Enhanced 4D position with holographic depth
    float timeSpeed = u_time * 0.0001 * u_speed;
    vec4 pos = vec4(uv * 3.0, sin(timeSpeed * 3.0), cos(timeSpeed * 2.0));
    pos.xy += (u_mouse - 0.5) * u_mouseIntensity * 2.0;
    
    // Apply 4D rotations
    pos = rotateXW(u_rot4dXW) * pos;
    pos = rotateYW(u_rot4dYW) * pos;
    pos = rotateZW(u_rot4dZW) * pos;
    
    // Calculate enhanced geometry value
    float value = geometryFunction(pos);
    
    // Enhanced chaos with holographic effects
    float noise = sin(pos.x * 7.0) * cos(pos.y * 11.0) * sin(pos.z * 13.0);
    value += noise * u_chaos;
    
    // Enhanced intensity calculation with holographic glow
    float geometryIntensity = 1.0 - clamp(abs(value * 0.8), 0.0, 1.0);
    geometryIntensity = pow(geometryIntensity, 1.5); // More dramatic falloff
    geometryIntensity += u_clickIntensity * 0.3;
    
    // Holographic shimmer effect
    float shimmer = sin(uv.x * 20.0 + timeSpeed * 5.0) * cos(uv.y * 15.0 + timeSpeed * 3.0) * 0.1;
    geometryIntensity += shimmer * geometryIntensity;
    
    // Apply user intensity control
    float finalIntensity = geometryIntensity * u_intensity;
    
    // Enhanced HSV color system
    float baseHue = u_hue / 360.0;
    float hueShift = value * 0.2 + timeSpeed * 0.1; // Color shifts over time
    float finalHue = baseHue + hueShift;
    
    // Create rich holographic color
    vec3 hsvColor = vec3(finalHue, u_saturation, finalIntensity);
    vec3 baseColor = hsv2rgb(hsvColor);
    
    // Add holographic particles effect
    float particles = 0.0;
    vec2 particleUV = uv * 8.0;
    vec2 particleID = floor(particleUV);
    vec2 particlePos = fract(particleUV) - 0.5;
    float particleDist = length(particlePos);
    
    // Animated particles
    float particleTime = timeSpeed + dot(particleID, vec2(127.1, 311.7));
    float particleAlpha = sin(particleTime) * 0.5 + 0.5;
    particles = (1.0 - smoothstep(0.1, 0.3, particleDist)) * particleAlpha * 0.3;
    
    // Apply RGB glitch for holographic shimmer
    vec3 glitchedColor = rgbGlitch(baseColor, uv, finalIntensity * 0.5);
    
    // Combine base color with particles
    vec3 finalColor = glitchedColor + particles * vec3(1.0, 0.8, 1.0);
    
    // Enhanced role-based intensity
    float roleIntensity = u_roleIntensity;
    
    gl_FragColor = vec4(finalColor, finalIntensity * roleIntensity);
}\`;
        
        // Create shader program
        function createShader(type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compilation error:', gl.getShaderInfoLog(shader));
                return null;
            }
            
            return shader;
        }
        
        function createProgram(vertexSource, fragmentSource) {
            const vertexShader = createShader(gl.VERTEX_SHADER, vertexSource);
            const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragmentSource);
            
            if (!vertexShader || !fragmentShader) {
                return null;
            }
            
            const program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                console.error('Program linking failed:', gl.getProgramInfoLog(program));
                return null;
            }
            
            return program;
        }
        
        const program = createProgram(vertexShaderSource, fragmentShaderSource);
        
        // Set up buffers
        const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
        const buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
        
        const positionLocation = gl.getAttribLocation(program, 'a_position');
        gl.enableVertexAttribArray(positionLocation);
        gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
        
        // Get uniform locations
        const uniforms = {
            resolution: gl.getUniformLocation(program, 'u_resolution'),
            time: gl.getUniformLocation(program, 'u_time'),
            mouse: gl.getUniformLocation(program, 'u_mouse'),
            geometry: gl.getUniformLocation(program, 'u_geometry'),
            gridDensity: gl.getUniformLocation(program, 'u_gridDensity'),
            morphFactor: gl.getUniformLocation(program, 'u_morphFactor'),
            chaos: gl.getUniformLocation(program, 'u_chaos'),
            speed: gl.getUniformLocation(program, 'u_speed'),
            hue: gl.getUniformLocation(program, 'u_hue'),
            intensity: gl.getUniformLocation(program, 'u_intensity'),
            saturation: gl.getUniformLocation(program, 'u_saturation'),
            dimension: gl.getUniformLocation(program, 'u_dimension'),
            rot4dXW: gl.getUniformLocation(program, 'u_rot4dXW'),
            rot4dYW: gl.getUniformLocation(program, 'u_rot4dYW'),
            rot4dZW: gl.getUniformLocation(program, 'u_rot4dZW'),
            mouseIntensity: gl.getUniformLocation(program, 'u_mouseIntensity'),
            clickIntensity: gl.getUniformLocation(program, 'u_clickIntensity'),
            roleIntensity: gl.getUniformLocation(program, 'u_roleIntensity')
        };
        
        // EXACT parameters from function call
        const parameters = {
            geometry: ${e.geometry||0},
            gridDensity: ${e.gridDensity||20},
            morphFactor: ${e.morphFactor||1},
            chaos: ${e.chaos||.2},
            speed: ${e.speed||1},
            hue: ${e.hue||280},
            intensity: ${e.intensity||.7},
            saturation: ${e.saturation||.9},
            dimension: ${e.dimension||3.5},
            rot4dXW: ${e.rot4dXW||0},
            rot4dYW: ${e.rot4dYW||0},
            rot4dZW: ${e.rot4dZW||0}
        };
        
        const startTime = Date.now();
        
        function render() {
            gl.viewport(0, 0, canvas.width, canvas.height);
            gl.useProgram(program);
            
            const time = Date.now() - startTime;
            
            // Set uniforms with EXACT values from QuantumHolographicVisualizer
            gl.uniform2f(uniforms.resolution, canvas.width, canvas.height);
            gl.uniform1f(uniforms.time, time);
            gl.uniform2f(uniforms.mouse, 0.5, 0.5);
            gl.uniform1f(uniforms.geometry, parameters.geometry);
            gl.uniform1f(uniforms.gridDensity, parameters.gridDensity);
            gl.uniform1f(uniforms.morphFactor, parameters.morphFactor);
            gl.uniform1f(uniforms.chaos, parameters.chaos);
            gl.uniform1f(uniforms.speed, parameters.speed);
            gl.uniform1f(uniforms.hue, parameters.hue);
            gl.uniform1f(uniforms.intensity, parameters.intensity);
            gl.uniform1f(uniforms.saturation, parameters.saturation);
            gl.uniform1f(uniforms.dimension, parameters.dimension);
            gl.uniform1f(uniforms.rot4dXW, parameters.rot4dXW);
            gl.uniform1f(uniforms.rot4dYW, parameters.rot4dYW);
            gl.uniform1f(uniforms.rot4dZW, parameters.rot4dZW);
            gl.uniform1f(uniforms.mouseIntensity, 0.0);
            gl.uniform1f(uniforms.clickIntensity, 0.0);
            gl.uniform1f(uniforms.roleIntensity, 1.0); // Content layer intensity
            
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            
            requestAnimationFrame(render);
        }
        
        render();
    <\/script>
</body>
</html>`;return{filename:`vib34d-quantum-exact-${a}-${r}.html`,content:n,system:"quantum"}}}const ji=Object.freeze(Object.defineProperty({__proto__:null,QuantumCardGeneratorExact:Zi},Symbol.toStringTag,{value:"Module"}));class Ki{static generateCard(e,t="trading-card-canvas"){console.log("ğŸŒŒ HolographicCardGeneratorMultiLayer received parameters:",e);const a={0:"tetrahedron",1:"hypercube",2:"sphere",3:"torus",4:"klein",5:"fractal",6:"wave",7:"crystal"}[e.geometry]||"hypercube",r=new Date().toISOString().replace(/[:.]/g,"-");console.log("ğŸŒŒ Using geometry:",e.geometry,"â†’",a),console.log("ğŸŒŒ GridDensity parameter:",e.gridDensity),console.log("ğŸŒŒ Template literal values that will be baked into HTML:"),console.log("   geometry:",e.geometry||0),console.log("   speed:",e.speed||1),console.log("   intensity:",e.intensity||.6),console.log("   hue:",e.hue||320),console.log("   saturation:",e.saturation||.8),console.log("   morphFactor:",e.morphFactor||1),console.log("   chaos:",e.chaos||.2),console.log("   rot4dXW:",e.rot4dXW||0),console.log("   rot4dYW:",e.rot4dYW||0),console.log("   rot4dZW:",e.rot4dZW||0);const n=`<!DOCTYPE html>
<html>
<head>
    <title>VIB34D Multi-Layer Holographic Card - ${a}</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: 'Orbitron', monospace;
        }
        .card-container {
            position: relative;
            width: 400px;
            height: 400px;
            border: 2px solid #f0f;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }
        .holographic-layers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        canvas { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #f0f;
            font-size: 12px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="card-container">
        <div class="holographic-layers">
            <canvas id="background-canvas" width="800" height="800"></canvas>
            <canvas id="shadow-canvas" width="800" height="800"></canvas>
            <canvas id="content-canvas" width="800" height="800"></canvas>
            <canvas id="highlight-canvas" width="800" height="800"></canvas>
            <canvas id="accent-canvas" width="800" height="800"></canvas>
        </div>
        <div class="info">
            <div>Multi-Layer Holographic - ${a.charAt(0).toUpperCase()+a.slice(1)}</div>
            <div>5 Layers: Background â†’ Shadow â†’ Content â†’ Highlight â†’ Accent</div>
            <div>Density: ${e.gridDensity} | Morph: ${e.morphFactor}</div>
            <div>Hue: ${e.hue}Â° | Speed: ${e.speed}</div>
        </div>
    </div>
    
    <script>
        // EXACT 5-layer system matching HolographicVisualizer
        const layers = [
            { id: 'background-canvas', role: 'background', intensityMult: 0.2, densityMult: 0.4, speedMult: 0.2, colorShift: 0.0 },
            { id: 'shadow-canvas', role: 'shadow', intensityMult: 0.4, densityMult: 0.8, speedMult: 0.3, colorShift: 180.0 },
            { id: 'content-canvas', role: 'content', intensityMult: 0.8, densityMult: 1.0, speedMult: 1.0, colorShift: 0.0 },
            { id: 'highlight-canvas', role: 'highlight', intensityMult: 1.0, densityMult: 1.3, speedMult: 0.8, colorShift: 60.0 },
            { id: 'accent-canvas', role: 'accent', intensityMult: 1.2, densityMult: 2.0, speedMult: 0.4, colorShift: 300.0 }
        ];
        
        // Vertex shader (standard for all layers)
        const vertexShaderSource = \`attribute vec2 a_position;
            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
            }\`;
        
        const fragmentShaderSource = \`precision highp float;
            
            uniform vec2 u_resolution;
            uniform float u_time;
            uniform vec2 u_mouse;
            uniform float u_geometry;
            uniform float u_density;
            uniform float u_speed;
            uniform vec3 u_color;
            uniform float u_intensity;
            uniform float u_roleDensity;
            uniform float u_roleSpeed;
            uniform float u_colorShift;
            uniform float u_chaosIntensity;
            uniform float u_mouseIntensity;
            uniform float u_clickIntensity;
            uniform float u_densityVariation;
            uniform float u_geometryType;
            uniform float u_chaos;
            uniform float u_morph;
            uniform float u_touchMorph;
            uniform float u_touchChaos;
            uniform float u_scrollParallax;
            uniform float u_gridDensityShift;
            uniform float u_colorScrollShift;
            uniform float u_audioDensityBoost;
            uniform float u_audioMorphBoost;
            uniform float u_audioSpeedBoost;
            uniform float u_audioChaosBoost;
            uniform float u_audioColorShift;
            uniform float u_rot4dXW;
            uniform float u_rot4dYW;
            uniform float u_rot4dZW;
            
            // 4D rotation matrices
            mat4 rotateXW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(c, 0, 0, -s, 0, 1, 0, 0, 0, 0, 1, 0, s, 0, 0, c);
            }
            
            mat4 rotateYW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(1, 0, 0, 0, 0, c, 0, -s, 0, 0, 1, 0, 0, s, 0, c);
            }
            
            mat4 rotateZW(float theta) {
                float c = cos(theta);
                float s = sin(theta);
                return mat4(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, c, -s, 0, 0, s, c);
            }
            
            // 4D to 3D projection
            vec3 project4Dto3D(vec4 p) {
                float w = 2.5 / (2.5 + p.w);
                return vec3(p.x * w, p.y * w, p.z * w);
            }
            
            // Enhanced VIB3 Geometry Library - Higher Fidelity
            float tetrahedronLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                
                // Enhanced tetrahedron vertices with holographic shimmer
                float d1 = length(q);
                float d2 = length(q - vec3(0.35, 0.0, 0.0));
                float d3 = length(q - vec3(0.0, 0.35, 0.0));
                float d4 = length(q - vec3(0.0, 0.0, 0.35));
                float d5 = length(q - vec3(0.2, 0.2, 0.0));
                float d6 = length(q - vec3(0.2, 0.0, 0.2));
                float d7 = length(q - vec3(0.0, 0.2, 0.2));
                
                float vertices = 1.0 - smoothstep(0.0, 0.03, min(min(min(d1, d2), min(d3, d4)), min(min(d5, d6), d7)));
                
                // Enhanced edge network with interference patterns
                float edges = 0.0;
                float shimmer = sin(u_time * 0.002) * 0.02;
                edges = max(edges, 1.0 - smoothstep(0.0, 0.015, abs(length(q.xy) - (0.18 + shimmer))));
                edges = max(edges, 1.0 - smoothstep(0.0, 0.015, abs(length(q.yz) - (0.18 + shimmer * 0.8))));
                edges = max(edges, 1.0 - smoothstep(0.0, 0.015, abs(length(q.xz) - (0.18 + shimmer * 1.2))));
                
                // Add interference patterns between vertices
                float interference = sin(d1 * 25.0 + u_time * 0.003) * sin(d2 * 22.0 + u_time * 0.0025) * 0.1;
                
                // Volumetric density based on distance field
                float volume = exp(-length(q) * 3.0) * 0.15;
                
                return max(vertices, edges * 0.7) + interference + volume;
            }
            
            float hypercubeLattice(vec3 p, float gridSize) {
                vec3 grid = fract(p * gridSize);
                vec3 q = grid - 0.5;
                
                // Enhanced hypercube with 4D projection effects
                vec3 edges = 1.0 - smoothstep(0.0, 0.025, abs(q));
                float wireframe = max(max(edges.x, edges.y), edges.z);
                
                // Add 4D hypercube vertices (8 corners + 8 hypervertices)
                float vertices = 0.0;
                for(int i = 0; i < 8; i++) {
                    // WebGL 1.0 compatible modulus replacement
                    float iFloat = float(i);
                    vec3 corner = vec3(
                        floor(iFloat - floor(iFloat / 2.0) * 2.0) - 0.5,
                        floor((iFloat / 2.0) - floor((iFloat / 2.0) / 2.0) * 2.0) - 0.5,
                        float(i / 4) - 0.5
                    );
                    float dist = length(q - corner * 0.4);
                    vertices = max(vertices, 1.0 - smoothstep(0.0, 0.04, dist));
                }
                
                // Holographic interference patterns
                float interference = sin(length(q) * 20.0 + u_time * 0.002) * 0.08;
                
                // Cross-dimensional glow
                float glow = exp(-length(q) * 2.5) * 0.12;
                
                return wireframe * 0.8 + vertices + interference + glow;
            }
            
            float sphereLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                float r = length(q);
                return 1.0 - smoothstep(0.2, 0.5, r);
            }
            
            float torusLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                float r1 = sqrt(q.x*q.x + q.y*q.y);
                float r2 = sqrt((r1 - 0.3)*(r1 - 0.3) + q.z*q.z);
                return 1.0 - smoothstep(0.0, 0.1, r2);
            }
            
            float kleinLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize);
                float u = q.x * 2.0 * 3.14159;
                float v = q.y * 2.0 * 3.14159;
                float x = cos(u) * (3.0 + cos(u/2.0) * sin(v) - sin(u/2.0) * sin(2.0*v));
                float klein = length(vec2(x, q.z)) - 0.1;
                return 1.0 - smoothstep(0.0, 0.05, abs(klein));
            }
            
            float fractalLattice(vec3 p, float gridSize) {
                vec3 q = p * gridSize;
                float scale = 1.0;
                float fractal = 0.0;
                for(int i = 0; i < 4; i++) {
                  q = fract(q) - 0.5;
                  fractal += abs(length(q)) / scale;
                  scale *= 2.0;
                  q *= 2.0;
                }
                return 1.0 - smoothstep(0.0, 1.0, fractal);
            }
            
            float waveLattice(vec3 p, float gridSize) {
                vec3 q = p * gridSize;
                float wave = sin(q.x * 2.0) * sin(q.y * 2.0) * sin(q.z * 2.0 + u_time);
                return smoothstep(-0.5, 0.5, wave);
            }
            
            float crystalLattice(vec3 p, float gridSize) {
                vec3 q = fract(p * gridSize) - 0.5;
                float d = max(max(abs(q.x), abs(q.y)), abs(q.z));
                return 1.0 - smoothstep(0.3, 0.5, d);
            }
            
            float getDynamicGeometry(vec3 p, float gridSize, float geometryType) {
                // WebGL 1.0 compatible modulus replacement
                float baseGeomFloat = geometryType - floor(geometryType / 8.0) * 8.0;
                int baseGeom = int(baseGeomFloat);
                float variation = floor(geometryType / 8.0) / 4.0;
                float variedGridSize = gridSize * (0.5 + variation * 1.5);
                
                if (baseGeom == 0) return tetrahedronLattice(p, variedGridSize);
                else if (baseGeom == 1) return hypercubeLattice(p, variedGridSize);
                else if (baseGeom == 2) return sphereLattice(p, variedGridSize);
                else if (baseGeom == 3) return torusLattice(p, variedGridSize);
                else if (baseGeom == 4) return kleinLattice(p, variedGridSize);
                else if (baseGeom == 5) return fractalLattice(p, variedGridSize);
                else if (baseGeom == 6) return waveLattice(p, variedGridSize);
                else return crystalLattice(p, variedGridSize);
            }
            
            vec3 hsv2rgb(vec3 c) {
                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
            }
            
            vec3 rgbGlitch(vec3 color, vec2 uv, float intensity) {
                vec2 offset = vec2(intensity * 0.005, 0.0);
                float r = color.r + sin(uv.y * 30.0 + u_time * 0.001) * intensity * 0.06;
                float g = color.g + sin(uv.y * 28.0 + u_time * 0.0012) * intensity * 0.06;
                float b = color.b + sin(uv.y * 32.0 + u_time * 0.0008) * intensity * 0.06;
                return vec3(r, g, b);
            }
            
            float moirePattern(vec2 uv, float intensity) {
                float freq1 = 12.0 + intensity * 6.0 + u_densityVariation * 3.0;
                float freq2 = 14.0 + intensity * 8.0 + u_densityVariation * 4.0;
                float pattern1 = sin(uv.x * freq1) * sin(uv.y * freq1);
                float pattern2 = sin(uv.x * freq2) * sin(uv.y * freq2);
                return (pattern1 * pattern2) * intensity * 0.15;
            }
            
            float gridOverlay(vec2 uv, float intensity) {
                vec2 grid = fract(uv * (8.0 + u_densityVariation * 4.0));
                float lines = 0.0;
                lines = max(lines, 1.0 - smoothstep(0.0, 0.02, abs(grid.x - 0.5)));
                lines = max(lines, 1.0 - smoothstep(0.0, 0.02, abs(grid.y - 0.5)));
                return lines * intensity * 0.1;
            }
            
            void main() {
                vec2 uv = gl_FragCoord.xy / u_resolution.xy;
                float aspectRatio = u_resolution.x / u_resolution.y;
                uv.x *= aspectRatio;
                uv -= 0.5;
                
                float time = u_time * 0.0004 * u_speed * u_roleSpeed;
                
                float mouseInfluence = u_mouseIntensity * 0.5;
                vec2 mouseOffset = (u_mouse - 0.5) * mouseInfluence;
                
                float parallaxOffset = u_scrollParallax * 0.2;
                vec2 scrollOffset = vec2(parallaxOffset * 0.1, parallaxOffset * 0.05);
                
                float morphOffset = u_touchMorph * 0.3;
                
                vec4 p4d = vec4(uv + mouseOffset * 0.1 + scrollOffset, 
                               sin(time * 0.1 + morphOffset) * 0.15, 
                               cos(time * 0.08 + morphOffset * 0.5) * 0.15);
                
                float scrollRotation = u_scrollParallax * 0.1;
                float touchRotation = u_touchMorph * 0.2;
                
                // Combine manual rotation with automatic/interactive rotation
                p4d = rotateXW(u_rot4dXW + time * 0.2 + mouseOffset.y * 0.5 + scrollRotation) * p4d;
                p4d = rotateYW(u_rot4dYW + time * 0.15 + mouseOffset.x * 0.5 + touchRotation) * p4d;
                p4d = rotateZW(u_rot4dZW + time * 0.25 + u_clickIntensity * 0.3 + u_touchChaos * 0.4) * p4d;
                
                vec3 p = project4Dto3D(p4d);
                
                float scrollDensityMod = 1.0 + u_gridDensityShift * 0.3;
                float audioDensityMod = 1.0 + u_audioDensityBoost * 0.5;
                float roleDensity = ((u_density + u_densityVariation) * u_roleDensity) * scrollDensityMod * audioDensityMod;
                
                float morphedGeometry = u_geometryType + u_morph * 3.0 + u_touchMorph * 2.0 + u_audioMorphBoost * 1.5;
                float lattice = getDynamicGeometry(p, roleDensity, morphedGeometry);
                
                // Enhanced holographic color processing
                vec3 baseColor = u_color;
                float latticeIntensity = lattice * u_intensity;
                
                // Multi-layer color composition for higher fidelity
                vec3 color = baseColor * (0.2 + latticeIntensity * 0.8);
                
                // Holographic shimmer layers
                vec3 shimmer1 = baseColor * lattice * 0.5;
                vec3 shimmer2 = baseColor * sin(lattice * 8.0 + u_time * 0.001) * 0.2;
                vec3 shimmer3 = baseColor * cos(lattice * 12.0 + u_time * 0.0008) * 0.15;
                
                color += shimmer1 + shimmer2 + shimmer3;
                
                // Enhanced brightness variations with interference
                color += vec3(lattice * 0.6) * baseColor;
                color += vec3(sin(lattice * 15.0) * 0.1) * baseColor;
                
                // Depth-based coloring for 3D effect
                float depth = 1.0 - length(p) * 0.3;
                color *= (0.7 + depth * 0.3);
                
                float enhancedChaos = u_chaos + u_chaosIntensity + u_touchChaos * 0.3 + u_audioChaosBoost * 0.4;
                color += vec3(moirePattern(uv + scrollOffset, enhancedChaos));
                color += vec3(gridOverlay(uv, u_mouseIntensity + u_scrollParallax * 0.1));
                color = rgbGlitch(color, uv, enhancedChaos);
                
                // Apply morph distortion to position
                vec2 morphDistortion = vec2(sin(uv.y * 10.0 + u_time * 0.001) * u_morph * 0.1, 
                                           cos(uv.x * 10.0 + u_time * 0.001) * u_morph * 0.1);
                color = mix(color, color * (1.0 + length(morphDistortion)), u_morph * 0.5);
                
                // Enhanced holographic interaction effects
                float mouseDist = length(uv - (u_mouse - 0.5) * vec2(aspectRatio, 1.0));
                
                // Multi-layer mouse glow with holographic ripples
                float mouseGlow = exp(-mouseDist * 1.2) * u_mouseIntensity * 0.25;
                float mouseRipple = sin(mouseDist * 15.0 - u_time * 0.003) * exp(-mouseDist * 2.0) * u_mouseIntensity * 0.1;
                color += vec3(mouseGlow + mouseRipple) * baseColor * 0.8;
                
                // Enhanced click pulse with interference
                float clickPulse = u_clickIntensity * exp(-mouseDist * 1.8) * 0.4;
                float clickRing = sin(mouseDist * 20.0 - u_clickIntensity * 5.0) * u_clickIntensity * 0.15;
                color += vec3(clickPulse + clickRing, (clickPulse + clickRing) * 0.6, (clickPulse + clickRing) * 1.2);
                
                // Holographic interference from interactions
                float interference = sin(mouseDist * 25.0 + u_time * 0.002) * u_mouseIntensity * 0.05;
                color += vec3(interference) * baseColor;
                
                gl_FragColor = vec4(color, 0.95);
            }\`;
        
        // WebGL setup functions
        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compilation error:', gl.getShaderInfoLog(shader));
                return null;
            }
            
            return shader;
        }
        
        function createProgram(gl, vertexSource, fragmentSource) {
            const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexSource);
            const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentSource);
            
            if (!vertexShader || !fragmentShader) {
                return null;
            }
            
            const program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                console.error('Program linking failed:', gl.getProgramInfoLog(program));
                return null;
            }
            
            return program;
        }
        
        // HSV to RGB conversion
        function hsvToRgb(h, s, v) {
            h = h / 360.0;
            const c = v * s;
            const x = c * (1 - Math.abs((h * 6) % 2 - 1));
            const m = v - c;
            
            let r, g, b;
            if (h < 1/6) { r = c; g = x; b = 0; }
            else if (h < 2/6) { r = x; g = c; b = 0; }
            else if (h < 3/6) { r = 0; g = c; b = x; }
            else if (h < 4/6) { r = 0; g = x; b = c; }
            else if (h < 5/6) { r = x; g = 0; b = c; }
            else { r = c; g = 0; b = x; }
            
            return [(r + m), (g + m), (b + m)];
        }
        
        // Base parameters with EXACT engine scaling - MUST match HolographicVisualizer.js line 723-724
        const rawGridDensity = parseFloat(${e.gridDensity||15});
        const mappedBaseDensity = 0.6 + (rawGridDensity - 5) / 95 * 6.9; // EXACT same formula as engine
        const baseHue = ${e.hue||320};
        
        console.log('ğŸ”§ Trading card density mapping: gridDensity=' + rawGridDensity + ' â†’ mappedBaseDensity=' + mappedBaseDensity.toFixed(3));
        
        // EXACT role density calculations from HolographicVisualizer.js generateRoleParams() method
        // These MUST match the engine's dynamic calculations exactly
        const roleDensityCalculations = {
            'background': 0.4,  // Static from engine
            'shadow': 0.8,      // Static from engine
            'content': mappedBaseDensity,  // Dynamic: vp.density from engine
            'highlight': 1.5 + (mappedBaseDensity * 0.3),  // Dynamic: 1.5 + (vp.density * 0.3) from engine
            'accent': 2.5 + (mappedBaseDensity * 0.5)       // Dynamic: 2.5 + (vp.density * 0.5) from engine
        };
        
        console.log('ğŸ”§ Role density calculations:', roleDensityCalculations);
        
        // Initialize all layers
        const visualizers = [];
        
        layers.forEach(layer => {
            const canvas = document.getElementById(layer.id);
            const gl = canvas.getContext('webgl');
            
            if (!gl) {
                console.error('WebGL not supported for', layer.id);
                return;
            }
            
            const program = createProgram(gl, vertexShaderSource, fragmentShaderSource);
            if (!program) return;
            
            // Set up buffers
            const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
            const buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
            
            const positionLocation = gl.getAttribLocation(program, 'a_position');
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            // Get uniform locations (ALL uniforms from HolographicVisualizer)
            const uniforms = {
                resolution: gl.getUniformLocation(program, 'u_resolution'),
                time: gl.getUniformLocation(program, 'u_time'),
                mouse: gl.getUniformLocation(program, 'u_mouse'),
                geometry: gl.getUniformLocation(program, 'u_geometry'),
                density: gl.getUniformLocation(program, 'u_density'),
                speed: gl.getUniformLocation(program, 'u_speed'),
                color: gl.getUniformLocation(program, 'u_color'),
                intensity: gl.getUniformLocation(program, 'u_intensity'),
                roleDensity: gl.getUniformLocation(program, 'u_roleDensity'),
                roleSpeed: gl.getUniformLocation(program, 'u_roleSpeed'),
                colorShift: gl.getUniformLocation(program, 'u_colorShift'),
                chaosIntensity: gl.getUniformLocation(program, 'u_chaosIntensity'),
                mouseIntensity: gl.getUniformLocation(program, 'u_mouseIntensity'),
                clickIntensity: gl.getUniformLocation(program, 'u_clickIntensity'),
                densityVariation: gl.getUniformLocation(program, 'u_densityVariation'),
                geometryType: gl.getUniformLocation(program, 'u_geometryType'),
                chaos: gl.getUniformLocation(program, 'u_chaos'),
                morph: gl.getUniformLocation(program, 'u_morph'),
                touchMorph: gl.getUniformLocation(program, 'u_touchMorph'),
                touchChaos: gl.getUniformLocation(program, 'u_touchChaos'),
                scrollParallax: gl.getUniformLocation(program, 'u_scrollParallax'),
                gridDensityShift: gl.getUniformLocation(program, 'u_gridDensityShift'),
                colorScrollShift: gl.getUniformLocation(program, 'u_colorScrollShift'),
                audioDensityBoost: gl.getUniformLocation(program, 'u_audioDensityBoost'),
                audioMorphBoost: gl.getUniformLocation(program, 'u_audioMorphBoost'),
                audioSpeedBoost: gl.getUniformLocation(program, 'u_audioSpeedBoost'),
                audioChaosBoost: gl.getUniformLocation(program, 'u_audioChaosBoost'),
                audioColorShift: gl.getUniformLocation(program, 'u_audioColorShift'),
                rot4dXW: gl.getUniformLocation(program, 'u_rot4dXW'),
                rot4dYW: gl.getUniformLocation(program, 'u_rot4dYW'),
                rot4dZW: gl.getUniformLocation(program, 'u_rot4dZW')
            };
            
            // Layer-specific color with hue shift
            const layerHue = baseHue + layer.colorShift;
            const [r, g, b] = hsvToRgb(layerHue, ${e.saturation||.8}, ${e.intensity||.6});
            
            visualizers.push({
                gl, program, uniforms, layer,
                color: [r, g, b]
            });
        });
        
        const startTime = Date.now();
        
        function render() {
            const time = Date.now() - startTime;
            
            visualizers.forEach(viz => {
                const { gl, program, uniforms, layer, color } = viz;
                
                gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
                gl.useProgram(program);
                
                // Set uniforms with EXACT layer-specific role parameters from engine
                const exactRoleDensity = roleDensityCalculations[layer.role] || mappedBaseDensity;
                
                gl.uniform2f(uniforms.resolution, gl.canvas.width, gl.canvas.height);
                gl.uniform1f(uniforms.time, time);
                gl.uniform2f(uniforms.mouse, 0.5, 0.5);
                gl.uniform1f(uniforms.geometry, ${e.geometry||0});
                gl.uniform1f(uniforms.density, mappedBaseDensity);
                gl.uniform1f(uniforms.speed, ${e.speed||1});
                gl.uniform3fv(uniforms.color, color);
                gl.uniform1f(uniforms.intensity, (${e.intensity||.6}) * layer.intensityMult);
                gl.uniform1f(uniforms.roleDensity, exactRoleDensity); // EXACT from engine
                gl.uniform1f(uniforms.roleSpeed, layer.speedMult);
                gl.uniform1f(uniforms.colorShift, layer.colorShift);
                gl.uniform1f(uniforms.chaosIntensity, ${e.chaos||.2});
                gl.uniform1f(uniforms.mouseIntensity, 0.0);
                gl.uniform1f(uniforms.clickIntensity, 0.0);
                gl.uniform1f(uniforms.densityVariation, 0.0);
                gl.uniform1f(uniforms.geometryType, ${e.geometry||0});
                gl.uniform1f(uniforms.chaos, ${e.chaos||.2});
                gl.uniform1f(uniforms.morph, ${e.morphFactor||1});
                gl.uniform1f(uniforms.touchMorph, 0.0);
                gl.uniform1f(uniforms.touchChaos, 0.0);
                gl.uniform1f(uniforms.scrollParallax, 0.0);
                gl.uniform1f(uniforms.gridDensityShift, 0.0);
                gl.uniform1f(uniforms.colorScrollShift, 0.0);
                gl.uniform1f(uniforms.audioDensityBoost, 0.0);
                gl.uniform1f(uniforms.audioMorphBoost, 0.0);
                gl.uniform1f(uniforms.audioSpeedBoost, 0.0);
                gl.uniform1f(uniforms.audioChaosBoost, 0.0);
                gl.uniform1f(uniforms.audioColorShift, 0.0);
                gl.uniform1f(uniforms.rot4dXW, ${e.rot4dXW||0});
                gl.uniform1f(uniforms.rot4dYW, ${e.rot4dYW||0});
                gl.uniform1f(uniforms.rot4dZW, ${e.rot4dZW||0});
                
                // Enable blending for layer composition
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            });
            
            requestAnimationFrame(render);
        }
        
        console.log('ğŸŒŒ Multi-layer holographic card initialized with', visualizers.length, 'layers');
        render();
    <\/script>
</body>
</html>`;return{filename:`vib34d-holographic-multilayer-${a}-${r}.html`,content:n,system:"holographic-multilayer"}}}const Qi=Object.freeze(Object.defineProperty({__proto__:null,HolographicCardGeneratorMultiLayer:Ki},Symbol.toStringTag,{value:"Module"}));class Ji{constructor(e){this.systemName=e,this.canvasCount=0}async generateCard(e,t){try{const o=this.getSystemShaders(),a=this.getSystemStyles(),r=this.generateSystemContent(t),s=this.buildHTML({format:e,parameters:t,shaders:o,styles:a,content:r}),n=this.generateFilename(e,t);return this.downloadFile(n,s),{success:!0,filename:n,system:this.systemName}}catch(o){return console.error(`âŒ ${this.systemName} card generation failed:`,o),{success:!1,error:o.message,system:this.systemName}}}buildHTML({format:e,parameters:t,shaders:o,styles:a,content:r}){const s=new Date().toISOString().replace(/[:.]/g,"-");return`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${this.systemName.toUpperCase()} Trading Card</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        ${this.getBaseStyles()}
        ${a}
    </style>
</head>
<body>
    <div class="card-container">
        <div class="card-header">
            <div class="system-badge ${this.systemName.toLowerCase()}">${this.systemName.toUpperCase()}</div>
            <div class="card-title">${this.getCardTitle(t)}</div>
        </div>
        
        <div class="visualization-area">
            ${r}
        </div>
        
        <div class="card-footer">
            <div class="parameters">
                ${this.formatParameters(t)}
            </div>
            <div class="signature">
                VIB34D Engine â€¢ ${s}
            </div>
        </div>
    </div>
    
    <script>
        ${o.vertex?`const vertexShaderSource = \`${o.vertex}\`;`:""}
        ${o.fragment?`const fragmentShaderSource = \`${o.fragment}\`;`:""}
        
        // System-specific initialization
        ${this.getSystemJavaScript()}
        
        // Start visualization
        window.addEventListener('load', () => {
            try {
                initializeCard(${JSON.stringify(t)});
            } catch (error) {
                console.error('Card initialization failed:', error);
                document.querySelector('.visualization-area').innerHTML = 
                    '<div style="color: #ff0000; text-align: center; padding: 50px;">Visualization failed to load</div>';
            }
        });
    <\/script>
</body>
</html>`}getBaseStyles(){return`
            * { margin: 0; padding: 0; box-sizing: border-box; }
            
            body {
                background: #000;
                color: #fff;
                font-family: 'Orbitron', monospace;
                overflow: hidden;
            }
            
            .card-container {
                width: 100vw;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: radial-gradient(ellipse at center, #1a0033 0%, #000000 70%);
            }
            
            .card-header {
                padding: 20px;
                background: rgba(0, 0, 0, 0.8);
                border-bottom: 2px solid rgba(0, 255, 255, 0.5);
                display: flex;
                justify-content: space-between;
                align-items: center;
                backdrop-filter: blur(10px);
            }
            
            .system-badge {
                padding: 8px 16px;
                border-radius: 12px;
                font-weight: 700;
                font-size: 0.9rem;
                text-shadow: 0 0 10px currentColor;
            }
            
            .system-badge.faceted {
                background: rgba(0, 255, 255, 0.2);
                border: 2px solid #00ffff;
                color: #00ffff;
            }
            
            .system-badge.quantum {
                background: rgba(0, 255, 255, 0.2);
                border: 2px solid #00ffff;
                color: #00ffff;
            }
            
            .system-badge.holographic {
                background: rgba(255, 100, 255, 0.2);
                border: 2px solid #ff64ff;
                color: #ff64ff;
            }
            
            .system-badge.polychora {
                background: rgba(255, 150, 0, 0.2);
                border: 2px solid #ff9600;
                color: #ff9600;
            }
            
            .card-title {
                font-size: 1.4rem;
                font-weight: 700;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            }
            
            .visualization-area {
                flex: 1;
                position: relative;
                overflow: hidden;
            }
            
            .card-footer {
                padding: 15px 20px;
                background: rgba(0, 0, 0, 0.9);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.8rem;
            }
            
            .parameters {
                color: rgba(255, 255, 255, 0.8);
                line-height: 1.4;
            }
            
            .signature {
                color: rgba(0, 255, 255, 0.7);
                font-weight: 400;
                font-size: 0.7rem;
            }
            
            canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
        `}generateFilename(e,t){const o=new Date().toISOString().replace(/[:.]/g,"-"),a=this.getGeometryName(t);return`vib34d-card-${this.systemName.toLowerCase()}-${a.toLowerCase().replace(/\s+/g,"-")}-${o}.html`}formatParameters(e){return Object.entries(e).filter(([o,a])=>!["system","hideui"].includes(o)).slice(0,4).map(([o,a])=>`${o}: ${typeof a=="number"?a.toFixed(1):a}`).join(" â€¢ ")||"Default parameters"}downloadFile(e,t){const o=new Blob([t],{type:"text/html"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}getSystemShaders(){throw new Error(`${this.systemName} must implement getSystemShaders()`)}getSystemStyles(){throw new Error(`${this.systemName} must implement getSystemStyles()`)}generateSystemContent(e){throw new Error(`${this.systemName} must implement generateSystemContent()`)}getSystemJavaScript(){throw new Error(`${this.systemName} must implement getSystemJavaScript()`)}getCardTitle(e){return`${this.systemName.toUpperCase()} ${this.getGeometryName(e)}`}getGeometryName(e){const t=["TETRAHEDRON","HYPERCUBE","SPHERE","TORUS","KLEIN BOTTLE","FRACTAL","WAVE","CRYSTAL"],o=e.geometry||e.geometryType||0;return t[o]||"GEOMETRY"}}class je extends Ji{constructor(){super("Polychora")}getSystemShaders(){return{vertex:`
                attribute vec2 a_position;
                void main() {
                    gl_Position = vec4(a_position, 0.0, 1.0);
                }
            `,fragment:`
                precision highp float;
                
                uniform vec2 u_resolution;
                uniform float u_time;
                uniform float u_geometry;
                uniform float u_gridDensity;
                uniform float u_hue;
                uniform float u_intensity;
                uniform float u_morphFactor;
                uniform float u_chaos;
                uniform float u_rot4dXW;
                uniform float u_rot4dYW;
                uniform float u_rot4dZW;
                
                // 4D rotation matrices for polytopes
                mat4 rotateXW(float theta) {
                    float c = cos(theta);
                    float s = sin(theta);
                    return mat4(c, 0, 0, -s, 0, 1, 0, 0, 0, 0, 1, 0, s, 0, 0, c);
                }
                
                mat4 rotateYW(float theta) {
                    float c = cos(theta);
                    float s = sin(theta);
                    return mat4(1, 0, 0, 0, 0, c, 0, -s, 0, 0, 1, 0, 0, s, 0, c);
                }
                
                mat4 rotateZW(float theta) {
                    float c = cos(theta);
                    float s = sin(theta);
                    return mat4(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, c, -s, 0, 0, s, c);
                }
                
                // 4D to 3D projection with perspective
                vec3 project4Dto3D(vec4 p) {
                    float perspective = 3.0 / (3.0 + p.w);
                    return vec3(p.x * perspective, p.y * perspective, p.z * perspective);
                }
                
                // 4D polytope distance functions
                float polytope5Cell(vec4 p) {
                    // 5-cell (4D tetrahedron)
                    vec4 a = vec4(1.0, 1.0, 1.0, -1.0/sqrt(5.0));
                    vec4 b = vec4(1.0, -1.0, -1.0, -1.0/sqrt(5.0));
                    vec4 c = vec4(-1.0, 1.0, -1.0, -1.0/sqrt(5.0));
                    vec4 d = vec4(-1.0, -1.0, 1.0, -1.0/sqrt(5.0));
                    vec4 e = vec4(0.0, 0.0, 0.0, sqrt(5.0)/sqrt(5.0));
                    
                    float d1 = length(p - a);
                    float d2 = length(p - b);
                    float d3 = length(p - c);
                    float d4 = length(p - d);
                    float d5 = length(p - e);
                    
                    return min(min(min(d1, d2), min(d3, d4)), d5);
                }
                
                float polytopeTesseract(vec4 p) {
                    // 8-cell (tesseract)
                    vec4 q = abs(p);
                    return max(max(q.x, q.y), max(q.z, q.w)) - 1.0;
                }
                
                float polytope16Cell(vec4 p) {
                    // 16-cell (hyperoctahedron)
                    return abs(p.x) + abs(p.y) + abs(p.z) + abs(p.w) - 1.0;
                }
                
                float getPolytope(vec4 p, float polytypeType) {
                    int polyType = int(mod(polytypeType, 6.0));
                    
                    if (polyType == 0) return polytope5Cell(p);
                    else if (polyType == 1) return polytopeTesseract(p);
                    else if (polyType == 2) return polytope16Cell(p);
                    else if (polyType == 3) return polytope5Cell(p * 1.2); // 24-cell approximation
                    else if (polyType == 4) return polytope16Cell(p * 0.8); // 600-cell approximation
                    else return polytopeTesseract(p * 0.6); // 120-cell approximation
                }
                
                vec3 hsv2rgb(vec3 c) {
                    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
                }
                
                void main() {
                    vec2 uv = gl_FragCoord.xy / u_resolution.xy;
                    float aspectRatio = u_resolution.x / u_resolution.y;
                    uv.x *= aspectRatio;
                    uv -= 0.5;
                    
                    float time = u_time * 0.0006;
                    
                    // 4D point in space
                    vec4 p4d = vec4(uv * u_gridDensity * 0.1, 
                                   sin(time * 0.7) * 0.3, 
                                   cos(time * 0.5) * 0.25);
                    
                    // Apply 4D rotations
                    p4d = rotateXW(u_rot4dXW + time * 0.3) * p4d;
                    p4d = rotateYW(u_rot4dYW + time * 0.4) * p4d;
                    p4d = rotateZW(u_rot4dZW + time * 0.5) * p4d;
                    
                    // Apply morphing
                    p4d += vec4(sin(p4d.yxz * 5.0 + time) * u_morphFactor * 0.1, 0.0);
                    
                    // Get polytope distance
                    float dist = getPolytope(p4d, u_geometry);
                    
                    // Create glassmorphic effect
                    float edge = 1.0 - smoothstep(0.0, 0.1, abs(dist));
                    float interior = 1.0 - smoothstep(0.0, 0.3, abs(dist + 0.2));
                    
                    // Project to 3D for additional effects
                    vec3 p3d = project4Dto3D(p4d);
                    
                    // Glass refraction simulation
                    vec2 refraction = uv + normalize(p3d.xy) * edge * 0.02;
                    
                    // Color composition
                    vec3 baseColor = hsv2rgb(vec3(u_hue / 360.0, 0.7, u_intensity));
                    vec3 glassColor = hsv2rgb(vec3((u_hue + 30.0) / 360.0, 0.4, u_intensity * 0.8));
                    
                    vec3 color = mix(glassColor * interior * 0.3, baseColor * edge, edge);
                    
                    // Add glassmorphic highlights
                    float highlight = pow(edge, 3.0) * u_intensity;
                    color += vec3(highlight) * 0.5;
                    
                    // Chaos as glass distortion
                    float distortion = sin(length(uv) * 20.0 + time * 2.0) * u_chaos * 0.1;
                    color += vec3(distortion) * baseColor * 0.3;
                    
                    // Depth fade for 4D effect
                    float depth = 1.0 - length(p4d) * 0.2;
                    color *= (0.5 + depth * 0.5);
                    
                    gl_FragColor = vec4(color, 0.9);
                }
            `}}getSystemStyles(){return`
            .visualization-area {
                border: 2px solid rgba(255, 150, 0, 0.4);
                box-shadow: 
                    0 0 30px rgba(255, 150, 0, 0.3),
                    inset 0 0 20px rgba(255, 150, 0, 0.1);
                background: rgba(255, 150, 0, 0.02);
                backdrop-filter: blur(5px);
            }
            
            .card-title {
                color: #ff9600;
                text-shadow: 0 0 20px rgba(255, 150, 0, 0.8);
            }
            
            .system-badge.polychora {
                box-shadow: 0 0 15px rgba(255, 150, 0, 0.5);
                animation: polytope-glow 3s ease-in-out infinite alternate;
            }
            
            @keyframes polytope-glow {
                from { 
                    box-shadow: 0 0 15px rgba(255, 150, 0, 0.5);
                    transform: rotateY(0deg);
                }
                to { 
                    box-shadow: 0 0 25px rgba(255, 150, 0, 0.8);
                    transform: rotateY(5deg);
                }
            }
        `}generateSystemContent(e){return'<canvas id="polychora-canvas"></canvas>'}getSystemJavaScript(){return`
            function initializeCard(params) {
                const canvas = document.getElementById('polychora-canvas');
                const gl = canvas.getContext('webgl');
                
                if (!gl) {
                    throw new Error('WebGL not supported');
                }
                
                // Resize canvas
                function resize() {
                    canvas.width = canvas.clientWidth;
                    canvas.height = canvas.clientHeight;
                    gl.viewport(0, 0, canvas.width, canvas.height);
                }
                window.addEventListener('resize', resize);
                resize();
                
                // Create shader program
                function createShader(type, source) {
                    const shader = gl.createShader(type);
                    gl.shaderSource(shader, source);
                    gl.compileShader(shader);
                    
                    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                        console.error('Shader compile error:', gl.getShaderInfoLog(shader));
                        gl.deleteShader(shader);
                        return null;
                    }
                    return shader;
                }
                
                const vertexShader = createShader(gl.VERTEX_SHADER, vertexShaderSource);
                const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragmentShaderSource);
                
                const program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);
                
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    console.error('Program link error:', gl.getProgramInfoLog(program));
                    return;
                }
                
                // Set up buffers
                const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
                const positionBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
                
                const positionLocation = gl.getAttribLocation(program, 'a_position');
                gl.enableVertexAttribArray(positionLocation);
                gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
                
                // Get uniform locations
                const uniforms = {
                    resolution: gl.getUniformLocation(program, 'u_resolution'),
                    time: gl.getUniformLocation(program, 'u_time'),
                    geometry: gl.getUniformLocation(program, 'u_geometry'),
                    gridDensity: gl.getUniformLocation(program, 'u_gridDensity'),
                    hue: gl.getUniformLocation(program, 'u_hue'),
                    intensity: gl.getUniformLocation(program, 'u_intensity'),
                    morphFactor: gl.getUniformLocation(program, 'u_morphFactor'),
                    chaos: gl.getUniformLocation(program, 'u_chaos'),
                    rot4dXW: gl.getUniformLocation(program, 'u_rot4dXW'),
                    rot4dYW: gl.getUniformLocation(program, 'u_rot4dYW'),
                    rot4dZW: gl.getUniformLocation(program, 'u_rot4dZW')
                };
                
                // Animation loop
                const startTime = Date.now();
                
                function render() {
                    const time = Date.now() - startTime;
                    
                    gl.useProgram(program);
                    
                    // Set uniforms (optimized for 4D polytopes)
                    gl.uniform2f(uniforms.resolution, canvas.width, canvas.height);
                    gl.uniform1f(uniforms.time, time);
                    gl.uniform1f(uniforms.geometry, parseFloat(params.polytope) || parseFloat(params.geometry) || 0);
                    gl.uniform1f(uniforms.gridDensity, parseFloat(params.gridDensity) || 15);
                    gl.uniform1f(uniforms.hue, parseFloat(params.hue) || 30); // Default orange
                    gl.uniform1f(uniforms.intensity, parseFloat(params.intensity) || 0.6);
                    gl.uniform1f(uniforms.morphFactor, parseFloat(params.morphFactor) || 1.0);
                    gl.uniform1f(uniforms.chaos, parseFloat(params.chaos) || 0.1); // Lower chaos for mathematical precision
                    gl.uniform1f(uniforms.rot4dXW, parseFloat(params.rot4dXW) || 0);
                    gl.uniform1f(uniforms.rot4dYW, parseFloat(params.rot4dYW) || 0);
                    gl.uniform1f(uniforms.rot4dZW, parseFloat(params.rot4dZW) || 0);
                    
                    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
                    
                    requestAnimationFrame(render);
                }
                
                render();
                console.log('âœ… Polychora trading card initialized');
            }
        `}getCardTitle(e){const t=["5-CELL","TESSERACT","16-CELL","24-CELL","600-CELL","120-CELL"],o=e.polytope||e.geometry||0;return`${t[o]||"4D-POLYTOPE"} GLASSMORPHIC`}getGeometryName(e){const t=["5-CELL","TESSERACT","16-CELL","24-CELL","600-CELL","120-CELL"],o=e.polytope||e.geometry||0;return t[o]||"4D-POLYTOPE"}}const ea=Object.freeze(Object.defineProperty({__proto__:null,PolychoraCardGenerator:je,default:je},Symbol.toStringTag,{value:"Module"}));

</script>
  <style>
*{margin:0;padding:0;box-sizing:border-box}body{background:#000;color:#fff;font-family:Orbitron,monospace;overflow:hidden;position:relative}body.projection-mode .top-bar,body.projection-mode .control-panel,body.projection-mode #floating-debug-btn{transform:translateY(200%);opacity:0;pointer-events:none}.canvas-container{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;background:#000;z-index:1!important}.canvas-container *{position:relative;z-index:auto!important;max-height:100vh}.holographic-layers,.visualization-canvas,canvas{z-index:auto!important}.visualization-canvas,.holographic-layers{position:absolute;top:0;left:0;width:100%;height:100%}.top-bar{position:fixed;top:0;left:0;right:0;height:auto;min-height:50px;background:linear-gradient(180deg,#000000d9,#000a14bf);border-bottom:2px solid rgba(0,255,255,.3);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:10000!important;-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);box-shadow:0 4px 20px #000000b3;transition:all .3s ease}.top-bar *{z-index:inherit!important}@media (orientation: landscape) and (max-height: 500px){.top-bar{transform:translateY(-100%);opacity:0;pointer-events:none}}.logo-section{display:flex;align-items:center;gap:15px}.logo{font-size:1.3rem;font-weight:900;color:#0ff;text-shadow:0 0 25px rgba(0,255,255,.6);font-family:Orbitron,monospace;letter-spacing:2px}.engine-status{font-size:.7rem;color:#0ff9;font-family:Orbitron,monospace;padding:4px 8px;background:#00ffff1a;border:1px solid rgba(0,255,255,.2);border-radius:4px}.system-selector{display:flex;gap:8px;flex:1;justify-content:center;max-width:600px}.system-btn{background:linear-gradient(135deg,#00000080,#00142880);border:2px solid rgba(0,255,255,.2);color:#ffffffb3;padding:10px 18px;cursor:pointer;font-family:Orbitron,monospace;font-size:.85rem;font-weight:700;transition:all .3s ease;border-radius:8px;position:relative;overflow:hidden;display:flex;align-items:center;gap:8px}.system-btn:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at center,rgba(0,255,255,.1),transparent);opacity:0;transition:opacity .3s ease}.system-btn:hover:before{opacity:1}.system-btn:hover{background:linear-gradient(135deg,#00ffff26,#00c8ff26);border-color:#00ffff80;color:#0ff;box-shadow:0 0 15px #00ffff4d;transform:translateY(-2px)}.system-btn.active{background:linear-gradient(135deg,#00ffff40,#00c8ff4d);border-color:#0ff;color:#0ff;box-shadow:0 0 25px #00ffff80,inset 0 0 15px #0ff3;transform:translateY(-2px)}.system-btn.active:after{content:"";position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,#00ffff,transparent);animation:pulseGlow 2s ease-in-out infinite}@keyframes pulseGlow{0%,to{opacity:.5}50%{opacity:1}}.action-section{display:flex;align-items:center;gap:8px}.action-buttons{display:flex;gap:6px}.action-btn{background:linear-gradient(135deg,#00000080,#14002880);border:2px solid rgba(255,0,255,.2);color:#f0fc;padding:8px 12px;cursor:pointer;font-size:1.1rem;transition:all .3s ease;border-radius:8px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;min-width:40px;height:40px}.action-btn:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at center,rgba(255,0,255,.15),transparent);opacity:0;transition:opacity .3s ease}.action-btn:hover:before{opacity:1}.action-btn:hover{background:linear-gradient(135deg,#f0f3,#c800ff33);border-color:#f0f9;color:#f0f;box-shadow:0 0 15px #f0f6;transform:scale(1.1)}.save-btn{background:linear-gradient(135deg,#00ff0026,#00c86426);border:2px solid rgba(0,255,0,.3);color:#0f0;padding:10px 20px;font-family:Orbitron,monospace;font-size:.85rem;font-weight:700;cursor:pointer;border-radius:8px;transition:all .3s ease;display:flex;align-items:center;gap:8px}.save-btn:hover{background:linear-gradient(135deg,#00ff0040,#00c86440);border-color:#0f0;box-shadow:0 0 20px #0f06;transform:scale(1.05)}.expandable-section{position:relative}.expand-trigger{padding:6px 10px;background:#0000004d;border:1px solid rgba(255,255,255,.1);border-radius:6px;cursor:pointer;font-family:Orbitron,monospace;font-size:.75rem;color:#ffffffb3;transition:all .3s ease;display:flex;align-items:center;gap:6px}.expand-trigger:hover{background:#00ffff26;border-color:#00ffff4d;color:#0ff}.expand-trigger.active{background:#0ff3;border-color:#00ffff80;color:#0ff}.expanded-content{position:absolute;top:calc(100% + 10px);right:0;background:linear-gradient(135deg,#000a14f2,#001428f2);border:2px solid rgba(0,255,255,.3);border-radius:10px;padding:15px;min-width:200px;display:none;z-index:10001;box-shadow:0 10px 40px #000c;-webkit-backdrop-filter:blur(15px);backdrop-filter:blur(15px);animation:slideDown .3s ease-out}.expanded-content.visible{display:block}@keyframes slideDown{0%{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.option-row{padding:8px 12px;margin:4px 0;background:#0000004d;border:1px solid rgba(255,255,255,.1);border-radius:6px;cursor:pointer;font-family:Orbitron,monospace;font-size:.75rem;color:#fffc;transition:all .2s ease;display:flex;align-items:center;gap:8px}.option-row:hover{background:#00ffff26;border-color:#00ffff4d;color:#0ff;transform:translate(5px)}@media (max-width: 1024px){.top-bar{flex-wrap:wrap;padding:8px 15px;min-height:auto}.system-selector{order:3;width:100%;margin-top:8px}.system-btn{flex:1;padding:8px 12px;font-size:.75rem}.logo{font-size:1.1rem}.engine-status{display:none}}@media (max-width: 768px){.system-btn span:not(.system-icon){display:none!important}.system-btn{padding:10px!important;min-width:54px!important;min-height:48px!important;justify-content:center;align-items:center}.system-btn .system-icon{display:inline-flex!important;min-width:28px!important;min-height:28px!important;font-size:1.3rem!important;align-items:center;justify-content:center}.action-btn{padding:6px 10px;font-size:1rem;min-width:36px;height:36px}.save-btn span{display:none}.save-btn{padding:8px 12px}}@media (max-width: 480px){.logo{font-size:.9rem;letter-spacing:1px}.action-buttons{gap:4px}.action-btn{font-size:.9rem;min-width:32px;height:32px}}.control-panel{position:fixed;top:50px;right:0;bottom:0;width:300px;background:#000000f2;border-left:2px solid #00ffff;padding:20px;overflow-y:auto;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);z-index:100;transition:transform .3s ease}.panel-header{font-size:1.1rem;color:#f0f;margin-bottom:20px;text-align:center;text-shadow:0 0 10px #ff00ff;display:flex;justify-content:space-between;align-items:center}.mobile-collapse-btn{background:#f0f3;border:1px solid #ff00ff;color:#f0f;padding:8px 12px;cursor:pointer;font-size:1.2rem;border-radius:5px;transition:all .3s ease}.mobile-collapse-btn:hover{background:#f0f6}.control-section{margin-bottom:25px;padding-bottom:20px;border-bottom:1px solid rgba(0,255,255,.2)}.control-section:last-child{border-bottom:none}.section-title{font-size:.9rem;color:#0ff;margin-bottom:10px;text-transform:uppercase}.geometry-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}.geom-btn{background:#00ffff1a;border:1px solid rgba(0,255,255,.3);color:#0ff;padding:8px;cursor:pointer;font-size:.7rem;transition:all .3s}.geom-btn:hover{background:#0ff3}.geom-btn.active{background:#0ff6;border-color:#0ff;box-shadow:0 0 5px #00ffff80}.control-group{margin-bottom:15px}.control-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:.8rem;color:#fffc}.control-value{color:#0ff;font-weight:700}.control-slider{width:100%;height:6px;background:#0ff3;outline:none;opacity:.9;transition:opacity .2s;-webkit-appearance:none;-moz-appearance:none;appearance:none;border-radius:3px}.control-slider:hover{opacity:1}.control-slider::-webkit-slider-thumb{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:16px;height:16px;background:#0ff;cursor:pointer;border-radius:50%;box-shadow:0 0 5px #00ffff80}.control-slider::-moz-range-thumb{width:16px;height:16px;background:#0ff;cursor:pointer;border-radius:50%;border:none;box-shadow:0 0 5px #00ffff80}.panel-btn{background:#ff00ff1a;border:2px solid rgba(255,0,255,.3);color:#f0f;padding:10px 20px;margin:5px 0;cursor:pointer;font-size:.9rem;width:100%;transition:all .3s}.panel-btn:hover{background:#ff00ff4d;box-shadow:0 0 10px #ff00ff80}.panel-btn.wide{width:100%;margin-bottom:10px}.reactivity-grid{display:grid;grid-template-columns:65px 1fr 1fr 1fr;grid-template-rows:auto auto auto auto;gap:3px;margin:8px 0;border:1px solid rgba(0,255,255,.2);border-radius:6px;padding:6px;background:#0014284d;max-width:100%;overflow:hidden}.reactivity-header{font-size:.65rem;font-weight:700;color:#0ff;text-align:center;padding:2px;background:#00ffff1a;border-radius:3px;border:1px solid rgba(0,255,255,.2);line-height:1.2;overflow:hidden;white-space:nowrap}.reactivity-label{font-size:.6rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;padding:2px;background:#ffffff0d;border-radius:3px;border:1px solid rgba(255,255,255,.1);line-height:1.1;text-align:center}.reactivity-cell{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;padding:3px;background:#0000004d;border:1px solid rgba(255,255,255,.1);border-radius:3px;cursor:pointer;min-height:40px;transition:all .3s ease}.reactivity-cell:hover{background:#00ffff1a;border-color:#00ffff4d}.reactivity-cell input[type=checkbox]{width:14px;height:14px;accent-color:#00ffff;cursor:pointer;margin:0}.cell-text{color:#ffffffb3;font-size:.55rem;text-align:center;transition:color .3s;line-height:1.1;font-weight:500;white-space:nowrap}.reactivity-cell input[type=checkbox]:checked+.cell-text{color:#0ff;font-weight:700}.reactivity-note{font-size:.65rem;color:#ffffff80;text-align:center;margin-top:6px;font-style:italic}.audio-grid{display:grid;grid-template-columns:65px 1fr 1fr 1fr;grid-template-rows:auto auto auto auto;gap:3px;margin:8px 0;border:1px solid rgba(255,0,255,.2);border-radius:6px;padding:6px;background:#2800284d;max-width:100%;overflow:hidden}.audio-header{font-size:.65rem;font-weight:700;color:#f0f;text-align:center;padding:2px;background:#ff00ff1a;border-radius:3px;border:1px solid rgba(255,0,255,.2);line-height:1.2;overflow:hidden;white-space:nowrap}.audio-label{font-size:.6rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;padding:2px;background:#ffffff0d;border-radius:3px;border:1px solid rgba(255,255,255,.1);line-height:1.1;text-align:center}.audio-cell{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;padding:3px;background:#0000004d;border:1px solid rgba(255,255,255,.1);border-radius:3px;cursor:pointer;min-height:40px;transition:all .3s ease}.audio-cell:hover{background:#ff00ff1a;border-color:#ff00ff4d}.audio-cell input[type=checkbox]{width:14px;height:14px;accent-color:#ff00ff;cursor:pointer;margin:0}.audio-cell input[type=checkbox]:checked+.cell-text{color:#f0f;font-weight:700}.audio-note{font-size:.65rem;color:#ffffff80;text-align:center;margin-top:6px;font-style:italic}.gallery-modal{position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity .3s ease}.gallery-modal.visible{opacity:1}.gallery-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:#000000d9;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);cursor:pointer}.gallery-container{position:relative;width:90vw;max-width:1200px;height:80vh;background:linear-gradient(135deg,#000a14f2,#001428f2);border:2px solid rgba(0,255,255,.3);border-radius:16px;box-shadow:0 20px 60px #0ff3;display:flex;flex-direction:column;overflow:hidden;animation:modalSlideIn .3s ease-out}@keyframes modalSlideIn{0%{transform:translateY(50px) scale(.9);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}.gallery-header{padding:20px 30px;background:linear-gradient(90deg,#00ffff1a,#0096ff1a);border-bottom:1px solid rgba(0,255,255,.2);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}.gallery-title{display:flex;align-items:center;gap:12px;font-family:Orbitron,monospace;font-size:1.5rem;font-weight:900;color:#0ff;text-shadow:0 0 10px rgba(0,255,255,.5)}.gallery-icon{font-size:2rem}.gallery-stats{font-family:Orbitron,monospace;font-size:.85rem;color:#ffffffb3;display:flex;gap:15px}.stat-total{color:#0ff;font-weight:700}.stat-breakdown{color:#fff9}.gallery-close-btn{width:40px;height:40px;border:none;background:#f003;color:#f44;font-size:2rem;border-radius:8px;cursor:pointer;transition:all .2s ease;font-weight:700;line-height:1}.gallery-close-btn:hover{background:#f006;color:#f66;transform:scale(1.1)}.gallery-controls{padding:15px 30px;background:#00142880;border-bottom:1px solid rgba(0,255,255,.1);display:flex;justify-content:space-between;align-items:center;gap:20px;flex-shrink:0}.filter-tabs{display:flex;gap:8px}.filter-tab{padding:8px 16px;background:#0000004d;border:1px solid rgba(255,255,255,.1);color:#ffffffb3;font-family:Orbitron,monospace;font-size:.8rem;border-radius:6px;cursor:pointer;transition:all .2s ease}.filter-tab:hover{background:#00ffff1a;border-color:#00ffff4d;color:#fff}.filter-tab.active{background:#0ff3;border-color:#00ffff80;color:#0ff;font-weight:700}.sort-select{padding:8px 12px;background:#0000004d;border:1px solid rgba(255,255,255,.1);color:#ffffffe6;font-family:Orbitron,monospace;font-size:.8rem;border-radius:6px;cursor:pointer;outline:none;transition:all .2s ease}.sort-select:hover{border-color:#00ffff4d}.gallery-grid{flex:1;overflow-y:auto;padding:30px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;align-content:start}.gallery-grid::-webkit-scrollbar{width:10px}.gallery-grid::-webkit-scrollbar-track{background:#0000004d}.gallery-grid::-webkit-scrollbar-thumb{background:#00ffff4d;border-radius:5px}.gallery-grid::-webkit-scrollbar-thumb:hover{background:#00ffff80}.gallery-card{background:linear-gradient(135deg,#000a14cc,#001428cc);border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden;transition:all .3s ease;cursor:pointer}.gallery-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px #0ff3;border-color:#0ff6}.card-preview{height:150px;background:linear-gradient(135deg,#00000080,#00142880);border-bottom:2px solid;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden}.card-preview:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at center,rgba(255,255,255,.05),transparent);pointer-events:none}.preview-icon{font-size:3rem;z-index:1;text-shadow:0 0 20px currentColor}.preview-info{text-align:center;z-index:1}.preview-system{font-family:Orbitron,monospace;font-size:.7rem;font-weight:700;color:#fff9;letter-spacing:1px}.preview-geometry{font-family:Orbitron,monospace;font-size:.75rem;color:#fffc}.card-info{padding:15px}.card-title{font-family:Orbitron,monospace;font-size:.9rem;font-weight:700;color:#fff;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.card-meta{display:flex;justify-content:space-between;align-items:center;font-family:Orbitron,monospace;font-size:.7rem;color:#ffffff80}.card-actions{padding:10px 15px;background:#0000004d;border-top:1px solid rgba(255,255,255,.05);display:flex;gap:10px}.card-btn{flex:1;padding:8px 12px;border:none;border-radius:6px;font-family:Orbitron,monospace;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s ease}.load-btn{background:linear-gradient(135deg,#0ff3,#00c8ff4d);color:#0ff;border:1px solid rgba(0,255,255,.3)}.load-btn:hover{background:linear-gradient(135deg,#00ffff4d,#00c8ff66);transform:scale(1.05)}.delete-btn{background:#ff00001a;color:#f44;border:1px solid rgba(255,0,0,.2);flex:0 0 auto;padding:8px}.delete-btn:hover{background:#f003;transform:scale(1.1)}.gallery-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:60px 40px;text-align:center}.empty-icon{font-size:4rem;opacity:.5}.empty-title{font-family:Orbitron,monospace;font-size:1.5rem;font-weight:700;color:#ffffffb3}.empty-text{font-family:Orbitron,monospace;font-size:.9rem;color:#ffffff80;max-width:400px;line-height:1.6}@media (max-width: 768px){.gallery-container{width:95vw;height:90vh}.gallery-header{padding:15px 20px}.gallery-title{font-size:1.2rem}.gallery-stats{flex-direction:column;align-items:flex-start;gap:5px}.gallery-controls{flex-direction:column;align-items:stretch}.filter-tabs{overflow-x:auto;-webkit-overflow-scrolling:touch}.gallery-grid{grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;padding:20px}}@media (max-width: 480px){.gallery-grid{grid-template-columns:1fr}.filter-tab{font-size:.7rem;padding:6px 12px}}.control-panel{position:fixed;bottom:0;left:0;right:0;width:100%!important;max-width:100%!important;height:auto;max-height:65vh;background:linear-gradient(180deg,#000000d9,#000f1ee6);border-top:2px solid rgba(0,255,255,.3);border-right:none;border-radius:0;box-shadow:0 -10px 40px #00ffff26;-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);transition:all .4s cubic-bezier(.4,0,.2,1);z-index:9000!important;display:flex;flex-direction:column;overflow:hidden}@media (orientation: landscape) and (max-height: 500px){.control-panel{transform:translateY(100%);opacity:0;pointer-events:none}}.control-panel.collapsed{max-height:52px}.control-panel.collapsed .bezel-content{display:none}.control-panel.collapsed~.canvas-container{bottom:52px!important}.bezel-header{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;background:linear-gradient(90deg,#00ffff14,#0096ff14);border-bottom:1px solid rgba(0,255,255,.15);flex-shrink:0;min-height:52px}.bezel-tabs{display:flex;gap:4px;flex:1}.bezel-tab{padding:10px 20px;background:#0000004d;border:1px solid rgba(255,255,255,.1);border-bottom:none;color:#fff9;font-family:Orbitron,monospace;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s ease;border-radius:8px 8px 0 0;display:flex;align-items:center;gap:8px;position:relative}.bezel-tab:hover{background:#00ffff1a;color:#ffffffe6;border-color:#00ffff4d}.bezel-tab.active{background:linear-gradient(180deg,#0ff3,#00ffff26);color:#0ff;border-color:#00ffff80;border-bottom:2px solid rgba(0,255,255,.8);box-shadow:0 -4px 20px #0ff3}.bezel-tab.active:after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#00ffff,transparent);animation:tabGlow 2s ease-in-out infinite}@keyframes tabGlow{0%,to{opacity:.5}50%{opacity:1}}.tab-icon{font-size:1.1rem}.bezel-collapse-btn{width:36px;height:36px;background:#00ffff26;border:1px solid rgba(0,255,255,.3);border-radius:8px;color:#0ff;font-size:1.2rem;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;flex-shrink:0}.bezel-collapse-btn:hover{background:#00ffff40;transform:scale(1.1)}.control-panel.collapsed .bezel-collapse-btn{transform:rotate(180deg)}.bezel-content{flex:1;overflow-y:auto;padding:20px;display:none}.bezel-content.active{display:block}.bezel-content::-webkit-scrollbar{width:8px}.bezel-content::-webkit-scrollbar-track{background:#0000004d}.bezel-content::-webkit-scrollbar-thumb{background:#00ffff4d;border-radius:4px}.bezel-content::-webkit-scrollbar-thumb:hover{background:#00ffff80}.tab-content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;max-width:1400px;margin:0 auto}.control-section{background:#000a1480;border:1px solid rgba(0,255,255,.15);border-radius:10px;padding:15px;margin-bottom:0}.section-title{font-family:Orbitron,monospace;font-size:.85rem;font-weight:700;color:#0ff;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,255,255,.2);text-transform:uppercase;letter-spacing:1px}.control-group{margin-bottom:12px}.control-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:.75rem}.control-slider{width:100%;height:4px}.geometry-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.geom-btn{padding:10px 8px;font-size:.7rem;min-height:45px}.reactivity-grid,.audio-grid{font-size:.85rem}.reactivity-cell,.audio-cell{min-height:35px}.action-button-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}.panel-btn{padding:12px 16px;font-size:.8rem}.quick-access{display:none;gap:15px;padding:0 20px}.control-panel.collapsed .quick-access{display:flex;align-items:center}.quick-action-btn{padding:6px 12px;background:#00ffff1a;border:1px solid rgba(0,255,255,.2);border-radius:6px;color:#0ff;font-family:Orbitron,monospace;font-size:.75rem;cursor:pointer;transition:all .2s ease}.quick-action-btn:hover{background:#0ff3;transform:scale(1.05)}@media (max-width: 1024px){.control-panel{max-height:70vh}.tab-content-grid{grid-template-columns:1fr}.bezel-tab{padding:8px 12px;font-size:.75rem}.tab-icon{font-size:1rem}}@media (max-width: 768px){.control-panel{max-height:75vh}.bezel-tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}.bezel-tab{flex-shrink:0;padding:8px 10px;font-size:.7rem;gap:4px}.bezel-content{padding:15px}.geometry-grid{grid-template-columns:repeat(3,1fr);gap:6px}.geom-btn{font-size:.65rem;min-height:40px}.action-button-row{grid-template-columns:repeat(2,1fr)}}@media (max-width: 480px){.control-panel.collapsed{max-height:48px}.bezel-header{padding:6px 10px;min-height:48px}.bezel-tab{padding:6px 8px;font-size:.65rem}.tab-icon{font-size:.9rem}.bezel-collapse-btn{width:32px;height:32px;font-size:1rem}.geometry-grid{grid-template-columns:repeat(2,1fr)}.action-button-row{grid-template-columns:1fr}}.control-panel,.bezel-content,.canvas-container{transition:all .4s cubic-bezier(.4,0,.2,1)}.panel-header{display:none}.geometry-container{display:flex;flex-direction:column;gap:15px}.core-tabs{display:flex;gap:8px;justify-content:stretch}.core-tab{flex:1;padding:12px 16px;background:#0000004d;border:2px solid rgba(255,255,255,.1);border-radius:8px;color:#fff9;font-family:Orbitron,monospace;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .3s ease;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;position:relative;overflow:hidden}.core-tab:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,transparent,rgba(255,255,255,.05));opacity:0;transition:opacity .3s ease}.core-tab:hover:before{opacity:1}.core-tab-icon{font-size:1.5rem;margin-bottom:2px}.core-tab-name{font-size:.75rem;letter-spacing:.5px}.core-tab-range{font-size:.65rem;opacity:.7;font-weight:400}.core-tab[data-core=base]{border-color:#0ff3}.core-tab[data-core=base]:hover{background:#00ffff1a;border-color:#0ff6;color:#0ff;box-shadow:0 0 15px #00ffff4d}.core-tab[data-core=base].active{background:linear-gradient(135deg,#0ff3,#00c8ff40);border-color:#0ff9;color:#0ff;box-shadow:0 0 20px #0ff6,inset 0 0 10px #00ffff1a}.core-tab[data-core=hypersphere]{border-color:#f0f3}.core-tab[data-core=hypersphere]:hover{background:#ff00ff1a;border-color:#f0f6;color:#f0f;box-shadow:0 0 15px #ff00ff4d}.core-tab[data-core=hypersphere].active{background:linear-gradient(135deg,#f0f3,#c800ff40);border-color:#f0f9;color:#f0f;box-shadow:0 0 20px #f0f6,inset 0 0 10px #ff00ff1a}.core-tab[data-core=hypertetra]{border-color:#f803}.core-tab[data-core=hypertetra]:hover{background:#ff88001a;border-color:#f806;color:#f80;box-shadow:0 0 15px #ff88004d}.core-tab[data-core=hypertetra].active{background:linear-gradient(135deg,#f803,#ff640040);border-color:#f809;color:#f80;box-shadow:0 0 20px #f806,inset 0 0 10px #ff88001a}.geometry-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.geom-btn{padding:14px 10px;background:#0006;border:2px solid rgba(255,255,255,.15);border-radius:8px;color:#fffc;font-family:Orbitron,monospace;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .3s ease;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;position:relative;overflow:hidden}.geom-btn:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at center,rgba(255,255,255,.1),transparent);opacity:0;transition:opacity .3s ease}.geom-btn:hover:before{opacity:1}.geom-icon{font-size:1.8rem;margin-bottom:2px}.geom-name{font-size:.7rem;text-align:center;letter-spacing:.5px}.geometry-container[data-active-core=base] .geom-btn{border-color:#0ff3}.geometry-container[data-active-core=base] .geom-btn:hover{background:#00ffff26;border-color:#00ffff80;color:#0ff;box-shadow:0 0 20px #00ffff4d;transform:translateY(-3px)}.geometry-container[data-active-core=base] .geom-btn.active{background:linear-gradient(135deg,#00ffff40,#00c8ff4d);border-color:#00ffffb3;color:#0ff;box-shadow:0 0 25px #00ffff80,inset 0 0 15px #0ff3;transform:translateY(-3px)}.geometry-container[data-active-core=hypersphere] .geom-btn{border-color:#f0f3}.geometry-container[data-active-core=hypersphere] .geom-btn:hover{background:#ff00ff26;border-color:#ff00ff80;color:#f0f;box-shadow:0 0 20px #ff00ff4d;transform:translateY(-3px)}.geometry-container[data-active-core=hypersphere] .geom-btn.active{background:linear-gradient(135deg,#ff00ff40,#c800ff4d);border-color:#ff00ffb3;color:#f0f;box-shadow:0 0 25px #ff00ff80,inset 0 0 15px #f0f3;transform:translateY(-3px)}.geometry-container[data-active-core=hypertetra] .geom-btn{border-color:#f803}.geometry-container[data-active-core=hypertetra] .geom-btn:hover{background:#ff880026;border-color:#ff880080;color:#f80;box-shadow:0 0 20px #ff88004d;transform:translateY(-3px)}.geometry-container[data-active-core=hypertetra] .geom-btn.active{background:linear-gradient(135deg,#ff880040,#ff64004d);border-color:#ff8800b3;color:#f80;box-shadow:0 0 25px #ff880080,inset 0 0 15px #f803;transform:translateY(-3px)}@media (max-width: 768px){.geometry-grid{grid-template-columns:repeat(3,1fr);gap:8px}.geom-btn{padding:12px 8px;min-height:55px;font-size:.7rem}.geom-icon{font-size:1.5rem}.geom-name{font-size:.65rem}.core-tab{padding:10px 12px;font-size:.75rem}.core-tab-icon{font-size:1.2rem}.core-tab-name{font-size:.7rem}.core-tab-range{font-size:.6rem}}@media (max-width: 480px){.geometry-grid{grid-template-columns:repeat(2,1fr);gap:6px}.geom-btn{padding:10px 6px;min-height:50px;font-size:.65rem}.geom-icon{font-size:1.3rem}.geom-name{font-size:.6rem}.core-tab{padding:8px 10px;font-size:.7rem}.core-tab-icon{font-size:1rem}.core-tab-name{font-size:.65rem}}.geom-btn,.core-tab{transition:all .3s cubic-bezier(.4,0,.2,1)}.geom-btn:active{transform:translateY(-1px) scale(.98)}.core-tab:active{transform:scale(.97)}@keyframes coreGlow{0%,to{box-shadow:0 0 20px var(--glow-color),inset 0 0 10px var(--glow-color)}50%{box-shadow:0 0 30px var(--glow-color),inset 0 0 15px var(--glow-color)}}.core-tab.active{animation:coreGlow 2s ease-in-out infinite}.geometry-container[data-active-core=base] .core-tab.active{--glow-color: rgba(0, 255, 255, .4)}.geometry-container[data-active-core=hypersphere] .core-tab.active{--glow-color: rgba(255, 0, 255, .4)}.geometry-container[data-active-core=hypertetra] .core-tab.active{--glow-color: rgba(255, 136, 0, .4)}@media (max-width: 768px){.control-panel{width:100vw!important;height:auto!important;max-height:60vh!important;top:auto!important;bottom:0!important;right:0!important;left:0!important;border-left:none!important;border-top:2px solid #00ffff!important}.control-panel.collapsed{max-height:52px!important;min-height:52px!important}.canvas-container{right:0!important;left:0!important}.top-bar{max-height:100px!important;flex-wrap:wrap}.system-selector{flex-wrap:wrap;gap:5px}.system-btn{font-size:.8rem;padding:6px 12px}.mobile-collapse-btn{display:block!important}.panel-header{text-align:left}.system-btn,.action-btn,.geom-btn,.panel-btn{min-height:44px;font-size:.9rem;touch-action:manipulation}.control-slider{height:8px;min-height:44px}.control-slider::-webkit-slider-thumb{width:24px;height:24px}.touch-active{opacity:.7;transform:scale(.95)}.reactivity-grid,.audio-grid{gap:2px;padding:4px}.reactivity-cell,.audio-cell{min-height:36px;padding:2px}.reactivity-cell input[type=checkbox],.audio-cell input[type=checkbox]{width:16px;height:16px}.cell-text{font-size:.6rem}.reactivity-header,.audio-header{font-size:.7rem}.reactivity-label,.audio-label{font-size:.65rem}.control-section{margin-bottom:20px;padding-bottom:15px}.panel-btn{margin:8px 0;padding:12px 16px}.geometry-grid{gap:8px}.geom-btn{padding:12px 8px;font-size:.75rem}}@media (max-width: 480px){.top-bar{padding:0 10px;flex-wrap:wrap;min-height:50px}.logo{font-size:1rem}.system-btn{font-size:.7rem;padding:4px 8px}.action-btn{font-size:.9rem;padding:6px 8px}.control-panel{padding:15px;height:45vh}.canvas-container{bottom:55px}.section-title{font-size:.8rem}.control-label{font-size:.75rem}.panel-header{font-size:1rem}.reactivity-grid,.audio-grid{grid-template-columns:50px 1fr 1fr 1fr;gap:1px;padding:3px}.reactivity-cell,.audio-cell{min-height:32px}.cell-text{font-size:.55rem}}@media (max-width: 768px) and (orientation: landscape){.control-panel{height:50vh;width:50vw;right:0;left:auto;top:50px;bottom:0;border-left:2px solid #00ffff;border-top:none}.canvas-container{right:50vw;bottom:0;top:50px}}@media (hover: none) and (pointer: coarse){.system-btn:hover,.action-btn:hover,.geom-btn:hover,.panel-btn:hover,.reactivity-cell:hover,.audio-cell:hover{background:initial;border-color:initial;box-shadow:initial}.system-btn:active,.action-btn:active,.geom-btn:active,.panel-btn:active{transform:scale(.95);opacity:.8}.reactivity-cell:active,.audio-cell:active{background:#0ff3;transform:scale(.95)}}@keyframes fadeInOut{0%{opacity:0;transform:translateY(-10px)}20%{opacity:1;transform:translateY(0)}80%{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-10px)}}@keyframes slideIn{0%{opacity:0;transform:translate(20px)}to{opacity:1;transform:translate(0)}}@keyframes neonGlow{0%,to{text-shadow:0 0 10px #00ffff,0 0 20px #00ffff;box-shadow:0 0 5px #00ffff4d}50%{text-shadow:0 0 20px #00ffff,0 0 30px #00ffff,0 0 40px #00ffff;box-shadow:0 0 15px #0ff9}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}@keyframes bounce{0%,20%,50%,80%,to{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}@keyframes shimmer{0%{background-position:-1000px 0}to{background-position:1000px 0}}.shimmer{background:linear-gradient(90deg,transparent,rgba(0,255,255,.3),transparent);background-size:1000px 100%;animation:shimmer 2s infinite}@keyframes buttonPress{0%{transform:scale(1)}50%{transform:scale(.95)}to{transform:scale(1)}}.button-press{animation:buttonPress .2s ease}@keyframes activeGlow{0%,to{box-shadow:0 0 10px #00ffff80;border-color:#00ffff80}50%{box-shadow:0 0 20px #0ffc,0 0 30px #0ff6;border-color:#0ffc}}.active-glow{animation:activeGlow 2s infinite ease-in-out}@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.fade-in{animation:fadeIn .5s ease}@keyframes slideUp{0%{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}.slide-up{animation:slideUp .3s ease}@keyframes colorCycle{0%{border-color:#0ff;color:#0ff}33%{border-color:#f0f;color:#f0f}66%{border-color:#ff0;color:#ff0}to{border-color:#0ff;color:#0ff}}.color-cycle{animation:colorCycle 3s infinite ease-in-out}*{transition:opacity .3s ease,transform .3s ease,background-color .3s ease,border-color .3s ease,color .3s ease,box-shadow .3s ease}.loading *{transition:none!important}.top-bar{z-index:10000!important}.top-bar,.top-bar *{position:relative}.system-btn,.action-btn,.save-btn,.logo,.logo-section{z-index:10001!important}.control-panel{z-index:9000!important}.control-panel *{position:relative}#floating-debug-btn{z-index:9999!important}#system-diagnostics-overlay{z-index:10002!important}.canvas-container{z-index:1!important;isolation:isolate}.canvas-container,.canvas-container *{max-height:100vh}.holographic-layers,.holographic-layers *,.visualization-canvas,.visualization-canvas *,canvas,canvas *{z-index:-1!important;position:absolute!important}.canvas-container canvas{position:absolute!important;top:0!important;left:0!important;z-index:-1!important}#vib34dLayers,#quantumLayers,#holographicLayers,#polychoraLayers{z-index:-1!important;position:absolute!important}#vib34dLayers *,#quantumLayers *,#holographicLayers *,#polychoraLayers *{z-index:-1!important}.gallery-modal{z-index:10003!important}.system-btn{position:relative!important;overflow:visible!important}.system-icon{position:relative!important;display:inline-flex!important;align-items:center;justify-content:center;width:32px!important;height:32px!important;font-size:1.8rem!important;filter:drop-shadow(0 0 8px currentColor);transition:all .3s cubic-bezier(.34,1.56,.64,1)}.system-icon:before,.system-icon:after{content:attr(data-icon);position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:inherit;pointer-events:none;transition:all .3s ease}.system-icon:before{color:#f00c;transform:translate(-2px,-1px);mix-blend-mode:screen}.system-icon:after{color:#0064ffcc;transform:translate(2px,1px);mix-blend-mode:screen}.system-icon{color:#00ff64e6;text-shadow:0 0 10px currentColor,0 0 20px currentColor}.system-btn:hover .system-icon:before{transform:translate(-3px,-2px);color:red}.system-btn:hover .system-icon:after{transform:translate(3px,2px);color:#0064ff}.system-btn:hover .system-icon{filter:drop-shadow(0 0 15px currentColor);text-shadow:0 0 15px currentColor,0 0 30px currentColor}.system-btn.active .system-icon:before,.system-btn.active .system-icon:after,.system-btn:active .system-icon:before,.system-btn:active .system-icon:after{transform:translate(0)!important;animation:channelConverge .4s cubic-bezier(.34,1.56,.64,1)}.system-btn.active .system-icon,.system-btn:active .system-icon{animation:iconPulse .4s cubic-bezier(.34,1.56,.64,1);filter:drop-shadow(0 0 20px currentColor) drop-shadow(0 0 40px currentColor)}@keyframes channelConverge{0%{transform:translate(var(--split-x, 0),var(--split-y, 0));opacity:.8}50%{transform:translate(0) scale(1.2);opacity:1}to{transform:translate(0);opacity:.8}}@keyframes iconPulse{0%{transform:scale(1)}50%{transform:scale(1.3)}to{transform:scale(1)}}.system-icon[data-system=faceted]:before,.system-icon[data-system=faceted]:after,.system-icon[data-system=faceted]{content:"â—†"}.system-icon[data-system=quantum]:before,.system-icon[data-system=quantum]:after,.system-icon[data-system=quantum]{content:"â—‰"}.system-icon[data-system=holographic]:before,.system-icon[data-system=holographic]:after,.system-icon[data-system=holographic]{content:"â¬¡"}.system-icon[data-system=polychora]:before,.system-icon[data-system=polychora]:after,.system-icon[data-system=polychora]{content:"â– "}.system-btn.active .system-icon{--glow-color: currentColor;filter:drop-shadow(0 0 8px var(--glow-color)) drop-shadow(0 0 16px var(--glow-color)) drop-shadow(0 0 24px var(--glow-color)) brightness(1.5)}.system-btn[data-system=faceted] .system-icon{--glow-color: #00ffff}.system-btn[data-system=quantum] .system-icon{--glow-color: #ff00ff}.system-btn[data-system=holographic] .system-icon{--glow-color: #ff64ff}.system-btn[data-system=polychora] .system-icon{--glow-color: #ffff00}@keyframes glitchShake{0%,to{transform:translate(0)}25%{transform:translate(-2px,2px)}50%{transform:translate(2px,-2px)}75%{transform:translate(-1px,-1px)}}.system-btn.glitching .system-icon{animation:glitchShake .2s infinite}.system-btn.glitching .system-icon:before{animation:glitchShake .2s infinite reverse}.system-btn.glitching .system-icon:after{animation:glitchShake .15s infinite}@media (max-width: 768px){.system-icon{font-size:2rem!important;width:36px!important;height:36px!important}.system-icon:before{transform:translate(-2.5px,-1.5px)}.system-icon:after{transform:translate(2.5px,1.5px)}}.action-btn,.save-btn,.bezel-collapse-btn,.bezel-tab,.tab-icon{position:relative!important;overflow:visible!important}.action-btn:before,.action-btn:after,.save-btn:before,.save-btn:after,.bezel-collapse-btn:before,.bezel-collapse-btn:after{content:attr(data-icon);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) translate(-1.5px,-.5px);font-size:inherit;pointer-events:none;transition:all .3s ease;mix-blend-mode:screen}.action-btn:before,.save-btn:before,.bezel-collapse-btn:before{color:#ff0000b3}.action-btn:after,.save-btn:after,.bezel-collapse-btn:after{transform:translate(-50%,-50%) translate(1.5px,.5px);color:#0064ffb3}.action-btn,.save-btn,.bezel-collapse-btn{color:#00ff64e6;filter:drop-shadow(0 0 6px currentColor)}.bezel-collapse-btn[data-icon=â–¼]:before,.bezel-collapse-btn[data-icon=â–¼]:after{content:"â–¼"}.bezel-collapse-btn[data-icon=â–²]:before,.bezel-collapse-btn[data-icon=â–²]:after{content:"â–²"}.tab-icon{position:relative!important;display:inline-flex!important;filter:drop-shadow(0 0 4px currentColor)}.tab-icon:before,.tab-icon:after{content:attr(data-icon);position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;mix-blend-mode:screen}.tab-icon:before{color:#f009;transform:translate(-1px,-.5px)}.tab-icon:after{color:#0064ff99;transform:translate(1px,.5px)}.tab-icon{color:#00ffffe6}.bezel-tab.active .tab-icon:before,.bezel-tab.active .tab-icon:after{transform:translate(0)!important;animation:channelConverge .4s ease}.bezel-tab.active .tab-icon{filter:drop-shadow(0 0 8px currentColor) drop-shadow(0 0 16px currentColor)}

</style>
</head>
<body class="loading">
    <!-- Enhanced Top Navigation Bar -->
    <div class="top-bar">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo">VIB3+ ENGINE</div>
            <div class="engine-status">24 GEOMETRIES â€¢ 6D</div>
        </div>

        <!-- System Selector -->
        <div class="system-selector">
            <button class="system-btn active" data-system="faceted" onclick="switchSystem('faceted')">
                <span class="system-icon">ğŸ”·</span>
                <span>FACETED</span>
            </button>
            <button class="system-btn" data-system="quantum" onclick="switchSystem('quantum')">
                <span class="system-icon">ğŸŒŒ</span>
                <span>QUANTUM</span>
            </button>
            <button class="system-btn" data-system="holographic" onclick="switchSystem('holographic')">
                <span class="system-icon">âœ¨</span>
                <span>HOLOGRAPHIC</span>
            </button>
            <button class="system-btn" data-system="polychora" onclick="switchSystem('polychora')">
                <span class="system-icon">ğŸ”®</span>
                <span>POLYCHORA</span>
            </button>
        </div>

        <!-- Action Section -->
        <div class="action-section">
            <!-- Save Button (prominent) -->
            <button class="save-btn" onclick="saveToGallery()" title="Save Current State">
                ğŸ’¾ <span>SAVE</span>
            </button>

            <!-- Other Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn" onclick="openGallery()" title="Gallery">ğŸ–¼ï¸</button>
                <button class="action-btn" onclick="toggleAudio()" title="Audio">ğŸµ</button>
                <button class="action-btn" onclick="toggleDeviceTilt()" title="Device Tilt (4D Rotation)" id="tiltBtn">ğŸ“±</button>
                <button class="action-btn" onclick="showLLMInterface()" title="AI Parameters">ğŸ¤–</button>
                <button class="action-btn" onclick="toggleInteractivity()" title="Interactivity Menu (Press I)">I</button>
            </div>
        </div>
    </div>

    <!-- Main Canvas Container -->
    <div class="canvas-container" id="canvasContainer">
        <!-- Dynamic Canvas Containers - Canvases created/destroyed per system -->
        <div class="holographic-layers" id="vib34dLayers" style="display: block;"></div>
        <div class="holographic-layers" id="quantumLayers" style="display: none;"></div>
        <div class="holographic-layers" id="holographicLayers" style="display: none;"></div>
        <div class="holographic-layers" id="polychoraLayers" style="display: none;"></div>
    </div>

    <!-- Bottom Bezel Control Panel (Tab-Based) -->
    <div class="control-panel" id="controlPanel">
        <!-- Bezel Header with Tabs -->
        <div class="bezel-header">
            <div class="bezel-tabs">
                <button class="bezel-tab active" data-tab="controls" onclick="switchBezelTab('controls')">
                    <span class="tab-icon">âš™ï¸</span>
                    <span>Controls</span>
                </button>
                <button class="bezel-tab" data-tab="color" onclick="switchBezelTab('color')">
                    <span class="tab-icon">ğŸ¨</span>
                    <span>Color</span>
                </button>
                <button class="bezel-tab" data-tab="geometry" onclick="switchBezelTab('geometry')">
                    <span class="tab-icon">ğŸ§¬</span>
                    <span>Geometry</span>
                </button>
                <button class="bezel-tab" data-tab="reactivity" onclick="switchBezelTab('reactivity')">
                    <span class="tab-icon">ğŸ›ï¸</span>
                    <span>Reactivity</span>
                </button>
                <button class="bezel-tab" data-tab="export" onclick="switchBezelTab('export')">
                    <span class="tab-icon">ğŸ’¾</span>
                    <span>Export</span>
                </button>
            </div>

            <!-- Quick Actions (shown when collapsed) -->
            <div class="quick-access">
                <button class="quick-action-btn" onclick="quickRandomize()" title="Quick Randomize">ğŸ²</button>
                <button class="quick-action-btn" onclick="quickSave()" title="Quick Save">ğŸ’¾</button>
                <button class="quick-action-btn" onclick="quickGallery()" title="Open Gallery">ğŸ–¼ï¸</button>
            </div>

            <!-- Collapse Toggle -->
            <button class="bezel-collapse-btn" onclick="toggleBezelCollapse()" title="Toggle Controls (Ctrl+B / Space)">â–¼</button>
        </div>

        <!-- Tab 1: Controls Content (6D Rotations + Visual Parameters) -->
        <div class="bezel-content active" id="controls-content">
            <div class="tab-content-grid">
                <!-- 3D Space Rotations -->
                <div class="control-section">
                    <div class="section-title">3D Space Rotations</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>X-Y Plane</span>
                            <span class="control-value" id="rot4dXY-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dXY" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dXY', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>X-Z Plane</span>
                            <span class="control-value" id="rot4dXZ-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dXZ" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dXZ', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Y-Z Plane</span>
                            <span class="control-value" id="rot4dYZ-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dYZ" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dYZ', this.value)">
                    </div>
                </div>

                <!-- 4D Hyperspace Rotations -->
                <div class="control-section">
                    <div class="section-title">4D Hyperspace Rotations</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>X-W Plane</span>
                            <span class="control-value" id="rot4dXW-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dXW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dXW', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Y-W Plane</span>
                            <span class="control-value" id="rot4dYW-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dYW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dYW', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Z-W Plane</span>
                            <span class="control-value" id="rot4dZW-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dZW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dZW', this.value)">
                    </div>
                </div>

                <!-- Visual Parameters -->
                <div class="control-section">
                    <div class="section-title">Visual Parameters</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Grid Density</span>
                            <span class="control-value" id="gridDensity-display">15</span>
                        </div>
                        <input type="range" id="gridDensity" class="control-slider" min="5" max="100" step="1" value="15"
                               oninput="updateParameter('gridDensity', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Morph Factor</span>
                            <span class="control-value" id="morphFactor-display">1.00</span>
                        </div>
                        <input type="range" id="morphFactor" class="control-slider" min="0" max="2" step="0.01" value="1"
                               oninput="updateParameter('morphFactor', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Chaos</span>
                            <span class="control-value" id="chaos-display">0.20</span>
                        </div>
                        <input type="range" id="chaos" class="control-slider" min="0" max="1" step="0.01" value="0.2"
                               oninput="updateParameter('chaos', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Speed</span>
                            <span class="control-value" id="speed-display">1.00</span>
                        </div>
                        <input type="range" id="speed" class="control-slider" min="0.1" max="3" step="0.01" value="1"
                               oninput="updateParameter('speed', this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Color Content -->
        <div class="bezel-content" id="color-content">
            <div class="tab-content-grid">
                <div class="control-section">
                    <div class="section-title">Color Parameters</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Hue</span>
                            <span class="control-value" id="hue-display">200Â°</span>
                        </div>
                        <input type="range" id="hue" class="control-slider" min="0" max="360" step="1" value="200"
                               oninput="updateParameter('hue', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Saturation</span>
                            <span class="control-value" id="saturation-display">0.80</span>
                        </div>
                        <input type="range" id="saturation" class="control-slider" min="0" max="1" step="0.01" value="0.8"
                               oninput="updateParameter('saturation', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Intensity</span>
                            <span class="control-value" id="intensity-display">0.50</span>
                        </div>
                        <input type="range" id="intensity" class="control-slider" min="0" max="1" step="0.01" value="0.5"
                               oninput="updateParameter('intensity', this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Geometry Content (8 Base + 3 Core Tabs = 24 Geometries) -->
        <div class="bezel-content" id="geometry-content">
            <div class="tab-content-grid">
                <div class="control-section">
                    <div class="section-title">ğŸ“ 24 Geometry System</div>
                    <div class="geometry-container" data-active-core="base">
                        <!-- Core Type Tabs (3 tabs) -->
                        <div id="coreTabsContainer">
                            <!-- Populated by geometry-tabs.js -->
                        </div>

                        <!-- Base Geometry Buttons (8 buttons) -->
                        <div class="geometry-grid" id="geometryGrid">
                            <!-- Populated by geometry-tabs.js -->
                        </div>
                    </div>

                    <!-- Geometry Info Display -->
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 8px;">
                        <div style="font-family: 'Orbitron', monospace; font-size: 0.75rem; color: rgba(255, 255, 255, 0.7); text-align: center;">
                            <strong style="color: #00ffff;">Active Geometry:</strong>
                            <span data-geometry-display style="color: #ffffff;">Tetrahedron</span>
                            <span style="opacity: 0.6; margin-left: 10px;">(#<span data-geometry-display data-geometry-index="0">0</span>)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Reactivity Content -->
        <div class="bezel-content" id="reactivity-content">
            <div class="tab-content-grid">
                <!-- Interactivity Matrix -->
                <div class="control-section">
                    <div class="section-title">ğŸ›ï¸ Interactivity Matrix</div>
                    <div class="reactivity-grid">
                        <div class="reactivity-header"></div>
                        <div class="reactivity-header">ğŸ”· FACET</div>
                        <div class="reactivity-header">ğŸŒŒ QUANTUM</div>
                        <div class="reactivity-header">âœ¨ HOLO</div>

                        <div class="reactivity-label">ğŸ–±ï¸ Mouse</div>
                        <div class="reactivity-cell" onclick="document.getElementById('facetedMouse').click()">
                            <input type="checkbox" id="facetedMouse" onchange="toggleSystemReactivity('faceted', 'mouse', this.checked)">
                            <span class="cell-text">ROT</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('quantumMouse').click()">
                            <input type="checkbox" id="quantumMouse" onchange="toggleSystemReactivity('quantum', 'mouse', this.checked)">
                            <span class="cell-text">VEL</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('holographicMouse').click()">
                            <input type="checkbox" id="holographicMouse" onchange="toggleSystemReactivity('holographic', 'mouse', this.checked)">
                            <span class="cell-text">SHIMMER</span>
                        </div>

                        <div class="reactivity-label">ğŸ‘† Click</div>
                        <div class="reactivity-cell" onclick="document.getElementById('facetedClick').click()">
                            <input type="checkbox" id="facetedClick" onchange="toggleSystemReactivity('faceted', 'click', this.checked)">
                            <span class="cell-text">BURST</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('quantumClick').click()">
                            <input type="checkbox" id="quantumClick" onchange="toggleSystemReactivity('quantum', 'click', this.checked)">
                            <span class="cell-text">BLAST</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('holographicClick').click()">
                            <input type="checkbox" id="holographicClick" onchange="toggleSystemReactivity('holographic', 'click', this.checked)">
                            <span class="cell-text">RIPPLE</span>
                        </div>

                        <div class="reactivity-label">ğŸŒ€ Scroll</div>
                        <div class="reactivity-cell" onclick="document.getElementById('facetedScroll').click()">
                            <input type="checkbox" id="facetedScroll" onchange="toggleSystemReactivity('faceted', 'scroll', this.checked)">
                            <span class="cell-text">CYCLE</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('quantumScroll').click()">
                            <input type="checkbox" id="quantumScroll" onchange="toggleSystemReactivity('quantum', 'scroll', this.checked)">
                            <span class="cell-text">WAVE</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('holographicScroll').click()">
                            <input type="checkbox" id="holographicScroll" onchange="toggleSystemReactivity('holographic', 'scroll', this.checked)">
                            <span class="cell-text">SWEEP</span>
                        </div>
                    </div>
                    <div class="reactivity-note">Toggle mouse, click, and scroll interactions per system</div>
                </div>

                <!-- Audio Reactivity Matrix -->
                <div class="control-section">
                    <div class="section-title">ğŸµ Audio Reactivity Matrix</div>
                    <div class="audio-grid">
                        <div class="audio-header"></div>
                        <div class="audio-header">ğŸ¨ COLOR</div>
                        <div class="audio-header">ğŸ§¬ GEO</div>
                        <div class="audio-header">ğŸŒ€ MOVE</div>

                        <div class="audio-label">LOW</div>
                        <div class="audio-cell" onclick="document.getElementById('lowColor').click()">
                            <input type="checkbox" id="lowColor" onchange="toggleAudioReactivity('low', 'color', this.checked)">
                            <span class="cell-text">30%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('lowGeometry').click()">
                            <input type="checkbox" id="lowGeometry" onchange="toggleAudioReactivity('low', 'geometry', this.checked)">
                            <span class="cell-text">30%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('lowMovement').click()">
                            <input type="checkbox" id="lowMovement" onchange="toggleAudioReactivity('low', 'movement', this.checked)">
                            <span class="cell-text">30%</span>
                        </div>

                        <div class="audio-label">MED</div>
                        <div class="audio-cell" onclick="document.getElementById('mediumColor').click()">
                            <input type="checkbox" id="mediumColor" checked onchange="toggleAudioReactivity('medium', 'color', this.checked)">
                            <span class="cell-text">100%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('mediumGeometry').click()">
                            <input type="checkbox" id="mediumGeometry" onchange="toggleAudioReactivity('medium', 'geometry', this.checked)">
                            <span class="cell-text">100%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('mediumMovement').click()">
                            <input type="checkbox" id="mediumMovement" onchange="toggleAudioReactivity('medium', 'movement', this.checked)">
                            <span class="cell-text">100%</span>
                        </div>

                        <div class="audio-label">HIGH</div>
                        <div class="audio-cell" onclick="document.getElementById('highColor').click()">
                            <input type="checkbox" id="highColor" onchange="toggleAudioReactivity('high', 'color', this.checked)">
                            <span class="cell-text">200%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('highGeometry').click()">
                            <input type="checkbox" id="highGeometry" onchange="toggleAudioReactivity('high', 'geometry', this.checked)">
                            <span class="cell-text">200%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('highMovement').click()">
                            <input type="checkbox" id="highMovement" onchange="toggleAudioReactivity('high', 'movement', this.checked)">
                            <span class="cell-text">200%</span>
                        </div>
                    </div>
                    <div class="audio-note">Control audio sensitivity and which parameters react</div>
                </div>
            </div>
        </div>

        <!-- Tab 5: Export Content -->
        <div class="bezel-content" id="export-content">
            <div class="tab-content-grid">
                <div class="control-section">
                    <div class="section-title">ğŸ“¤ Export & Actions</div>
                    <div class="action-button-row">
                        <button class="panel-btn" onclick="createTradingCard()">ğŸ´ Trading Card</button>
                        <button class="panel-btn" onclick="openGallery()">ğŸ–¼ï¸ Open Gallery</button>
                        <button class="panel-btn" onclick="resetAll()">ğŸ”„ Reset All</button>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 8px; text-align: center;">
                        <div style="font-family: 'Orbitron', monospace; font-size: 0.75rem; color: rgba(255, 255, 255, 0.7);">
                            ğŸ’¡ <strong style="color: #00ffff;">TIP:</strong> Use <strong>ğŸ² Randomize All</strong> and <strong>ğŸ¯ Random Tab</strong> buttons at the top of each tab to randomize parameters!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- URL Parameter Handler (runs first) -->

    <!-- Gallery Preview Fix (runs early for gallery previews) -->

    <!-- Core JavaScript Modules (NEW CLEAN ARCHITECTURE) - Order matters for globals -->

    <!-- Enhanced UI Modules -->

    <!-- Initialize globals and user parameter state BEFORE main app -->
    <script>
        // Initialize global state that modules need
        window.userParameterState = {};
        // CRITICAL FIX: Don't overwrite currentSystem if URL parameters already set it
        if (!window.currentSystem) {
            window.currentSystem = 'faceted';
            console.log('ğŸ”§ Global: Set currentSystem to default faceted');
        } else {
            console.log(`ğŸ”§ Global: Preserving existing currentSystem = '${window.currentSystem}'`);
        }
        window.moduleReady = false;
        
        // Initialize geometries data - 24 GEOMETRIES PER SYSTEM
        window.geometries = {
            faceted: [
                // Base geometries (0-7)
                'Tetrahedron', 'Hypercube', 'Sphere', 'Torus', 'Klein Bottle', 'Fractal', 'Wave', 'Crystal',
                // Hypersphere Core (8-15)
                'ğŸŒ€ Tetrahedron Core', 'ğŸŒ€ Hypercube Core', 'ğŸŒ€ Sphere Core', 'ğŸŒ€ Torus Core',
                'ğŸŒ€ Klein Core', 'ğŸŒ€ Fractal Core', 'ğŸŒ€ Wave Core', 'ğŸŒ€ Crystal Core',
                // Hypertetrahedron Core (16-23)
                'ğŸ”º Tetrahedron Core', 'ğŸ”º Hypercube Core', 'ğŸ”º Sphere Core', 'ğŸ”º Torus Core',
                'ğŸ”º Klein Core', 'ğŸ”º Fractal Core', 'ğŸ”º Wave Core', 'ğŸ”º Crystal Core'
            ],
            quantum: [
                // Base geometries (0-7)
                'Tetrahedron', 'Hypercube', 'Sphere', 'Torus', 'Klein Bottle', 'Fractal', 'Wave', 'Crystal',
                // Hypersphere Core (8-15)
                'ğŸŒ€ Tetrahedron Core', 'ğŸŒ€ Hypercube Core', 'ğŸŒ€ Sphere Core', 'ğŸŒ€ Torus Core',
                'ğŸŒ€ Klein Core', 'ğŸŒ€ Fractal Core', 'ğŸŒ€ Wave Core', 'ğŸŒ€ Crystal Core',
                // Hypertetrahedron Core (16-23)
                'ğŸ”º Tetrahedron Core', 'ğŸ”º Hypercube Core', 'ğŸ”º Sphere Core', 'ğŸ”º Torus Core',
                'ğŸ”º Klein Core', 'ğŸ”º Fractal Core', 'ğŸ”º Wave Core', 'ğŸ”º Crystal Core'
            ],
            holographic: ['HOLOGRAPHIC'], // Single holographic mode
            polychora: ['5-CELL', 'TESSERACT', '16-CELL', '24-CELL', '600-CELL', '120-CELL']
        };
        
        console.log('ğŸ”§ Global state initialized for clean architecture');
    </script>

    <!-- Main Application Module -->
</body>
</html>